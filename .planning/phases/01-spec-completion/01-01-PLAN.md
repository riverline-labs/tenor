---
phase: 01-spec-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/cffp/persona.json
  - docs/TENOR.md
autonomous: true
requirements:
  - SPEC-01
  - SPEC-05

must_haves:
  truths:
    - "Persona construct has formal syntax, semantics, and interchange representation in docs/TENOR.md"
    - "Persona CFFP artifact exists and conforms to docs/cffp.cue schema"
    - "Every persona reference in an Operation or Flow must resolve to a declared Persona"
    - "Persona ids are unique within a contract"
  artifacts:
    - path: "docs/cffp/persona.json"
      provides: "Complete CFFP instance for Persona construct"
      contains: "phase6"
    - path: "docs/TENOR.md"
      provides: "Persona spec section with syntax, semantics, elaboration rules, interchange representation, validation rules"
      contains: "Persona"
  key_links:
    - from: "docs/cffp/persona.json"
      to: "docs/TENOR.md"
      via: "CFFP canonical form translated to spec section"
      pattern: "canonical.*formal_statement"
---

<objective>
Execute CFFP run for the Persona construct and translate the canonical form into a formal spec section in docs/TENOR.md.

Purpose: Persona is currently implicit (bare strings in Operation `allowed_personas` and Flow step `persona` fields). Formalizing it as a first-class declared construct enables S4 authority topology analysis and closes spec gap TS-10. This is the first CFFP run and establishes the execution pattern for P7 and P5.

Output: `docs/cffp/persona.json` (complete CFFP instance), updated `docs/TENOR.md` with new Persona section.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-spec-completion/01-CONTEXT.md
@.planning/phases/01-spec-completion/01-RESEARCH.md
@docs/cffp.cue
@docs/TENOR.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execute full CFFP run for Persona construct</name>
  <files>docs/cffp/persona.json</files>
  <action>
Create `docs/cffp/` directory and produce `docs/cffp/persona.json` — a complete CFFP instance conforming to `docs/cffp.cue#CFFPInstance`.

**Phase 1 — Invariant Declaration:**
Starting invariants from CONTEXT.md:
- I1: Every persona reference in an Operation `allowed_personas` set or Flow step `persona` field must resolve to a declared Persona construct (class: soundness)
- I2: Persona ids are unique within a contract (class: soundness)

Derive additional invariants from the design constraints (C1-C7). Consider:
- I3: Persona resolution terminates (class: termination) — persona references do not create cycles
- I4: Persona set is statically determinable (class: analyzability) — the set of all declared personas is known at elaboration time
- I5: Persona does not affect evaluation determinism (class: determinism) — persona identity is an input, not computed

Every invariant must be testable, structural, and falsifiable per `docs/cffp.cue#Invariant`.

**Phase 2 — Candidate Formalisms:**
Generate at least 2 candidate formalisms. Start with the minimal candidate from CONTEXT.md:
- Candidate A: Minimal Persona — `{id: PersonaId, metadata?: Record}` where PersonaId is a unique string, metadata is optional key-value pairs. Evaluation rule: persona reference lookup is O(1) hash map check. Resolution rule: unresolved persona reference is an elaboration error (Pass 5).
- Candidate B: Enriched Persona — includes description, display_name, and optional delegation set (explicit list of persona ids this persona can act on behalf of). Enables richer authority analysis.
- Additional candidates as the design space warrants.

Each candidate must include: formalism (structure, evaluation_rule, resolution_rule), claims with proof sketches for every invariant, complexity bounds, and failure modes.

**Phase 3 — Pressure:**
Generate counterexamples targeting each candidate. Per research pitfall #1, apply design constraints C1-C7 as additional pressure:
- Test: Does delegation (if present) violate C6 (explicit over implicit)?
- Test: Can metadata fields create unbounded complexity violating C1 (decidability)?
- Test: Do persona hierarchies introduce non-termination (C2)?
Composition test against ALL depends_on constructs: Fact, Entity, Rule, Operation, Flow, TypeDecl.
Key composition tests:
- Operation: `allowed_personas` references must resolve to declared Personas
- Flow: step `persona` fields, HandoffStep `from_persona`/`to_persona` must resolve
- Rule: Rules do not reference personas directly (verify no composition issue)
Each counterexample must be minimal per `docs/cffp.cue#Counterexample`.

**Survivor Derivation:** Populate `derived` field with eliminated candidates and survivors. Record scope narrowings.

**Phase 4 — Collapse Test:** Only if multiple survivors. Attempt merge or select with rationale.

**Phase 5 — Static Analysis Obligations:** Prove: S4 authority topology can extract all persona references from a contract and build the complete authority graph.

**Phase 6 — Canonicalization:** Produce formal statement, evaluation definition, satisfied invariants, acknowledged limitations. The canonical form defines: Persona declaration syntax, semantics, elaboration rules, interchange representation, and validation rules.

Key design question: How does adding Persona affect the interchange format? Research recommends option (a) — Persona constructs appear as new items in the `constructs` array, existing string references in Operations and Flows become validated against declared Personas. This parallels how Fact references work. Let the CFFP pressure decide.
  </action>
  <verify>
Validate the CFFP artifact structure:
- JSON parses without error
- Contains all required top-level fields: protocol, construct, version, phase1, phase2, phase3, derived, phase5, phase6, outcome, outcome_notes
- phase1.invariants is non-empty
- phase2.candidates is non-empty
- derived.survivors is non-empty
- phase5.all_provable is true
- phase6.canonical exists with construct, formal_statement, evaluation_def, satisfies, acknowledged_limitations
- outcome is "canonical" or "collapse"
- construct.depends_on lists ["Fact", "Entity", "Rule", "Operation", "Flow", "TypeDecl"]
  </verify>
  <done>
Complete CFFP instance for Persona at docs/cffp/persona.json with outcome "canonical" or "collapse". At least 2 candidate formalisms generated, pressure-tested with counterexamples and composition tests, survivor(s) identified, static obligations proved, canonical form produced.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write Persona spec section in docs/TENOR.md</name>
  <files>docs/TENOR.md</files>
  <action>
Translate the CFFP canonical form from `docs/cffp/persona.json` into a formal spec section in `docs/TENOR.md`. Follow the exact structure of existing construct sections (Sections 5-10):

1. **Add Persona to Table of Contents** — insert as a new numbered section. Since Persona is referenced by Operation (Section 8) and Flow (Section 10), and is a simpler construct than Operation, place it logically. Consider inserting between Operation and PredicateExpression, or as a new Section 4.x alongside BaseType. Choose placement that respects the dependency order stated in Section 3.

2. **Write Persona section** following the pattern:
   - N.1 Definition — formal definition using the canonical form's `formal_statement`. Include algebraic notation consistent with existing sections.
   - N.2 Semantics — operational semantics from canonical form's `evaluation_def`. How persona declaration is processed, how persona references are validated.
   - N.3 Constraints — elaboration-time validation rules. Include: persona id uniqueness, persona reference resolution (must resolve to declared Persona), any constraints from the canonical form.
   - N.4 Provenance — provenance record structure (file, line).
   - N.5 Interchange Representation — how Persona serializes to JSON in Pass 6. Include the "kind" value ("Persona"), all fields with types, example JSON.

3. **Update Section 3 (Core Constructs Overview)** — add Persona to the semantic layer construct list. Update the construct count.

4. **Update Section 8 (Operation)** — note that `allowed_personas` values must resolve to declared Persona constructs. Reference the new Persona section.

5. **Update Section 10 (Flow)** — note that step `persona` fields, HandoffStep `from_persona`/`to_persona` must resolve to declared Persona constructs. Reference the new Persona section.

6. **Update Section 16 (Pending Work)** — Persona is not in the pending list but add a note that persona formalization is resolved in v1.0 if appropriate.

7. **Update Appendix A (Acknowledged Limitations)** — add any acknowledged limitations from the CFFP canonical form.

Do NOT change existing construct definitions or evaluation rules. Persona is additive. The spec freeze means existing semantics are preserved.
  </action>
  <verify>
- docs/TENOR.md contains a new Persona section with subsections: Definition, Semantics, Constraints, Provenance, Interchange Representation
- Table of Contents updated with Persona
- Section 3 lists Persona in construct overview
- Section 8 (Operation) references Persona for allowed_personas validation
- Section 10 (Flow) references Persona for step persona field validation
- All acknowledged limitations from CFFP canonical form appear in Appendix A
  </verify>
  <done>
docs/TENOR.md contains complete Persona construct specification section following the same structure as existing construct sections. Operations and Flows reference Persona for persona field validation. Table of Contents and Core Constructs Overview updated.
  </done>
</task>

</tasks>

<verification>
1. `docs/cffp/persona.json` exists, parses as valid JSON, and structurally matches `docs/cffp.cue#CFFPInstance`
2. `docs/TENOR.md` contains a Persona section with Definition, Semantics, Constraints, Provenance, and Interchange Representation subsections
3. Persona section is structurally parallel to existing construct sections (Fact, Entity, Rule, Operation, Flow)
4. Operation section references Persona for `allowed_personas` validation
5. Flow section references Persona for step `persona` field validation
6. CFFP artifact has non-empty counterexamples and composition tests (not cargo-culted per pitfall #5)
</verification>

<success_criteria>
- Persona CFFP run completed with canonical outcome
- Persona spec section in docs/TENOR.md is complete and structurally parallel to existing sections
- The Persona construct integrates with Operation and Flow via declared references, not bare strings
- No breaking changes to existing construct semantics
</success_criteria>

<output>
After completion, create `.planning/phases/01-spec-completion/01-01-SUMMARY.md`
</output>
