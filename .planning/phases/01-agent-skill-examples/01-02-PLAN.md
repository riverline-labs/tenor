---
phase: 01-agent-skill-examples
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - examples/express-middleware/package.json
  - examples/express-middleware/src/middleware.ts
  - examples/express-middleware/src/server.ts
  - examples/express-middleware/README.md
  - examples/express-middleware/tsconfig.json
autonomous: true
requirements:
  - SKEX-02

must_haves:
  truths:
    - "Starting the Express server auto-generates routes from contract operations"
    - "Each operation becomes a POST endpoint that validates persona and evaluates the contract"
    - "GET /contracts lists loaded contracts with their operations"
    - "POST /contracts/:id/operations/:opId executes the operation with provided facts"
    - "The middleware uses the TenorClient SDK to communicate with tenor serve"
  artifacts:
    - path: "examples/express-middleware/src/middleware.ts"
      provides: "Express middleware that generates routes from contract operations"
      min_lines: 80
    - path: "examples/express-middleware/src/server.ts"
      provides: "Example Express server using the middleware"
      min_lines: 30
    - path: "examples/express-middleware/package.json"
      provides: "npm package with express and @tenor-lang/sdk dependencies"
      contains: "express"
    - path: "examples/express-middleware/README.md"
      provides: "Usage instructions and architecture explanation"
      min_lines: 30
  key_links:
    - from: "examples/express-middleware/src/middleware.ts"
      to: "@tenor-lang/sdk"
      via: "TenorClient import for evaluator communication"
      pattern: "TenorClient"
    - from: "examples/express-middleware/src/server.ts"
      to: "examples/express-middleware/src/middleware.ts"
      via: "app.use(tenorMiddleware(...))"
      pattern: "tenorMiddleware"
---

<objective>
Build an Express middleware reference implementation that auto-generates REST routes from Tenor contract operations.

Purpose: Show how a web framework can use the SDK to turn contract operations into a typed HTTP API -- the contract defines the endpoints, not the developer.

Output: Working Express middleware with example server in `examples/express-middleware/`.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@sdk/typescript/src/client.ts
@sdk/typescript/src/types.ts
@sdk/typescript/examples/agent-basics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Express middleware that generates routes from operations</name>
  <files>
    examples/express-middleware/package.json
    examples/express-middleware/tsconfig.json
    examples/express-middleware/src/middleware.ts
  </files>
  <action>
Create `examples/express-middleware/` directory structure.

**package.json:**
```json
{
  "name": "@tenor-examples/express-middleware",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "build": "tsc",
    "start": "node --experimental-strip-types src/server.ts",
    "dev": "node --experimental-strip-types --watch src/server.ts"
  },
  "dependencies": {
    "express": "^4.21.0"
  },
  "devDependencies": {
    "@types/express": "^4.17.21",
    "typescript": "~5.7.0"
  }
}
```

Note: The SDK is imported via relative path (not npm) since it's in the same repo: `../../sdk/typescript/src/index.ts`.

**tsconfig.json:** Target ES2022, module NodeNext, strict mode.

**middleware.ts:**
Create a `tenorMiddleware(options)` function that:

1. Accepts `{ tenorUrl: string, prefix?: string }` config. Default prefix: `/tenor`.
2. Returns an Express Router.
3. On initialization, creates a `TenorClient` pointed at `tenorUrl`.
4. Exposes these routes:
   - `GET {prefix}/contracts` -- calls `client.listContracts()`, returns the list with operations for each
   - `GET {prefix}/contracts/:contractId` -- calls `client.explain(contractId)`, returns explanation
   - `GET {prefix}/contracts/:contractId/operations` -- calls `client.getOperations(contractId)`, returns operations
   - `POST {prefix}/contracts/:contractId/evaluate` -- reads `{ facts, flow_id?, persona? }` from body, calls `client.invoke(contractId, facts, { flow_id, persona })`, returns result
   - `POST {prefix}/contracts/:contractId/operations/:opId` -- reads `{ facts, persona }` from body. First calls `client.getOperations(contractId)` to validate the operation exists. Then finds the operation's entity and required state transition. Constructs the evaluation call with the appropriate flow or rule evaluation. Returns the result.

5. Each route handler wraps in try/catch, returns appropriate HTTP status codes:
   - `ContractNotFoundError` -> 404
   - `EvaluationError` -> 422
   - `ConnectionError` -> 502
   - Other errors -> 500

6. Add JSDoc comments explaining how each route maps to SDK agent skills.

The import for TenorClient should use relative path: `import { TenorClient, ContractNotFoundError, EvaluationError, ConnectionError } from '../../../sdk/typescript/src/index.ts';`
  </action>
  <verify>
    <automated>cd /Users/bwb/src/riverline/tenor/examples/express-middleware && node -e "import('./src/middleware.ts')" 2>&1 || echo "TypeScript check: use tsc if available"</automated>
    <manual>Check that middleware.ts exports tenorMiddleware function and routes are defined</manual>
  </verify>
  <done>Middleware module exports `tenorMiddleware()` that generates Express routes from contract operations, with proper error handling and JSDoc comments.</done>
</task>

<task type="auto">
  <name>Task 2: Create example server and README</name>
  <files>
    examples/express-middleware/src/server.ts
    examples/express-middleware/README.md
  </files>
  <action>
**server.ts:**
Create a minimal Express server that demonstrates the middleware:

1. Import `express` and `tenorMiddleware` from `./middleware.ts`.
2. Create Express app with `express.json()` body parser.
3. Mount the Tenor middleware at the default prefix.
4. Add a root `GET /` route that returns a welcome message listing available endpoints.
5. Start listening on port 3000 (configurable via `PORT` env var).
6. Print startup message showing the base URL and available routes.

The server.ts should be runnable with: `node --experimental-strip-types src/server.ts`

Prerequisites shown in console output:
```
Prerequisites: tenor serve --port 8080 domains/saas/saas_subscription.tenor
```

**README.md:**
Write a README covering:
1. What this example does (Express middleware auto-generates routes from contract operations)
2. Architecture diagram showing: Express App -> Tenor Middleware -> TenorClient SDK -> tenor serve -> Contract
3. Prerequisites (Rust toolchain, Node.js 22+, running `tenor serve`)
4. Quick start steps (start tenor serve, install deps, run server)
5. Available endpoints with curl examples
6. How to extend (add auth, custom validators, webhooks)
7. Note that this is a reference implementation, not a production library

Keep the README practical and concise. No marketing language. Show real curl commands that work with the SaaS subscription contract.
  </action>
  <verify>
    <automated>test -f /Users/bwb/src/riverline/tenor/examples/express-middleware/src/server.ts && test -f /Users/bwb/src/riverline/tenor/examples/express-middleware/README.md && echo "Files exist"</automated>
    <manual>Review server.ts for correct middleware usage, README for accuracy of curl examples</manual>
  </verify>
  <done>Example server demonstrates middleware usage, README provides working quickstart with curl examples against the SaaS subscription contract.</done>
</task>

</tasks>

<verification>
1. All files exist in `examples/express-middleware/`
2. `middleware.ts` compiles without type errors (syntax check via Node import)
3. `server.ts` uses the middleware correctly
4. README has working curl examples
</verification>

<success_criteria>
- Express middleware generates routes from contract operations
- Example server is runnable with `node --experimental-strip-types`
- Routes map to TenorClient SDK methods
- Error handling returns appropriate HTTP status codes
- README provides complete quickstart
</success_criteria>

<output>
After completion, create `.planning/phases/01-agent-skill-examples/01-02-SUMMARY.md`
</output>
