---
phase: 12-system-construct
plan: 05
type: execute
wave: 5
depends_on:
  - 12-04
files_modified:
  # Positive System fixtures (system .tenor + expected JSON)
  - conformance/positive/system_basic.tenor
  - conformance/positive/system_basic.expected.json
  - conformance/positive/system_shared_persona.tenor
  - conformance/positive/system_shared_persona.expected.json
  - conformance/positive/system_flow_trigger.tenor
  - conformance/positive/system_flow_trigger.expected.json
  - conformance/positive/system_shared_entity.tenor
  - conformance/positive/system_shared_entity.expected.json
  # Member contract .tenor files referenced by System fixtures (each needs .expected.json
  # because the conformance runner flags .tenor files without a matching expected file)
  - conformance/positive/system_member_a.tenor
  - conformance/positive/system_member_a.expected.json
  - conformance/positive/system_member_b.tenor
  - conformance/positive/system_member_b.expected.json
  # Negative fixtures
  - conformance/negative/pass5/system_duplicate_member.tenor
  - conformance/negative/pass5/system_duplicate_member.expected-error.json
  - conformance/negative/pass5/system_invalid_persona_ref.tenor
  - conformance/negative/pass5/system_invalid_persona_ref.expected-error.json
  - conformance/negative/pass5/system_invalid_flow_trigger.tenor
  - conformance/negative/pass5/system_invalid_flow_trigger.expected-error.json
  - conformance/negative/pass2/system_duplicate_id.tenor
  - conformance/negative/pass2/system_duplicate_id.expected-error.json
  # Schema validation test
  - crates/core/tests/schema_validation.rs
autonomous: true
requirements:
  - SYS-08

must_haves:
  truths:
    - "Positive conformance tests cover System with member contracts, shared personas, flow triggers, and shared entities"
    - "Negative conformance tests cover duplicate System ids (pass 2), duplicate members, invalid persona refs, invalid flow triggers (pass 5)"
    - "All positive conformance expected JSONs validate against the interchange schema"
    - "The conformance runner discovers and runs System fixtures"
  artifacts:
    - path: "conformance/positive/system_basic.tenor"
      provides: "Basic System positive fixture"
      contains: "system"
    - path: "conformance/negative/pass5/system_duplicate_member.tenor"
      provides: "System duplicate member negative fixture"
      contains: "system"
  key_links:
    - from: "conformance/positive/system_basic.expected.json"
      to: "docs/interchange-schema.json"
      via: "expected JSON validates against schema"
      pattern: "System"
    - from: "crates/core/tests/schema_validation.rs"
      to: "conformance/positive/system_basic.expected.json"
      via: "schema validation test discovers and validates system fixtures"
      pattern: "system"
---

<objective>
Create the conformance test suite for System construct elaboration — positive tests that verify correct interchange output, and negative tests that verify proper error detection.

Purpose: Conformance tests are the ground-truth correctness mechanism. They ensure the elaborator produces exact expected output for valid System input and exact expected errors for invalid System input. Schema validation tests confirm all expected JSONs are schema-compliant.

Output: At least 4 positive and 4 negative conformance fixtures covering all System features, plus updated schema validation test.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-system-construct/12-04-SUMMARY.md
@docs/TENOR.md
@docs/interchange-schema.json
@conformance/positive/fact_basic.tenor
@conformance/positive/fact_basic.expected.json
@conformance/negative/pass5/entity_invalid_initial.tenor
@conformance/negative/pass5/entity_invalid_initial.expected-error.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create positive System conformance fixtures</name>
  <files>
conformance/positive/system_member_a.tenor
conformance/positive/system_member_a.expected.json
conformance/positive/system_member_b.tenor
conformance/positive/system_member_b.expected.json
conformance/positive/system_basic.tenor
conformance/positive/system_basic.expected.json
conformance/positive/system_shared_persona.tenor
conformance/positive/system_shared_persona.expected.json
conformance/positive/system_flow_trigger.tenor
conformance/positive/system_flow_trigger.expected.json
conformance/positive/system_shared_entity.tenor
conformance/positive/system_shared_entity.expected.json
  </files>
  <action>
**Member contract files first:** System constructs reference member contracts as separate .tenor files. The conformance runner (`run_positive_dir` in runner.rs) discovers ALL .tenor files in positive/ and expects a matching .expected.json for each. Therefore, member contract .tenor files MUST have their own .expected.json files — otherwise the runner flags them as failures.

Create two reusable member contract files:
- **system_member_a.tenor / system_member_a.expected.json**: A minimal contract with at least one fact, one entity (with states and transitions), one persona, one flow, and one operation. This provides enough constructs for the System fixtures to reference for shared personas, flow triggers, and shared entities.
- **system_member_b.tenor / system_member_b.expected.json**: A second contract similar to member_a but with different ids. Should declare a persona with the same name as member_a (for shared persona testing), an entity with compatible states (for shared entity testing), and a flow (for flow trigger testing).

Generate the .expected.json files by running `cargo run -p tenor-cli -- elaborate <file>.tenor` and saving the output. These are proper standalone conformance tests in their own right.

**Then create 4 positive System fixtures that import the member contracts:**

**1. system_basic.tenor / system_basic.expected.json:**
A minimal System with 2 member contracts (imports system_member_a.tenor and system_member_b.tenor). No shared personas, flow triggers, or entity relationships — just the basic System container.

**2. system_shared_persona.tenor / system_shared_persona.expected.json:**
A System with shared persona bindings. Imports both member contracts. Declares the shared persona that exists in both member_a and member_b.

**3. system_flow_trigger.tenor / system_flow_trigger.expected.json:**
A System with a cross-contract flow trigger. Imports both member contracts. Declares a trigger from a flow in member_a to a flow in member_b.

**4. system_shared_entity.tenor / system_shared_entity.expected.json:**
A System with a shared entity relationship. Imports both member contracts. Declares the entity with compatible state machines as shared.

For each fixture:
1. Write the .tenor DSL source using lowercase `system` keyword
2. Run `cargo run -p tenor-cli -- elaborate <file>.tenor` to get actual output
3. Save the actual output as the .expected.json file
4. Verify the expected JSON has sorted keys and correct System representation

**Important:** The expected JSON must be generated from the elaborator, not hand-written. Run the elaborator first, inspect the output, then save it as expected. This ensures byte-for-byte match in the conformance runner.

**Note on member contract reuse:** If individual System fixtures require specific constructs not present in the shared member_a/member_b files (e.g., a specific entity state machine for shared_entity testing), the executor may need to create additional member contract files or modify the shared ones. Use judgment — the goal is to keep the fixture set minimal while covering all four System features. If additional member .tenor files are needed beyond member_a and member_b, create them with the `system_member_` prefix and add their .expected.json files.
  </action>
  <verify>
1. `cargo run -p tenor-cli -- test conformance 2>&1 | grep -c "not ok"` — zero failures
2. All system_*.expected.json files exist and contain "kind": "System"
3. `cargo run -p tenor-cli -- validate conformance/positive/system_basic.expected.json` — validates against schema
  </verify>
  <done>
Four positive System conformance fixtures exist covering basic System, shared personas, flow triggers, and shared entities. All pass the conformance runner and schema validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create negative System conformance fixtures and update schema validation</name>
  <files>
conformance/negative/pass2/system_duplicate_id.tenor
conformance/negative/pass2/system_duplicate_id.expected-error.json
conformance/negative/pass5/system_duplicate_member.tenor
conformance/negative/pass5/system_duplicate_member.expected-error.json
conformance/negative/pass5/system_invalid_persona_ref.tenor
conformance/negative/pass5/system_invalid_persona_ref.expected-error.json
conformance/negative/pass5/system_invalid_flow_trigger.tenor
conformance/negative/pass5/system_invalid_flow_trigger.expected-error.json
crates/core/tests/schema_validation.rs
  </files>
  <action>
**Negative fixtures:**

Create at least 4 negative conformance fixtures:

1. **system_duplicate_id (pass2):** Two System constructs with the same id → pass 2 duplicate id error
2. **system_duplicate_member (pass5):** A System that declares the same member contract id twice → pass 5 validation error
3. **system_invalid_persona_ref (pass5):** A shared persona binding references a persona that does not exist in one of the member contracts → pass 5 validation error
4. **system_invalid_flow_trigger (pass5):** A flow trigger references a flow that does not exist in the target contract → pass 5 validation error

For each negative fixture:
1. Write the .tenor DSL that should trigger the error
2. Run `cargo run -p tenor-cli -- elaborate <file>.tenor 2>&1` to get the actual error JSON
3. Save the error output as the .expected-error.json file
4. Verify the error JSON has the expected pass number, construct_kind, construct_id, field, and message

Error JSON format (matching ElabError::to_json_value()):
```json
{
  "construct_id": "my_system",
  "construct_kind": "System",
  "field": "members",
  "file": "system_duplicate_member.tenor",
  "line": 3,
  "message": "duplicate member contract id 'contract_a'",
  "pass": 5
}
```

**Schema validation test (schema_validation.rs):**
The existing schema validation test at `crates/core/tests/schema_validation.rs` walks all `*.expected.json` files and validates them against the interchange schema. It should automatically discover the new system_*.expected.json files. Verify this works by running `cargo test -p tenor-core --test schema_validation`.

If the schema validation test needs updating (e.g., if it uses a hardcoded file list rather than glob), update it to include System fixtures.
  </action>
  <verify>
1. `cargo run -p tenor-cli -- test conformance 2>&1 | grep -c "not ok"` — zero failures
2. `cargo test -p tenor-core --test schema_validation` — passes (system expected JSONs validate against schema)
3. All 4 negative fixture pairs exist and contain proper error JSON
4. `cargo test --workspace` — all tests pass
  </verify>
  <done>
Four negative System conformance fixtures exist covering duplicate id (pass 2), duplicate member (pass 5), invalid persona reference (pass 5), and invalid flow trigger (pass 5). All pass the conformance runner. Schema validation test covers all new positive fixtures.
  </done>
</task>

</tasks>

<verification>
- `cargo run -p tenor-cli -- test conformance` — all tests pass (including new System tests)
- `cargo test --workspace` — all tests pass
- Conformance suite covers all four System features (members, shared personas, flow triggers, shared entities)
- Both positive (correct output) and negative (correct errors) cases covered
</verification>

<success_criteria>
The conformance suite has at least 8 new System fixtures (4 positive, 4 negative) and all pass. Schema validation confirms all positive expected JSONs comply with the interchange schema.
</success_criteria>

<output>
After completion, create `.planning/phases/12-system-construct/12-05-SUMMARY.md`
</output>
