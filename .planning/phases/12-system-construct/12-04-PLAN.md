---
phase: 12-system-construct
plan: 04
type: execute
wave: 4
depends_on:
  - 12-03
files_modified:
  - crates/core/src/pass5_validate.rs
  - crates/core/src/pass6_serialize.rs
  - docs/interchange-schema.json
autonomous: true
requirements:
  - SYS-06
  - SYS-07

must_haves:
  truths:
    - "Pass 5 validates System constructs — member contract resolution, shared persona existence, flow trigger validity, entity relationship compatibility"
    - "Pass 6 serializes System constructs to canonical interchange JSON with sorted keys"
    - "The interchange JSON Schema validates System construct documents"
    - "Elaborating a valid System .tenor file produces correct interchange JSON"
  artifacts:
    - path: "crates/core/src/pass5_validate.rs"
      provides: "System structural validation"
      contains: "System"
    - path: "crates/core/src/pass6_serialize.rs"
      provides: "System interchange JSON serialization"
      contains: "System"
    - path: "docs/interchange-schema.json"
      provides: "JSON Schema definition for System construct"
      contains: "System"
  key_links:
    - from: "crates/core/src/pass5_validate.rs"
      to: "crates/core/src/ast.rs"
      via: "validates RawConstruct::System fields"
      pattern: "RawConstruct::System"
    - from: "crates/core/src/pass6_serialize.rs"
      to: "docs/interchange-schema.json"
      via: "serialized JSON must validate against schema"
      pattern: "System"
---

<objective>
Implement Pass 5 validation and Pass 6 serialization for the System construct, and extend the interchange JSON Schema to cover System documents.

Purpose: Pass 5 enforces all structural constraints from the spec (CFFP invariants). Pass 6 produces the canonical interchange JSON representation. The schema ensures consumers can validate System construct documents.

Output: Working elaboration pipeline that validates and serializes System constructs, plus an updated JSON Schema.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-system-construct/12-03-SUMMARY.md
@docs/TENOR.md
@crates/core/src/pass5_validate.rs
@crates/core/src/pass6_serialize.rs
@docs/interchange-schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Pass 5 System validation</name>
  <files>crates/core/src/pass5_validate.rs</files>
  <action>
Add System construct validation to Pass 5. Read the System constraints section from docs/TENOR.md (plan 02 output) for the authoritative list of structural checks.

The validation function (e.g., `validate_system()`) must check, at minimum:

1. **Member contract validation:**
   - Each member contract id references a file that was loaded during Pass 1 (import resolution)
   - No duplicate member contract ids within a System
   - At least one member contract declared (degenerate System with zero members is invalid)

2. **Shared persona validation:**
   - Each shared persona id exists as a declared Persona in every member contract it references
   - Each contract_id in a shared persona binding is a declared member of this System
   - Shared persona bindings reference at least 2 member contracts (sharing with one contract is meaningless)

3. **Cross-contract flow trigger validation:**
   - Source and target contract ids are declared members
   - Source flow exists in the source contract
   - Target flow exists in the target contract
   - No self-referential triggers (source_contract == target_contract AND source_flow == target_flow)

4. **Cross-contract entity relationship validation:**
   - Both contract ids are declared members
   - The entity_id exists in both contracts
   - The entity state machines are compatible (same states and transitions — or whatever compatibility rule the spec defines)

5. **No recursive System embedding:**
   - A System cannot contain another System as a member (if this is an invariant from CFFP)

Return `ElabError` with pass=5, construct_kind="System", construct_id=system_id, appropriate field names, file, line, and message for each validation failure.

Wire `validate_system()` into the main `validate()` function alongside `validate_entity()`, `validate_operation()`, etc.

Note: System validation may need access to constructs from member contracts. If the current Pass 5 architecture only sees the flat construct list from the root contract, this validation must work with whatever cross-file resolution Pass 1 provides. Read pass1_bundle.rs to understand what is available.

If member contracts are separate elaboration units, System validation may need a different approach (validate references exist as file paths, defer deep cross-contract checks to a System-level validation that runs after member contract elaboration). Follow whatever approach the spec defines.
  </action>
  <verify>
1. `cargo build -p tenor-core 2>&1 | grep -c "error"` — zero errors
2. `cargo test -p tenor-core` — existing tests still pass
  </verify>
  <done>
Pass 5 validates System constructs per all spec constraints. Validation errors produce properly structured ElabError with pass=5.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Pass 6 System serialization and extend JSON Schema</name>
  <files>
crates/core/src/pass6_serialize.rs
docs/interchange-schema.json
  </files>
  <action>
**Pass 6 Serialization (pass6_serialize.rs):**
Add a serialization arm for `RawConstruct::System` in the `serialize_construct()` function (or equivalent). The serialized JSON must:

1. Follow the interchange representation defined in the spec (plan 02 output)
2. Use `"kind": "System"` for the construct kind
3. Include all fields with lexicographically sorted keys (the pass6 convention)
4. Include `"provenance"` and `"tenor"` fields like all other constructs
5. Serialize member contracts as an array of objects with contract_id and path
6. Serialize shared personas, flow triggers, and entity relationships per the spec

Example expected structure (adjust based on actual spec):
```json
{
  "flow_triggers": [...],
  "id": "my_system",
  "kind": "System",
  "members": [...],
  "provenance": {"file": "system.tenor", "line": 1},
  "shared_entities": [...],
  "shared_personas": [...],
  "tenor": "1.0"
}
```

Ensure keys are in lex order within each object.

**JSON Schema (docs/interchange-schema.json):**
Add a `System` definition to `$defs` in the interchange schema. Follow the same pattern as the existing Fact, Entity, Rule, Persona, Operation, Flow definitions:

1. Add `{ "$ref": "#/$defs/System" }` to the `Construct.oneOf` array
2. Define `$defs/System` with:
   - `"kind": { "const": "System" }`
   - Required and optional properties matching the Pass 6 output
   - Proper descriptions for each field
   - `"additionalProperties": false`

Update the `constructs` array description to include System in the canonical ordering.

Verify the schema is valid JSON: `cat docs/interchange-schema.json | python3 -m json.tool`
  </action>
  <verify>
1. `cargo build --workspace 2>&1 | grep -c "error"` — zero errors
2. `cat docs/interchange-schema.json | python3 -m json.tool > /dev/null` — valid JSON
3. Create a simple system.tenor file and run `cargo run -p tenor-cli -- elaborate system.tenor` — produces JSON with "kind": "System"
4. `cargo run -p tenor-cli -- validate system_output.json` — validates against updated schema
  </verify>
  <done>
Pass 6 serializes System constructs to canonical interchange JSON with sorted keys. The interchange JSON Schema validates System construct documents. A valid System .tenor file elaborates to correct interchange JSON that passes schema validation.
  </done>
</task>

</tasks>

<verification>
- `cargo build --workspace` succeeds
- `cargo test --workspace` passes (all existing tests)
- A System .tenor file elaborates to valid interchange JSON
- The interchange JSON validates against the updated schema
- Pass 5 catches invalid System constructs with appropriate errors
</verification>

<success_criteria>
The full elaboration pipeline (Parse -> Index -> Validate -> Serialize) works end-to-end for System constructs. Valid System inputs produce correct interchange JSON; invalid inputs produce structured ElabError with pass=5.
</success_criteria>

<output>
After completion, create `.planning/phases/12-system-construct/12-04-SUMMARY.md`
</output>
