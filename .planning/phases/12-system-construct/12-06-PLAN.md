---
phase: 12-system-construct
plan: 06
type: execute
wave: 5
depends_on:
  - 12-04
files_modified:
  - crates/analyze/src/bundle.rs
  - crates/analyze/src/s4_authority.rs
  - crates/analyze/src/s6_flow_paths.rs
  - crates/analyze/src/lib.rs
  - crates/analyze/src/report.rs
  - crates/cli/src/main.rs
  - conformance/analysis/system_authority.tenor
  - conformance/analysis/system_flow_trigger.tenor
autonomous: true
requirements:
  - ANLZ-09
  - ANLZ-10
  - ANLZ-11

must_haves:
  truths:
    - "S4 authority topology analysis handles cross-contract personas within a System"
    - "S6 flow path enumeration handles cross-contract flow triggers within a System"
    - "tenor check on a System produces findings about cross-contract authority and flow paths"
  artifacts:
    - path: "crates/analyze/src/s4_authority.rs"
      provides: "Cross-contract persona authority analysis"
      contains: "cross_contract"
    - path: "crates/analyze/src/s6_flow_paths.rs"
      provides: "Cross-contract flow trigger path analysis"
      contains: "cross_contract"
    - path: "crates/analyze/src/bundle.rs"
      provides: "System construct deserialization for analysis"
      contains: "System"
  key_links:
    - from: "crates/analyze/src/bundle.rs"
      to: "docs/interchange-schema.json"
      via: "deserializes System construct from interchange JSON"
      pattern: "System"
    - from: "crates/cli/src/main.rs"
      to: "crates/analyze/src/lib.rs"
      via: "check command invokes analysis including System"
      pattern: "analyze"
---

<objective>
Extend the static analysis suite (S4 authority topology, S6 flow path enumeration) to handle cross-contract analysis within System constructs, and update the `tenor check` CLI output.

Purpose: When a System declares shared personas across member contracts, S4 must analyze the cross-contract authority topology — which personas can perform operations in which contracts. When a System declares cross-contract flow triggers, S6 must trace flow paths that span contract boundaries. These analyses are the key value proposition of the System construct for contract authors.

Output: Extended S4 and S6 analyses, updated bundle deserialization, and updated check CLI output with cross-contract findings.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-system-construct/12-04-SUMMARY.md
@crates/analyze/src/lib.rs
@crates/analyze/src/bundle.rs
@crates/analyze/src/s4_authority.rs
@crates/analyze/src/s6_flow_paths.rs
@crates/analyze/src/report.rs
@crates/cli/src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend bundle deserialization and S4/S6 for cross-contract analysis</name>
  <files>
crates/analyze/src/bundle.rs
crates/analyze/src/s4_authority.rs
crates/analyze/src/s6_flow_paths.rs
crates/analyze/src/report.rs
crates/analyze/src/lib.rs
  </files>
  <action>
**bundle.rs — System deserialization:**
Add an `AnalysisSystem` struct to bundle.rs with fields matching the interchange representation:
```rust
pub struct AnalysisSystem {
    pub id: String,
    pub members: Vec<SystemMember>,
    pub shared_personas: Vec<SharedPersona>,
    pub flow_triggers: Vec<FlowTrigger>,
    pub shared_entities: Vec<SharedEntity>,
}
```
Add `#[derive(Debug, Clone, Serialize)]` as with other analysis types.

Update `AnalysisBundle` to include `pub systems: Vec<AnalysisSystem>`.
Update `AnalysisBundle::from_interchange()` to extract System constructs from the interchange JSON (match on `"kind": "System"`).

**s4_authority.rs — Cross-contract authority (ANLZ-09):**
Extend `analyze_authority()` to handle System-level shared persona analysis:

1. If the bundle contains System constructs, for each System:
   - For each shared persona binding, determine which operations across all member contracts this persona can invoke
   - Add cross-contract authority entries to the result (persona P can invoke operation O in contract C)
2. Add a `cross_contract_authorities` field to `S4Result`:
   ```rust
   pub cross_contract_authorities: Vec<CrossContractAuthority>,
   ```
   where `CrossContractAuthority` captures persona_id, contract_id, entity_id, state, operation_id

3. Generate findings:
   - Info: "Persona 'X' has authority across N contracts: [contract_ids]"
   - Warning: "Persona 'X' can invoke operations in contract A but has no authority in contract B" (shared persona with asymmetric authority)

**s6_flow_paths.rs — Cross-contract flow triggers (ANLZ-10):**
Extend `analyze_flow_paths()` to handle cross-contract flow trigger analysis:

1. If the bundle contains System constructs, for each System:
   - For each flow trigger (source_contract, source_flow -> target_contract, target_flow):
     - Extend path enumeration to follow the trigger across contract boundaries
     - A path that reaches the end of source_flow continues into target_flow
2. Add a `cross_contract_paths` field to `S6Result`:
   ```rust
   pub cross_contract_paths: Vec<CrossContractFlowPath>,
   ```
   where `CrossContractFlowPath` captures source_contract, source_flow, target_contract, target_flow, and the combined path

3. Generate findings:
   - Info: "Cross-contract flow trigger: contract_a.flow_x -> contract_b.flow_y"
   - Warning: If a trigger creates a cycle across contracts

**report.rs — Cross-contract findings (ANLZ-11):**
Update `extract_findings()` to include cross-contract findings from S4 and S6. Use a new analysis identifier like "s4_cross" and "s6_cross" to distinguish from single-contract findings.

**lib.rs:**
Update re-exports if new public types are added (AnalysisSystem, CrossContractAuthority, CrossContractFlowPath).
  </action>
  <verify>
1. `cargo build --workspace 2>&1 | grep -c "error"` — zero errors
2. `cargo test -p tenor-analyze` — existing analysis tests still pass
3. `cargo test --workspace` — all tests pass
  </verify>
  <done>
S4 authority analysis detects cross-contract persona authority within Systems. S6 flow path analysis traces cross-contract flow triggers. The analysis bundle deserializes System constructs. New findings are generated for cross-contract patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tenor check CLI output and add analysis fixtures</name>
  <files>
crates/cli/src/main.rs
conformance/analysis/system_authority.tenor
conformance/analysis/system_flow_trigger.tenor
  </files>
  <action>
**CLI check output (main.rs):**
Update `cmd_check()` to display cross-contract analysis results when a System is present:

In the text output format, add sections after the existing S4 and S6 output:
```
  Cross-Contract Authority (S4): N shared personas, M cross-contract authority entries
  Cross-Contract Flow Paths (S6): N cross-contract triggers, M cross-contract paths
```

In the JSON output format, the S4Result and S6Result structs already serialize to JSON (they derive Serialize). The new fields (cross_contract_authorities, cross_contract_paths) will appear automatically.

**Analysis fixtures:**
Create test .tenor files for analysis integration testing:

1. `conformance/analysis/system_authority.tenor`: A System with shared personas across member contracts. Running `tenor check system_authority.tenor` should produce cross-contract authority findings.

2. `conformance/analysis/system_flow_trigger.tenor`: A System with cross-contract flow triggers. Running `tenor check system_flow_trigger.tenor` should produce cross-contract flow path findings.

These are not formal conformance fixtures (no .expected.json) — they are reference .tenor files used for manual verification and can be used in future test automation.

Verify:
- `cargo run -p tenor-cli -- check conformance/analysis/system_authority.tenor` produces output mentioning cross-contract authority
- `cargo run -p tenor-cli -- check conformance/analysis/system_flow_trigger.tenor` produces output mentioning cross-contract flow triggers
  </action>
  <verify>
1. `cargo run -p tenor-cli -- check conformance/analysis/system_authority.tenor --output text` — shows cross-contract authority output
2. `cargo run -p tenor-cli -- check conformance/analysis/system_flow_trigger.tenor --output text` — shows cross-contract flow path output
3. `cargo run -p tenor-cli -- check conformance/analysis/system_authority.tenor --output json | python3 -m json.tool` — valid JSON with cross-contract fields
4. `cargo test --workspace` — all tests pass
  </verify>
  <done>
`tenor check` on a System .tenor file produces cross-contract authority topology findings and cross-contract flow path findings in both text and JSON output formats.
  </done>
</task>

</tasks>

<verification>
- `cargo build --workspace` succeeds
- `cargo test --workspace` passes
- `tenor check` on System fixtures produces cross-contract findings
- S4 and S6 handle Systems without breaking single-contract analysis
</verification>

<success_criteria>
Running `tenor check` on a System .tenor file reports cross-contract authority topology findings (S4 extended) and cross-contract flow path findings (S6 extended). Both text and JSON output formats include the new cross-contract analysis results.
</success_criteria>

<output>
After completion, create `.planning/phases/12-system-construct/12-06-SUMMARY.md`
</output>
