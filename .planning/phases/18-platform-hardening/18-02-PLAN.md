---
phase: 18-platform-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/core/src/pass5_validate.rs
  - crates/core/src/pass3_types.rs
  - crates/core/src/pass4_typecheck.rs
  - crates/core/src/pass1_bundle.rs
  - crates/core/src/pass6_serialize.rs
autonomous: true
requirements:
  - HARD-03
  - HARD-22
  - HARD-23
must_haves:
  truths:
    - "No expect() calls remain in pass5_validate.rs or pass3_types.rs -- all panicking paths replaced with Result returns"
    - "Import cycle detection uses HashSet for O(1) membership tests instead of Vec::contains"
    - "pass6_serialize.rs uses fewer string allocations (Cow<str> or string reuse where possible)"
  artifacts:
    - path: "crates/core/src/pass5_validate.rs"
      provides: "Panic-free structural validation"
      contains: "ElabError"
    - path: "crates/core/src/pass3_types.rs"
      provides: "Panic-free type cycle detection"
      contains: "ElabError"
    - path: "crates/core/src/pass1_bundle.rs"
      provides: "HashSet-based cycle detection"
      contains: "HashSet"
  key_links:
    - from: "crates/core/src/pass5_validate.rs"
      to: "crates/core/src/error.rs"
      via: "ElabError returns replacing expect()"
      pattern: "ElabError::new"
---

<objective>
Harden tenor-core by replacing all expect()/unwrap() calls with proper error propagation, improving cycle detection performance, and reducing string allocations in serialization.

Purpose: Eliminate panics on user input (pass5_validate.rs:842, pass5_validate.rs:1343, pass3_types.rs:49/55/98, pass4_typecheck.rs:179/183), improve import cycle detection from O(n) to O(1), and reduce WASM-impacting string allocations in pass6.

Output: Panic-free core passes, faster cycle detection, leaner serialization.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/codebase/CONCERNS.md
@crates/core/src/pass5_validate.rs
@crates/core/src/pass3_types.rs
@crates/core/src/pass4_typecheck.rs
@crates/core/src/pass1_bundle.rs
@crates/core/src/pass6_serialize.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace all expect() calls with proper ElabError returns</name>
  <files>
    crates/core/src/pass5_validate.rs
    crates/core/src/pass3_types.rs
    crates/core/src/pass4_typecheck.rs
  </files>
  <action>
Replace every `.expect()` and `.unwrap()` call in these three files with proper `Result` error propagation:

**pass5_validate.rs** (2 known expect sites):
- Line ~842: `.expect(...)` -- replace with `.ok_or_else(|| ElabError::new(...))` returning a descriptive error about the failed invariant
- Line ~1343: `.expect(...)` -- same treatment
- Search for any additional `.expect()` or `.unwrap()` calls and replace them all

**pass3_types.rs** (3 known expect sites):
- Lines ~49, ~55, ~98: `.expect("name must be in in_stack...")` in cycle detection DFS -- replace with `.ok_or_else(|| ElabError::new(3, "TypeDecl", ...))` returning a proper type cycle error

**pass4_typecheck.rs** (2 known expect sites):
- Lines ~179, ~183: `.min().expect(...)` and `.max().expect(...)` on a 4-element products array -- these are mathematically safe (array is always 4 elements), but replace with defensive code: either use `unwrap_or` with a comment, or return an internal error

For each replacement:
- Use `ElabError::new()` with the correct pass number (3, 4, or 5)
- Include a descriptive message explaining what invariant was violated
- Propagate with `?` operator
- If the function doesn't already return `Result`, check if its callers handle errors (they should, since the pipeline uses Result throughout)

Run `cargo test -p tenor-core` after each file to catch breakage incrementally.
  </action>
  <verify>
    `cargo fmt --all` passes. `cargo build -p tenor-core` succeeds. `cargo test -p tenor-core` passes. `grep -rn 'expect(' crates/core/src/pass5_validate.rs crates/core/src/pass3_types.rs` returns zero results (no expect calls remain). `cargo clippy -p tenor-core -- -D warnings` clean.
  </verify>
  <done>Zero expect() or unwrap() calls remain in pass5_validate.rs, pass3_types.rs, and pass4_typecheck.rs. All return proper ElabError on invariant violations.</done>
</task>

<task type="auto">
  <name>Task 2: HashSet cycle detection + pass6 string allocation reduction</name>
  <files>
    crates/core/src/pass1_bundle.rs
    crates/core/src/pass6_serialize.rs
  </files>
  <action>
**pass1_bundle.rs -- HashSet cycle detection (HARD-22):**

In `pass1_bundle.rs`, find the import cycle detection code that uses `stack.contains(&canon)` (lines ~120 and ~217). The `stack` is a `Vec<PathBuf>`.

Add a parallel `HashSet<PathBuf>` called `visited` or `stack_set`:
- Initialize alongside the Vec stack
- Insert into both when pushing a path onto the stack
- Remove from the HashSet when popping (if the stack is used as a DFS stack)
- Replace `stack.contains(&canon)` with `stack_set.contains(&canon)` for O(1) membership test
- Keep the Vec for ordered error message reporting (the cycle path)

**pass6_serialize.rs -- String allocation reduction (HARD-23):**

Audit `crates/core/src/pass6_serialize.rs` (1,044 lines) for excessive owned `String` allocations. Target the following patterns:

1. Replace `format!("...")` calls that produce constant strings with `&str` or `Cow<'_, str>` where the result flows into a `serde_json::Value::String(...)`. Since `serde_json::Value::String` requires an owned `String`, focus instead on:
   - Eliminating intermediate `String` allocations that are immediately consumed
   - Reusing string buffers where the same key is serialized across many constructs
   - Using `.to_string()` on string literals only once (e.g., for "kind", "Fact", "Bundle" etc.)

2. For repeated field names like "kind", "id", "provenance", "file", "line" that appear in every construct serialization, consider extracting them as `static` string constants to avoid repeated allocations.

3. Look for patterns like `format!("{}", x)` where `x` is already a `&str` -- replace with `x.to_string()`.

This is an optimization, not a correctness change. Be conservative -- only change allocations that are clearly wasteful. Don't refactor the entire file.
  </action>
  <verify>
    `cargo fmt --all` passes. `cargo build --workspace` succeeds. `cargo test --workspace` passes. `cargo run -p tenor-cli -- test conformance` passes (all 73 tests -- serialization output must not change). `cargo clippy --workspace -- -D warnings` clean.
  </verify>
  <done>Import cycle detection uses HashSet for O(1) membership. pass6_serialize.rs has measurably fewer string allocations (static key constants, eliminated redundant format! calls).</done>
</task>

</tasks>

<verification>
1. `cargo fmt --all` -- formatting clean
2. `cargo build --workspace` compiles cleanly
3. `cargo test --workspace` -- all tests pass
4. `cargo run -p tenor-cli -- test conformance` -- all 73 tests pass (critical: serialization output unchanged)
5. `cargo clippy --workspace -- -D warnings` -- no warnings
6. `grep -rn 'expect(' crates/core/src/pass5_validate.rs crates/core/src/pass3_types.rs` -- zero results
7. `grep -n 'HashSet' crates/core/src/pass1_bundle.rs` -- HashSet used for cycle detection
</verification>

<success_criteria>
- All expect() in pass5_validate.rs and pass3_types.rs replaced with ElabError returns
- pass1_bundle.rs uses HashSet for O(1) cycle detection
- pass6_serialize.rs has reduced string allocations
- All 508+ existing tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/18-platform-hardening/18-02-SUMMARY.md`
</output>
