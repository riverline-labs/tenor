---
phase: 18-platform-hardening
plan: 07
type: execute
wave: 2
depends_on:
  - "18-01"
files_modified:
  - crates/cli/Cargo.toml
  - crates/cli/src/explain.rs
autonomous: true
requirements:
  - HARD-02
must_haves:
  truths:
    - "explain.rs uses typed interchange structs from tenor-interchange instead of raw serde_json::Value traversal"
    - "Silent fallbacks (unwrap_or_default, unwrap_or('')) replaced with explicit handling or logged warnings"
    - "If an interchange field is renamed, explain.rs will produce a compile error rather than silently omitting the section"
  artifacts:
    - path: "crates/cli/src/explain.rs"
      provides: "Typed explain implementation using tenor-interchange types"
      contains: "tenor_interchange"
  key_links:
    - from: "crates/cli/src/explain.rs"
      to: "crates/interchange/src/types.rs"
      via: "use tenor_interchange::"
      pattern: "tenor_interchange"
---

<objective>
Rewrite explain.rs to use typed interchange structs from the shared tenor-interchange crate instead of untyped JSON traversal with 75+ silent fallbacks.

Purpose: The current explain.rs (1,478 lines) traverses interchange JSON using raw `.get()`, `.as_str()`, `.as_array()` with `.unwrap_or("")` fallbacks throughout. Any interchange format change silently breaks sections. Using typed structs makes breakage a compile error instead of a silent omission.

Output: Typed explain.rs that catches interchange changes at compile time.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/codebase/CONCERNS.md
@.planning/phases/18-platform-hardening/18-01-SUMMARY.md
@crates/cli/src/explain.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite explain.rs to use typed interchange structs</name>
  <files>
    crates/cli/Cargo.toml
    crates/cli/src/explain.rs
  </files>
  <action>
Refactor `crates/cli/src/explain.rs` (1,478 lines) to use typed interchange structs from `tenor-interchange`:

1. **Add dependency**: In `crates/cli/Cargo.toml`, add `tenor-interchange = { path = "../interchange" }`.

2. **Replace entry point**: The `explain()` function currently takes `&serde_json::Value` (the interchange bundle). Change it to first deserialize into `tenor_interchange::InterchangeBundle` using `tenor_interchange::from_interchange()`, then pass the typed struct to the rendering functions.

3. **Refactor section renderers**: For each major section in explain.rs (facts, entities, rules, operations, flows, personas, systems), replace the raw JSON traversal with struct field access:

   **Before (typical pattern):**
   ```rust
   let name = construct.get("id").and_then(|v| v.as_str()).unwrap_or("");
   let states = construct.get("states").and_then(|v| v.as_array()).unwrap_or(&vec![]);
   ```

   **After:**
   ```rust
   let name = &entity.id;
   let states = &entity.states;
   ```

4. **Handle Optional fields**: Where the current code uses `.unwrap_or("")` or `.unwrap_or_default()` to handle optional fields, use Rust's `Option` ergonomics:
   - `if let Some(field) = &construct.optional_field { ... }`
   - `construct.optional_field.as_deref().unwrap_or("N/A")` for display purposes

5. **Preserve output format**: The explain output format (both Terminal and Markdown) MUST remain identical. This is a pure internal refactoring -- external behavior is unchanged. Run the existing explain tests to verify.

6. **Error handling**: Replace silent fallbacks with explicit handling. If a field that should exist is missing, either:
   - Skip the section with a visible `[section unavailable]` marker (better than silent omission)
   - Or return an error if the field is required by the interchange schema

7. **Incremental approach**: Don't try to rewrite all 1,478 lines at once. Start with the top-level dispatch and the simplest section (e.g., facts), verify tests pass, then continue with entities, rules, operations, flows, personas, systems.

IMPORTANT: The `ExplainFormat::Terminal` and `ExplainFormat::Markdown` output formats must produce identical output to the current implementation. Do NOT change any user-visible output.
  </action>
  <verify>
    `cargo fmt --all` passes. `cargo build --workspace` succeeds. `cargo test --workspace` passes. The existing explain tests in `crates/cli/src/explain.rs` (3 tests) pass. Run `cargo run -p tenor-cli -- explain domains/saas/saas.tenor` and `cargo run -p tenor-cli -- explain domains/healthcare/prior_auth.tenor` -- output should be unchanged. `cargo clippy --workspace -- -D warnings` clean. `grep -c 'unwrap_or' crates/cli/src/explain.rs` -- significantly reduced from current count.
  </verify>
  <done>explain.rs uses typed tenor-interchange structs. Silent fallbacks eliminated or made explicit. Interchange format changes will cause compile errors, not silent output omission. All existing tests pass with identical output.</done>
</task>

</tasks>

<verification>
1. `cargo fmt --all` -- formatting clean
2. `cargo build --workspace` compiles cleanly
3. `cargo test --workspace` -- all tests pass
4. `cargo run -p tenor-cli -- test conformance` -- passes
5. `cargo clippy --workspace -- -D warnings` -- no warnings
6. Explain output for domain contracts is unchanged (diff check)
7. `grep -c 'as_str()' crates/cli/src/explain.rs` -- significantly reduced
8. `grep -c 'tenor_interchange' crates/cli/src/explain.rs` -- present (uses typed imports)
</verification>

<success_criteria>
- explain.rs uses typed structs from tenor-interchange
- No raw serde_json::Value traversal for interchange data
- Silent fallbacks (unwrap_or) eliminated or made explicit
- Output format identical to current implementation
- All existing tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/18-platform-hardening/18-07-SUMMARY.md`
</output>
