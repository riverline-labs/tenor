---
phase: 18-platform-hardening
plan: 09
type: execute
wave: 3
depends_on:
  - "18-05"
  - "18-07"
files_modified:
  - crates/lsp/src/lib.rs
  - crates/lsp/src/navigation.rs
  - crates/lsp/src/completion.rs
  - crates/lsp/src/hover.rs
  - crates/lsp/src/semantic_tokens.rs
  - crates/lsp/tests/lsp_tests.rs
  - crates/lsp/Cargo.toml
  - crates/cli/tests/cli_integration.rs
  - crates/cli/src/explain.rs
  - conformance/eval/positive/flow_error_escalate.tenor
  - conformance/eval/positive/flow_error_escalate.facts.json
  - conformance/eval/positive/flow_error_escalate.verdicts.json
  - crates/eval/tests/conformance.rs
  - crates/analyze/tests/analysis_tests.rs
  - crates/analyze/src/s3a_admissibility.rs
  - docs/system-contract-coordinator.md
autonomous: true
requirements:
  - HARD-12
  - HARD-14
  - HARD-20
  - HARD-24
  - HARD-25
  - HARD-26
must_haves:
  truths:
    - "LSP crate has unit tests covering navigation (go-to-definition) and completion correctness"
    - "tenor diff CLI is tested end-to-end in cli_integration.rs"
    - "Flow error-path conformance fixtures exist (FlowError, EntityNotFound, FailureHandler::Escalate)"
    - "explain.rs Markdown format output has dedicated test assertions"
    - "S3a admissibility has negative test cases that verify findings are reported"
    - "SystemContract coordinator design is documented"
  artifacts:
    - path: "crates/lsp/tests/lsp_tests.rs"
      provides: "LSP unit tests for navigation and completion"
      min_lines: 50
    - path: "crates/cli/tests/cli_integration.rs"
      provides: "End-to-end diff tests"
      contains: "diff"
    - path: "conformance/eval/positive/flow_error_escalate.tenor"
      provides: "Flow error-path test fixture"
  key_links:
    - from: "crates/lsp/tests/lsp_tests.rs"
      to: "crates/lsp/src/navigation.rs"
      via: "Tests navigation functions directly"
      pattern: "navigation"
    - from: "crates/eval/tests/conformance.rs"
      to: "conformance/eval/positive/"
      via: "Flow error fixtures loaded by test runner"
      pattern: "flow_error"
---

<objective>
Close all test coverage gaps and document the SystemContract coordinator design: LSP unit tests, diff CLI e2e tests, flow error-path conformance fixtures, explain Markdown tests, S3a negative tests, and SystemContract design doc.

Purpose: The codebase mapping identified six specific test gaps and one missing design document. Closing these gaps prevents silent regressions in user-facing features (LSP, diff, explain) and verifies error-handling paths that currently rely on panic! assertions.

Output: Comprehensive test coverage across all identified gaps plus SystemContract coordinator design.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/TESTING.md
@crates/lsp/src/navigation.rs
@crates/lsp/src/completion.rs
@crates/cli/tests/cli_integration.rs
@crates/cli/src/explain.rs
@crates/eval/tests/conformance.rs
@crates/analyze/tests/analysis_tests.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: LSP unit tests and diff CLI e2e tests</name>
  <files>
    crates/lsp/tests/lsp_tests.rs
    crates/lsp/Cargo.toml
    crates/cli/tests/cli_integration.rs
  </files>
  <action>
**HARD-14 -- LSP unit tests:**

Create `crates/lsp/tests/lsp_tests.rs` with unit tests covering navigation and completion:

1. **Navigation tests** (go-to-definition, references, document symbols):
   - Test that navigating to a fact reference resolves to the fact declaration
   - Test that navigating to an entity reference in an operation resolves to the entity definition
   - Test that "find all references" for a fact returns all constructs that reference it
   - Test document symbols returns the correct list of construct names and kinds

   The navigation module in `crates/lsp/src/navigation.rs` has a `ProjectIndex` that can be built from files. Create test fixtures as temp files, build a ProjectIndex, and call the navigation functions directly (not via LSP protocol).

2. **Completion tests**:
   - Test that typing after `entity ` suggests entity names
   - Test that typing inside a rule body suggests fact names
   - Test that keyword completion includes all DSL keywords

   The completion module in `crates/lsp/src/completion.rs` should have functions that can be called directly with a document and position.

3. **Dev dependencies**: Add `tempfile = "3"` and `serde_json = { workspace = true }` to `crates/lsp/Cargo.toml` `[dev-dependencies]` if not already present.

4. **Test infrastructure**: Create a helper function that elaborates a `.tenor` string and builds a ProjectIndex from it, for use across all LSP tests.

**HARD-24 -- diff CLI e2e tests:**

In `crates/cli/tests/cli_integration.rs`, add end-to-end tests for the `tenor diff` subcommand:

1. Test `tenor diff <bundle1.json> <bundle2.json>` with identical bundles -- should exit 0 with "no differences" or empty diff
2. Test `tenor diff <bundle1.json> <bundle2.json>` with a fact added -- should exit 0 and show the addition
3. Test `tenor diff <bundle1.json> <bundle2.json> --breaking` -- should exit 0 for non-breaking changes, exit 1 for breaking changes
4. Test `tenor diff` with invalid file -- should exit 1 with error message

Create the test bundles as temp files using the existing `TempDir` pattern from other CLI integration tests. You can elaborate small `.tenor` fixtures to get valid bundles, or use `serde_json::json!()` to construct minimal valid bundles.
  </action>
  <verify>
    `cargo fmt --all` passes. `cargo test -p tenor-lsp` passes with new tests. `cargo test -p tenor-cli --test cli_integration` passes with new diff tests. `cargo clippy --workspace -- -D warnings` clean.
  </verify>
  <done>LSP crate has unit tests for navigation and completion. tenor diff has 4+ e2e CLI tests. All new tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Flow error fixtures, explain Markdown tests, S3a negatives, SystemContract design</name>
  <files>
    conformance/eval/positive/flow_error_escalate.tenor
    conformance/eval/positive/flow_error_escalate.facts.json
    conformance/eval/positive/flow_error_escalate.verdicts.json
    crates/eval/tests/conformance.rs
    crates/cli/src/explain.rs
    crates/analyze/tests/analysis_tests.rs
    crates/analyze/src/s3a_admissibility.rs
    docs/system-contract-coordinator.md
  </files>
  <action>
**HARD-20 -- Flow error-path conformance fixtures:**

Create file-based conformance fixtures that exercise flow error handling (currently only tested by inline unit tests with panic! assertions):

1. Create `conformance/eval/positive/flow_error_escalate.tenor` -- a contract with a flow that triggers a FailureHandler::Escalate path. The flow should have a step that fails (e.g., operation on an entity not in the required state) with an `on_failure: escalate` handler.

2. Create matching `.facts.json` and `.verdicts.json` files. The verdicts should reflect the escalation (flow aborted, appropriate error recorded).

3. If the evaluator returns an error (not a verdict) for escalation, create the fixture in a `conformance/eval/negative/` directory instead with an `.expected-error.json` file.

4. Add a `#[test]` function in `crates/eval/tests/conformance.rs` that runs the new fixture.

5. If possible, also create a fixture for `OperationError::EntityNotFound` -- an operation referencing a non-existent entity.

**HARD-25 -- explain.rs Markdown format tests:**

In `crates/cli/src/explain.rs`, add tests for the Markdown format output:

1. Add at least 2 `#[test]` functions that test `ExplainFormat::Markdown` output:
   - Test that Markdown headings (`##`, `###`) are produced for section headers
   - Test that Markdown formatting (bold, code blocks, lists) is used where Terminal format uses ANSI
   - Compare a known bundle's Markdown output against expected strings

**HARD-26 -- S3a admissibility negative tests:**

In `crates/analyze/tests/analysis_tests.rs`, add negative test cases for S3a admissibility:

1. Create or use a fixture where an operation references an entity state that doesn't exist in the `from` state -- S3a should report a finding about unreachable operations.
2. Create a fixture where an entity has states that no operation can reach -- S3a should report dead state findings.
3. Assert that `report.findings` contains the expected findings with correct severity.

If needed, create new `.tenor` fixtures in `conformance/analysis/` for these tests.

**HARD-12 -- SystemContract coordinator design:**

Create `docs/system-contract-coordinator.md` with the design for cross-contract triggers and shared entity state:

1. **Problem statement**: System construct is elaborated and validated, but no runtime exists for cross-contract execution.
2. **Coordinator architecture**: A `SystemRuntime` that manages multiple `Contract` instances, dispatches cross-contract triggers, and maintains shared entity state consistency.
3. **Trigger dispatch**: When an operation in Contract A fires a trigger, the coordinator identifies the target operation in Contract B and invokes it.
4. **Shared entity state**: Entities referenced by multiple contracts via `shared_entities` in the System construct need a single source of truth.
5. **Persona mapping**: The System's `shared_personas` maps personas across contract boundaries.
6. **API sketch**: Key types and function signatures (Rust pseudocode).
7. **Implementation phases**: What can be built in Phase 25 (Multi-party Contract Execution).

This is a design document, not implementation code. Keep it focused and actionable.
  </action>
  <verify>
    `cargo fmt --all` passes. `cargo test --workspace` passes with all new tests. `cargo run -p tenor-cli -- test conformance` passes. New eval conformance fixtures pass. New S3a negative tests assert findings. `docs/system-contract-coordinator.md` exists and is well-structured. `cargo clippy --workspace -- -D warnings` clean.
  </verify>
  <done>Flow error-path conformance fixtures added. Explain Markdown format tested. S3a has negative test cases. SystemContract coordinator design documented. All tests pass.</done>
</task>

</tasks>

<verification>
1. `cargo fmt --all` -- formatting clean
2. `cargo build --workspace` compiles cleanly
3. `cargo test --workspace` -- all tests pass including new ones
4. `cargo run -p tenor-cli -- test conformance` -- passes
5. `cargo clippy --workspace -- -D warnings` -- no warnings
6. `cargo test -p tenor-lsp` -- LSP tests pass
7. `ls conformance/eval/positive/flow_error*` -- fixtures exist
8. `ls docs/system-contract-coordinator.md` -- design doc exists
</verification>

<success_criteria>
- LSP has unit tests for navigation and completion
- diff CLI has 4+ e2e integration tests
- Flow error-path conformance fixtures exercise escalation/entity-not-found
- explain.rs Markdown format has dedicated tests
- S3a has negative test cases asserting findings
- SystemContract coordinator design documented
- All 508+ existing tests pass plus new tests
</success_criteria>

<output>
After completion, create `.planning/phases/18-platform-hardening/18-09-SUMMARY.md`
</output>
