---
phase: 18-platform-hardening
plan: 08
type: execute
wave: 3
depends_on:
  - "18-06"
files_modified:
  - crates/cli/src/serve.rs
  - crates/cli/Cargo.toml
autonomous: true
requirements:
  - HARD-10
  - HARD-11
must_haves:
  truths:
    - "Elaborate endpoint validates user content before writing to temp files (input size, import injection, encoding)"
    - "All HTTP endpoints have CORS headers configured"
    - "Rate limiting is applied to all endpoints"
    - "Optional API key authentication can be enabled via environment variable"
  artifacts:
    - path: "crates/cli/src/serve.rs"
      provides: "Security-hardened HTTP server with auth, CORS, rate limiting, and input validation"
      contains: "CorsLayer"
  key_links:
    - from: "crates/cli/src/serve.rs"
      to: "crates/core/src/elaborate.rs"
      via: "Validated input passed to elaborate()"
      pattern: "elaborate"
---

<objective>
Add security hardening to the HTTP server: input validation on the elaborate endpoint, CORS configuration, rate limiting, and optional API key authentication.

Purpose: The tenor serve HTTP API currently has no security measures -- any caller can elaborate arbitrary content, evaluate contracts, and consume CPU without limit. These hardening measures are prerequisites for the Hosted Evaluator Service (Phase 22) and protect even local development use from accidental exposure.

Output: Security-hardened serve.rs with input validation, CORS, rate limiting, and optional auth.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/codebase/CONCERNS.md
@.planning/phases/18-platform-hardening/18-06-SUMMARY.md
@crates/cli/src/serve.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Input validation on elaborate endpoint</name>
  <files>
    crates/cli/src/serve.rs
  </files>
  <action>
Add input validation to the `/elaborate` POST handler before writing user content to temp files:

1. **Content size validation**: Reject requests where the `source` field exceeds a reasonable size limit (e.g., 1MB for source text -- distinct from the 10MB body limit). Return 400 with `{"error": "source content exceeds maximum size"}`.

2. **Encoding validation**: Ensure the source content is valid UTF-8 (it should be since it comes from JSON, but validate explicitly). Reject non-UTF-8 with 400.

3. **Import injection prevention**: Before writing to temp file, scan the source for `import` directives. If imports reference paths that would escape the temp directory (e.g., `import "../../../etc/passwd"`), reject with 400 and `{"error": "import paths must not escape sandbox"}`. Note: pass1_bundle.rs already has sandbox checking after canonicalization, but we want to fail-fast before even writing to disk.

4. **Filename sanitization**: If the optional `filename` field is provided, validate it contains no path separators (`/`, `\`) and no `..` components. Default to `source.tenor` if not provided or invalid.

5. **Null byte rejection**: Reject source content containing null bytes (`\0`) which could cause issues with filesystem operations.

All validation should happen BEFORE the temp file is created. Return clear 400 error messages for each validation failure.
  </action>
  <verify>
    `cargo fmt --all` passes. `cargo build --workspace` succeeds. `cargo test --workspace` passes. Serve integration tests pass. Add at least 2 new tests: one that sends oversized source (should get 400), one with path traversal in filename (should get 400).
  </verify>
  <done>Elaborate endpoint validates source content size, encoding, import paths, and filename before writing to disk. Clear 400 errors for each validation failure.</done>
</task>

<task type="auto">
  <name>Task 2: Add CORS, rate limiting, and optional API key auth</name>
  <files>
    crates/cli/src/serve.rs
    crates/cli/Cargo.toml
  </files>
  <action>
Add security middleware layers to the axum server:

**CORS (Cross-Origin Resource Sharing):**

Add `tower-http` dependency to `crates/cli/Cargo.toml`: `tower-http = { version = "0.6", features = ["cors"] }` (and to workspace dependencies in root Cargo.toml).

Configure CORS as an axum layer:
```rust
use tower_http::cors::{CorsLayer, Any};

let cors = CorsLayer::new()
    .allow_origin(Any)  // Default: permissive for local dev
    .allow_methods([Method::GET, Method::POST])
    .allow_headers(Any);

let app = Router::new()
    // ... routes ...
    .layer(cors);
```

For local dev, `allow_origin(Any)` is appropriate. The Hosted Evaluator Service (Phase 22) will tighten this.

**Rate Limiting:**

Implement a simple in-memory rate limiter (no external dependency needed for basic functionality):

1. Create a `RateLimiter` struct using `Arc<Mutex<HashMap<IpAddr, (u64, Instant)>>>` that tracks request count per IP per window.
2. Default: 60 requests per minute per IP (configurable via `--rate-limit` CLI flag or `TENOR_RATE_LIMIT` env var).
3. Implement as axum middleware that checks the rate before routing.
4. Return 429 Too Many Requests with `{"error": "rate limit exceeded", "retry_after": N}` when exceeded.

Alternatively, use `tower::limit::RateLimitLayer` for simpler implementation if it fits the use case. However, the tower rate limiter is global (not per-IP). For per-IP limiting, a custom middleware is better.

**Optional API Key Authentication:**

1. If `TENOR_API_KEY` environment variable is set, require all requests to include `Authorization: Bearer <key>` or `X-API-Key: <key>` header.
2. If the env var is NOT set, no authentication is required (local dev mode).
3. Unauthenticated requests when auth is enabled return 401 with `{"error": "authentication required"}`.
4. Invalid API key returns 403 with `{"error": "invalid API key"}`.
5. The `/health` endpoint should be exempt from authentication (for load balancer health checks).

Add as axum middleware/layer in the router setup.
  </action>
  <verify>
    `cargo fmt --all` passes. `cargo build --workspace` succeeds. `cargo test --workspace` passes. Serve integration tests pass (they don't set TENOR_API_KEY, so auth is disabled). Manually test: `TENOR_API_KEY=test cargo run -p tenor-cli -- serve --port 9999 &` then `curl -v localhost:9999/health` (should succeed) and `curl -v localhost:9999/contracts` (should get 401). `cargo clippy --workspace -- -D warnings` clean.
  </verify>
  <done>CORS headers on all responses. Per-IP rate limiting (60 req/min default). Optional API key auth via TENOR_API_KEY env var. /health exempt from auth. All existing tests pass.</done>
</task>

</tasks>

<verification>
1. `cargo fmt --all` -- formatting clean
2. `cargo build --workspace` compiles cleanly
3. `cargo test --workspace` -- all tests pass
4. `cargo run -p tenor-cli -- test conformance` -- passes
5. `cargo clippy --workspace -- -D warnings` -- no warnings
6. Elaborate endpoint rejects: oversized source, path traversal in filename, import escape attempts
7. CORS headers present on responses
8. Rate limiting returns 429 after burst
9. Auth returns 401 when TENOR_API_KEY set and no key provided
</verification>

<success_criteria>
- Elaborate endpoint validates all user input before disk operations
- CORS configured on all endpoints
- Rate limiting prevents abuse (60 req/min/IP default)
- Optional API key auth via env var
- /health exempt from auth
- All existing tests pass (auth disabled by default)
</success_criteria>

<output>
After completion, create `.planning/phases/18-platform-hardening/18-08-SUMMARY.md`
</output>
