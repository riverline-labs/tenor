---
phase: 18-platform-hardening
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/cli/src/ambiguity/mod.rs
  - crates/cli/src/ambiguity/fixtures.rs
  - crates/cli/src/runner.rs
  - crates/cli/src/manifest.rs
  - crates/lsp/src/semantic_tokens.rs
  - crates/lsp/src/navigation.rs
  - crates/analyze/src/s6_flow_paths.rs
  - crates/analyze/src/lib.rs
  - crates/core/src/pass6_serialize.rs
  - crates/core/src/lib.rs
  - crates/cli/src/main.rs
autonomous: true
requirements:
  - HARD-07
  - HARD-15
  - HARD-16
  - HARD-19
  - HARD-21
must_haves:
  truths:
    - "spec_sections dead code in ambiguity module is either removed or properly wired through"
    - "runner.rs imports manifest/etag logic from manifest.rs instead of reimplementing it"
    - "LSP dead code annotations resolved -- unused token types and struct fields either wired in or removed"
    - "S6 MAX_PATHS and MAX_DEPTH are configurable parameters, not hardcoded constants"
    - "All serialization sites reference TENOR_BUNDLE_VERSION constant instead of hardcoded strings"
  artifacts:
    - path: "crates/cli/src/runner.rs"
      provides: "Consolidated manifest/etag logic"
      contains: "manifest::"
    - path: "crates/lsp/src/semantic_tokens.rs"
      provides: "Clean semantic token definitions without dead code"
    - path: "crates/analyze/src/s6_flow_paths.rs"
      provides: "Configurable path enumeration limits"
      contains: "max_paths"
  key_links:
    - from: "crates/cli/src/runner.rs"
      to: "crates/cli/src/manifest.rs"
      via: "Import of manifest/etag functions"
      pattern: "use crate::manifest"
    - from: "crates/core/src/pass6_serialize.rs"
      to: "crates/core/src/lib.rs"
      via: "TENOR_BUNDLE_VERSION constant"
      pattern: "TENOR_BUNDLE_VERSION"
---

<objective>
Clean up dead code, eliminate duplicated logic, make hardcoded limits configurable, and consolidate version strings to a single constant.

Purpose: Five independent cleanup items that reduce maintenance burden, improve code hygiene, and make the codebase more production-ready. Each is small but collectively they address 5 of the 27 hardening requirements.

Output: Cleaner codebase with no dead code annotations, no duplicated manifest logic, configurable analysis limits, and version strings from a single source.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/codebase/CONCERNS.md
@crates/cli/src/ambiguity/mod.rs
@crates/cli/src/runner.rs
@crates/cli/src/manifest.rs
@crates/lsp/src/semantic_tokens.rs
@crates/lsp/src/navigation.rs
@crates/analyze/src/s6_flow_paths.rs
@crates/core/src/pass6_serialize.rs
@crates/core/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dead code cleanup (spec_sections, LSP annotations) and version constant consolidation</name>
  <files>
    crates/cli/src/ambiguity/mod.rs
    crates/cli/src/ambiguity/fixtures.rs
    crates/lsp/src/semantic_tokens.rs
    crates/lsp/src/navigation.rs
    crates/core/src/pass6_serialize.rs
    crates/core/src/lib.rs
    crates/cli/src/main.rs
  </files>
  <action>
**HARD-07 -- spec_sections dead code:**

In `crates/cli/src/ambiguity/mod.rs` (line ~27-28), `AmbiguityTestCase.spec_sections` has `#[allow(dead_code)]`. Decision: **Remove the field entirely.** The spec_sections concept is not wired through to prompt construction (check `crates/cli/src/ambiguity/prompt.rs` to confirm). If spec-section injection is needed in the future, it can be re-added. Remove the field, remove the `#[allow(dead_code)]` annotation, and update `fixtures.rs` to stop populating it.

**HARD-16 -- LSP dead code annotations:**

In `crates/lsp/src/semantic_tokens.rs` (lines ~15-37): 12 `#[allow(dead_code)]` annotations on semantic token type constants. Determine which tokens are actually used by the semantic token provider function. For tokens that ARE used: remove the `#[allow(dead_code)]` annotation. For tokens that are NOT used by any code path: remove the constant entirely. A token constant should only exist if it's referenced in the token legend or emitted during tokenization.

In `crates/lsp/src/navigation.rs` (lines ~714-767): 3 `#[allow(dead_code)]` on struct fields. Check if the fields are used. If they're set but never read, remove both the field and the code that sets it. If they're needed for future use, add a clear `// TODO:` comment explaining the plan and keep the allow annotation.

**HARD-21 -- Version string consolidation:**

The `TENOR_BUNDLE_VERSION` constant exists in `crates/core/src/lib.rs`. Verify that ALL serialization sites in `crates/core/src/pass6_serialize.rs` use this constant instead of hardcoded `"1.0"` or `"1.1.0"` string literals. Also check `crates/cli/src/main.rs` and `crates/cli/src/runner.rs` for hardcoded version strings.

Specifically:
- In `pass6_serialize.rs`, search for `"1.0"` and `"1.1.0"` literals. Replace with `TENOR_VERSION` and `TENOR_BUNDLE_VERSION` respectively (both defined in `crates/core/src/lib.rs`).
- In `main.rs` and `runner.rs`, search for `"tenor"` field values and ensure they use the constant.
- Add `use crate::TENOR_VERSION` and `use crate::TENOR_BUNDLE_VERSION` where needed.
  </action>
  <verify>
    `cargo fmt --all` passes. `cargo build --workspace` succeeds. `cargo test --workspace` passes. `cargo clippy --workspace -- -D warnings` clean (no dead code warnings). `grep -rn 'allow(dead_code)' crates/lsp/src/semantic_tokens.rs crates/cli/src/ambiguity/mod.rs` -- reduced or eliminated. `grep -rn '"1\.0"' crates/core/src/pass6_serialize.rs` -- no hardcoded version strings.
  </verify>
  <done>spec_sections removed from ambiguity. LSP dead code annotations resolved. All version strings reference TENOR_VERSION/TENOR_BUNDLE_VERSION constants.</done>
</task>

<task type="auto">
  <name>Task 2: Consolidate manifest/etag logic and make S6 limits configurable</name>
  <files>
    crates/cli/src/runner.rs
    crates/cli/src/manifest.rs
    crates/analyze/src/s6_flow_paths.rs
    crates/analyze/src/lib.rs
  </files>
  <action>
**HARD-15 -- Consolidate duplicate manifest/etag logic:**

In `crates/cli/src/runner.rs`, find the duplicated `build_manifest` and `compute_etag` logic that reimplements what's in `crates/cli/src/manifest.rs`.

1. Make the functions in `manifest.rs` public (if not already): `pub fn build_manifest(...)`, `pub fn compute_etag(...)`.
2. In `runner.rs`, replace the inlined implementations with `use crate::manifest::{build_manifest, compute_etag}` (or just the specific functions needed).
3. Remove the duplicated code from `runner.rs`.
4. Verify that the manifest tests still pass by running `cargo test -p tenor-cli`.

**HARD-19 -- Make S6 path enumeration limits configurable:**

In `crates/analyze/src/s6_flow_paths.rs` (lines ~15-17), `MAX_PATHS` and `MAX_DEPTH` are hardcoded constants:
```rust
const MAX_PATHS: usize = 10_000;
const MAX_DEPTH: usize = 1_000;
```

Refactor to make these configurable:

1. Create an `S6Config` struct (or `FlowPathConfig`):
```rust
pub struct FlowPathConfig {
    pub max_paths: usize,
    pub max_depth: usize,
}

impl Default for FlowPathConfig {
    fn default() -> Self {
        Self { max_paths: 10_000, max_depth: 1_000 }
    }
}
```

2. Add a `config` parameter to the S6 analysis entry function. Use `Default::default()` when called from `analyze()` in `lib.rs` to maintain backward compatibility.

3. Expose the config through `analyze_selected()` or via a new `AnalysisConfig` struct that wraps per-analysis configs. Keep the API change minimal -- the simplest approach is to add an `Option<FlowPathConfig>` parameter or add it to an existing options struct.

4. Update the CLI `check` subcommand if it calls analysis -- pass through the default config.
  </action>
  <verify>
    `cargo fmt --all` passes. `cargo build --workspace` succeeds. `cargo test --workspace` passes. `cargo run -p tenor-cli -- test conformance` passes. Manifest/etag tests in CLI integration tests pass. Analysis tests pass with default config. `cargo clippy --workspace -- -D warnings` clean.
  </verify>
  <done>runner.rs imports manifest/etag from manifest.rs (no duplication). S6 MAX_PATHS and MAX_DEPTH are configurable via FlowPathConfig with sensible defaults. All tests pass.</done>
</task>

</tasks>

<verification>
1. `cargo fmt --all` -- formatting clean
2. `cargo build --workspace` compiles cleanly
3. `cargo test --workspace` -- all tests pass
4. `cargo run -p tenor-cli -- test conformance` -- all 73 tests pass
5. `cargo clippy --workspace -- -D warnings` -- no warnings
6. No `#[allow(dead_code)]` remains in fixed locations
7. No hardcoded version strings in pass6_serialize.rs
8. runner.rs has no inlined manifest/etag code
</verification>

<success_criteria>
- spec_sections field removed from ambiguity module
- LSP dead code annotations resolved (removed or wired in)
- All version strings use TENOR_VERSION/TENOR_BUNDLE_VERSION
- runner.rs delegates to manifest.rs for etag computation
- S6 limits are configurable with defaults matching current values
- All 508+ tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/18-platform-hardening/18-05-SUMMARY.md`
</output>
