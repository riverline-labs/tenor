---
phase: 15-typescript-agent-sdk-client-to-rust-evaluator
plan: 03
type: execute
wave: 3
depends_on:
  - 15-01
  - 15-02
files_modified:
  - Dockerfile
  - docker-compose.yml
  - sdk/typescript/README.md
  - sdk/typescript/examples/agent-basics.ts
autonomous: true
requirements:
  - SDK-04
  - SDK-05

must_haves:
  truths:
    - "Docker image builds and runs `tenor serve` with pre-loaded contracts"
    - "`docker run` starts the evaluator and responds to SDK client requests"
    - "SDK README documents the trust boundary: SDK is client, evaluator is trusted core"
    - "SDK README shows getting started with both `tenor serve` and Docker"
    - "Example script demonstrates all three agent skills in a complete workflow"
  artifacts:
    - path: "Dockerfile"
      provides: "Multi-stage Docker build for tenor evaluator image"
      contains: "tenor serve"
      min_lines: 15
    - path: "sdk/typescript/README.md"
      provides: "SDK documentation with trust boundary explanation"
      min_lines: 80
    - path: "sdk/typescript/examples/agent-basics.ts"
      provides: "Working example demonstrating getOperations, invoke, explain"
      min_lines: 30
  key_links:
    - from: "Dockerfile"
      to: "crates/cli/src/serve.rs"
      via: "ENTRYPOINT runs tenor serve"
      pattern: "tenor.*serve"
    - from: "sdk/typescript/README.md"
      to: "sdk/typescript/src/client.ts"
      via: "Code examples reference TenorClient API"
      pattern: "TenorClient"
    - from: "sdk/typescript/examples/agent-basics.ts"
      to: "sdk/typescript/src/index.ts"
      via: "Import and use SDK"
      pattern: "import.*@tenor-lang/sdk"
---

<objective>
Create the Docker image for the evaluator, write SDK documentation that clearly communicates the trust boundary, and provide a working example demonstrating all three agent skills.

Purpose: Developers need two things to get started: (1) a way to run the evaluator without building from source (Docker), and (2) documentation that explains the architecture and shows working code. The trust boundary message is critical — the SDK is a client, the evaluator is the trusted core.

Output: Dockerfile, docker-compose.yml, SDK README with architecture explanation and getting-started guide, and a working example script.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-typescript-agent-sdk-client-to-rust-evaluator/15-01-SUMMARY.md
@.planning/phases/15-typescript-agent-sdk-client-to-rust-evaluator/15-02-SUMMARY.md

@Cargo.toml
@crates/cli/Cargo.toml
@sdk/typescript/package.json
@sdk/typescript/src/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile and docker-compose.yml for the evaluator</name>
  <files>
    Dockerfile
    docker-compose.yml
    .dockerignore
  </files>
  <action>
**Dockerfile** — multi-stage build:

```dockerfile
# Stage 1: Build the Rust binary
FROM rust:1.83-slim AS builder
WORKDIR /build
COPY Cargo.toml Cargo.lock ./
COPY crates/ crates/
COPY docs/ docs/
RUN cargo build --release -p tenor-cli

# Stage 2: Minimal runtime image
FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates && rm -rf /var/lib/apt/lists/*
COPY --from=builder /build/target/release/tenor /usr/local/bin/tenor

# Default port
EXPOSE 8080

# Contracts are mounted at /contracts
VOLUME ["/contracts"]

ENTRYPOINT ["tenor", "serve", "--port", "8080"]
# Users can append contract paths: docker run tenor/evaluator /contracts/my_contract.tenor
```

Use `rust:1.83-slim` or latest stable as the build image. The final image is `debian:bookworm-slim` to keep it small (~80MB). The binary is statically linked enough for this base.

**docker-compose.yml** — convenience for local development:

```yaml
version: "3.8"
services:
  evaluator:
    build: .
    ports:
      - "8080:8080"
    volumes:
      - ./domains:/contracts:ro
    command: ["/contracts/saas/saas_subscription.tenor"]
```

This mounts the `domains/` directory as `/contracts` and loads the SaaS subscription example by default.

**.dockerignore:**
```
target/
.planning/
.git/
node_modules/
sdk/typescript/dist/
sdk/typescript/node_modules/
```

Verify the Dockerfile builds:
```bash
docker build -t tenor/evaluator .
```

Verify the container runs:
```bash
docker run --rm -p 8080:8080 -v $(pwd)/domains:/contracts:ro tenor/evaluator /contracts/saas/saas_subscription.tenor
# In another terminal:
curl http://localhost:8080/health
```
  </action>
  <verify>
```bash
docker build -t tenor/evaluator .
docker run --rm -d -p 8080:8080 -v $(pwd)/domains:/contracts:ro --name tenor-test tenor/evaluator /contracts/saas/saas_subscription.tenor
sleep 2
curl -s http://localhost:8080/health | grep '"status":"ok"'
docker stop tenor-test
```
Docker image builds. Container starts and responds to health check. Container stops cleanly.
  </verify>
  <done>
Docker image builds from the repo root. Container runs `tenor serve` and responds to HTTP requests. Contracts can be mounted via volume. docker-compose.yml provides a one-command local dev setup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write SDK README and example script</name>
  <files>
    sdk/typescript/README.md
    sdk/typescript/examples/agent-basics.ts
  </files>
  <action>
**sdk/typescript/README.md:**

Write a comprehensive README with these sections:

1. **Title and tagline**: `@tenor-lang/sdk` — TypeScript SDK for Tenor contract evaluation

2. **Architecture** (this is SDK-05 — the trust boundary explanation):
   > The SDK is a **client**. The Rust evaluator is the **trusted core**.
   >
   > All contract evaluation, rule execution, and flow processing happens in the Rust evaluator. The SDK sends facts over HTTP and receives verdicts. It never reimplements evaluation logic. This means:
   > - The evaluator is the single source of truth for contract semantics
   > - The SDK cannot produce incorrect verdicts — it only relays what the evaluator produces
   > - You can audit the evaluator independently of any SDK consumer
   >
   > ```
   > Your App  -->  @tenor-lang/sdk  -->  HTTP  -->  tenor serve (Rust)
   >                (client)                          (trusted evaluator)
   > ```

3. **Getting started** — two options:
   - **Option A: `tenor serve`** (if you have the Rust toolchain):
     ```bash
     cargo install tenor-cli
     tenor serve --port 8080 path/to/contract.tenor
     ```
   - **Option B: Docker** (no Rust needed):
     ```bash
     docker run -p 8080:8080 -v ./contracts:/contracts tenor/evaluator /contracts/my_contract.tenor
     ```

4. **Installation**:
   ```bash
   npm install @tenor-lang/sdk
   ```

5. **Quick start** — minimal code example:
   ```typescript
   import { TenorClient } from '@tenor-lang/sdk';

   const client = new TenorClient({ baseUrl: 'http://localhost:8080' });

   // List available contracts
   const contracts = await client.listContracts();

   // Get operations an agent can perform
   const ops = await client.getOperations('my_contract');

   // Evaluate the contract with facts
   const result = await client.invoke('my_contract', {
     is_active: true,
     balance: { amount: '5000.00', currency: 'USD' }
   });

   // Get a natural-language explanation
   const explanation = await client.explain('my_contract');
   ```

6. **Agent skills** — explain the three core skills:
   - `getOperations(contractId)` — "What can I do?" Returns the list of operations an agent can invoke, with personas and state transitions.
   - `invoke(contractId, facts, options?)` — "Execute the contract." Evaluates facts against rules, returns verdicts with provenance. Optionally executes a flow.
   - `explain(contractId)` — "What does this contract do?" Returns a human-readable summary of the contract.

7. **API reference** — brief documentation of each method on TenorClient with parameters and return types.

8. **Error handling** — show how to catch specific error types:
   ```typescript
   import { ConnectionError, EvaluationError, ContractNotFoundError } from '@tenor-lang/sdk';

   try {
     const result = await client.invoke('unknown', {});
   } catch (err) {
     if (err instanceof ContractNotFoundError) {
       console.log(`Contract ${err.contractId} not found`);
     } else if (err instanceof EvaluationError) {
       console.log(`Evaluation failed: ${err.message}`);
     } else if (err instanceof ConnectionError) {
       console.log(`Cannot reach evaluator at ${err.url}`);
     }
   }
   ```

9. **Configuration** — TenorClientOptions reference.

10. **Requirements** — Node.js 22+, running `tenor serve` instance.

**sdk/typescript/examples/agent-basics.ts:**

A complete, runnable example script that demonstrates an agent workflow:

```typescript
/**
 * Agent Basics — demonstrates all three agent skills.
 *
 * Prerequisites:
 *   tenor serve --port 8080 domains/saas/saas_subscription.tenor
 *
 * Run:
 *   npx tsx examples/agent-basics.ts
 *   # or: node --experimental-strip-types examples/agent-basics.ts
 */
import { TenorClient } from '../src/index.js';

async function main() {
  const client = new TenorClient({ baseUrl: 'http://localhost:8080' });

  // Step 1: Check connectivity
  const health = await client.health();
  console.log(`Connected to Tenor evaluator v${health.tenor_version}\n`);

  // Step 2: Discover available contracts
  const contracts = await client.listContracts();
  console.log(`Available contracts: ${contracts.map(c => c.id).join(', ')}\n`);

  if (contracts.length === 0) {
    console.log('No contracts loaded. Start the server with a .tenor file.');
    return;
  }

  const contractId = contracts[0].id;

  // Step 3: Agent skill — getOperations
  // "What can I do with this contract?"
  const operations = await client.getOperations(contractId);
  console.log(`Operations for '${contractId}':`);
  for (const op of operations) {
    const personas = op.allowed_personas.join(', ');
    const entityIds = op.effects.map(e => e.entity_id).join(', ');
    console.log(`  - ${op.id} (entities: ${entityIds}, personas: ${personas})`);
  }
  console.log();

  // Step 4: Agent skill — invoke (evaluate contract)
  // "Run the contract with these facts"
  const result = await client.invoke(contractId, {
    plan_type: 'pro',
    monthly_seats: 5,
    is_active: true,
    annual_commitment: true,
    account_age_days: 365,
    current_mrr: { amount: '500.00', currency: 'USD' },
    expansion_revenue: { amount: '100.00', currency: 'USD' }
  });
  console.log('Evaluation result:');
  console.log(JSON.stringify(result, null, 2).slice(0, 500) + '...\n');

  // Step 5: Agent skill — explain
  // "What does this contract do?"
  const explanation = await client.explain(contractId);
  console.log('Contract explanation:');
  console.log(JSON.stringify(explanation, null, 2).slice(0, 500) + '...\n');

  console.log('All agent skills demonstrated successfully.');
}

main().catch(console.error);
```

Adjust the facts in the example to match what the SaaS subscription contract expects (reference `domains/saas/` for the actual fact names).
  </action>
  <verify>
README renders correctly in a markdown viewer (check structure, code blocks, headings).
Example script is syntactically valid TypeScript:
```bash
cd sdk/typescript && npx tsc --noEmit examples/agent-basics.ts --skipLibCheck --esModuleInterop --module Node16 --moduleResolution Node16 --target ES2022
```
(Or simply verify it type-checks alongside the src/ files.)

Integration test of the example (requires running server):
```bash
# Terminal 1:
cargo run -p tenor-cli -- serve --port 8080 domains/saas/saas_subscription.tenor

# Terminal 2:
cd sdk/typescript && node --experimental-strip-types examples/agent-basics.ts
```
  </verify>
  <done>
README clearly explains the trust boundary (SDK is client, evaluator is trusted core). Getting started covers both `tenor serve` and Docker. All three agent skills are documented with code examples. Example script runs end-to-end demonstrating the complete agent workflow.
  </done>
</task>

</tasks>

<verification>
1. `docker build -t tenor/evaluator .` succeeds
2. Docker container starts and responds to health checks
3. SDK README is comprehensive and clearly explains the trust boundary
4. Example script demonstrates all three agent skills when run against a live server
5. docker-compose.yml starts the evaluator with one command
</verification>

<success_criteria>
- Docker image builds and runs the evaluator (SDK-04)
- SDK documentation explicitly states the trust boundary: SDK is client, evaluator is trusted core (SDK-05)
- README shows getting started with both `tenor serve` and Docker
- Working example script demonstrates the complete agent workflow
- All three agent skills (getOperations, invoke, explain) documented with code examples
</success_criteria>

<output>
After completion, create `.planning/phases/15-typescript-agent-sdk-client-to-rust-evaluator/15-03-SUMMARY.md`
</output>
