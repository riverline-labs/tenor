---
phase: 14.1-tech-debt-bugs-hardening
plan: 05
subsystem: eval, analyze, cli
tags: [hashmap, performance, flow-execution, configurable-limits, ambiguity]

# Dependency graph
requires:
  - phase: 14.1-03
    provides: "typed explain deserialization groundwork"
  - phase: 14.1-04
    provides: "typed explain deserialization"
provides:
  - "O(1) operation lookup in flow execution via HashMap"
  - "Configurable flow step limit (max_steps parameter)"
  - "Configurable S6 path enumeration limits via FlowPathConfig"
  - "Informative generate stub message"
  - "Non-dated ambiguity model alias"
  - "AmbiguityRunResult summary stats printed to stderr"
affects: [phase-15, phase-16, phase-19]

# Tech tracking
tech-stack:
  added: []
  patterns: ["HashMap index for O(1) lookup in hot loops", "Config struct with Default impl for configurable limits"]

key-files:
  created: []
  modified:
    - "crates/eval/src/flow.rs"
    - "crates/eval/src/lib.rs"
    - "crates/analyze/src/s6_flow_paths.rs"
    - "crates/analyze/src/lib.rs"
    - "crates/cli/src/main.rs"
    - "crates/cli/src/ambiguity/api.rs"
    - "crates/cli/src/ambiguity/mod.rs"

key-decisions:
  - "Operation index built per execute_flow call rather than stored on Contract -- keeps Contract immutable and index lifetime scoped"
  - "max_steps as Option<usize> rather than a config struct -- minimal API surface for single parameter"
  - "FlowPathConfig as separate struct with Default -- extensible for Phase 19 embedded evaluator"
  - "Sub-flows and parallel branches pass None for max_steps -- inherit default, not parent limit"

patterns-established:
  - "HashMap index pattern: build index from Vec before hot loop, use O(1) lookup in loop body"
  - "Config struct + Default: configurable limits with backward-compatible defaults"

requirements-completed: []

# Metrics
duration: 6min
completed: 2026-02-23
---

# Phase 14.1 Plan 05: Perf & Misc Tech Debt Summary

**O(1) operation lookup via HashMap in flow execution, configurable flow/S6 limits, and CLI surface cleanup (generate stub, model alias, dead code stats)**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-23T00:55:59Z
- **Completed:** 2026-02-23T01:02:35Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Replaced O(n) linear operation scans with O(1) HashMap lookup in both execute_flow main loop and handle_failure compensation path
- Made flow step limit configurable via max_steps parameter (default 1000) with backward-compatible Option<usize> API
- Introduced FlowPathConfig struct for configurable S6 path enumeration limits (max_paths, max_depth) with Default impl
- Updated generate stub to print informative Phase 16 message with exit code 2
- Changed ambiguity model alias from dated "claude-sonnet-4-5-20250514" to non-dated "claude-sonnet-4-5"
- Surfaced AmbiguityRunResult summary stats (total, matches, mismatches, hard errors) to stderr
- Removed dead_code annotations from total/matches/mismatches fields now that they are consumed

## Task Commits

Each task was committed atomically:

1. **Task 1: O(1) operation lookup and configurable flow step limit** - `d973131` (feat)
2. **Task 2: Configurable S6 limits + generate stub + model alias + dead code cleanup** - `ae43155` (feat)

## Files Created/Modified
- `crates/eval/src/flow.rs` - O(1) operation index via HashMap, configurable max_steps, op_index threaded through handle_failure
- `crates/eval/src/lib.rs` - Updated execute_flow call to pass None for max_steps
- `crates/analyze/src/s6_flow_paths.rs` - FlowPathConfig struct, analyze_flow_paths_with_config(), removed hardcoded constants
- `crates/analyze/src/lib.rs` - Exported FlowPathConfig from crate public API
- `crates/cli/src/main.rs` - Informative generate stub, ambiguity summary printing, removed stub_not_implemented
- `crates/cli/src/ambiguity/api.rs` - Non-dated model alias
- `crates/cli/src/ambiguity/mod.rs` - Removed dead_code annotations from AmbiguityRunResult fields

## Decisions Made
- Built operation index per execute_flow call (not stored on Contract) to keep Contract immutable and index lifetime scoped to execution
- Used Option<usize> for max_steps rather than a config struct -- single parameter doesn't warrant struct overhead
- Sub-flows and parallel branches pass None for max_steps (inherit default, not parent's custom limit) -- each flow invocation manages its own step budget
- FlowPathConfig as a separate struct with Default impl for extensibility in Phase 19

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Removed unused stub_not_implemented function**
- **Found during:** Task 2 (generate stub update)
- **Issue:** After inlining the generate stub message, stub_not_implemented was no longer called and would trigger a clippy dead_code warning
- **Fix:** Removed the unused function
- **Files modified:** crates/cli/src/main.rs
- **Verification:** cargo clippy --workspace -- -D warnings passes clean

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Necessary to pass clippy quality gate. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All CONCERNS.md items addressed across plans 14.1-01 through 14.1-05
- Phase 14.1 (Tech Debt, Bugs & Hardening) is complete
- Codebase ready for Phase 15+ (Agent Tooling SDK work)
- Flow execution is performant (O(1) lookups) and configurable (step limits, path limits)

## Self-Check: PASSED

- All 7 modified files exist on disk
- SUMMARY.md exists at `.planning/phases/14.1-tech-debt-bugs-hardening/14.1-05-SUMMARY.md`
- Commit `d973131` (Task 1) verified in git log
- Commit `ae43155` (Task 2) verified in git log

---
*Phase: 14.1-tech-debt-bugs-hardening*
*Completed: 2026-02-23*
