# Phase 14.1 Context: Tech Debt, Bugs & Hardening

## Decisions from Assumption Review

1. **explain.rs refactor**: Use a dedicated `ExplainBundle` struct covering exactly what explain.rs needs — NOT full `Contract` deserialization from tenor-eval. Wrong dependency direction and unnecessary coupling.

2. **Date/DateTime validation**: Add a minimal date parsing dependency (`time` or `chrono`) rather than hand-rolling inline calendar logic. Leap years and edge cases are exactly what proven libraries exist for.

3. **Import path sandboxing**: Fail closed. If `canonicalize()` fails (path doesn't exist), reject the import with an `ElabError`. Never fail open on a security boundary.

4. **Unit test scope**: Targeted tests for the specific `unwrap` sites being fixed. NOT a comprehensive unit test pass for all of tenor-core. Test what you're changing.

5. **Tests are part of the work, not a separate step**: Every fix — especially the riskiest ones (explain.rs refactor, date validation, import sandboxing, unwrap conversions) — must include tests as part of the same plan that makes the change. Don't ship a fix and "add tests later." The test proves the fix works. This applies to both new unit tests and new conformance fixtures where appropriate.

## Urgency Tiers (from user)

### Fix immediately — these will bite you:
- Duplicated manifest/etag logic — conformance tests can silently diverge from CLI output
- Hardcoded version strings in 9+ locations — next version bump is a debugging nightmare
- Stale "tenor_version": "1.0.0" in test helpers — silent inconsistency
- pass5_validate.rs unwrap() calls — elaborator panics on user input if invariants shift
- explain.rs untyped JSON traversal — silently drops output sections if interchange format changes

### Fix before Phase 15 ships:
- Import path traversal not sandboxed — catastrophic if tenor-core gets embedded in a server
- Date/DateTime validation bugs — accepts garbage dates
- generate stub exits with code 2 — runtime error with no explanation
- O(n) operation lookup per flow step — will hurt once real contracts run through the SDK

### Fix before Phase 19:
- Flow step limit of 1000 is unconfigurable — legitimate complex flows fail silently
- S6 path enumeration caps at 10,000 — truncation means incomplete analysis
- ureq error string parsing for HTTP status codes — retry logic silently breaks if ureq changes

### Address but not blocking:
- No unit tests in tenor-core source files (targeted only — see decision #4)
- Thin negative test coverage for passes 0-4
- No eval conformance fixtures for flow error paths
- AmbiguityRunResult fields all dead code — stats computed, never surfaced
- Hardcoded model name in ambiguity testing — use a non-dated alias

### Low priority / track:
- Excessive string allocations in pass6_serialize — irrelevant for CLI
- Linear import cycle detection — only hurts on deep import trees
- Markdown format output untested in explain.rs
- tenor diff not covered by CLI integration tests

## Implementation Order (validated)

1. Version constants + manifest extraction
2. Unwrap→expect/error conversions
3. Import path sandboxing
4. Date/DateTime validation (with dependency)
5. Hardened explain.rs (ExplainBundle struct)
6. O(n) lookup + configurable limits
7. Generate stub, model alias, dead code cleanup, ureq docs
8. Test coverage additions (targeted)

## Source Material

- `.planning/codebase/CONCERNS.md` — full analysis with file locations and line numbers
