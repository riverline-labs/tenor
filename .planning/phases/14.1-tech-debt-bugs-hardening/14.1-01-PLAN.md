---
phase: 14.1-tech-debt-bugs-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/core/src/lib.rs
  - crates/core/src/pass6_serialize.rs
  - crates/cli/src/main.rs
  - crates/cli/src/runner.rs
  - crates/cli/src/manifest.rs
  - crates/analyze/src/bundle.rs
  - crates/analyze/src/lib.rs
autonomous: true
requirements: []

must_haves:
  truths:
    - "All version strings across the codebase derive from a single constant definition"
    - "Changing the Tenor version requires editing exactly one location"
    - "Manifest/etag logic exists in exactly one module, used by both CLI and runner"
    - "All conformance tests still pass with the extracted constants"
  artifacts:
    - path: "crates/core/src/lib.rs"
      provides: "TENOR_VERSION and TENOR_BUNDLE_VERSION constants"
      contains: "TENOR_VERSION"
    - path: "crates/cli/src/manifest.rs"
      provides: "Shared compute_etag and build_manifest functions"
      contains: "pub fn compute_etag"
  key_links:
    - from: "crates/core/src/pass6_serialize.rs"
      to: "crates/core/src/lib.rs"
      via: "constant import"
      pattern: "TENOR_VERSION|TENOR_BUNDLE_VERSION"
    - from: "crates/cli/src/main.rs"
      to: "crates/cli/src/manifest.rs"
      via: "module import"
      pattern: "manifest::"
    - from: "crates/cli/src/runner.rs"
      to: "crates/cli/src/manifest.rs"
      via: "module import"
      pattern: "manifest::"
---

<objective>
Centralize version constants and extract duplicated manifest/etag logic into shared modules.

Purpose: Eliminate the two highest-urgency tech debt items: (1) hardcoded version strings in 9+ locations that make version bumps error-prone, and (2) duplicated manifest/etag logic that can silently diverge between CLI output and conformance tests.

Output: Single-source version constants in tenor-core, shared manifest module in tenor-cli.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md

Key references:
- Version strings in pass6_serialize.rs: lines 78, 80, 128, 150, 188, 228, 249, 257, 1014
- Version in main.rs:206, runner.rs:265
- Stale versions in analyze/bundle.rs:567, analyze/lib.rs:188
- Manifest functions in main.rs:191-208, duplicated in runner.rs:257-265
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define version constants and replace all hardcoded version strings</name>
  <files>
    crates/core/src/lib.rs
    crates/core/src/pass6_serialize.rs
    crates/analyze/src/bundle.rs
    crates/analyze/src/lib.rs
  </files>
  <action>
    1. In `crates/core/src/lib.rs`, add two public constants at the top (after the module doc comment, before `pub mod` declarations):
       ```rust
       /// Tenor spec version used in per-construct `"tenor"` fields (e.g., "1.0").
       pub const TENOR_VERSION: &str = "1.0";
       /// Tenor interchange bundle version (semver, e.g., "1.1.0").
       pub const TENOR_BUNDLE_VERSION: &str = "1.1.0";
       ```

    2. In `crates/core/src/pass6_serialize.rs`, replace ALL occurrences of:
       - `"1.0".to_owned()` and `json!("1.0")` used for the per-construct `"tenor"` field with `crate::TENOR_VERSION.to_owned()` / `json!(crate::TENOR_VERSION)` respectively
       - `"1.1.0".to_owned()` used for `"tenor_version"` bundle field with `crate::TENOR_BUNDLE_VERSION.to_owned()`
       There are 9 locations total. Replace every one. Do NOT leave any hardcoded version string.

    3. In `crates/analyze/src/bundle.rs` (line ~567) and `crates/analyze/src/lib.rs` (line ~188), update the test helper `make_bundle()` functions to use `tenor_core::TENOR_BUNDLE_VERSION` instead of the hardcoded `"1.0.0"` string. Add `use tenor_core::TENOR_BUNDLE_VERSION;` at the top of each file's test module.

    4. Run `cargo build --workspace` to verify all imports resolve.
  </action>
  <verify>
    ```bash
    cargo build --workspace
    cargo test --workspace
    cargo run -p tenor-cli -- test conformance
    ```
    All must pass. Then verify no hardcoded version strings remain:
    ```bash
    grep -rn '"1\.0"' crates/core/src/pass6_serialize.rs  # Should return 0 matches
    grep -rn '"1\.1\.0"' crates/core/src/pass6_serialize.rs  # Should return 0 matches
    grep -rn '"1\.0\.0"' crates/analyze/src/  # Should return 0 matches
    ```
  </verify>
  <done>All version strings derive from `TENOR_VERSION` and `TENOR_BUNDLE_VERSION` constants in `crates/core/src/lib.rs`. Zero hardcoded version literals remain in pass6_serialize.rs and analyze test helpers.</done>
</task>

<task type="auto">
  <name>Task 2: Extract manifest/etag logic into shared module</name>
  <files>
    crates/cli/src/manifest.rs
    crates/cli/src/main.rs
    crates/cli/src/runner.rs
  </files>
  <action>
    1. Create `crates/cli/src/manifest.rs` with the following public functions extracted from main.rs:
       **NOTE:** The code snippet below is a skeleton only. Read the complete `build_manifest` function body from `crates/cli/src/main.rs` lines 191-208 and copy the full envelope construction into `manifest.rs`. Do NOT use the stub below as the complete implementation.

       ```rust
       use sha2::{Digest, Sha256};
       use serde_json::{Map, Value};
       use tenor_core::TENOR_BUNDLE_VERSION;

       /// Compute SHA-256 etag from compact JSON representation.
       pub fn compute_etag(bundle: &Value) -> String {
           let canonical = serde_json::to_string(bundle).expect("JSON serialization cannot fail");
           let hash = Sha256::digest(canonical.as_bytes());
           format!("{:x}", hash)
       }

       /// Wrap an interchange bundle in a TenorManifest envelope.
       pub fn build_manifest(bundle: Value) -> Value {
           let etag = compute_etag(&bundle);
           let mut manifest = Map::new();
           manifest.insert("tenor".to_string(), Value::String(TENOR_BUNDLE_VERSION.replace(".0", "").to_string()));
           // ... rest of envelope construction â€” read full body from main.rs lines 191-208
       }
       ```
       Use `tenor_core::TENOR_BUNDLE_VERSION` for the manifest `"tenor"` field (derive the short version like "1.1" from "1.1.0" by trimming trailing ".0", or define a `TENOR_MANIFEST_VERSION` constant if cleaner).

       Actually, looking at the code: main.rs uses `"1.1"` for the manifest tenor field. This is the manifest version, distinct from the per-construct `"1.0"`. Define a constant in manifest.rs: `const TENOR_MANIFEST_VERSION: &str = "1.1";` OR derive it. Simplest: just use a `pub const MANIFEST_TENOR_VERSION: &str = "1.1";` in manifest.rs since it only applies to manifests.

    2. In `crates/cli/src/main.rs`:
       - Add `mod manifest;` declaration
       - Remove the `compute_etag` and `build_manifest` function definitions
       - Replace calls with `manifest::compute_etag(...)` and `manifest::build_manifest(...)`
       - Remove the now-unused `use sha2::{Digest, Sha256}` import from main.rs if sha2 is no longer directly used there

    3. In `crates/cli/src/runner.rs`:
       - Remove the inline SHA-256 computation and manifest envelope construction (~lines 257-265)
       - Import and call `crate::manifest::compute_etag(...)` and `crate::manifest::build_manifest(...)`
       - Remove `use sha2::{Digest, Sha256}` from runner.rs

    4. Verify the manifest conformance tests still pass -- they exercise both code paths.
  </action>
  <verify>
    ```bash
    cargo build --workspace
    cargo test --workspace
    cargo run -p tenor-cli -- test conformance
    ```
    All pass. Then verify no duplicate logic:
    ```bash
    grep -rn 'Sha256::digest' crates/cli/src/main.rs crates/cli/src/runner.rs  # Should return 0 matches (only in manifest.rs)
    ```
  </verify>
  <done>Manifest/etag logic exists in exactly one location (`crates/cli/src/manifest.rs`). Both `main.rs` and `runner.rs` import from it. Zero code duplication for manifest construction.</done>
</task>

</tasks>

<verification>
1. `cargo fmt --all` -- clean formatting
2. `cargo build --workspace` -- compiles without errors
3. `cargo test --workspace` -- all tests pass
4. `cargo run -p tenor-cli -- test conformance` -- all conformance tests pass
5. `cargo clippy --workspace -- -D warnings` -- no warnings
6. `grep -rn '"1\.0"' crates/core/src/pass6_serialize.rs` returns empty
7. `grep -rn 'Sha256::digest' crates/cli/src/main.rs crates/cli/src/runner.rs` returns empty
</verification>

<success_criteria>
- Single `TENOR_VERSION` and `TENOR_BUNDLE_VERSION` constants in `crates/core/src/lib.rs`
- All 9+ hardcoded version strings replaced with constant references
- Stale `"1.0.0"` in analyze test helpers updated
- `manifest.rs` module contains the only `compute_etag` and `build_manifest` implementations
- All five quality gates pass
</success_criteria>

<output>
After completion, create `.planning/phases/14.1-tech-debt-bugs-hardening/14.1-01-SUMMARY.md`
</output>
