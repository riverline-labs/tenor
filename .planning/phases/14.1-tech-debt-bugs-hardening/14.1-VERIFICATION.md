---
phase: 14.1-tech-debt-bugs-hardening
verified: 2026-02-22T00:00:00Z
status: passed
score: 21/21 must-haves verified
re_verification: false
gaps: []
---

# Phase 14.1: Tech Debt, Bugs & Hardening — Verification Report

**Phase Goal:** Resolve all critical tech debt, known bugs, fragile areas, and security gaps identified in CONCERNS.md before starting the Agent Tooling SDK work
**Verified:** 2026-02-22
**Status:** PASSED
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| #  | Truth | Status | Evidence |
|----|-------|--------|----------|
| 1  | All version strings derive from single constants in tenor-core | VERIFIED | `TENOR_VERSION = "1.0"` and `TENOR_BUNDLE_VERSION = "1.1.0"` in `crates/core/src/lib.rs:22-24`; zero hardcoded `"1.0"` or `"1.1.0"` literals remain in pass6_serialize.rs |
| 2  | Changing the Tenor version requires editing exactly one location | VERIFIED | pass6_serialize.rs uses `crate::TENOR_VERSION` and `crate::TENOR_BUNDLE_VERSION` in all 9 previously hardcoded sites; analyze test helpers use `tenor_core::TENOR_BUNDLE_VERSION` |
| 3  | Manifest/etag logic exists in exactly one module | VERIFIED | `crates/cli/src/manifest.rs` contains the only `compute_etag` and `build_manifest` implementations; `Sha256::digest` absent from main.rs and runner.rs |
| 4  | All conformance tests pass with the extracted constants | VERIFIED | `cargo run -p tenor-cli -- test conformance` reports 73/73 pass |
| 5  | The elaborator never panics on user input in passes 3, 4, 5 | VERIFIED | Zero `.unwrap()` calls in production (non-test) code in pass3_types.rs, pass4_typecheck.rs, pass5_validate.rs; `ok_or_else` used for fallible lookups, `expect` with invariant text for algorithmic guarantees |
| 6  | Each converted unwrap site has a targeted unit test | VERIFIED | 4 unit tests in pass5_validate.rs (trigger acyclicity, flow reference cycle detection), 3 unit tests in pass3_types.rs (type cycle detection, type resolution) |
| 7  | Import paths cannot escape the contract root directory via ../ traversal | VERIFIED | `canonicalize() + starts_with(sandbox_root)` check in `crates/core/src/pass1_bundle.rs:187-214`; fails closed on canonicalize failure |
| 8  | Canonicalize failure rejects the import (fail closed) | VERIFIED | `canon_import = resolved.canonicalize().map_err(...)` produces ElabError on failure; no fallthrough |
| 9  | Negative conformance test for import escape passes | VERIFIED | `conformance/negative/pass1/import_escape.tenor` + `.expected-error.json` exist; `ok 26 - negative/pass1/import_escape` in conformance output |
| 10 | Date facts like "2024-13-45" are rejected | VERIFIED | `validate_date_format` uses `time::Date::parse` with format_description macro; tests confirm "2024-13-01", "2024-02-30", "2023-02-29", "2024-99-99" all rejected |
| 11 | DateTime facts like "2024-01-15Tgarbage" are rejected | VERIFIED | `validate_datetime_format` parses first 19 chars with `time::PrimitiveDateTime::parse`; test confirms "2024-01-15Tgarbage000" rejected |
| 12 | Valid dates including leap year Feb 29 are accepted | VERIFIED | Test confirms "2024-02-29" accepted; "2023-02-29" (non-leap) rejected |
| 13 | explain.rs consumes typed ExplainBundle, not raw JSON traversal | VERIFIED | `struct ExplainBundle` with `#[derive(Deserialize)]` defined in explain.rs; `serde_json::from_value` deserializes at entry to explain() |
| 14 | Interchange format changes cause loud deserialization errors | VERIFIED | `explain()` returns `Result<String, String>`; cmd_explain surfaces errors with non-zero exit code |
| 15 | Operation lookup in flow execution is O(1) via HashMap | VERIFIED | `op_index: HashMap<&str, &Operation>` built in `execute_flow` before the step loop; used in both main loop and `handle_failure` compensation path |
| 16 | Flow step limit is configurable via max_steps parameter | VERIFIED | `execute_flow` signature includes `max_steps: Option<usize>`; defaults to 1000; unit test verifies custom limit triggers |
| 17 | S6 path enumeration limits are configurable via FlowPathConfig | VERIFIED | `pub struct FlowPathConfig { max_paths, max_depth }` with `Default` impl in s6_flow_paths.rs; `analyze_flow_paths_with_config` accepts `&FlowPathConfig` |
| 18 | `tenor generate` prints a clear not-yet-implemented message with exit code 2 | VERIFIED | `eprintln!("tenor generate: code generation is not yet implemented.")` + Phase 16 reference at main.rs:178-179; exits with code 2 |
| 19 | Ambiguity module uses a non-dated model alias | VERIFIED | `const DEFAULT_MODEL: &str = "claude-sonnet-4-5"` in ambiguity/api.rs:12 (was `claude-sonnet-4-5-20250514`) |
| 20 | AmbiguityRunResult summary stats are printed to stderr | VERIFIED | `eprintln!` with total/matches/mismatches/hard_errors at main.rs:758-759; `#[allow(dead_code)]` annotations removed from those fields |
| 21 | All quality gates pass clean | VERIFIED | `cargo build`: 0 errors; `cargo test`: 398 passed, 0 failed; `cargo run -p tenor-cli -- test conformance`: 73/73 pass; `cargo clippy --workspace -- -D warnings`: clean |

**Score:** 21/21 truths verified

---

## Required Artifacts

### Plan 01 — Version Constants & Manifest Deduplication

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `crates/core/src/lib.rs` | TENOR_VERSION and TENOR_BUNDLE_VERSION constants | VERIFIED | Lines 22-24 contain both `pub const` declarations |
| `crates/cli/src/manifest.rs` | Shared `compute_etag` and `build_manifest` functions | VERIFIED | Both `pub fn` exist; `Sha256::digest` used only here |

### Plan 02 — Unwrap Elimination

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `crates/core/src/pass5_validate.rs` | Unwrap-free graph traversal with ElabError | VERIFIED | 3 converted sites: `ok_or_else` at line 715, `expect` at lines 842 and 1343; 4 unit tests in `#[cfg(test)]` |
| `crates/core/src/pass3_types.rs` | Unwrap-free type cycle detection | VERIFIED | 6 sites converted: `expect` with invariant text at lines 49, 55, 98; `ok_or_else` at lines 56, 133 and variant; 3 unit tests |
| `crates/core/src/pass4_typecheck.rs` | `expect`-annotated min/max | VERIFIED | `expect("products array has exactly 4 elements")` at lines 179 and 183 |

### Plan 03 — Import Sandboxing & Date Validation

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `crates/core/src/pass1_bundle.rs` | Sandboxed import path resolution | VERIFIED | `sandbox_root` computed via `canonicalize` at entry; `starts_with(sandbox_root)` check at line 202; fail-closed at line 187 |
| `crates/eval/src/assemble.rs` | Calendar-correct date and datetime validation | VERIFIED | `time::Date::parse` and `time::PrimitiveDateTime::parse` used; 6 unit tests for date and datetime edge cases |
| `conformance/negative/pass1/import_escape.tenor` | Negative conformance fixture | VERIFIED | File exists; conformance test passes |
| `conformance/negative/pass1/import_escape.expected-error.json` | Expected error for escape test | VERIFIED | Expects pass 1, field "import", message "cannot resolve path '../escape.tenor'" |

### Plan 04 — Typed Explain Deserialization

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `crates/cli/src/explain.rs` | ExplainBundle struct with serde::Deserialize | VERIFIED | `struct ExplainBundle` at line 25 with `#[derive(Deserialize)]` at line 24; all sub-structs also derive Deserialize |
| `crates/cli/tests/cli_integration.rs` | Integration tests for explain section presence | VERIFIED | `explain_terminal_sections_present_and_nonempty` and `explain_markdown_sections_present_and_nonempty` test functions confirmed |

### Plan 05 — Perf & Misc Tech Debt

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `crates/eval/src/flow.rs` | O(1) operation lookup and configurable max_steps | VERIFIED | `op_index: HashMap<&str, &Operation>` at line 224; `max_steps: Option<usize>` parameter at line 211 |
| `crates/analyze/src/s6_flow_paths.rs` | FlowPathConfig with max_paths and max_depth | VERIFIED | `pub struct FlowPathConfig` at line 18 with `Default` impl at line 25; `analyze_flow_paths_with_config` at line 94 |
| `crates/cli/src/ambiguity/api.rs` | Non-dated model alias | VERIFIED | `const DEFAULT_MODEL: &str = "claude-sonnet-4-5"` at line 12 |
| `crates/cli/src/ambiguity/mod.rs` | Dead code annotations removed from AmbiguityRunResult fields | VERIFIED | `total`, `matches`, `mismatches` fields have no `#[allow(dead_code)]`; one remaining allow is on `spec_sections` in `AmbiguityTestCase` — correct, that field is still unused |

---

## Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `pass6_serialize.rs` | `crates/core/src/lib.rs` | `crate::TENOR_VERSION` / `crate::TENOR_BUNDLE_VERSION` | WIRED | 9 occurrences verified; zero hardcoded literals remain |
| `crates/cli/src/main.rs` | `crates/cli/src/manifest.rs` | `manifest::build_manifest(...)` at line 197 | WIRED | mod manifest declared; function called |
| `crates/cli/src/runner.rs` | `crates/cli/src/manifest.rs` | `crate::manifest::build_manifest(...)` at line 255 | WIRED | Sha256 import absent from runner.rs |
| `pass5_validate.rs` | `crates/core/src/error.rs` | `ElabError` returns via `ok_or_else` | WIRED | ElabError returned at line 715 |
| `pass3_types.rs` | `crates/core/src/error.rs` | `ElabError` returns via `ok_or_else` | WIRED | ElabError returned at lines 56 and 133 |
| `pass1_bundle.rs` | filesystem (sandbox check) | `canonicalize() + starts_with(sandbox_root)` | WIRED | Both checks present at lines 187-214 |
| `crates/eval/src/assemble.rs` | `time` crate | `time::Date::parse` / `time::PrimitiveDateTime::parse` | WIRED | Both used inside validate_date_format and validate_datetime_format |
| `crates/cli/src/explain.rs` | `serde_json` | `#[derive(Deserialize)]` on ExplainBundle | WIRED | derive at line 24; `serde_json::from_value` used for deserialization |
| `crates/cli/src/main.rs` | `crates/cli/src/explain.rs` | `explain::explain(...)` call at line 1042 | WIRED | call present; Result handled |
| `crates/eval/src/flow.rs` | `crates/eval/src/lib.rs` | `max_steps` parameter threaded through | WIRED | `execute_flow(..., None)` at the lib.rs call site |
| `crates/cli/src/main.rs` | `crates/cli/src/ambiguity/mod.rs` | `result.total`, `result.matches`, `result.mismatches` at lines 758-759 | WIRED | All three consumed in the eprintln! summary |

---

## Requirements Coverage

No formal requirement IDs were assigned to this phase (inserted phase, pre-roadmap requirement numbering). All concerns addressed are sourced directly from `.planning/codebase/CONCERNS.md`.

### CONCERNS.md Coverage Summary

| Concern Category | Items | Addressed by Plans | Status |
|-----------------|-------|--------------------|--------|
| Tech Debt: Duplicated manifest/etag | 1 | Plan 01 | SATISFIED |
| Tech Debt: Hardcoded version strings | 1 | Plan 01 | SATISFIED |
| Tech Debt: Stale analyze test helpers | 1 | Plan 01 | SATISFIED |
| Tech Debt: stub CLI generate | 1 | Plan 05 | SATISFIED |
| Tech Debt: AmbiguityRunResult dead code | 1 | Plan 05 | SATISFIED |
| Tech Debt: spec_sections dead code | 1 | Plan 05 (field left with allow(dead_code) intentionally — future use) | INFO |
| Known Bugs: Date validation accepts semantic garbage | 1 | Plan 03 | SATISFIED |
| Known Bugs: DateTime validation incomplete | 1 | Plan 03 | SATISFIED |
| Security: Import path traversal unrestricted | 1 | Plan 03 | SATISFIED |
| Security: Hardcoded dated model name | 1 | Plan 05 | SATISFIED |
| Security: API key in headers | 1 | Not addressed (documented as acceptable per CONCERNS.md) | INTENTIONALLY DEFERRED |
| Fragile: pass5_validate.rs unwrap() calls | 3 sites | Plan 02 | SATISFIED |
| Fragile: pass3_types.rs unwrap() calls | 6 sites | Plan 02 | SATISFIED |
| Fragile: pass4_typecheck.rs unwrap() | 2 sites | Plan 02 | SATISFIED |
| Fragile: explain.rs untyped JSON traversal | 75+ sites | Plan 04 | SATISFIED |
| Fragile: Flow step limit unconfigurable | 1 | Plan 05 | SATISFIED |
| Performance: O(n) operation lookup per flow step | 1 | Plan 05 | SATISFIED |
| Performance: O(n) operation lookup in compensation | 1 | Plan 05 | SATISFIED |
| Scaling: S6 path limits unconfigurable | 1 | Plan 05 | SATISFIED |
| Performance: O(k*n) stratum rule evaluation | 1 | Not in phase scope (not in urgency tiers) | INTENTIONALLY DEFERRED |
| Performance: Frequent deep clones in flow | 1 | Not in phase scope | INTENTIONALLY DEFERRED |
| Performance: Linear import cycle detection | 1 | Not in phase scope (low priority) | INTENTIONALLY DEFERRED |
| Dependencies: ureq error parsing fragile | 1 | Not in phase scope ("fix before Phase 19") | INTENTIONALLY DEFERRED |
| Dependencies: jsonschema pinned | 1 | Not in phase scope (low urgency) | INTENTIONALLY DEFERRED |
| Missing: Unit tests in tenor-core | targeted | Plans 02, 03, 04 added targeted tests | PARTIALLY SATISFIED (per decision #4 — not a full unit test pass) |
| Test Coverage: Various gaps | multiple | Not in phase scope | INTENTIONALLY DEFERRED |

All items in the "Fix immediately" and "Fix before Phase 15 ships" urgency tiers from CONTEXT.md are SATISFIED. All intentional deferrals are in "Fix before Phase 19", "Address but not blocking", or "Low priority" tiers.

---

## Anti-Patterns Found

No blockers found. All scan results were clean.

| File | Pattern | Severity | Impact |
|------|---------|----------|--------|
| `crates/cli/src/ambiguity/mod.rs:27` | `#[allow(dead_code)]` on `spec_sections` | INFO | Intentional — documented future use for spec-section-targeted prompting; not removed by this phase |

---

## Human Verification Required

None. All observable truths were verified programmatically via grep, file inspection, and test runs.

---

## Gaps Summary

No gaps. All 21 must-have truths verified. All planned artifacts exist, are substantive (not stubs), and are wired into the execution path.

**Quality gate results (verified at time of verification):**
- `cargo build --workspace`: Finished with 0 errors
- `cargo test --workspace`: 398 passed, 0 failed across all crates
- `cargo run -p tenor-cli -- test conformance`: 73 pass, 0 fail (up from 72 pre-phase, +1 for import_escape negative test)
- `cargo clippy --workspace -- -D warnings`: Clean, no warnings

**Phase goal assessment:** The phase goal — resolving all critical tech debt, known bugs, fragile areas, and security gaps in CONCERNS.md before Phase 15 — is fully achieved. Every item in the "Fix immediately" and "Fix before Phase 15 ships" urgency tiers is addressed. The codebase is hardened and ready for Agent Tooling SDK work.

---

_Verified: 2026-02-22_
_Verifier: Claude (gsd-verifier)_
