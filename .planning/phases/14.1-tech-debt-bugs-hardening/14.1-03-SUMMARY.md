---
phase: 14.1-tech-debt-bugs-hardening
plan: 03
subsystem: security, validation
tags: [import-sandboxing, path-traversal, date-validation, time-crate, canonicalize]

# Dependency graph
requires:
  - phase: 14.1-01
    provides: "Codebase mapping and concern identification"
provides:
  - "Sandboxed import path resolution preventing directory traversal"
  - "Calendar-correct date/datetime validation via time crate"
  - "Negative conformance test for import escape"
affects: [15-sdk, eval, core]

# Tech tracking
tech-stack:
  added: [time 0.3]
  patterns: [sandbox-root canonicalize check, fail-closed import resolution]

key-files:
  created:
    - conformance/negative/pass1/import_escape.tenor
    - conformance/negative/pass1/import_escape.expected-error.json
  modified:
    - crates/core/src/pass1_bundle.rs
    - crates/eval/src/assemble.rs
    - Cargo.toml
    - crates/eval/Cargo.toml
    - conformance/negative/pass1/missing_import.expected-error.json

key-decisions:
  - "Sandbox root canonicalized once at load_bundle entry, threaded through load_file"
  - "Canonicalize failure = fail closed (reject import) per CONTEXT.md decision #3"
  - "time crate 0.3 for date validation per CONTEXT.md decision #2 (proven library over hand-rolled)"
  - "DateTime validation parses first 19 chars, accepting timezone suffixes"

patterns-established:
  - "Import sandbox: canonicalize + starts_with for all import paths"
  - "Calendar validation: use time::Date::parse and time::PrimitiveDateTime::parse"

requirements-completed: []

# Metrics
duration: 5min
completed: 2026-02-23
---

# Phase 14.1 Plan 03: Import Sandboxing & Date Validation Summary

**Sandboxed import resolution via canonicalize + starts_with, calendar-correct date/datetime validation via time crate**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-23T00:38:51Z
- **Completed:** 2026-02-23T00:44:23Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Import paths sandboxed to contract root directory, preventing directory traversal attacks
- Canonicalize failures fail closed (reject import) instead of silently proceeding
- Date validation now rejects semantically invalid dates (month 13, Feb 30, non-leap Feb 29)
- DateTime validation checks both date and time portions (rejects hour 25, garbage after T)
- Negative conformance test verifies import escape rejection
- 6 unit tests cover calendar correctness edge cases

## Task Commits

Each task was committed atomically:

1. **Task 1: Sandbox import path resolution** - `24fae27` (feat)
2. **Task 2: Fix date/datetime validation with time crate** - `d509200` (fix)

## Files Created/Modified
- `crates/core/src/pass1_bundle.rs` - Added sandbox_root parameter, canonicalize + starts_with checks on all imports
- `crates/eval/src/assemble.rs` - Replaced format-only validation with time::Date/PrimitiveDateTime parsing
- `Cargo.toml` - Added `time` workspace dependency
- `crates/eval/Cargo.toml` - Added `time` dependency reference
- `conformance/negative/pass1/import_escape.tenor` - Negative test for ../ traversal
- `conformance/negative/pass1/import_escape.expected-error.json` - Expected error for escape test
- `conformance/negative/pass1/missing_import.expected-error.json` - Updated error message for canonicalize-first path

## Decisions Made
- Sandbox root canonicalized once at load_bundle entry, then threaded through load_file as parameter
- Canonicalize failure produces "cannot resolve path" error (fail closed) rather than separate file-not-found check
- Updated missing_import expected error to match new canonicalize-first behavior (consistent error path)
- time crate 0.3 with parsing+macros features for calendar-correct validation
- DateTime validates first 19 chars (YYYY-MM-DDThh:mm:ss) allowing timezone suffixes

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Updated missing_import expected error for new canonicalize path**
- **Found during:** Task 1 (sandbox import path resolution)
- **Issue:** The new canonicalize-first approach changed the error message for missing imports from "file not found" to "cannot resolve path" since canonicalize now runs before the file existence check
- **Fix:** Updated `missing_import.expected-error.json` to match new error message
- **Files modified:** conformance/negative/pass1/missing_import.expected-error.json
- **Verification:** All 73 conformance tests pass
- **Committed in:** 24fae27 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Necessary error message update for consistency. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Import path security hardened for embedding tenor-core in server contexts
- Date/datetime validation calendar-correct for all eval use cases
- Ready for plan 14.1-04

---
*Phase: 14.1-tech-debt-bugs-hardening*
*Completed: 2026-02-23*
