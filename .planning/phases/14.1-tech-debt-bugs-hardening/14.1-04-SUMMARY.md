---
phase: 14.1-tech-debt-bugs-hardening
plan: 04
subsystem: cli
tags: [serde, deserialization, typed-json, explain, drift-detection]

# Dependency graph
requires:
  - phase: 14.1-01
    provides: version constants and manifest deduplication
provides:
  - ExplainBundle typed struct for interchange JSON deserialization
  - Loud failure on interchange format drift instead of silent output drops
  - Integration tests verifying all 4 explain sections present with content
affects: [explain, interchange-format]

# Tech tracking
tech-stack:
  added: []
  patterns: [typed-deserialization-over-untyped-traversal, serde-tagged-enum-for-heterogeneous-arrays]

key-files:
  created: []
  modified:
    - crates/cli/src/explain.rs
    - crates/cli/src/main.rs
    - crates/cli/tests/cli_integration.rs

key-decisions:
  - "Use serde tagged enum (#[serde(tag = \"kind\")]) for construct dispatch instead of manual string matching"
  - "Keep flow steps as serde_json::Value due to high polymorphism (5 step kinds with deeply nested expression trees)"
  - "Return Result<String, String> from explain() to surface deserialization errors to the CLI"
  - "error_contract field is Vec<String> not Option<String> -- discovered via integration test failure against real contracts"

patterns-established:
  - "Typed deserialization: define structs covering exactly what a consumer reads, use #[serde(default)] for optional fields, let serde ignore extra JSON fields"
  - "Drift detection via struct: if interchange format renames a field, deserialization either fails loudly or produces empty defaults caught by tests"

requirements-completed: []

# Metrics
duration: 13min
completed: 2026-02-23
---

# Phase 14.1 Plan 04: Typed Explain Deserialization Summary

**ExplainBundle struct with serde::Deserialize replaces 75+ untyped JSON traversals in explain.rs, catching interchange format drift at parse time**

## Performance

- **Duration:** 13 min
- **Started:** 2026-02-23T00:38:46Z
- **Completed:** 2026-02-23T00:51:45Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- Replaced all construct-level untyped JSON traversal (.as_str()/.as_array()/.as_object() chains) with typed ExplainBundle struct using serde::Deserialize
- Interchange format changes now cause loud deserialization errors instead of silently dropping output sections
- explain() returns Result<String, String> allowing cmd_explain to surface parse failures with non-zero exit code
- Added 3 unit tests (deserialization round-trip, end-to-end output, wrong-type detection) and 2 integration tests (terminal + markdown section completeness)
- Output is byte-for-byte identical for all 17 domain contracts

## Task Commits

Each task was committed atomically:

1. **Task 1: Define ExplainBundle struct and migrate explain.rs to typed deserialization** - `721528d` (feat)
2. **Task 2: Add explain integration test for format drift detection** - `972ee08` (test)

## Files Created/Modified
- `crates/cli/src/explain.rs` - ExplainBundle struct, ExplainConstruct tagged enum, typed sub-structs, Result return type, 3 unit tests
- `crates/cli/src/main.rs` - Updated cmd_explain to handle Result<String, String> from explain()
- `crates/cli/tests/cli_integration.rs` - 2 new integration tests verifying section presence in terminal and markdown formats

## Decisions Made
- Used `#[serde(tag = "kind")]` for ExplainConstruct enum to match interchange format's internally-tagged constructs
- Kept flow steps as `serde_json::Value` -- the 5 step types (OperationStep, BranchStep, HandoffStep, SubFlowStep, ParallelStep) with their deeply nested condition/outcome expression trees would require extensive type definitions for minimal benefit
- Used `#[serde(other)]` to silently skip unknown construct kinds (TypeDecl, System) that explain.rs doesn't render
- Added `#[allow(dead_code)]` on ExplainRule and ExplainOperation for fields used only in test drift detection assertions

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] error_contract field type mismatch**
- **Found during:** Task 1 (integration test failures against real contracts)
- **Issue:** Plan specified `error_contract: Option<String>` but actual interchange format uses `Vec<String>` (array of error outcome names)
- **Fix:** Changed to `error_contract: Vec<String>` and updated test fixture
- **Files modified:** crates/cli/src/explain.rs
- **Verification:** All 4 previously-failing integration tests now pass
- **Committed in:** 721528d (part of Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Corrected type for real interchange format. No scope creep.

## Issues Encountered
None beyond the error_contract type fix documented above.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- explain.rs now has typed deserialization foundation
- Future interchange format changes will be caught at compile/test time
- Ready for plan 14.1-05

---
*Phase: 14.1-tech-debt-bugs-hardening*
*Completed: 2026-02-23*
