---
phase: 17-vs-code-extension
plan: 05
type: execute
wave: 4
depends_on: ["17-03", "17-04"]
files_modified:
  - editors/vscode/package.json
  - editors/vscode/src/extension.ts
  - editors/vscode/src/commands.ts
  - editors/vscode/src/statusBar.ts
  - editors/vscode/snippets/tenor.json
autonomous: false
requirements: [DEVX-01, DEVX-02, DEVX-03, DEVX-04]

must_haves:
  truths:
    - "Status bar shows checkmark when .tenor file is valid, X with error count on errors, spinner during elaboration"
    - "All command palette commands work: Open Agent Capabilities, Elaborate File, Validate Project, New Tenor File, Show Elaboration Output, Run Conformance Tests, Open Docs"
    - "Snippets scaffold new construct skeletons when typing construct keywords"
    - "Extension provides a polished end-to-end authoring experience"
  artifacts:
    - path: "editors/vscode/src/commands.ts"
      provides: "Command palette command implementations"
      min_lines: 60
    - path: "editors/vscode/src/statusBar.ts"
      provides: "Status bar item showing elaboration status"
      min_lines: 30
    - path: "editors/vscode/snippets/tenor.json"
      provides: "Snippet definitions for Tenor construct scaffolding"
      min_lines: 50
  key_links:
    - from: "editors/vscode/src/extension.ts"
      to: "editors/vscode/src/commands.ts"
      via: "command registration in activate()"
      pattern: "registerCommand"
    - from: "editors/vscode/src/statusBar.ts"
      to: "editors/vscode/src/extension.ts"
      via: "status bar updated on diagnostic events"
      pattern: "updateStatusBar"
    - from: "editors/vscode/package.json"
      to: "editors/vscode/snippets/tenor.json"
      via: "snippets contribution point"
      pattern: "snippets"
---

<objective>
Complete the VS Code extension with command palette commands, status bar indicator, construct snippets, and end-to-end polish.

Purpose: This plan brings together all the pieces built in plans 01-04 into a cohesive, polished extension. The status bar gives instant feedback, commands expose the full toolchain, and snippets accelerate authoring. After this plan, the extension is ready for packaging and distribution.

Output: Complete VS Code extension with all user-facing features wired up and verified.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-vs-code-extension/17-03-SUMMARY.md
@.planning/phases/17-vs-code-extension/17-04-SUMMARY.md
@editors/vscode/src/extension.ts
@editors/vscode/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement commands, status bar, and snippets</name>
  <files>
    editors/vscode/src/commands.ts
    editors/vscode/src/statusBar.ts
    editors/vscode/snippets/tenor.json
    editors/vscode/package.json
    editors/vscode/src/extension.ts
  </files>
  <action>
**editors/vscode/snippets/tenor.json:**
Snippet definitions for Tenor construct scaffolding:

- `entity`: prefix "entity", body:
  ```
  entity ${1:EntityName} {
    states: [${2:initial}, ${3:final}]
    initial_state: ${2:initial}
  }
  ```
- `fact`: prefix "fact", body: `fact ${1:fact_name} : ${2|Int,Decimal,Money,Bool,String,Date,DateTime,Duration,Enum,Record,List|} ${3:= ${4:default}}`
- `rule`: prefix "rule", body:
  ```
  rule ${1:rule_name} {
    when ${2:condition}
    then ${3:VerdictType}(${4:payload})
  }
  ```
- `operation`: prefix "operation", body:
  ```
  operation ${1:op_name} {
    allowed_personas: [${2:persona}]
    precondition: ${3:condition}
    effects: {
      ${4:Entity}: ${5:from_state} -> ${6:to_state}
    }
  }
  ```
- `flow`: prefix "flow", body:
  ```
  flow ${1:flow_name} {
    entry_point: ${2:step1}
    steps: {
      ${2:step1}: OperationStep {
        operation: ${3:op_name}
        on_success: Terminate
      }
    }
  }
  ```
- `persona`: prefix "persona", body: `persona ${1:persona_name}`
- `type`: prefix "type", body: `type ${1:TypeName} = ${2|Record,Enum,TaggedUnion|} { ${3:fields} }`
- `import`: prefix "import", body: `import "${1:path/to/file.tenor}"`
- `system`: prefix "system", body:
  ```
  system ${1:system_name} {
    members: {
      ${2:contract_id}: "${3:path/to/contract.tenor}"
    }
  }
  ```

**editors/vscode/package.json** updates:
- Add `contributes.snippets`: [{language: "tenor", path: "./snippets/tenor.json"}]
- Add all commands to `contributes.commands`:
  1. `tenor.openAgentCapabilities` — "Tenor: Open Agent Capabilities Panel" (already from Plan 04)
  2. `tenor.elaborateFile` — "Tenor: Elaborate File"
  3. `tenor.validateProject` — "Tenor: Validate Project"
  4. `tenor.newTenorFile` — "Tenor: New Tenor File (from template)"
  5. `tenor.showElaborationOutput` — "Tenor: Show Elaboration Output (JSON)"
  6. `tenor.runConformanceTests` — "Tenor: Run Conformance Tests"
  7. `tenor.openDocs` — "Tenor: Open Documentation"
- Add menus: editor/title for .tenor files (elaborate, agent capabilities)

**editors/vscode/src/statusBar.ts:**
- `StatusBarManager` class:
  - Creates `vscode.StatusBarItem` with `StatusBarAlignment.Right`, priority 100
  - Show when a .tenor file is active (use `vscode.window.onDidChangeActiveTextEditor`)
  - Methods:
    - `showValid()`: text = "$(check) Tenor", tooltip = "No errors", color = default
    - `showErrors(count)`: text = "$(x) Tenor: ${count} error(s)", tooltip = "Click to show errors", color = `statusBarItem.errorForeground`, command = `workbench.action.showErrorsWarnings`
    - `showLoading()`: text = "$(sync~spin) Tenor", tooltip = "Elaborating..."
    - `hide()`: hide when no .tenor file is active
  - Listen for diagnostic changes from the language client to auto-update

**editors/vscode/src/commands.ts:**
- `registerCommands(context, client)`:
  1. `tenor.elaborateFile`:
     - Get active .tenor file
     - Run `tenor elaborate <file>` via child_process.exec
     - Show output in a new editor tab
  2. `tenor.validateProject`:
     - Find all .tenor files in workspace
     - Run `tenor elaborate` on each, collect results
     - Show summary in output channel
  3. `tenor.newTenorFile`:
     - Show quickpick: "Empty contract", "Entity + Operation", "Full contract skeleton"
     - Create new untitled document with template content
  4. `tenor.showElaborationOutput`:
     - Run `tenor elaborate <active-file>` and capture JSON output
     - Open JSON in new editor with language set to JSON
  5. `tenor.runConformanceTests`:
     - Run `tenor test conformance` in integrated terminal
  6. `tenor.openDocs`:
     - Open `https://tenor-lang.org/docs` in browser (or local docs/guide/author-guide.md if exists)

**editors/vscode/src/extension.ts** updates:
- Import and call `registerCommands(context, client)` in activate()
- Import and create `StatusBarManager` in activate()
- Wire status bar to language client diagnostics:
  - Listen to `client.onNotification('textDocument/publishDiagnostics', ...)` or use `vscode.languages.onDidChangeDiagnostics`
  - On diagnostic change for .tenor files: update status bar (showValid or showErrors)
- Wire status bar loading state: before sending elaborate request, show loading; after response, show result

Run `cd editors/vscode && npm install && npm run compile`.

Also run the full Rust quality gate:
```
cargo fmt --all
cargo build --workspace
cargo test --workspace
cargo run -p tenor-cli -- test conformance
cargo clippy --workspace -- -D warnings
```
  </action>
  <verify>
`cd editors/vscode && npm run compile` succeeds.
All Rust quality gates pass.
All command palette commands are registered (check package.json contributes.commands has 7 entries).
Snippets file is valid JSON.
  </verify>
  <done>All command palette commands work. Status bar shows elaboration status (checkmark, X with error count, spinner). Snippets scaffold new construct skeletons. Extension is feature-complete.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end extension verification</name>
  <files>editors/vscode/</files>
  <action>
Human verifies the complete VS Code extension for Tenor with syntax highlighting, LSP diagnostics, semantic tokens, navigation, Agent Capabilities panel, commands, status bar, and snippets.

Steps:
1. Open VS Code with the extension: `code --extensionDevelopmentPath=editors/vscode .`
2. Open `conformance/positive/escrow.tenor`:
   - Verify syntax highlighting: keywords colored, strings colored, comments dimmed
   - Verify status bar shows checkmark (valid file)
   - Verify no error diagnostics
3. Open `conformance/negative/duplicate_fact.tenor` (or create a .tenor file with a syntax error):
   - Verify red squiggly appears at the error location
   - Verify status bar shows X with error count
4. Test semantic tokens:
   - In escrow.tenor, verify fact references, entity names, and type names have distinct colors
5. Test navigation:
   - Ctrl+click on a fact reference in a rule — jumps to the fact declaration
   - Hover over an operation name — shows persona list and effects
   - Type inside a rule's when block — completions offer fact names
6. Test Agent Capabilities panel:
   - Open Command Palette > "Tenor: Open Agent Capabilities Panel"
   - Verify operations grouped by persona
   - Verify entity state machine SVG diagrams render
   - Verify analysis findings section present
   - Save the file — panel should auto-refresh
7. Test snippets:
   - In a new .tenor file, type "entity" and select the snippet — skeleton appears
8. Test commands:
   - "Tenor: Show Elaboration Output (JSON)" — opens JSON in new tab
   - "Tenor: New Tenor File" — creates template file

Type "approved" if the extension works correctly, or describe specific issues to fix.
  </action>
  <verify>All 8 verification steps above pass visual inspection.</verify>
  <done>Extension verified end-to-end by human. Syntax highlighting, diagnostics, navigation, Agent Capabilities panel, commands, status bar, and snippets all working correctly.</done>
</task>

</tasks>

<verification>
1. All Rust quality gates pass
2. VS Code extension compiles and loads
3. All 7 command palette commands registered
4. Status bar updates correctly on save
5. Snippets work for all 9 construct types
6. End-to-end user flow verified (human checkpoint)
</verification>

<success_criteria>
- Complete VS Code extension with all DEVX-01 through DEVX-04 requirements met
- Status bar provides instant elaboration feedback
- All command palette commands functional
- Snippets accelerate contract authoring
- Extension verified by human testing
</success_criteria>

<output>
After completion, create `.planning/phases/17-vs-code-extension/17-05-SUMMARY.md`
</output>
