---
phase: 17-vs-code-extension
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - editors/vscode/package.json
  - editors/vscode/tsconfig.json
  - editors/vscode/.vscodeignore
  - editors/vscode/syntaxes/tenor.tmLanguage.json
  - editors/vscode/language-configuration.json
  - editors/vscode/src/extension.ts
  - editors/vscode/.gitignore
autonomous: true
requirements: [DEVX-01]

must_haves:
  truths:
    - "Opening a .tenor file in VS Code shows syntax highlighting with keywords, strings, comments, and construct blocks colored distinctly"
    - "Bracket matching works for { } in .tenor files"
    - "Code folding collapses construct blocks (entity, rule, operation, flow, etc.)"
    - "Extension activates on .tenor file open"
  artifacts:
    - path: "editors/vscode/package.json"
      provides: "VS Code extension manifest with language contribution, grammar, and activation events"
      contains: "tenor"
    - path: "editors/vscode/syntaxes/tenor.tmLanguage.json"
      provides: "TextMate grammar for Tenor DSL syntax highlighting"
      contains: "source.tenor"
    - path: "editors/vscode/language-configuration.json"
      provides: "Language configuration for bracket matching, folding, and comment toggling"
      contains: "autoClosingPairs"
    - path: "editors/vscode/src/extension.ts"
      provides: "Extension entry point with activation and deactivation"
  key_links:
    - from: "editors/vscode/package.json"
      to: "editors/vscode/syntaxes/tenor.tmLanguage.json"
      via: "grammars contribution point"
      pattern: "syntaxes/tenor.tmLanguage.json"
    - from: "editors/vscode/package.json"
      to: "editors/vscode/language-configuration.json"
      via: "languages contribution point"
      pattern: "language-configuration.json"
---

<objective>
Scaffold the VS Code extension and implement TextMate grammar for Tenor DSL syntax highlighting.

Purpose: Establish the extension package structure and deliver immediate visual value — authors opening .tenor files see keywords, strings, comments, construct blocks, and field names colored by their existing theme. This is the foundation all subsequent plans build on.

Output: A working VS Code extension that provides syntax highlighting, bracket matching, and code folding for .tenor files.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/TENOR.md (sections 1-12 for DSL keyword/syntax reference)
@crates/core/src/lexer.rs (canonical token definitions)
@crates/core/src/parser.rs (construct syntax patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold VS Code extension package</name>
  <files>
    editors/vscode/package.json
    editors/vscode/tsconfig.json
    editors/vscode/.vscodeignore
    editors/vscode/src/extension.ts
    editors/vscode/.gitignore
  </files>
  <action>
Create the `editors/vscode/` directory structure for a VS Code extension.

**package.json:**
- `name`: "tenor-lang"
- `displayName`: "Tenor"
- `description`: "Syntax highlighting, LSP diagnostics, and agent capabilities preview for Tenor contracts"
- `publisher`: "tenor-lang" (placeholder)
- `version`: "0.1.0"
- `engines.vscode`: "^1.85.0"
- `categories`: ["Programming Languages"]
- `activationEvents`: ["onLanguage:tenor"]
- `main`: "./out/extension.js"
- `contributes.languages`: [{id: "tenor", aliases: ["Tenor", "tenor"], extensions: [".tenor"], configuration: "./language-configuration.json"}]
- `contributes.grammars`: [{language: "tenor", scopeName: "source.tenor", path: "./syntaxes/tenor.tmLanguage.json"}]
- `scripts`: {"compile": "tsc -p .", "watch": "tsc -watch -p .", "package": "npx @vscode/vsce package"}
- `devDependencies`: {"@types/vscode": "^1.85.0", "@types/node": "^22", "typescript": "~5.7"}

Do NOT add vscode-languageclient yet — that comes in Plan 02.

**tsconfig.json:**
- target: ES2022, module: Node16, moduleResolution: Node16
- outDir: "./out", rootDir: "./src"
- strict: true, sourceMap: true
- lib: ["ES2022"]

**.vscodeignore:** Exclude src/, node_modules/, .gitignore, tsconfig.json. Include out/, syntaxes/, language-configuration.json, package.json.

**.gitignore:** out/, node_modules/

**src/extension.ts:** Minimal activate/deactivate functions. activate() logs "Tenor extension activated" to output channel. Export both functions.

Run `cd editors/vscode && npm install && npm run compile` to verify the package builds.
  </action>
  <verify>
`cd editors/vscode && npm run compile` succeeds without errors.
`ls editors/vscode/out/extension.js` exists.
  </verify>
  <done>VS Code extension package scaffolded with build pipeline working. Extension entry point compiles to JS.</done>
</task>

<task type="auto">
  <name>Task 2: Create TextMate grammar and language configuration</name>
  <files>
    editors/vscode/syntaxes/tenor.tmLanguage.json
    editors/vscode/language-configuration.json
  </files>
  <action>
**language-configuration.json:**
- comments: lineComment "//", blockComment ["/*", "*/"]
- brackets: [["{", "}"], ["[", "]"], ["(", ")"]]
- autoClosingPairs: braces, brackets, parens, double quotes
- surroundingPairs: same as autoClosingPairs
- folding: offSide false, markers begin "^\\s*(?:entity|rule|operation|flow|system|type|fact|persona)\\s+", end "^\\s*\\}"
- indentationRules: increaseIndentPattern for lines ending with `{`, decreaseIndentPattern for lines starting with `}`

**syntaxes/tenor.tmLanguage.json** — TextMate grammar with scopeName "source.tenor":

Map to STANDARD TextMate scopes so the grammar blends with the user's existing theme:

1. **Comments:** `comment.line.double-slash.tenor`, `comment.block.tenor`
2. **Keywords — construct declarations:** `keyword.declaration.tenor` for: `fact`, `entity`, `rule`, `operation`, `flow`, `system`, `type`, `persona`
3. **Keywords — control/structural:** `keyword.control.tenor` for: `import`, `when`, `then`, `where`, `precondition`, `postcondition`, `on_success`, `on_failure`, `entry_point`
4. **Keywords — operators:** `keyword.operator.tenor` for: `and`, `or`, `not`, `forall`, `exists`, `->`, `→`
5. **Strings:** `string.quoted.double.tenor` for double-quoted strings with escape sequences
6. **Numbers:** `constant.numeric.tenor` for integer, decimal, and money literals (including currency prefix like `USD 100.00`)
7. **Booleans:** `constant.language.boolean.tenor` for `true`, `false`
8. **Types — built-in base types:** `support.type.tenor` for: `Int`, `Decimal`, `Money`, `Bool`, `String`, `Date`, `DateTime`, `Duration`, `Enum`, `Record`, `List`, `TaggedUnion`
9. **Identifiers — construct names:** After a construct keyword, match the name as `entity.name.type.tenor`
10. **Field labels:** Match patterns like `word:` at start of indented lines as `variable.other.property.tenor` (for fields within constructs like `states:`, `allowed_personas:`, `effects:`, etc.)
11. **Punctuation:** `punctuation.definition.block.tenor` for `{` `}`, `punctuation.separator.tenor` for `,`
12. **Fact references:** Match `identifier` patterns inside `when`/`precondition` blocks as default scope (semantic tokens will upgrade these in Plan 02)

Key patterns to match from the Tenor lexer:
- Line comments: `//` to end of line
- Block comments: `/* ... */` (nestable if possible, otherwise basic)
- Construct blocks: `keyword identifier { ... }`
- State lists in entities: `states: [word, word, ...]`
- Transitions: `word -> word` or `word → word`
- Verdict type declarations: `type: Approval | Denial`
- Money literals: `USD 100.00`, `EUR 50`
- Import statements: `import "path/to/file.tenor"`

Use repository patterns to keep the grammar DRY. Use `begin`/`end` patterns for construct blocks to scope nested content.

Ensure the grammar handles multi-line constructs correctly — construct bodies can span many lines.
  </action>
  <verify>
`cd editors/vscode && npm run compile` still succeeds.
Open a .tenor file from conformance/positive/ in VS Code with the extension loaded (via `code --extensionDevelopmentPath=editors/vscode conformance/positive/escrow.tenor`) and verify keywords are colored distinctly from identifiers, strings, and comments.
  </verify>
  <done>TextMate grammar highlights Tenor DSL keywords, strings, comments, numbers, types, construct names, field labels, and punctuation using standard TextMate scopes. Bracket matching and code folding work for construct blocks.</done>
</task>

</tasks>

<verification>
1. Extension package builds: `cd editors/vscode && npm run compile` exits 0
2. Grammar file is valid JSON: `node -e "JSON.parse(require('fs').readFileSync('editors/vscode/syntaxes/tenor.tmLanguage.json'))"` exits 0
3. Language configuration is valid JSON: same check for language-configuration.json
4. Opening escrow.tenor shows colored syntax (manual spot check or screenshot)
5. Folding markers collapse construct blocks
6. Bracket matching highlights paired { }
</verification>

<success_criteria>
- VS Code extension package scaffolded at editors/vscode/ with working build
- TextMate grammar provides syntax highlighting for all Tenor DSL constructs
- Bracket matching and code folding functional
- Grammar maps to standard TextMate scopes (no custom theme required)
</success_criteria>

<output>
After completion, create `.planning/phases/17-vs-code-extension/17-01-SUMMARY.md`
</output>
