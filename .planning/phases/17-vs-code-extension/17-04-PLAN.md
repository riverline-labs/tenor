---
phase: 17-vs-code-extension
plan: 04
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - editors/vscode/src/agentPanel.ts
  - editors/vscode/src/svgRenderer.ts
  - editors/vscode/media/panel.css
  - editors/vscode/media/panel.js
  - editors/vscode/src/extension.ts
  - editors/vscode/package.json
  - crates/lsp/src/agent_capabilities.rs
  - crates/lsp/src/server.rs
  - crates/lsp/src/lib.rs
autonomous: true
requirements: [DEVX-04]

must_haves:
  truths:
    - "Opening the Agent Capabilities panel shows operations grouped by persona with parameters and types"
    - "Entity state machines are rendered as SVG diagrams showing states and transitions"
    - "Analysis insights (coverage gaps, unreachable states, dead-end flows) appear in the panel"
    - "Panel updates automatically on save and has a manual refresh button"
    - "Panel uses rich HTML/CSS rendering in a webview, not a tree view"
  artifacts:
    - path: "editors/vscode/src/agentPanel.ts"
      provides: "Webview panel provider showing agent capabilities"
      min_lines: 100
    - path: "editors/vscode/src/svgRenderer.ts"
      provides: "SVG generation for entity state machine diagrams"
      min_lines: 60
    - path: "editors/vscode/media/panel.css"
      provides: "Styling for the agent capabilities webview panel"
      min_lines: 30
    - path: "crates/lsp/src/agent_capabilities.rs"
      provides: "Agent capabilities data extraction from elaborated bundle and analysis"
      min_lines: 80
  key_links:
    - from: "editors/vscode/src/agentPanel.ts"
      to: "crates/lsp/src/agent_capabilities.rs"
      via: "custom LSP request tenor/agentCapabilities"
      pattern: "tenor/agentCapabilities"
    - from: "crates/lsp/src/agent_capabilities.rs"
      to: "crates/core/src/elaborate.rs"
      via: "elaborate() for interchange JSON"
      pattern: "elaborate"
    - from: "crates/lsp/src/agent_capabilities.rs"
      to: "crates/analyze/src/lib.rs"
      via: "analyze() for coverage and reachability findings"
      pattern: "tenor_analyze::analyze"
    - from: "editors/vscode/src/svgRenderer.ts"
      to: "editors/vscode/src/agentPanel.ts"
      via: "SVG diagram generation called from panel render"
      pattern: "renderStateMachine"
---

<objective>
Implement the Agent Capabilities webview panel that shows what an AI agent would see when reading the contract, plus static analysis insights.

Purpose: This is the differentiating feature — authors see their contract through the agent's eyes before deployment. Operations grouped by persona, entity state machines as visual diagrams, preconditions/postconditions, and analysis warnings about coverage gaps and unreachable states. It answers "is my contract ready for agents?"

Output: A rich webview panel with agent operational view, entity state machine SVG diagrams, and analysis insights that updates on save.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-vs-code-extension/17-02-SUMMARY.md
@crates/analyze/src/lib.rs
@crates/analyze/src/report.rs
@crates/cli/src/explain.rs
@crates/lsp/src/server.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement agent capabilities data extraction and LSP endpoint</name>
  <files>
    crates/lsp/src/agent_capabilities.rs
    crates/lsp/src/server.rs
    crates/lsp/src/lib.rs
  </files>
  <action>
**crates/lsp/src/agent_capabilities.rs:**

Define response structures (serializable with serde):

```rust
pub struct AgentCapabilities {
    pub contract_id: String,
    pub personas: Vec<PersonaView>,
    pub entities: Vec<EntityView>,
    pub operations: Vec<OperationView>,
    pub flows: Vec<FlowView>,
    pub analysis_findings: Vec<Finding>,
    pub error: Option<String>,  // if elaboration/analysis failed
}

pub struct PersonaView {
    pub id: String,
    pub operations: Vec<String>,  // operation IDs this persona can call
}

pub struct EntityView {
    pub id: String,
    pub states: Vec<String>,
    pub initial_state: String,
    pub transitions: Vec<(String, String)>,  // (from_state, to_state)
}

pub struct OperationView {
    pub id: String,
    pub allowed_personas: Vec<String>,
    pub parameters: Vec<ParameterInfo>,  // fact refs used in preconditions as "inputs"
    pub preconditions: Vec<String>,      // human-readable precondition summaries
    pub effects: Vec<EffectInfo>,        // entity state changes
    pub outcomes: Vec<String>,
    pub postconditions: Vec<String>,
}

pub struct ParameterInfo {
    pub name: String,
    pub fact_type: String,
}

pub struct EffectInfo {
    pub entity: String,
    pub transition: String,  // "from -> to"
}

pub struct FlowView {
    pub id: String,
    pub entry_point: String,
    pub step_count: usize,
    pub step_summary: Vec<String>,  // brief description of each step
}

pub struct Finding {
    pub severity: String,   // "warning" or "info"
    pub analysis: String,   // S1, S2, etc.
    pub message: String,
}
```

`compute_agent_capabilities(file_path: &Path) -> AgentCapabilities`:
1. Call `tenor_core::elaborate::elaborate(file_path)`:
   - On error: return AgentCapabilities with `error` set and empty lists
2. Parse the interchange JSON to extract:
   - Personas: list of persona IDs
   - Entities: ID, states array, initial_state, derive transitions from operations' effects
   - Operations: ID, allowed_personas, facts referenced in preconditions (as parameters), effects as entity state changes, outcomes
   - Flows: ID, entry_point, step count, brief step descriptions
   - Group operations by persona (PersonaView)
3. Call `tenor_analyze::analyze(&bundle)`:
   - On error: skip analysis (non-fatal)
   - On success: extract findings from the AnalysisReport
   - Map S1-S8 findings to human-readable messages:
     - S1 (state space): mention any entities with missing initial states
     - S2 (persona coverage): list operations no persona can call
     - S3 (dead code): list unreferenced facts or unused types
     - S4 (authority): summarize persona-operation matrix
     - S5 (flow reachability): list unreachable flow steps
     - S6 (flow paths): list dead-end flows
     - S7 (coverage): list entities never modified by any operation
     - S8 (verdict uniqueness): list duplicate verdict rules

**crates/lsp/src/server.rs** updates:
- Register custom request: `tenor/agentCapabilities` (custom method)
- Handle the request: takes TextDocumentIdentifier parameter, calls compute_agent_capabilities, returns JSON
- Also send capabilities data proactively after diagnostics on save (as a custom notification `tenor/agentCapabilitiesUpdated`) so the panel can auto-refresh

**crates/lsp/src/lib.rs:** Add `pub mod agent_capabilities;`

Run `cargo build --workspace && cargo clippy --workspace -- -D warnings`.
  </action>
  <verify>
`cargo build --workspace` succeeds.
`cargo clippy --workspace -- -D warnings` passes.
`cargo test --workspace` passes.
  </verify>
  <done>Agent capabilities data extraction works for all contract constructs. Custom LSP request returns structured JSON with personas, entities, operations, flows, and analysis findings. Server sends updated capabilities on save.</done>
</task>

<task type="auto">
  <name>Task 2: Build Agent Capabilities webview panel with SVG state diagrams</name>
  <files>
    editors/vscode/src/agentPanel.ts
    editors/vscode/src/svgRenderer.ts
    editors/vscode/media/panel.css
    editors/vscode/media/panel.js
    editors/vscode/src/extension.ts
    editors/vscode/package.json
  </files>
  <action>
**editors/vscode/package.json** updates:
- Add command: `tenor.openAgentCapabilities` (title: "Tenor: Open Agent Capabilities Panel")
- Add command to contributes.commands array
- Add keybinding: Ctrl+Shift+T (Cmd+Shift+T on Mac) for the command

**editors/vscode/src/svgRenderer.ts:**
- `renderStateMachine(entity: EntityView): string`:
  1. Layout algorithm: arrange states in a circle or horizontal line depending on count
     - 2-4 states: horizontal layout with even spacing
     - 5+ states: circular layout
  2. Each state is a rounded rectangle with the state name centered inside
  3. Initial state has a bold border or double outline
  4. Transitions are curved arrows between states with arrowhead markers
  5. Self-transitions (same state to same state) rendered as small loops above the state
  6. SVG uses VS Code CSS variables for colors so it matches the user's theme:
     - `var(--vscode-foreground)` for text
     - `var(--vscode-editor-background)` for state fill
     - `var(--vscode-badge-background)` for initial state accent
     - `var(--vscode-editorWidget-border)` for borders and arrows
  7. Return complete SVG string (viewBox-based, responsive sizing)

**editors/vscode/media/panel.css:**
- Style the panel sections: Operations, Entities, Flows, Analysis
- Use VS Code CSS variables throughout (`--vscode-*`) for theme integration
- Section headers with expand/collapse toggles
- Operations grouped by persona with persona name as section header
- Operation cards showing: name, parameters table, preconditions list, effects list, outcomes badges
- Entity section with SVG diagrams inline
- Findings section with warning/info icons and colored severity badges
- Responsive layout that works in side panel or bottom panel positions
- Loading spinner for when elaboration is running

**editors/vscode/media/panel.js:**
- Handle messages from the extension:
  - `update`: receive AgentCapabilities data, re-render the panel
  - `loading`: show loading spinner
  - `error`: show error message with the elaboration error
- Render functions:
  - `renderPersonaOperations(personas, operations)`: group operations by persona, render operation cards
  - `renderEntities(entities)`: render entity cards with inline SVG state diagrams
  - `renderFlows(flows)`: render flow summaries
  - `renderFindings(findings)`: render analysis findings with severity styling
- Refresh button handler: post `refresh` message back to extension
- Expand/collapse section toggles

**editors/vscode/src/agentPanel.ts:**
- `AgentCapabilitiesPanel` class:
  - Static `currentPanel` singleton reference
  - `createOrShow(extensionUri, client)`: create new panel or reveal existing
  - Constructor: create webview panel with `tenor.agentCapabilities` viewType
  - `title`: "Agent Capabilities"
  - `viewColumn`: ViewColumn.Beside
  - `webviewOptions`: enableScripts: true, localResourceRoots for media/
  - `getHtmlContent()`: return full HTML document with:
    - panel.css linked via webview URI
    - panel.js linked via webview URI
    - Initial "loading..." content
  - `refresh(uri: string)`: send `tenor/agentCapabilities` request to LSP client, post `update` message to webview with response data
  - Listen for webview messages: `refresh` → call refresh()
  - `dispose()`: clean up panel reference

**editors/vscode/src/extension.ts** updates:
- Import AgentCapabilitiesPanel
- Register command `tenor.openAgentCapabilities`:
  1. Get active text editor
  2. If it's a .tenor file, create/show AgentCapabilitiesPanel
  3. Trigger initial refresh with the file URI
- Listen for `tenor/agentCapabilitiesUpdated` notifications from LSP:
  1. If AgentCapabilitiesPanel is visible, refresh it with the updated data
- This way panel auto-refreshes on save

Run `cd editors/vscode && npm install && npm run compile`.

Also run the full Rust quality gate to ensure no regressions:
```
cargo fmt --all
cargo build --workspace
cargo test --workspace
cargo run -p tenor-cli -- test conformance
cargo clippy --workspace -- -D warnings
```
  </action>
  <verify>
`cd editors/vscode && npm run compile` succeeds.
All Rust quality gates pass.
Opening the Agent Capabilities panel on a conformance .tenor file shows operations grouped by persona, entity state diagrams, and analysis findings.
  </verify>
  <done>Agent Capabilities webview panel renders the agent's operational view with operations grouped by persona, entity state machine SVG diagrams, analysis insights, and auto-refresh on save with manual refresh button.</done>
</task>

</tasks>

<verification>
1. All Rust quality gates pass: `cargo fmt --all && cargo build --workspace && cargo test --workspace && cargo run -p tenor-cli -- test conformance && cargo clippy --workspace -- -D warnings`
2. VS Code extension compiles: `cd editors/vscode && npm run compile`
3. Agent Capabilities panel opens via command palette
4. Panel shows operations grouped by persona with parameter types
5. Entity state machines render as SVG diagrams with states and transitions
6. Analysis findings appear with severity indicators
7. Panel auto-refreshes on save
8. Manual refresh button works
9. Panel handles elaboration errors gracefully (shows error message)
</verification>

<success_criteria>
- Agent Capabilities panel is a rich webview with HTML/CSS rendering
- Operations grouped by persona with parameters, preconditions, effects, outcomes
- Entity state machines as visual SVG diagrams using VS Code theme colors
- Analysis insights from tenor-analyze displayed with severity levels
- Panel updates on save and has a manual refresh button
- Panel handles errors gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/17-vs-code-extension/17-04-SUMMARY.md`
</output>
