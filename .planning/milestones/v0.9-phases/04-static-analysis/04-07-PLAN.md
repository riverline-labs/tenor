---
phase: 04-static-analysis
plan: 07
type: execute
wave: 5
depends_on: [06]
files_modified:
  - crates/analyze/tests/analysis_tests.rs
  - conformance/analysis/dead_states.tenor
  - conformance/analysis/authority_basic.tenor
  - conformance/analysis/flow_branching.tenor
autonomous: true
requirements: [TEST-03]

must_haves:
  truths:
    - "Each S1-S7 analysis has test coverage with at least one known-good contract"
    - "Dead state detection (S2) tested with a contract containing unreachable states"
    - "Structural unsatisfiability (S3a) tested with a contract containing type-incompatible preconditions"
    - "Flow path enumeration (S6) tested with a contract containing branching flows"
    - "Integration test: `tenor check` on integration_escrow.tenor produces expected analysis results"
  artifacts:
    - path: "crates/analyze/tests/analysis_tests.rs"
      provides: "Integration tests for all S1-S7 analyses"
      contains: "fn test_s1_escrow"
    - path: "conformance/analysis/"
      provides: "Dedicated analysis test fixtures"
      contains: "entity"
  key_links:
    - from: "crates/analyze/tests/analysis_tests.rs"
      to: "tenor_analyze::analyze"
      via: "Integration test calling analyze()"
      pattern: "tenor_analyze::analyze"
    - from: "crates/analyze/tests/analysis_tests.rs"
      to: "tenor_core::elaborate::elaborate"
      via: "Elaborate fixture then analyze"
      pattern: "elaborate::elaborate"
---

<objective>
Build the comprehensive test suite for the static analyzer, covering each S1-S7 analysis with known-good contracts and dedicated edge-case fixtures.

Purpose: Phase 04 success criterion 5 requires "each S1-S8 analysis has test coverage with known-good and known-bad contracts." This plan creates integration tests using the escrow fixture (primary known-good) plus dedicated analysis fixtures for edge cases (dead states, type mismatches, branching flows).

Output: Integration test suite in `crates/analyze/tests/` plus dedicated `.tenor` analysis fixtures.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-static-analysis/04-RESEARCH.md
@.planning/phases/04-static-analysis/04-CONTEXT.md

@crates/analyze/src/lib.rs
@crates/analyze/src/report.rs
@conformance/positive/integration_escrow.tenor
@conformance/positive/entity_basic.tenor
@conformance/positive/flow_basic.tenor
@conformance/positive/operation_basic.tenor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analysis test fixtures for edge cases</name>
  <files>
    conformance/analysis/dead_states.tenor
    conformance/analysis/authority_basic.tenor
    conformance/analysis/flow_branching.tenor
  </files>
  <action>
1. Create `conformance/analysis/` directory.

2. Create `conformance/analysis/dead_states.tenor`:
   - An Entity "order" with states: pending, confirmed, shipped, delivered, cancelled, archived
   - Initial: pending
   - Transitions: pending->confirmed, confirmed->shipped, shipped->delivered, pending->cancelled
   - "archived" is a dead state -- declared but unreachable from pending
   - Include minimal supporting constructs (a Fact and a Persona) to make it a valid contract

3. Create `conformance/analysis/authority_basic.tenor`:
   - Two personas: "admin" and "user"
   - An Entity "ticket" with states: open, in_progress, resolved, closed
   - Transitions: open->in_progress, in_progress->resolved, resolved->closed, open->closed
   - Operations:
     - "assign" (allowed_personas: admin, user) with effect ticket: open->in_progress
     - "resolve" (allowed_personas: user) with effect ticket: in_progress->resolved
     - "close" (allowed_personas: admin) with effect ticket: resolved->closed and open->closed
   - This tests S4 authority topology: admin can close from open and resolved; user can assign from open and resolve from in_progress

4. Create `conformance/analysis/flow_branching.tenor`:
   - A Flow with an OperationStep that has 2 outcomes
   - Outcome routing leads to different terminal steps
   - A BranchStep that routes based on a condition
   - This tests S6 flow path enumeration with multiple path types
   - Include supporting Entities, Facts, Personas, Rules, Operations as needed
  </action>
  <verify>
    Run `cargo run -p tenor-cli -- elaborate conformance/analysis/dead_states.tenor` -- must elaborate without error.
    Run `cargo run -p tenor-cli -- elaborate conformance/analysis/authority_basic.tenor` -- must elaborate without error.
    Run `cargo run -p tenor-cli -- elaborate conformance/analysis/flow_branching.tenor` -- must elaborate without error.
  </verify>
  <done>
    Three dedicated analysis fixtures created, each targeting specific analysis edge cases. All elaborate successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write integration tests for all S1-S7 analyses</name>
  <files>
    crates/analyze/tests/analysis_tests.rs
  </files>
  <action>
1. Create `crates/analyze/tests/analysis_tests.rs`:
   - Helper: `fn workspace_root() -> PathBuf` using CARGO_MANIFEST_DIR -> parent -> parent
   - Helper: `fn elaborate_and_analyze(fixture: &str) -> AnalysisReport` -- elaborate fixture path, then call tenor_analyze::analyze()
   - Helper: `fn elaborate_fixture(fixture: &str) -> serde_json::Value` -- just elaborate

2. S1 tests:
   - `test_s1_entity_basic`: elaborate entity_basic.tenor, verify S1 contains entity with correct states
   - `test_s1_escrow`: elaborate integration_escrow.tenor, verify all entities have their declared states

3. S2 tests:
   - `test_s2_all_reachable`: elaborate entity_basic.tenor, verify no dead states
   - `test_s2_dead_states`: elaborate dead_states.tenor, verify "archived" appears in unreachable_states

4. S3a tests:
   - `test_s3a_escrow`: elaborate integration_escrow.tenor, verify operations are structurally admissible where expected

5. S4 tests:
   - `test_s4_authority`: elaborate authority_basic.tenor, verify:
     - admin can invoke "close" in resolved and open states
     - user can invoke "resolve" in in_progress state
     - user cannot invoke "close" (not in allowed_personas)

6. S5 tests:
   - `test_s5_verdict_types`: elaborate rule_basic.tenor or integration_escrow.tenor, verify verdict types enumerated
   - `test_s5_operation_outcomes`: elaborate operation_outcomes.tenor, verify outcomes listed

7. S6 tests:
   - `test_s6_flow_paths`: elaborate flow_branching.tenor, verify multiple paths enumerated
   - `test_s6_escrow_flow`: elaborate integration_escrow.tenor, verify flow paths with correct step counts

8. S7 tests:
   - `test_s7_complexity`: elaborate integration_escrow.tenor, verify complexity bounds are populated
   - `test_s7_flow_depth`: verify max flow depth matches S6 results

9. Full integration test:
   - `test_full_analysis_escrow`: run analyze() on escrow, verify all S1-S8 fields populated
   - `test_analyze_selected`: run analyze_selected() with ["s1", "s2"], verify only S1 and S2 populated
  </action>
  <verify>
    Run `cargo test -p tenor-analyze` -- all unit and integration tests pass.
    Run `cargo test --workspace` -- no regressions.
  </verify>
  <done>
    Comprehensive test suite covering all S1-S7 analyses with known-good contracts and edge-case fixtures. Full integration test on escrow contract.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p tenor-analyze` -- all tests pass
2. `cargo test --workspace` -- no regressions
3. Each S1-S7 analysis has at least one test with a known-good fixture
4. Dead state detection tested and verified
5. Authority topology tested with multi-persona contract
6. Flow path enumeration tested with branching flow
7. Full analysis integration test on escrow fixture passes
</verification>

<success_criteria>
- Every S1-S7 analysis has test coverage
- Dead state edge case tested (S2)
- Authority multi-persona edge case tested (S4)
- Flow branching edge case tested (S6)
- Integration test on escrow produces complete AnalysisReport
- analyze_selected() tested for partial analysis runs
- All fixtures elaborate without error
</success_criteria>

<output>
After completion, create `.planning/phases/04-static-analysis/04-07-SUMMARY.md`
</output>
