---
phase: 04-static-analysis
plan: 03
type: execute
wave: 2
depends_on: [02]
files_modified:
  - crates/analyze/src/s4_authority.rs
  - crates/analyze/src/s5_verdicts.rs
  - crates/analyze/src/lib.rs
autonomous: true
requirements: [ANLZ-04, ANLZ-05]

must_haves:
  truths:
    - "S4 derives the authority topology: for each persona and entity state, which Operations that persona can invoke"
    - "S4 answers whether a persona can cause a specific state transition S->S'"
    - "S5 enumerates all possible verdict types from rules and all possible outcomes per Operation"
    - "S5 result includes operation-to-outcome mapping suitable for S6 flow path enumeration"
  artifacts:
    - path: "crates/analyze/src/s4_authority.rs"
      provides: "S4 authority topology mapping"
      contains: "pub fn analyze_authority"
    - path: "crates/analyze/src/s5_verdicts.rs"
      provides: "S5 verdict and outcome space enumeration"
      contains: "pub fn analyze_verdict_space"
  key_links:
    - from: "crates/analyze/src/s4_authority.rs"
      to: "crates/analyze/src/s3a_admissibility.rs"
      via: "Refines admissibility with persona authority mapping"
      pattern: "S3aResult"
    - from: "crates/analyze/src/s5_verdicts.rs"
      to: "crates/analyze/src/bundle.rs"
      via: "Extracts verdict types from rules and outcomes from operations"
      pattern: "AnalysisBundle"
---

<objective>
Implement S4 (Authority Topology) and S5 (Verdict and Outcome Space) analyses.

Purpose: S4 builds on S3a to create the full authority map -- answering "who can do what in each state?" which is essential for security analysis. S5 enumerates the full verdict and outcome spaces -- essential for S6 flow path enumeration and for understanding the contract's observable behavior.

Output: S4 producing `Map<PersonaId, Map<EntityId, Map<State, Vec<OperationId>>>>` and S5 producing verdict type enumeration plus per-operation outcome sets.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-static-analysis/04-RESEARCH.md
@.planning/phases/04-static-analysis/04-CONTEXT.md

@crates/analyze/src/lib.rs
@crates/analyze/src/bundle.rs
@crates/analyze/src/s3a_admissibility.rs
@docs/TENOR.md (Section 15 â€” S4, S5 definitions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement S4 authority topology mapping</name>
  <files>
    crates/analyze/src/s4_authority.rs
    crates/analyze/src/lib.rs
  </files>
  <action>
1. Create `crates/analyze/src/s4_authority.rs`:
   - Define `AuthorityMap` struct (Debug, Clone, Serialize):
     - `by_entity: BTreeMap<String, BTreeMap<String, Vec<String>>>` -- entity_id -> state -> [operation_ids]
   - Define `TransitionAuthority` struct (Debug, Clone, Serialize):
     - `persona_id: String`
     - `entity_id: String`
     - `from_state: String`
     - `to_state: String`
     - `via_operation: String`
   - Define `S4Result` struct (Debug, Clone, Serialize):
     - `persona_authority: BTreeMap<String, AuthorityMap>` -- persona_id -> AuthorityMap
     - `transition_authorities: Vec<TransitionAuthority>` -- all persona->transition derivations
     - `total_personas: usize`
     - `total_authority_entries: usize`
   - Implement `pub fn analyze_authority(bundle: &AnalysisBundle, s3a: &S3aResult) -> S4Result`:
     - Reorganize S3a results: S3a is keyed by (entity, state, persona) -> [ops]
     - S4 inverts to: persona -> entity -> state -> [ops]
     - For each entry in s3a.admissible_operations:
       - Group by persona_id first, then entity_id, then state
     - Derive transition_authorities:
       - For each persona P, entity E, state S, and admissible operation O:
         - For each effect of O that applies to E with from_state == S:
           - Record TransitionAuthority { persona: P, entity: E, from: S, to: effect.to_state, via: O }
     - Compute totals for summary reporting

2. Update `lib.rs`: add `pub mod s4_authority;` and re-export `S4Result`.

3. Unit tests:
   a. Single persona with authority over one operation in one state -- verify mapping
   b. Multiple personas with overlapping authority -- verify each persona's map is distinct
   c. Persona with no admissible operations -- empty AuthorityMap
   d. Transition authority derivation -- persona can cause S->S' via operation O
   e. Cross-entity authority -- persona has operations on different entities in different states
  </action>
  <verify>
    Run `cargo test -p tenor-analyze` -- S4 tests pass.
    Run `cargo test --workspace` -- no regressions.
  </verify>
  <done>
    S4 correctly maps persona authority across entities and states. Transition authorities derived for all persona-transition-operation combinations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement S5 verdict and outcome space enumeration</name>
  <files>
    crates/analyze/src/s5_verdicts.rs
    crates/analyze/src/lib.rs
  </files>
  <action>
1. Create `crates/analyze/src/s5_verdicts.rs`:
   - Define `VerdictTypeInfo` struct (Debug, Clone, Serialize):
     - `verdict_type: String`
     - `producing_rule: String` -- rule ID that produces this verdict type
     - `stratum: u64` -- rule stratum
   - Define `OperationOutcomeInfo` struct (Debug, Clone, Serialize):
     - `operation_id: String`
     - `outcomes: Vec<String>` -- declared outcomes
     - `outcome_count: usize`
   - Define `S5Result` struct (Debug, Clone, Serialize):
     - `verdict_types: Vec<VerdictTypeInfo>` -- all verdict types from rules, sorted by (stratum, verdict_type)
     - `operation_outcomes: BTreeMap<String, OperationOutcomeInfo>` -- operation_id -> outcomes
     - `total_verdict_types: usize`
     - `total_operations_with_outcomes: usize`
   - Implement `pub fn analyze_verdict_space(bundle: &AnalysisBundle) -> S5Result`:
     - For each rule in bundle.rules:
       - Extract verdict_type from rule.produce_verdict_type
       - Build VerdictTypeInfo with rule ID and stratum
     - Sort by (stratum, verdict_type) for deterministic output
     - For each operation in bundle.operations:
       - If operation.outcomes is non-empty, build OperationOutcomeInfo
     - Compute totals

2. Update `lib.rs`: add `pub mod s5_verdicts;` and re-export `S5Result`.

3. Unit tests:
   a. Rules producing distinct verdict types at different strata -- verify all enumerated
   b. Operation with declared outcomes -- verify outcome list extracted
   c. Operation with no outcomes (outcomes field empty) -- verify omitted or empty
   d. Multiple rules at same stratum -- verify both verdict types appear
   e. Verify deterministic ordering (sorted by stratum, then verdict_type)
  </action>
  <verify>
    Run `cargo test -p tenor-analyze` -- S5 tests pass.
    Run `cargo test --workspace` -- no regressions.
  </verify>
  <done>
    S5 enumerates all verdict types from rules and all operation outcomes. Output sorted deterministically by stratum and verdict type.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` succeeds
2. `cargo test -p tenor-analyze` -- S4 and S5 tests pass
3. S4 correctly inverts S3a results into persona-centric authority map
4. S5 enumerates all verdict types and operation outcomes
5. All results are serializable and deterministically ordered
</verification>

<success_criteria>
- S4 maps persona authority: persona -> entity -> state -> [operations]
- S4 derives transition authorities (who can cause which state transition)
- S5 enumerates all verdict types from rules with producing rule and stratum
- S5 enumerates all operation outcomes
- Unit tests cover single/multi persona, overlap, empty, and cross-entity cases
</success_criteria>

<output>
After completion, create `.planning/phases/04-static-analysis/04-03-SUMMARY.md`
</output>
