---
phase: 04-static-analysis
plan: 06
type: execute
wave: 4
depends_on: [04, 05]
files_modified:
  - crates/cli/Cargo.toml
  - crates/cli/src/main.rs
autonomous: true
requirements: [CLI-04]

must_haves:
  truths:
    - "`tenor check <file.tenor>` elaborates the file then runs all S1-S7 analyses"
    - "`tenor check` in text mode produces human-readable summary with findings"
    - "`tenor check` in JSON mode produces full structured AnalysisReport suitable for LSP consumption"
    - "`tenor check --analysis s1,s2` selects specific analyses to run"
    - "Exit code 0 = no findings, 1 = findings reported, exit on elaboration error"
  artifacts:
    - path: "crates/cli/src/main.rs"
      provides: "Working cmd_check implementation replacing the stub"
      contains: "fn cmd_check"
    - path: "crates/cli/Cargo.toml"
      provides: "tenor-analyze dependency"
      contains: "tenor-analyze"
  key_links:
    - from: "crates/cli/src/main.rs"
      to: "tenor_analyze::analyze"
      via: "check subcommand handler"
      pattern: "tenor_analyze::analyze"
    - from: "crates/cli/src/main.rs"
      to: "tenor_core::elaborate::elaborate"
      via: "elaborate-then-analyze pipeline"
      pattern: "elaborate::elaborate"
---

<objective>
Wire `tenor check` CLI subcommand to the tenor-analyze crate, replacing the stub with a working implementation that elaborates, analyzes, and presents results.

Purpose: This is the user-facing integration -- contract authors run `tenor check` to see static analysis results. Text mode gives a readable summary; JSON mode gives structured output for tooling. The `--analysis` flag enables focused checks.

Output: Working `tenor check` subcommand with text and JSON output modes and optional analysis selection.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-static-analysis/04-RESEARCH.md
@.planning/phases/04-static-analysis/04-CONTEXT.md

@crates/cli/src/main.rs
@crates/cli/Cargo.toml
@crates/analyze/src/lib.rs
@crates/analyze/src/report.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --analysis flag and wire cmd_check to tenor-analyze</name>
  <files>
    crates/cli/Cargo.toml
    crates/cli/src/main.rs
  </files>
  <action>
1. Update `crates/cli/Cargo.toml`:
   - Add `tenor-analyze = { path = "../analyze" }` to `[dependencies]`

2. Update `crates/cli/src/main.rs`:
   - Add `--analysis` flag to Check subcommand:
     ```
     Check {
         file: PathBuf,
         /// Comma-separated list of analyses to run (s1,s2,s3a,s4,s5,s6,s7). Default: all.
         #[arg(long)]
         analysis: Option<String>,
     },
     ```
   - Update the match arm for Commands::Check to call cmd_check instead of stub_not_implemented:
     ```
     Commands::Check { file, analysis } => {
         cmd_check(&file, analysis.as_deref(), cli.output, cli.quiet);
     }
     ```
   - Implement `fn cmd_check(file: &Path, analysis: Option<&str>, output: OutputFormat, quiet: bool)`:
     a. Elaborate first: call `tenor_core::elaborate::elaborate(file)`
        - On error: report elaboration error and exit(1)
     b. Parse analysis selection:
        - If analysis is Some, split by comma: `analysis.split(',').map(|s| s.trim()).collect()`
        - Validate each: must be one of "s1", "s2", "s3a", "s4", "s5", "s6", "s7"
        - Invalid analysis ID: report error and exit(1)
     c. Run analysis:
        - If analysis selection is None: `tenor_analyze::analyze(&bundle)?`
        - If analysis selection is Some: `tenor_analyze::analyze_selected(&bundle, &selected)?`
     d. Format output:
        - **JSON mode**: serialize entire AnalysisReport via serde_json::to_string_pretty
        - **Text mode**: format human-readable summary:
          - Header: "Static Analysis Report"
          - If S1 present: "Entities: N entities, M total states"
          - If S2 present: "Reachability: N entities fully reachable" or "WARNING: N dead states found" with details
          - If S3a present: "Admissibility: N combinations checked, M admissible operations found"
          - If S4 present: "Authority: N personas, M total authority entries"
          - If S5 present: "Verdicts: N verdict types, M operations with outcomes"
          - If S6 present: "Flow Paths: N total paths across M flows" + truncation warnings
          - If S7 present: "Complexity: max predicate depth N, max flow depth M"
          - If S8 present: "Verdict Uniqueness: pre-verified (Pass 5)"
          - Separator
          - "Findings:" section listing all findings with severity and message
          - If no findings: "No findings."
     e. Exit code:
        - 0 if no Warning-level findings
        - 1 if any Warning-level findings
        - (elaboration errors already exit 1 in step a)
  </action>
  <verify>
    Run `cargo build --workspace` -- compiles.
    Run `cargo run -p tenor-cli -- check conformance/positive/entity_basic.tenor` -- produces analysis output (text mode).
    Run `cargo run -p tenor-cli -- check conformance/positive/entity_basic.tenor --output json` -- produces JSON.
    Run `cargo run -p tenor-cli -- check conformance/positive/integration_escrow.tenor` -- produces full analysis on comprehensive contract.
    Run `cargo run -p tenor-cli -- check conformance/positive/entity_basic.tenor --analysis s1,s2` -- only S1 and S2 in output.
    Run `cargo test --workspace` -- no regressions.
  </verify>
  <done>
    `tenor check` works end-to-end: elaborates .tenor file, runs S1-S8 analyses, produces text or JSON output. --analysis flag selects specific analyses. Exit codes reflect findings.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` succeeds
2. `tenor check <file>` produces human-readable text analysis report
3. `tenor check <file> --output json` produces structured JSON report
4. `tenor check <file> --analysis s1,s2` only includes S1 and S2 results
5. Exit code 0 for clean contracts, 1 for contracts with findings
6. Elaboration errors produce error message and exit 1
7. All existing tests pass
</verification>

<success_criteria>
- `tenor check` replaces stub with working implementation
- Text output is human-readable with per-analysis summaries and findings
- JSON output is full AnalysisReport serialization
- --analysis flag enables selective analysis
- Exit codes follow 0/1 convention based on findings
- Integration with tenor-analyze works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/04-static-analysis/04-06-SUMMARY.md`
</output>
