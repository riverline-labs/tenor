---
phase: 03.2-technical-debt-bug-fixes-missing-eval-features
plan: 03
subsystem: eval
tags: [flow, parallel-step, compensate, escalate, failure-handler, persona, provenance]

# Dependency graph
requires:
  - phase: 03.2-technical-debt-bug-fixes-missing-eval-features
    plan: 01
    provides: "EvalError::FlowError variant, checked arithmetic, currency-aware Money comparison"
provides:
  - "ParallelStep execution with isolated entity state clones and merge on join"
  - "Compensate failure handler executing compensation steps with rollback routing"
  - "Escalate failure handler recording persona transfer and routing to next step"
  - "SubFlowStep Compensate/Escalate handlers using shared handle_failure helper"
  - "Flow initiating_persona recorded for provenance in FlowResult"
  - "Escalate variant in core AST, parser, and serializer"
  - "3 new eval conformance test fixtures (parallel_step, compensate_handler, escalate_handler)"
affects: [04-static-analysis]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Shared handle_failure() helper factored out for OperationStep and SubFlowStep failure handling"
    - "BranchOutcome enum for typed parallel branch outcome classification (not string-based)"
    - "Entity state cloning per parallel branch with merge-back on join (spec 11.5 isolation)"

key-files:
  created:
    - "conformance/eval/positive/parallel_step.tenor"
    - "conformance/eval/positive/parallel_step.facts.json"
    - "conformance/eval/positive/parallel_step.verdicts.json"
    - "conformance/eval/positive/compensate_handler.tenor"
    - "conformance/eval/positive/compensate_handler.facts.json"
    - "conformance/eval/positive/compensate_handler.verdicts.json"
    - "conformance/eval/positive/escalate_handler.tenor"
    - "conformance/eval/positive/escalate_handler.facts.json"
    - "conformance/eval/positive/escalate_handler.verdicts.json"
  modified:
    - "crates/eval/src/flow.rs"
    - "crates/eval/src/lib.rs"
    - "crates/eval/tests/conformance.rs"
    - "crates/core/src/ast.rs"
    - "crates/core/src/parser.rs"
    - "crates/core/src/pass6_serialize.rs"

key-decisions:
  - "BranchOutcome enum used for parallel branch outcome classification instead of string-based matching (avoids Pitfall 6 from RESEARCH.md)"
  - "handle_failure() factored as shared helper for OperationStep and SubFlowStep to avoid code duplication"
  - "initiating_persona set on FlowResult after execute_flow returns (not threaded through execution) -- cleaner API"
  - "Escalate added to core parser/AST/serializer to enable end-to-end conformance testing (Rule 3 deviation)"

patterns-established:
  - "BranchOutcome enum: Success { branch_id, outcome, entity_changes, steps, entity_states } | Failure { branch_id, error, steps }"
  - "Shared failure handling: handle_failure() returns Option<FlowResult> -- Some for terminal, None for continue-flow"

requirements-completed: []

# Metrics
duration: 13min
completed: 2026-02-22
---

# Phase 03.2 Plan 03: Missing Eval Features Summary

**ParallelStep execution with isolated entity state clones, Compensate/Escalate failure handlers, and flow persona provenance -- all three spec-defined flow features now functional with end-to-end conformance tests**

## Performance

- **Duration:** 13 min
- **Started:** 2026-02-22T01:52:23Z
- **Completed:** 2026-02-22T02:05:23Z
- **Tasks:** 2
- **Files modified:** 15 (6 source files + 9 conformance fixture files)

## Accomplishments
- ParallelStep executes branches with isolated entity state clones and merges non-overlapping changes on join, supporting on_all_success, on_any_failure, and on_all_complete join policies
- Compensate failure handler executes compensation steps in order, handles compensation step failures, and routes to the then-target on success
- Escalate failure handler records persona transfer as a provenance event and routes to the next step for the escalated persona
- SubFlowStep now handles Compensate and Escalate failure handlers (previously returned TypeError on the wildcard arm)
- Flow initiating_persona is recorded in FlowResult for provenance tracing
- All "not yet implemented" TypeError paths eliminated from flow.rs
- 3 new eval conformance fixtures covering ParallelStep, Compensate, and Escalate (eval test count: 24 -> 27)
- Escalate added to core AST, parser, and serializer for end-to-end DSL support

## Task Commits

Each task was committed atomically:

1. **Task 1: Implement ParallelStep, Compensate, Escalate, and persona provenance** - `ec9054f` (feat)
2. **Task 2: Add conformance test fixtures** - `640c43d` (test)

## Files Created/Modified
- `crates/eval/src/flow.rs` - ParallelStep execution, Compensate handler, Escalate handler, shared handle_failure() helper, BranchOutcome enum, initiating_persona field on FlowResult
- `crates/eval/src/lib.rs` - Wire persona parameter in evaluate_flow for provenance recording
- `crates/eval/tests/conformance.rs` - Register 3 new flow fixture tests (parallel_step, compensate_handler, escalate_handler)
- `crates/core/src/ast.rs` - Add Escalate variant to RawFailureHandler enum
- `crates/core/src/parser.rs` - Parse Escalate(to: PersonaId, next: StepId) failure handler syntax
- `crates/core/src/pass6_serialize.rs` - Serialize Escalate handler to interchange JSON
- `conformance/eval/positive/parallel_step.*` - Parallel step fixture with two non-overlapping branches
- `conformance/eval/positive/compensate_handler.*` - Compensation rollback on operation failure
- `conformance/eval/positive/escalate_handler.*` - Escalation to supervisor persona on step failure

## Decisions Made
- Used BranchOutcome enum (Success/Failure) for parallel branch classification instead of string-matching approach from RESEARCH.md -- avoids the fragile "error:" prefix check
- Factored handle_failure() as a shared helper returning Option<FlowResult> -- terminal handlers return Some, continue-flow handlers return None and caller sets next step
- Set initiating_persona on FlowResult after execute_flow returns rather than threading through the recursive execution -- keeps the internal API clean
- Added Escalate to core parser/AST/serializer (Rule 3 deviation) to enable end-to-end DSL-based conformance testing rather than hand-built JSON bundles

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added Escalate variant to core parser/AST/serializer**
- **Found during:** Task 1 (implementing Escalate failure handler)
- **Issue:** The evaluator types.rs already had an Escalate FailureHandler variant for deserialization from interchange JSON, but the core parser (ast.rs, parser.rs) did not support parsing `Escalate(to: ..., next: ...)` from .tenor source files, and pass6_serialize.rs did not serialize it. This meant conformance test fixtures using Escalate could not be created through the normal .tenor -> elaborate -> eval pipeline.
- **Fix:** Added `Escalate { to_persona, next }` to `RawFailureHandler` in ast.rs, parsing logic in parser.rs accepting `Escalate(to: PersonaId, next: StepId)` syntax, and serialization in pass6_serialize.rs emitting `{"kind": "Escalate", "next": ..., "to_persona": ...}`.
- **Files modified:** crates/core/src/ast.rs, crates/core/src/parser.rs, crates/core/src/pass6_serialize.rs
- **Verification:** `cargo build --workspace` clean, `cargo run -p tenor-cli -- test conformance` still 55/55, escalate_handler.tenor elaborates and evaluates correctly
- **Committed in:** ec9054f (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (Rule 3 - blocking)
**Impact on plan:** Essential for creating the Escalate conformance test fixture. Without this, Escalate could only be tested through hand-built JSON bundles, which violates the conformance triplet convention (.tenor + .facts.json + .verdicts.json). No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All spec-defined evaluator flow features are now functional: OperationStep, BranchStep, HandoffStep, SubFlowStep, ParallelStep, with Terminate/Compensate/Escalate failure handlers
- Ready for Phase 4 (Static Analysis) -- evaluator foundation is complete and correct
- Phase 3.2 is complete (all 3 plans executed)
- 55/55 elaborator conformance tests pass, 264 total workspace tests pass (up from 261)

## Self-Check: PASSED

All files exist, all commits verified (ec9054f, 640c43d).

---
*Phase: 03.2-technical-debt-bug-fixes-missing-eval-features*
*Completed: 2026-02-22*
