---
phase: 03.2-technical-debt-bug-fixes-missing-eval-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/eval/src/numeric.rs
  - crates/eval/src/operation.rs
  - crates/eval/src/assemble.rs
  - crates/eval/src/types.rs
  - crates/eval/src/flow.rs
  - crates/eval/src/lib.rs
autonomous: true
requirements: []  # Remediation work â€” no v1.0 requirement ID; tracked by success criteria

must_haves:
  truths:
    - "Decimal precision > 18 does not panic -- returns EvalError::Overflow instead"
    - "Money comparison with different currencies returns an error, not a silent wrong result"
    - "Multi-outcome Operations without effect-to-outcome mapping return an error, not silent first-outcome fallback"
    - "Date/DateTime facts with non-ISO-8601 format are rejected at fact assembly time"
    - "Duration values with same unit can be compared correctly"
    - "EvalError variants are semantically correct (FlowError for flow errors, not TypeError)"
  artifacts:
    - path: "crates/eval/src/numeric.rs"
      provides: "Checked precision arithmetic, Money currency validation, Duration comparison"
      contains: "checked_mul|checked_powi|coerce_to_money.*currency"
    - path: "crates/eval/src/operation.rs"
      provides: "Multi-outcome routing error for missing effect-to-outcome mapping"
      contains: "multi-outcome operation has no effect-to-outcome mapping"
    - path: "crates/eval/src/assemble.rs"
      provides: "ISO 8601 date format validation"
      contains: "iso.*8601|date.*format|YYYY-MM-DD"
    - path: "crates/eval/src/types.rs"
      provides: "EvalError::FlowError and EvalError::Overflow variants"
      contains: "FlowError|Overflow"
  key_links:
    - from: "crates/eval/src/numeric.rs"
      to: "crates/eval/src/types.rs"
      via: "EvalError::Overflow variant for precision overflow"
      pattern: "EvalError::Overflow"
    - from: "crates/eval/src/flow.rs"
      to: "crates/eval/src/types.rs"
      via: "EvalError::FlowError variant for step limit exceeded"
      pattern: "EvalError::FlowError"
---

<objective>
Fix all critical evaluator bugs (precision overflow panic, Money currency gap, multi-outcome silent fallback, Date format validation), add Duration comparison support, and introduce semantically correct EvalError variants. Each fix includes targeted test coverage proving the fix works.

Purpose: The evaluator must never panic on valid contract inputs and must never produce silently incorrect results. These bugs are the highest-severity items from the codebase concerns audit and must be resolved before Phase 4 builds on top of the evaluator.
Output: Corrected numeric.rs, operation.rs, assemble.rs, types.rs, flow.rs with bug fixes and new tests.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-technical-debt-bug-fixes-missing-eval-features/03.2-RESEARCH.md

@crates/eval/src/types.rs
@crates/eval/src/numeric.rs
@crates/eval/src/operation.rs
@crates/eval/src/assemble.rs
@crates/eval/src/flow.rs
@crates/eval/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix critical bugs and add EvalError variants</name>
  <files>
    crates/eval/src/types.rs
    crates/eval/src/numeric.rs
    crates/eval/src/operation.rs
    crates/eval/src/assemble.rs
    crates/eval/src/flow.rs
  </files>
  <action>
Fix bugs B1-B4 from the research inventory and add new EvalError variants:

**1. Add EvalError variants (types.rs):**
Add `FlowError { flow_id: String, message: String }` and `Overflow { message: String }` variants to the `EvalError` enum. Update the `fmt::Display` impl to handle both new variants. Keep existing `TypeError` for genuine type errors (forall domain not a list, multiplication on non-numeric).

**2. Fix B1 - Precision overflow panic (numeric.rs ~line 83):**
Replace `Decimal::from(10i64.pow(max_int_digits))` with checked Decimal arithmetic. Use a loop multiplying `Decimal::TEN` with `checked_mul()` to build the bound, returning `EvalError::Overflow` if computation fails. For `max_int_digits > 28` (rust_decimal max), any value that fits in Decimal is valid -- return Ok(()). See RESEARCH.md "Fix 1" code example for the pattern.

Also fix `predicate.rs:189` where `unwrap_or(28)` provides a default precision that triggers the panic path -- ensure the default precision works safely with the new checked arithmetic.

**3. Fix B2 - Money currency comparison gap (numeric.rs ~lines 163-165):**
Replace `coerce_to_money_amount()` (which discards currency) with `coerce_to_money()` returning `(Decimal, String)`. In the `"Money"` arm of `compare_with_promotion`, extract both amount and currency from each side. Return `EvalError::TypeError` if currencies differ (this IS a genuine type error -- comparing incompatible types). See RESEARCH.md "Fix 2" for the pattern.

**4. Fix B3 - Multi-outcome silent fallback (operation.rs ~lines 210-212):**
In the outcome determination chain, when `op.outcomes.len() > 1` and no effect carries an `outcome` field, return `OperationError::PreconditionFailed` instead of silently falling back to `outcomes[0]`. The single-outcome case (`len() == 1`) remains a valid implicit default. See RESEARCH.md "Fix 3" for the pattern.

**5. Fix B4 - Date format validation (assemble.rs):**
Add a `validate_date_format(s: &str) -> bool` helper that checks for ISO 8601 date format (YYYY-MM-DD pattern: 4 digits, dash, 2 digits, dash, 2 digits). For DateTime, check for `YYYY-MM-DDT` prefix. Call this during fact assembly when coercing Date/DateTime values. Return `EvalError::TypeError` with a clear message if the format is invalid. Do NOT use a date parsing library -- simple format check is sufficient.

**6. Add Duration comparison (numeric.rs):**
In `compare_values()`, add a `("Duration", "Duration")` arm. Extract `value` and `unit` from both sides. If units match, compare the numeric values as Decimals. If units differ, return `EvalError::TypeError` stating cross-unit Duration comparison is not supported (per RESEARCH.md recommendation: same-unit only for Phase 03.2; full unit promotion deferred to Phase 5).

Also add Duration unit validation in assemble.rs (T8): validate that Duration `unit` field is one of `seconds`, `minutes`, `hours`, `days` per the spec DurationUnit enum.

**7. Fix E1 - Flow step limit error (flow.rs ~lines 100-105):**
Change the step limit exceeded error from `EvalError::TypeError` to `EvalError::FlowError { flow_id: flow.id.clone(), message: format!("exceeded maximum step count ({})", max_steps) }`.
  </action>
  <verify>
Run `cargo test --workspace` -- all existing tests must still pass. Run `cargo build --workspace` with no warnings related to new variants. Specifically verify no panics by checking that `check_precision` uses only checked arithmetic.
  </verify>
  <done>
All four critical bugs fixed: (1) precision > 18 returns Overflow error instead of panicking, (2) Money comparison validates currency match, (3) multi-outcome ops without mapping return error, (4) Date format validated at assembly. Duration comparison works for same-unit values. FlowError variant used for step limit. All existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add test coverage for all bug fixes</name>
  <files>
    crates/eval/src/numeric.rs
    crates/eval/src/operation.rs
    crates/eval/src/assemble.rs
    crates/eval/src/lib.rs
  </files>
  <action>
Add targeted unit tests proving each bug fix works. Place tests in the same file's `#[cfg(test)] mod tests` section where the fix was made:

**1. Precision overflow test (numeric.rs tests):**
Test `check_precision` with precision=28, scale=0 (the exact case that panicked before). Verify it returns `Ok(())` for values within bounds and `Err(EvalError::Overflow)` for values exceeding bounds. Also test precision=38 (beyond Decimal range) -- should return `Ok(())` per the "any Decimal value fits" rule.

**2. Money cross-currency test (numeric.rs tests):**
Test `compare_with_promotion` with two Money values having different currencies (e.g., USD vs EUR with same amount). Verify it returns `Err(EvalError::TypeError)` with a message containing "different currencies". Also test same-currency comparison still works correctly.

**3. Multi-outcome fallback test (operation.rs tests or lib.rs integration tests):**
Create a test with an Operation having 2+ declared outcomes but effects that carry no `outcome` field. Verify execution returns `OperationError::PreconditionFailed`. Also verify single-outcome Operations still succeed with implicit outcome.

**4. Date format validation tests (assemble.rs tests):**
Test `validate_date_format` with: valid ISO date "2024-01-15" (true), valid DateTime "2024-01-15T10:30:00Z" (true), invalid "1/1/2024" (false), invalid "24-01-15" (false), empty string (false). Add an integration test that fact assembly rejects a non-ISO date value.

**5. Duration comparison test (numeric.rs tests):**
Test same-unit Duration comparison (seconds vs seconds). Verify cross-unit comparison returns TypeError. Test Duration unit validation rejecting invalid units like "weeks".

**6. FlowError variant test (flow.rs or lib.rs):**
If the step limit test exists, update it to assert `EvalError::FlowError` instead of `TypeError`. If no test exists, add one that creates a flow with a circular step reference and verifies FlowError is returned.

All tests should use the existing test patterns from the codebase (direct interchange JSON construction for numeric tests, fixture files for integration tests).
  </action>
  <verify>
Run `cargo test --workspace` -- all tests pass including the new ones. Run `cargo test -p tenor-eval -- --list 2>&1 | grep -c test` to verify test count increased. Each bug from the inventory (B1-B4, T8, T9, E1) has at least one dedicated test (C1, C2, C3, C7, C8 from the research coverage gap inventory).
  </verify>
  <done>
Test coverage gaps C1 (precision overflow), C2 (Money cross-currency), C3 (multi-outcome fallback), C7 (Duration comparison), C8 (Date format), and C9 (flow step limit error variant) are all closed. Each test specifically targets the bug it covers and would have caught the original defect.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` succeeds with no new warnings
2. `cargo test --workspace` passes all existing + new tests
3. `cargo run -p tenor-cli -- test conformance` still reports 55/55 passing
4. No `10i64.pow` or `i64::pow` calls remain in numeric.rs (replaced with Decimal arithmetic)
5. `coerce_to_money_amount` function either renamed or removed (replaced with currency-aware version)
6. `EvalError::FlowError` and `EvalError::Overflow` variants exist in types.rs
7. New test count: at least 6 new tests in tenor-eval
</verification>

<success_criteria>
- Zero panics possible from valid contract inputs (the precision overflow was the only panic path)
- No silent incorrect behavior in Money comparison, multi-outcome routing, or Date comparison
- Duration same-unit comparison functional
- EvalError variants semantically correct
- All bug fixes have dedicated test coverage
- All existing 55 conformance tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-technical-debt-bug-fixes-missing-eval-features/03.2-01-SUMMARY.md`
</output>
