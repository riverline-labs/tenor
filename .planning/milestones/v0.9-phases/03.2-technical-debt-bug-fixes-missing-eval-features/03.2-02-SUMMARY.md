---
phase: 03.2-technical-debt-bug-fixes-missing-eval-features
plan: 02
subsystem: core, cli
tags: [unwrap-safety, retry-logic, workspace-deps, dead-code, code-quality]

# Dependency graph
requires:
  - phase: 01.1-spec-ci-ai-ambiguity-testing
    provides: ambiguity module with API client and retry logic
  - phase: 02-foundation
    provides: tenor-core elaboration pipeline with parser and passes
provides:
  - Safe integer parsing in parser.rs (returns ElabError instead of panicking)
  - SAFETY annotations on all justified unwrap calls in tenor-core
  - Structured HTTP status code retry logic in ambiguity API client
  - Workspace-level jsonschema dependency (no version drift)
  - Justified dead code annotations across ambiguity module
affects: [03.2-technical-debt-bug-fixes-missing-eval-features, 04-static-analysis]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "SAFETY comment convention for justified .unwrap() calls"
    - "extract_http_status() for structured retry decisions"
    - "Workspace dependency normalization via workspace = true"

key-files:
  created: []
  modified:
    - crates/core/src/parser.rs
    - crates/core/src/pass3_types.rs
    - crates/core/src/pass4_typecheck.rs
    - crates/core/src/pass5_validate.rs
    - crates/cli/src/ambiguity/api.rs
    - crates/cli/src/ambiguity/compare.rs
    - crates/cli/src/ambiguity/report.rs
    - crates/cli/src/ambiguity/mod.rs
    - Cargo.toml
    - crates/cli/Cargo.toml
    - crates/core/Cargo.toml

key-decisions:
  - "SAFETY comment pattern: // SAFETY: <invariant explanation> on justified unwraps"
  - "extract_http_status parses 3-digit codes from error strings, matches 429/500/502/503"
  - "Network-level retries via lowercase contains(connection/timeout) -- no HTTP code available"
  - "Dead code annotations kept with justification comments rather than removed (public API fields)"

patterns-established:
  - "SAFETY comments: every .unwrap() in non-test core code must have // SAFETY: annotation"
  - "Workspace deps: shared dependencies pinned once in root Cargo.toml [workspace.dependencies]"

requirements-completed: []

# Metrics
duration: 5min
completed: 2026-02-22
---

# Phase 3.2 Plan 02: Tech Debt Cleanup Summary

**Eliminated unwrap fragility in tenor-core (parser safe integer parsing, 10 SAFETY annotations), replaced string-match retry with structured HTTP status code extraction, normalized jsonschema workspace dependency**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-22T01:40:11Z
- **Completed:** 2026-02-22T01:45:37Z
- **Tasks:** 2
- **Files modified:** 11

## Accomplishments
- Replaced the most dangerous .unwrap() in parser.rs (integer parsing from string tokens) with proper ElabError via map_err
- Added SAFETY annotations to all 10 remaining .unwrap() calls in non-test tenor-core code, documenting the invariant that prevents each panic
- Restructured parallel conflict detection in pass5_validate.rs to use if-let pattern instead of unwrap
- Replaced fragile string-match retry logic (error.contains("429")) with structured extract_http_status() that parses actual HTTP status codes
- Normalized jsonschema dependency to workspace level, eliminating version drift risk

## Task Commits

Each task was committed atomically:

1. **Task 1: Audit and fix unwrap fragility in tenor-core** - `e4dd8a7` (fix)
2. **Task 2: Fix ambiguity retry logic, dead code, and workspace deps** - `664cf78` (fix)

## Files Created/Modified
- `crates/core/src/parser.rs` - Safe integer parsing via map_err instead of unwrap
- `crates/core/src/pass3_types.rs` - SAFETY annotations on 6 unwraps in cycle detection
- `crates/core/src/pass4_typecheck.rs` - SAFETY annotation on products.iter().min/max unwraps
- `crates/core/src/pass5_validate.rs` - SAFETY annotations + if-let restructuring for 4 unwraps
- `crates/cli/src/ambiguity/api.rs` - Structured extract_http_status() and justified dead_code annotations
- `crates/cli/src/ambiguity/compare.rs` - Justified dead_code annotation on VerdictComparison
- `crates/cli/src/ambiguity/report.rs` - Justified dead_code annotation on ambiguity_signals()
- `crates/cli/src/ambiguity/mod.rs` - Dead_code moved to specific fields with justification comments
- `Cargo.toml` - Added jsonschema = "0.42" to workspace.dependencies
- `crates/cli/Cargo.toml` - jsonschema via workspace reference
- `crates/core/Cargo.toml` - jsonschema via workspace reference

## Decisions Made
- Parser integer parse error returns ElabError::parse with "invalid integer literal" message (matches existing error conventions)
- SAFETY annotation pattern chosen over restructuring for cases where the invariant is clear and the code is simpler with unwrap
- Parallel conflict detection restructured to if-let (more defensive despite the invariant being sound)
- extract_http_status scans for 3-digit codes in 400-599 range to avoid false positives from port numbers
- Dead code annotations kept with justification rather than removed -- fields are part of public API contracts

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- tenor-core unwrap safety audit complete -- no unjustified panics remain
- Ambiguity API client uses robust retry logic that won't break on error message format changes
- Workspace dependency hygiene established for jsonschema
- Ready for Plan 03 (remaining tech debt items) or Phase 4 (static analysis)

---
## Self-Check: PASSED

- All 11 modified files exist on disk
- Commit e4dd8a7 (Task 1) verified in git log
- Commit 664cf78 (Task 2) verified in git log
- 55/55 conformance tests passing
- cargo clippy clean
- cargo test --workspace all passing

---
*Phase: 03.2-technical-debt-bug-fixes-missing-eval-features*
*Completed: 2026-02-22*
