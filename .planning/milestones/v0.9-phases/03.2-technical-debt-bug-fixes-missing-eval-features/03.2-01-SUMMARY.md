---
phase: 03.2-technical-debt-bug-fixes-missing-eval-features
plan: 01
subsystem: eval
tags: [rust_decimal, precision, money, duration, date, flow, error-handling]

# Dependency graph
requires:
  - phase: 03-cli-evaluator
    provides: "tenor-eval crate with numeric.rs, operation.rs, assemble.rs, flow.rs, types.rs"
provides:
  - "Checked precision arithmetic (no panic on precision > 18)"
  - "Currency-aware Money comparison in promotion path"
  - "Multi-outcome Operation routing error (no silent fallback)"
  - "ISO 8601 Date/DateTime format validation at fact assembly"
  - "Duration same-unit comparison support"
  - "Duration unit validation (seconds, minutes, hours, days)"
  - "EvalError::FlowError variant for flow execution errors"
  - "EvalError::Overflow variant for precision overflow"
  - "21 new targeted tests covering all fixes"
affects: [03.2-02, 03.2-03, 04-static-analysis]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Checked Decimal arithmetic for precision bounds (Decimal::TEN loop with checked_mul)"
    - "Currency-aware coercion returning (amount, currency) tuple"
    - "ISO 8601 format validation via byte-level pattern check (no date library)"

key-files:
  created: []
  modified:
    - "crates/eval/src/types.rs"
    - "crates/eval/src/numeric.rs"
    - "crates/eval/src/operation.rs"
    - "crates/eval/src/assemble.rs"
    - "crates/eval/src/flow.rs"

key-decisions:
  - "FlowError variant added (not StepLimitExceeded) to keep error granularity at flow level"
  - "Duration cross-unit comparison returns TypeError (full unit promotion deferred to Phase 5)"
  - "Date format validation is pattern-only (YYYY-MM-DD) without calendar correctness checking"
  - "coerce_to_money_amount replaced entirely with coerce_to_money returning (Decimal, &str)"

patterns-established:
  - "Checked Decimal arithmetic: use Decimal::TEN.checked_mul() loop instead of i64.pow() for precision bounds"
  - "Currency validation pattern: always extract and validate currency in Money comparison paths"

requirements-completed: []

# Metrics
duration: 7min
completed: 2026-02-22
---

# Phase 03.2 Plan 01: Critical Bug Fixes Summary

**Fixed 4 critical evaluator bugs (precision panic, Money currency gap, multi-outcome fallback, Date validation), added Duration comparison and FlowError variant, with 21 new targeted tests**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-22T01:39:53Z
- **Completed:** 2026-02-22T01:46:54Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Eliminated the only panic path in the evaluator: `10i64.pow(max_int_digits)` replaced with checked Decimal arithmetic that safely handles precision up to 28 and returns Ok(()) for precision > 28
- Money comparison in promotion path now validates currency match, preventing silent incorrect cross-currency comparisons
- Multi-outcome Operations without effect-to-outcome mapping now return an explicit error instead of silently defaulting to the first outcome
- Added Date/DateTime ISO 8601 format validation and Duration unit validation at fact assembly time
- Added same-unit Duration comparison support (cross-unit deferred to Phase 5)
- Flow step limit exceeded now returns semantically correct FlowError instead of TypeError
- 21 new tests covering all fixes (eval test count: 184 -> 205)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix critical bugs and add EvalError variants** - `d83ff69` (fix)
2. **Task 2: Add test coverage for all bug fixes** - `99a5573` (test)

## Files Created/Modified
- `crates/eval/src/types.rs` - Added EvalError::FlowError variant with Display impl
- `crates/eval/src/numeric.rs` - Fixed precision overflow panic, replaced coerce_to_money_amount with currency-aware coerce_to_money, added Duration comparison
- `crates/eval/src/operation.rs` - Fixed multi-outcome silent fallback to return PreconditionFailed error
- `crates/eval/src/assemble.rs` - Added ISO 8601 date format validation, DateTime format validation, Duration unit validation
- `crates/eval/src/flow.rs` - Changed step limit error from TypeError to FlowError

## Decisions Made
- FlowError variant used (not StepLimitExceeded) -- keeps error variants at construct level rather than creating per-error-cause variants
- Duration cross-unit comparison returns TypeError with explanation that cross-unit is not supported -- full unit promotion is a Phase 5 concern
- Date format validation uses byte-level pattern matching (YYYY-MM-DD) without a date parsing library -- simple format check is sufficient per RESEARCH.md recommendation
- coerce_to_money_amount entirely replaced with coerce_to_money returning (Decimal, &str) tuple -- cleaner API that forces callers to handle currency

## Deviations from Plan
None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All critical bugs fixed, evaluator is now safe for valid contract inputs
- Ready for Plan 02 (tech debt cleanup) and Plan 03 (missing eval features)
- 55/55 conformance tests still pass, all 261 workspace tests pass

## Self-Check: PASSED

All files exist, all commits verified (d83ff69, 99a5573).

---
*Phase: 03.2-technical-debt-bug-fixes-missing-eval-features*
*Completed: 2026-02-22*
