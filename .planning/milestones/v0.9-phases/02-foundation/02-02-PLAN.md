---
phase: 02-foundation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - crates/tenor-core/src/lib.rs
  - crates/tenor-core/src/ast.rs
  - crates/tenor-core/src/pass2_index.rs
  - crates/tenor-core/src/pass3_types.rs
  - crates/tenor-core/src/elaborate.rs
  - crates/tenor-eval/Cargo.toml
  - crates/tenor-eval/src/lib.rs
  - crates/tenor-analyze/Cargo.toml
  - crates/tenor-analyze/src/lib.rs
  - crates/tenor-codegen/Cargo.toml
  - crates/tenor-codegen/src/lib.rs
  - crates/tenor-lsp/Cargo.toml
  - crates/tenor-lsp/src/lib.rs
  - Cargo.toml
  - README.md
  - CLAUDE.md
autonomous: true
requirements:
  - FNDN-04

must_haves:
  truths:
    - "Downstream code can import Index, TypeEnv, and AST types from tenor_core"
    - "All 6 workspace crates compile with `cargo build --workspace`"
    - "Stub crates exist for eval, analyze, codegen, and lsp with doc comments"
    - "README.md reflects the new crate structure"
  artifacts:
    - path: "crates/tenor-core/src/lib.rs"
      provides: "Public API re-exports for downstream consumers"
      contains: "pub use"
    - path: "crates/tenor-eval/src/lib.rs"
      provides: "Stub evaluator crate"
      contains: "Phase 3"
    - path: "crates/tenor-analyze/src/lib.rs"
      provides: "Stub analyzer crate"
      contains: "Phase 4"
    - path: "crates/tenor-codegen/src/lib.rs"
      provides: "Stub codegen crate"
      contains: "Phase 6"
    - path: "crates/tenor-lsp/src/lib.rs"
      provides: "Stub LSP crate"
      contains: "Phase 8"
    - path: "README.md"
      provides: "Updated project README with workspace structure"
      contains: "crates/"
  key_links:
    - from: "crates/tenor-core/src/lib.rs"
      to: "crates/tenor-core/src/pass2_index.rs"
      via: "pub use re-export of Index"
      pattern: "pub use.*Index"
    - from: "crates/tenor-core/src/lib.rs"
      to: "crates/tenor-core/src/pass3_types.rs"
      via: "pub use re-export of TypeEnv"
      pattern: "pub use.*TypeEnv"
---

<objective>
Design and expose the public API from tenor-core (Index, TypeEnv, AST types) for downstream crate consumption, create stub crates for future phases, and update README.md + CLAUDE.md to reflect the new workspace structure.

Purpose: Downstream crates (tenor-eval in Phase 3, tenor-analyze in Phase 4) need typed intermediate representations from the elaboration pipeline. Without a public API, they cannot access pass outputs. Stub crates ensure the workspace compiles with all planned members from day one.

Output: tenor-core exposes `Index`, `TypeEnv`, and AST types as public API. Four stub crates compile. README.md and CLAUDE.md document the new structure.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-foundation/02-RESEARCH.md
@.planning/phases/02-foundation/02-01-SUMMARY.md

@crates/tenor-core/src/lib.rs
@crates/tenor-core/src/ast.rs
@crates/tenor-core/src/pass2_index.rs
@crates/tenor-core/src/pass3_types.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Design and expose tenor-core public API</name>
  <files>
    crates/tenor-core/src/lib.rs
    crates/tenor-core/src/ast.rs
    crates/tenor-core/src/pass2_index.rs
    crates/tenor-core/src/pass3_types.rs
    crates/tenor-core/src/elaborate.rs
  </files>
  <action>
    **Goal:** Make the key intermediate representations accessible to downstream crates while being conservative about what gets exposed.

    **Step 1: Make AST types public.** In `crates/tenor-core/src/ast.rs`, ensure the following are `pub`:
    - `RawConstruct` enum and all variants
    - `RawType` enum and all variants
    - `RawExpr` enum and all variants
    - `RawTerm` enum and all variants
    - `RawLiteral` enum and all variants
    - `Provenance` struct (both fields: `file`, `line`)
    - `Spanned` struct
    These should already be `pub` from Plan 01, but verify all struct fields that downstream consumers need are also public.

    **Step 2: Make Index public.** In `crates/tenor-core/src/pass2_index.rs`:
    - Ensure `pub struct Index` with all its HashMap fields as `pub`
    - Ensure `pub fn build_index()` is the public entry point
    - The Index fields are: `facts`, `entities`, `rules`, `operations`, `flows`, `type_decls`, `rule_verdicts`, `verdict_strata` (all HashMap<String, ...>)

    **Step 3: Make TypeEnv public.** In `crates/tenor-core/src/pass3_types.rs`:
    - Ensure `pub type TypeEnv = HashMap<String, RawType>` (or whatever the actual definition is)
    - Ensure `pub fn build_type_env()` is exposed

    **Step 4: Update lib.rs with convenience re-exports.** Add a structured public API in `crates/tenor-core/src/lib.rs`:
    ```rust
    // Re-export key types at crate root for convenience
    pub use ast::{RawConstruct, RawType, RawExpr, RawTerm, RawLiteral, Provenance};
    pub use pass2_index::Index;
    pub use pass3_types::TypeEnv;
    pub use error::ElabError;
    pub use elaborate::elaborate;
    ```
    This allows downstream crates to write `use tenor_core::Index;` instead of `use tenor_core::pass2_index::Index;`.

    **Step 5: Add per-pass public entry functions.** Expose individual pass functions for downstream crates that may want to run passes selectively (e.g., tenor-analyze needs passes 1-4 but not 5-6):
    - `pub use pass1_bundle::load_bundle;`
    - `pub use pass2_index::build_index;`
    - `pub use pass3_types::build_type_env;`
    - `pub use pass4_typecheck::resolve_types;`

    Do NOT expose internal helpers -- only the main entry function per pass. Start conservative; widen access as Phase 3/4 requirements emerge.

    **Anti-pattern:** Do NOT make all struct fields `pub` reflexively. Only expose what the public API contract requires.
  </action>
  <verify>
    Run `cargo build -p tenor-core` — compiles.
    Run `cargo doc -p tenor-core --no-deps` — generates documentation. Check that Index, TypeEnv, RawConstruct, elaborate appear in the generated docs.
    Run `cargo run -p tenor-cli -- run conformance` — 47/47 still passing (visibility changes should not break anything).
  </verify>
  <done>
    tenor-core exposes Index, TypeEnv, AST types, ElabError, and elaborate() as public API via re-exports in lib.rs. Individual pass entry functions are publicly accessible. Documentation generates without warnings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create stub crates and update README.md + CLAUDE.md</name>
  <files>
    crates/tenor-eval/Cargo.toml
    crates/tenor-eval/src/lib.rs
    crates/tenor-analyze/Cargo.toml
    crates/tenor-analyze/src/lib.rs
    crates/tenor-codegen/Cargo.toml
    crates/tenor-codegen/src/lib.rs
    crates/tenor-lsp/Cargo.toml
    crates/tenor-lsp/src/lib.rs
    Cargo.toml
    README.md
    CLAUDE.md
  </files>
  <action>
    **Step 1: Create 4 stub crates.** For each of `tenor-eval`, `tenor-analyze`, `tenor-codegen`, `tenor-lsp`:

    Create `crates/{name}/Cargo.toml`:
    ```toml
    [package]
    name = "{name}"
    version.workspace = true
    edition.workspace = true
    description = "{description}"

    [dependencies]
    tenor-core = { path = "../tenor-core" }
    ```

    Create `crates/{name}/src/lib.rs` with a doc comment describing the crate's future purpose and which phase implements it:
    - `tenor-eval`: "Tenor contract evaluator -- accepts interchange bundle + facts, produces verdicts with provenance. Implementation: Phase 3."
    - `tenor-analyze`: "Tenor static analyzer -- S1-S7 analysis suite with structured output. Implementation: Phase 4."
    - `tenor-codegen`: "Tenor code generator -- ports-and-adapters code generation for TypeScript, Rust, Go. Implementation: Phase 6."
    - `tenor-lsp`: "Tenor Language Server Protocol implementation for IDE integration. Implementation: Phase 8."

    Each lib.rs should be minimal (just the doc comment, no code).

    **Step 2: Update workspace root Cargo.toml** to add the 4 new members to the `[workspace]` `members` array.

    **Step 3: Update README.md** to reflect the new project structure. In the "Structure" section, replace the current directory listing with:
    ```
    docs/TENOR.md       — full formal specification (v1.0)
    STABILITY.md        — pre-release stability notice
    CONTRIBUTING.md     — contribution guidelines
    conformance/        — elaborator conformance suite (47/47 tests passing)
    crates/
      tenor-core/       — library: elaboration pipeline, AST, typed pass outputs
      tenor-cli/        — binary: `tenor` command-line tool
      tenor-eval/       — library: contract evaluator (Phase 3)
      tenor-analyze/    — library: static analysis S1-S7 (Phase 4)
      tenor-codegen/    — library: code generation targets (Phase 6)
      tenor-lsp/        — library: Language Server Protocol (Phase 8)
    ```

    Also update the build commands section to use workspace commands:
    ```bash
    # Build all crates
    cargo build --workspace

    # Run conformance suite
    cargo run -p tenor-cli -- run conformance

    # Elaborate a single file
    cargo run -p tenor-cli -- elaborate path/to/file.tenor
    ```

    **Step 4: Update CLAUDE.md** to reflect the new repository layout and build commands. Replace the "Repository layout" section with the crates/ directory structure. Update the "Build and test" section with workspace commands (`cargo build --workspace`, `cargo run -p tenor-cli -- run conformance`).

    **Step 5: Verify workspace compiles.**
    ```
    cargo build --workspace
    ```
    All 6 crates must compile (tenor-core, tenor-cli, and 4 stubs).
  </action>
  <verify>
    Run `cargo build --workspace` — all 6 crates compile.
    Run `cargo run -p tenor-cli -- run conformance` — 47/47 passing.
    Verify stub crates exist: `ls crates/tenor-*/src/lib.rs` shows 5 files (core + 4 stubs).
    Verify README.md contains "crates/" in the structure section.
    Verify CLAUDE.md contains updated build commands.
  </verify>
  <done>
    Four stub crates (eval, analyze, codegen, lsp) compile as workspace members. README.md and CLAUDE.md updated to reflect the new Cargo workspace structure with correct build commands. Workspace has 6 crates total.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` compiles all 6 crates without errors
2. `cargo doc -p tenor-core --no-deps` generates documentation showing Index, TypeEnv, AST types
3. `cargo run -p tenor-cli -- run conformance` reports 47/47 passing
4. `ls crates/*/src/lib.rs` shows 5 crate lib.rs files (core + 4 stubs)
5. README.md and CLAUDE.md reflect the workspace structure
</verification>

<success_criteria>
- tenor-core public API exposes Index, TypeEnv, AST types, ElabError, and elaborate()
- Four stub crates compile as workspace members
- README.md documents the new crate structure and build commands
- CLAUDE.md updated with workspace-based repository layout and commands
- All 47 conformance tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-foundation/02-02-SUMMARY.md`
</output>
