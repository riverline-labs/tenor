---
phase: 02-foundation
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - crates/tenor-core/src/ast.rs
  - crates/tenor-core/src/lexer.rs
  - crates/tenor-core/src/parser.rs
  - crates/tenor-core/src/pass1_bundle.rs
  - crates/tenor-core/src/pass2_index.rs
  - crates/tenor-core/src/pass5_validate.rs
  - crates/tenor-core/src/pass6_serialize.rs
  - conformance/positive/*.expected.json
  - conformance/negative/**/*.expected-error.json
  - conformance/numeric/*.expected.json
  - conformance/promotion/*.expected.json
  - conformance/shorthand/*.expected.json
  - conformance/cross_file/*.expected.json
autonomous: true
requirements:
  - TEST-02

must_haves:
  truths:
    - "Parser accepts `persona <id>` as a valid construct and produces a Persona AST node"
    - "Parser accepts `outcomes` field on Operation constructs"
    - "Pass 2 indexes Persona constructs and detects duplicate persona ids"
    - "Pass 5 validates persona references in Operation allowed_personas and Flow step persona fields"
    - "Pass 6 serializes Persona constructs with kind=Persona and tenor=1.0"
    - "Pass 6 emits tenor_version: 1.0.0 in the bundle envelope"
    - "All conformance fixture expected JSONs use tenor: 1.0 (not 0.3)"
    - "All 47 existing conformance tests pass with updated expected outputs"
  artifacts:
    - path: "crates/tenor-core/src/ast.rs"
      provides: "Persona variant in RawConstruct enum"
      contains: "Persona"
    - path: "crates/tenor-core/src/parser.rs"
      provides: "Persona parsing and outcomes field parsing"
      contains: "parse_persona"
    - path: "crates/tenor-core/src/pass2_index.rs"
      provides: "Persona indexing with duplicate detection"
      contains: "personas"
    - path: "crates/tenor-core/src/pass6_serialize.rs"
      provides: "Persona serialization and v1.0 version strings"
      contains: "1.0"
  key_links:
    - from: "crates/tenor-core/src/parser.rs"
      to: "crates/tenor-core/src/ast.rs"
      via: "creates RawConstruct::Persona variant"
      pattern: "RawConstruct::Persona"
    - from: "crates/tenor-core/src/pass6_serialize.rs"
      to: "conformance/positive/*.expected.json"
      via: "version string must match"
      pattern: "tenor.*1\\.0"
---

<objective>
Implement the three v1.0 spec constructs (persona, Operation outcomes, interchange versioning) in the elaborator and update all existing conformance fixture expected outputs from v0.3 to v1.0.

Purpose: The spec was frozen in Phase 1 but the elaborator still runs at v0.3 — it does not parse personas, does not handle Operation outcomes, and emits `"tenor": "0.3"` in all output. This plan bridges the gap so the conformance suite validates v1.0 behavior.

Output: Elaborator handles persona declarations, Operation outcomes field, and emits `"tenor": "1.0"` / `"tenor_version": "1.0.0"`. All 47 tests pass with updated expected outputs.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-foundation/02-RESEARCH.md
@.planning/phases/02-foundation/02-01-SUMMARY.md

@crates/tenor-core/src/ast.rs
@crates/tenor-core/src/parser.rs
@crates/tenor-core/src/pass2_index.rs
@crates/tenor-core/src/pass5_validate.rs
@crates/tenor-core/src/pass6_serialize.rs
@docs/TENOR.md (Section 8: Persona, Section 9: Operation with outcomes)
@docs/interchange-schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement persona construct and Operation outcomes in elaborator</name>
  <files>
    crates/tenor-core/src/ast.rs
    crates/tenor-core/src/lexer.rs
    crates/tenor-core/src/parser.rs
    crates/tenor-core/src/pass1_bundle.rs
    crates/tenor-core/src/pass2_index.rs
    crates/tenor-core/src/pass5_validate.rs
    crates/tenor-core/src/pass6_serialize.rs
  </files>
  <action>
    This is a vertical slice: persona touches all passes. Use the compiler's exhaustive match checking as your guide — add the `Persona` variant to the enum, then fix every `match` that doesn't handle it.

    **Persona implementation (SPEC-01):**

    1. **ast.rs:** Add `Persona { id: String, prov: Provenance }` variant to `RawConstruct` enum.

    2. **parser.rs:** Add `"persona"` keyword to the construct parsing match. Implement `parse_persona()`:
       ```rust
       fn parse_persona(&mut self, line: u32) -> Result<RawConstruct, ElabError> {
           self.advance(); // consume 'persona'
           let id = self.take_word()?;
           Ok(RawConstruct::Persona {
               id,
               prov: Provenance { file: self.filename.clone(), line },
           })
       }
       ```
       Persona has no body (no braces) — it is just `persona <id>`.

    3. **pass1_bundle.rs:** Handle `RawConstruct::Persona` in any match blocks for import/cross-file-dup logic. Treat like other constructs: check for cross-file duplicates on the `id` field.

    4. **pass2_index.rs:** Add `personas: HashMap<String, Provenance>` to `Index`. In `build_index()`, match on `RawConstruct::Persona { id, prov }`, insert into `idx.personas`, detect duplicate persona ids with the same error pattern as other constructs.

    5. **pass5_validate.rs:** Add persona reference validation:
       - In Operation validation: verify each persona in `allowed_personas` (or `personas` field) is declared as a Persona construct in the index
       - In Flow step validation: verify persona references (`as` field persona, `from_persona`/`to_persona` in HandoffStep) are declared
       - Report errors for undeclared persona references

    6. **pass6_serialize.rs:** Serialize Persona constructs:
       ```json
       {"id": "...", "kind": "Persona", "provenance": {...}, "tenor": "1.0"}
       ```
       Keys in lexicographic order. Add Persona to the bundle's `constructs` array.

    **Operation outcomes (SPEC-02 / P7):**

    1. **ast.rs:** Add `outcomes: Vec<String>` to the `RawConstruct::Operation` variant. Make it optional during parsing for backward compatibility with existing fixtures.

    2. **parser.rs:** In the Operation field parsing match block, add handler for `"outcomes"` that parses an array of identifiers: `outcomes = self.parse_ident_array()?;`. If `parse_ident_array` doesn't exist, implement it as parsing `[id1, id2, ...]`.

    3. **pass5_validate.rs:** For Operations that declare outcomes:
       - Validate outcomes is non-empty (if declared)
       - Validate outcomes are disjoint from error_contract names (outcomes and errors are disjoint channels)
       - For multi-outcome Operations, validate effect-to-outcome association completeness

    4. **pass6_serialize.rs:** Serialize `"outcomes"` array in Operation interchange JSON (only if outcomes is non-empty, to maintain backward compatibility with existing v0.3 fixtures that lack outcomes).

    **CRITICAL decision from research:** Make `outcomes` optional during parsing (default to empty Vec). The existing v0.3 fixtures do not declare outcomes. Existing fixtures will be updated in Task 2 to add persona declarations and outcomes where appropriate, but Operations without explicit outcomes should still elaborate correctly.
  </action>
  <verify>
    Run `cargo build -p tenor-core` — compiles without warnings about non-exhaustive matches.
    Create a quick test file with `persona admin` and an Operation with `outcomes: [approved, denied]` — verify it parses and elaborates.
    Verify the compiler is not emitting warnings about unhandled Persona variants in any match expressions.
  </verify>
  <done>
    Persona is a first-class construct: parsed, indexed (with duplicate detection), validated (persona reference checking), and serialized. Operation outcomes field is parsed and serialized. Elaborator handles v1.0 constructs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update version strings and all conformance fixture expected outputs to v1.0</name>
  <files>
    crates/tenor-core/src/pass6_serialize.rs
    conformance/positive/*.expected.json
    conformance/negative/**/*.expected-error.json
    conformance/numeric/*.expected.json
    conformance/promotion/*.expected.json
    conformance/shorthand/*.expected.json
    conformance/cross_file/*.expected.json
  </files>
  <action>
    **Step 1: Update version strings in serialization code.** In `pass6_serialize.rs`:
    - Change all occurrences of `"0.3"` to `"1.0"` (the per-construct `tenor` field)
    - Add `"tenor_version": "1.0.0"` to the bundle envelope (the top-level JSON object)
    - The bundle envelope should have `"tenor_version": "1.0.0"` as a sibling of the `"constructs"` array

    **Step 2: Bulk-update all `.expected.json` files.** Every positive test's `.expected.json` contains `"tenor": "0.3"` in multiple constructs. Replace all occurrences:
    - Find and replace `"tenor": "0.3"` with `"tenor": "1.0"` across ALL expected JSON files
    - Add `"tenor_version": "1.0.0"` to the bundle envelope in every positive test's expected JSON (the top-level object alongside `"constructs"`)

    Affected directories:
    - `conformance/positive/*.expected.json`
    - `conformance/numeric/*.expected.json`
    - `conformance/promotion/*.expected.json`
    - `conformance/shorthand/*.expected.json`
    - `conformance/cross_file/*.expected.json`

    **Step 3: Update existing .tenor fixtures to add persona declarations.** For existing positive test fixtures that reference personas in Operations (e.g., `operation_basic.tenor`, `integration_escrow.tenor`):
    - Add `persona <id>` declarations at the top of the file for each persona referenced
    - This satisfies the v1.0 validation that persona references must resolve to declared Persona constructs
    - For fixtures that do NOT reference personas (e.g., `fact_basic.tenor`, `entity_basic.tenor`), no change needed

    **Step 4: Update expected JSONs to include Persona serialization.** For any `.tenor` file that now has persona declarations, update the corresponding `.expected.json` to include the serialized Persona constructs in the `constructs` array.

    **Step 5: Run the full conformance suite.**
    ```
    cargo run -p tenor-cli -- run conformance
    ```
    All 47 tests must pass. If any fail, examine the diff carefully — likely a missing `"tenor_version"` field or a persona not added to a fixture that references one.

    **Pitfall avoidance (from research):**
    - The version string appears in EVERY construct in EVERY expected JSON — this is a bulk operation, not a targeted edit
    - `"tenor_version": "1.0.0"` goes in the bundle envelope (top level), NOT inside individual constructs
    - Per-construct field stays as `"tenor": "1.0"` (short version), bundle gets `"tenor_version": "1.0.0"` (semver)
    - JSON keys must remain in lexicographic order within each object
  </action>
  <verify>
    Run `cargo run -p tenor-cli -- run conformance` — 47/47 passing.
    Spot-check `conformance/positive/fact_basic.expected.json` — must contain `"tenor": "1.0"` and `"tenor_version": "1.0.0"`.
    Spot-check `conformance/positive/integration_escrow.expected.json` — must contain Persona construct entries if the .tenor file references personas.
    Verify no `.expected.json` file contains `"0.3"` anywhere: `grep -r '"0.3"' conformance/` should return no matches.
  </verify>
  <done>
    All conformance fixtures updated to v1.0: version strings bumped, tenor_version field added to bundle envelopes, persona declarations added where Operations reference personas. All 47 tests pass with v1.0 expected outputs.
  </done>
</task>

</tasks>

<verification>
1. `cargo run -p tenor-cli -- run conformance` reports 47/47 passing
2. `grep -r '"0.3"' conformance/` returns no matches (all version strings updated)
3. `grep -c '"tenor_version"' conformance/positive/fact_basic.expected.json` returns 1
4. A test file with `persona admin` parses and elaborates to JSON with `"kind": "Persona"`
5. An Operation with `outcomes: [approved, denied]` elaborates with an `"outcomes"` array in the JSON
</verification>

<success_criteria>
- Persona construct fully implemented across all passes (parse, index, validate, serialize)
- Operation outcomes field parsed and serialized
- All version strings updated from 0.3 to 1.0 across elaborator and conformance fixtures
- Bundle envelope includes tenor_version: 1.0.0
- All 47 existing conformance tests pass with updated expected outputs
</success_criteria>

<output>
After completion, create `.planning/phases/02-foundation/02-03-SUMMARY.md`
</output>
