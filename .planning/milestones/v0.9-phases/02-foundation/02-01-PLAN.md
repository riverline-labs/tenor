---
phase: 02-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/tenor-core/Cargo.toml
  - crates/tenor-core/src/lib.rs
  - crates/tenor-core/src/ast.rs
  - crates/tenor-core/src/error.rs
  - crates/tenor-core/src/lexer.rs
  - crates/tenor-core/src/parser.rs
  - crates/tenor-core/src/pass1_bundle.rs
  - crates/tenor-core/src/pass2_index.rs
  - crates/tenor-core/src/pass3_types.rs
  - crates/tenor-core/src/pass4_typecheck.rs
  - crates/tenor-core/src/pass5_validate.rs
  - crates/tenor-core/src/pass6_serialize.rs
  - crates/tenor-core/src/elaborate.rs
  - crates/tenor-cli/Cargo.toml
  - crates/tenor-cli/src/main.rs
  - crates/tenor-cli/src/runner.rs
  - crates/tenor-cli/src/tap.rs
  - crates/tenor-cli/src/ambiguity/mod.rs
  - crates/tenor-cli/src/ambiguity/api.rs
  - crates/tenor-cli/src/ambiguity/compare.rs
  - crates/tenor-cli/src/ambiguity/fixtures.rs
  - crates/tenor-cli/src/ambiguity/prompt.rs
  - crates/tenor-cli/src/ambiguity/report.rs
autonomous: true
requirements:
  - FNDN-01
  - FNDN-02
  - FNDN-03

must_haves:
  truths:
    - "Cargo workspace compiles with `cargo build --workspace` from repo root"
    - "All 47 conformance tests pass via `cargo run -p tenor-cli -- run conformance`"
    - "elaborate.rs is decomposed into 6 per-pass modules inside tenor-core"
    - "tenor-core is a library crate and tenor-cli is a binary crate depending on it"
  artifacts:
    - path: "Cargo.toml"
      provides: "Workspace root with members"
      contains: "[workspace]"
    - path: "crates/tenor-core/src/lib.rs"
      provides: "Library crate re-exporting elaboration API"
      contains: "pub mod"
    - path: "crates/tenor-core/src/pass1_bundle.rs"
      provides: "Pass 1 bundle assembly extracted from elaborate.rs"
      min_lines: 30
    - path: "crates/tenor-core/src/pass6_serialize.rs"
      provides: "Pass 6 serialization extracted from elaborate.rs"
      min_lines: 100
    - path: "crates/tenor-cli/src/main.rs"
      provides: "CLI binary entry point"
      contains: "tenor_core"
  key_links:
    - from: "crates/tenor-cli/src/main.rs"
      to: "crates/tenor-core/src/elaborate.rs"
      via: "use tenor_core::elaborate"
      pattern: "tenor_core::elaborate"
    - from: "crates/tenor-core/src/elaborate.rs"
      to: "crates/tenor-core/src/pass1_bundle.rs"
      via: "module calls"
      pattern: "pass1_bundle::"
---

<objective>
Extract the monolithic elaborator into a Cargo workspace with `tenor-core` (library) and `tenor-cli` (binary) crates, decomposing `elaborate.rs` into per-pass modules.

Purpose: This is the structural foundation for all subsequent phases. Downstream crates (eval, analyze, codegen, lsp) need to import typed intermediate representations from `tenor-core`. The existing monolith cannot support this.

Output: Working Cargo workspace where `cargo build --workspace` compiles and `cargo run -p tenor-cli -- run conformance` passes 47/47 tests.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-foundation/02-RESEARCH.md

@elaborator/src/elaborate.rs
@elaborator/src/parser.rs
@elaborator/src/lexer.rs
@elaborator/src/error.rs
@elaborator/src/main.rs
@elaborator/src/runner.rs
@elaborator/src/tap.rs
@elaborator/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cargo workspace and extract tenor-core pass modules</name>
  <files>
    Cargo.toml
    crates/tenor-core/Cargo.toml
    crates/tenor-core/src/lib.rs
    crates/tenor-core/src/ast.rs
    crates/tenor-core/src/error.rs
    crates/tenor-core/src/lexer.rs
    crates/tenor-core/src/parser.rs
    crates/tenor-core/src/pass1_bundle.rs
    crates/tenor-core/src/pass2_index.rs
    crates/tenor-core/src/pass3_types.rs
    crates/tenor-core/src/pass4_typecheck.rs
    crates/tenor-core/src/pass5_validate.rs
    crates/tenor-core/src/pass6_serialize.rs
    crates/tenor-core/src/elaborate.rs
  </files>
  <action>
    **Step 1: Create workspace root Cargo.toml** at repo root with `[workspace]` declaring members `crates/tenor-core` and `crates/tenor-cli`. Use `resolver = "2"`, `[workspace.package]` with `version = "0.1.0"` and `edition = "2021"`, and `[workspace.dependencies]` for `serde = { version = "1", features = ["derive"] }`, `serde_json = "1"`, `ureq = { version = "3", features = ["json"] }`.

    **Step 2: Create crates/tenor-core/Cargo.toml** with `name = "tenor-core"`, `version.workspace = true`, `edition.workspace = true`, dependencies: `serde.workspace = true`, `serde_json.workspace = true`.

    **Step 3: Extract shared types into ast.rs.** Move `RawConstruct`, `RawType`, `RawExpr`, `RawTerm`, `RawLiteral`, `Provenance`, `Spanned`, and any other shared type definitions from `parser.rs` into `crates/tenor-core/src/ast.rs`. Add `pub use crate::ast::*;` re-exports from `parser.rs` to maintain backward compatibility within the crate during the transition. All types must be `pub`.

    **Step 4: Move lexer.rs, parser.rs, error.rs** into `crates/tenor-core/src/`. Update `use` paths: replace `crate::parser::` with `crate::ast::` where types were moved. Keep `parser.rs` re-exporting from `ast.rs` until all callers are updated. Lexer stays unchanged (it has no construct awareness).

    **Step 5: Decompose elaborate.rs into 6 pass modules.** Read the existing `elaborate.rs` and split by pass boundaries identified in the research:
    - `pass1_bundle.rs`: `load_bundle()`, `load_file()`, `check_cross_file_dups()` and related helpers (Pass 0+1: parsing + bundle assembly)
    - `pass2_index.rs`: `build_index()`, `Index` struct definition (Pass 2)
    - `pass3_types.rs`: `build_type_env()`, `detect_typedecl_cycle()`, `resolve_typedecl()`, TypeEnv type alias (Pass 3)
    - `pass4_typecheck.rs`: `resolve_types()`, `type_check_rules()`, `type_check_expr()`, `type_of_fact_term()` (Pass 4)
    - `pass5_validate.rs`: `validate()`, `validate_entity()`, `validate_entity_dag()`, `validate_rule()`, `validate_operation()`, `validate_operation_transitions()`, `validate_flow()` (Pass 5)
    - `pass6_serialize.rs`: `serialize()` and all serialization helpers (Pass 6)

    Each module gets `use` imports from `crate::ast`, `crate::error`, and sibling modules as needed. Functions that were private in elaborate.rs become `pub(crate)` or `pub` depending on whether they need external visibility.

    **Step 6: Create thin elaborate.rs orchestrator** in `crates/tenor-core/src/elaborate.rs` that imports all pass modules and exposes the public `pub fn elaborate(root_path: &Path) -> Result<Value, ElabError>` function, calling passes in order. This is the same signature the conformance runner expects.

    **Step 7: Create lib.rs** that declares all modules (`pub mod ast; pub mod error; pub mod lexer; pub mod parser; pub mod pass1_bundle; pub mod pass2_index; pub mod pass3_types; pub mod pass4_typecheck; pub mod pass5_validate; pub mod pass6_serialize; pub mod elaborate;`) and re-exports the public API.

    **CRITICAL:** Do NOT change any behavioral logic. This is purely structural code motion. The `elaborate()` function signature must remain identical. Run the conformance suite after each major step to catch regressions early.

    **Pitfall avoidance:** When moving types from parser.rs to ast.rs, temporarily re-export via `pub use crate::ast::*;` from parser.rs to avoid cascading import failures. The `Index` struct in pass2_index.rs and `TypeEnv` in pass3_types.rs may reference types from ast.rs — ensure the import paths are correct.
  </action>
  <verify>
    Run `cd /Users/bwb/src/rll/tenor && cargo build -p tenor-core` — must compile without errors.
    Verify all pass module files exist: `ls crates/tenor-core/src/pass*.rs` should show 6 files.
    Verify `crates/tenor-core/src/lib.rs` exists and declares all modules.
  </verify>
  <done>
    tenor-core library crate compiles. elaborate.rs is decomposed into 6 per-pass modules plus orchestrator. All shared types in ast.rs. No behavioral changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tenor-cli binary crate and verify conformance</name>
  <files>
    crates/tenor-cli/Cargo.toml
    crates/tenor-cli/src/main.rs
    crates/tenor-cli/src/runner.rs
    crates/tenor-cli/src/tap.rs
    crates/tenor-cli/src/ambiguity/mod.rs
    crates/tenor-cli/src/ambiguity/api.rs
    crates/tenor-cli/src/ambiguity/compare.rs
    crates/tenor-cli/src/ambiguity/fixtures.rs
    crates/tenor-cli/src/ambiguity/prompt.rs
    crates/tenor-cli/src/ambiguity/report.rs
  </files>
  <action>
    **Step 1: Create crates/tenor-cli/Cargo.toml** with:
    - `name = "tenor-cli"`, `version.workspace = true`, `edition.workspace = true`
    - `[[bin]]` section: `name = "tenor"`, `path = "src/main.rs"`
    - Dependencies: `tenor-core = { path = "../tenor-core" }`, `serde_json.workspace = true`, `ureq.workspace = true`

    **Step 2: Move CLI files** from `elaborator/src/` to `crates/tenor-cli/src/`:
    - `main.rs` → update imports to use `tenor_core::elaborate` and `tenor_core::error` instead of `crate::elaborate` and `crate::error`
    - `runner.rs` → update imports: use `tenor_core::elaborate::elaborate` and `tenor_core::error::ElabError`
    - `tap.rs` → copy as-is (no external dependencies)
    - `ambiguity/` directory → copy entire directory, update imports to use `tenor_core::` paths where needed

    **Step 3: Update runner.rs** to call `tenor_core::elaborate::elaborate()` for each test. The runner currently calls `crate::elaborate::elaborate()` — change to `tenor_core::elaborate::elaborate()`. The JSON comparison logic (`json_equal`) stays in runner.rs (it's CLI tooling, not core logic).

    **Step 4: Update main.rs** to use `tenor_core::elaborate::elaborate` and `tenor_core::error::ElabError`. The command dispatch (`run`, `elaborate`, `ambiguity`) stays in main.rs. Keep the binary name as `tenor` via the `[[bin]]` section.

    **Step 5: Remove (or rename) the old elaborator/ directory.** Rename `elaborator/` to `elaborator.old/` (do NOT delete yet — keep as reference until conformance passes). Once tests pass, delete `elaborator.old/`.

    **Step 6: Run full conformance suite:**
    ```
    cargo run -p tenor-cli -- run conformance
    ```
    All 47 tests must pass. If any fail, debug by comparing output diffs — likely an import path or module visibility issue.

    **Note on conformance path:** The runner resolves fixture paths relative to the working directory, not the binary location. Run from repo root with `conformance` as the suite path argument. If paths break, check `runner.rs` path construction.
  </action>
  <verify>
    Run `cd /Users/bwb/src/rll/tenor && cargo run -p tenor-cli -- run conformance` — must show 47/47 passing.
    Run `cd /Users/bwb/src/rll/tenor && cargo run -p tenor-cli -- elaborate conformance/positive/fact_basic.tenor` — must output valid JSON.
    Run `cd /Users/bwb/src/rll/tenor && cargo build --workspace` — entire workspace must compile.
    Verify old `elaborator/` directory is removed or renamed.
  </verify>
  <done>
    Cargo workspace with tenor-core (library) and tenor-cli (binary) crates. All 47 conformance tests pass. `cargo build --workspace` succeeds. The `elaborate` and `run` CLI commands work via `cargo run -p tenor-cli`.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` compiles without errors
2. `cargo run -p tenor-cli -- run conformance` reports 47/47 passing
3. `cargo run -p tenor-cli -- elaborate conformance/positive/fact_basic.tenor` produces valid interchange JSON
4. `ls crates/tenor-core/src/pass*.rs` shows 6 pass module files
5. `crates/tenor-core/src/lib.rs` declares and re-exports all modules
6. No files remain in `elaborator/src/` (old directory removed)
</verification>

<success_criteria>
- Cargo workspace structure established with tenor-core and tenor-cli as separate crates
- elaborate.rs decomposed into pass1_bundle.rs through pass6_serialize.rs plus thin orchestrator
- All 47 conformance tests pass unchanged
- CLI commands (run, elaborate, ambiguity) work through tenor-cli binary
</success_criteria>

<output>
After completion, create `.planning/phases/02-foundation/02-01-SUMMARY.md`
</output>
