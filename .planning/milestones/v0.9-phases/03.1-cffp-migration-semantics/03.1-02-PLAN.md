---
phase: 03.1-cffp-migration-semantics
plan: 02
type: execute
wave: 2
depends_on:
  - 03.1-01
files_modified:
  - docs/TENOR.md
autonomous: true
requirements:
  - MIGR-04

must_haves:
  truths:
    - "TENOR.md contains a new Versioning & Migration section with numbered subsections"
    - "The breaking change taxonomy table covers all six construct kinds with per-field classifications"
    - "Executor migration obligations are numbered (M1, M2, ...) paralleling the E1-E9 pattern in Section 16"
    - "In-flight flow migration policy declaration is mandatory for any deployment with breaking changes"
    - "The section clearly distinguishes contract content versioning from interchange format versioning (Section 13.2.1)"
    - "Table of Contents updated to include the new section"
  artifacts:
    - path: "docs/TENOR.md"
      provides: "Versioning & Migration spec section"
      contains: "Versioning & Migration"
  key_links:
    - from: "docs/TENOR.md"
      to: "docs/cffp/migration-semantics.json"
      via: "CFFP provenance reference"
      pattern: "cffp/migration-semantics"
    - from: "docs/TENOR.md"
      to: "docs/TENOR.md Section 16"
      via: "Cross-reference to Executor Obligations"
      pattern: "Section 16|§16"
---

<objective>
Translate the CFFP canonical form from Plan 01 into a new Versioning & Migration section in TENOR.md — the authoritative spec prose defining breaking change taxonomy, executor migration obligations, and mandatory in-flight flow migration policy declaration.

Purpose: MIGR-04 requires a spec section defining executor obligations for contract version transitions. This section provides the formal specification that Phase 4's `tenor diff --breaking` and `tenor diff --explain` will implement.

Output: Updated `docs/TENOR.md` with new Section 17 (Versioning & Migration), pushing current Section 17 (Pending Work) to Section 18.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-cffp-migration-semantics/03.1-01-SUMMARY.md
@docs/cffp/migration-semantics.json
@docs/TENOR.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Versioning & Migration spec section in TENOR.md</name>
  <files>docs/TENOR.md</files>
  <action>
Add a new Section 17 "Versioning & Migration" to docs/TENOR.md, between the current Section 16 (Executor Obligations) and Section 17 (Pending Work). The current Section 17 (Pending Work) becomes Section 18. Update all internal cross-references accordingly.

The new section structure (following the pattern from RESEARCH.md Pattern 3):

```markdown
## 17. Versioning & Migration

### 17.1 The Migration Problem

[1-2 paragraph framing. Key points:
- A Tenor contract is the complete system description (C5 closed-world).
- When a contract changes, every executor built against the previous version must adapt.
- This section defines WHAT constitutes a breaking change and WHAT obligations executors have — not HOW executors should implement migration (that is deployment-specific).
- Distinguish from Section 13.2.1 (interchange format versioning): that covers the JSON structure version; this covers business logic content changes.
- Reference the CFFP provenance: docs/cffp/migration-semantics.json]

### 17.2 Breaking Change Taxonomy

[Opening paragraph explaining the classification system:
- Changes are classified as BREAKING, NON-BREAKING, or REQUIRES-ANALYSIS
- BREAKING: the change may invalidate existing executor behavior, entity state, or in-flight flows
- NON-BREAKING: the change is safe — no existing executor behavior is affected
- REQUIRES-ANALYSIS: the change's impact depends on the specific predicate/expression and requires static analysis (S1-S7) to classify definitively
- For each change, separately assess: impact on new flow initiations vs impact on in-flight flows]

Then include the complete taxonomy table, organized by construct kind. Pull the classifications directly from the CFFP canonical form (docs/cffp/migration-semantics.json, phase6.canonical.formal_statement). Use the comprehensive analysis from the RESEARCH.md as the baseline, but honor any refinements made during the CFFP pressure testing.

Format as subsections per construct kind:

#### 17.2.1 Fact Changes
[Table with columns: Field | Change Type | Classification | Reason | In-Flight Impact]

#### 17.2.2 Entity Changes
[Table]

#### 17.2.3 Rule Changes
[Table]

#### 17.2.4 Persona Changes
[Table]

#### 17.2.5 Operation Changes
[Table — note that outcome addition is BREAKING due to §11.5 exhaustive handling]

#### 17.2.6 Flow Changes
[Table]

### 17.3 Executor Migration Obligations

[Numbered obligations M1-Mn, paralleling E1-E9 from Section 16. Each obligation must be:
- Numbered (M1, M2, ...)
- Precise enough for an executor implementer to verify compliance
- Scoped to what the spec requires, not how to implement it]

Minimum obligations to include:
- M1: An executor MUST be able to determine whether a contract version transition contains breaking changes (i.e., apply the taxonomy from §17.2).
- M2: An executor deploying a new contract version with any BREAKING changes MUST declare an in-flight flow migration policy (§17.4).
- M3: An executor MUST NOT silently deploy a contract version with BREAKING changes without migration policy declaration.
- M4: An executor MUST validate that all entities in states removed by the new contract version have been migrated before completing the transition.
- M5: An executor MUST validate that all in-flight flows referencing removed or changed constructs are handled per the declared migration policy.
- M6: Changes classified as REQUIRES-ANALYSIS MUST be treated as BREAKING unless static analysis (S1-S7) proves them non-breaking for the specific contract pair.

### 17.4 In-Flight Flow Migration Policy

[Define the mandatory policy declaration and the three standard policies:

1. **Blue-Green**: New flows start on the new contract version. In-flight flows complete execution on the old contract version. No flow transitions between versions. Requires maintaining both contract versions simultaneously until all old-version flows complete.

2. **Force-Migrate**: All in-flight flows transition to the new contract version. The executor MUST handle state incompatibilities (e.g., entities in removed states, operations with changed effects). This is the most complex policy and places the highest burden on the executor.

3. **Abort**: In-flight flows affected by breaking changes are terminated with a migration-abort error. New flows start on the new contract version. Simplest policy but may lose in-progress work.

Key constraints:
- The policy is a DEPLOYMENT concern, not a CONTRACT concern. It does not affect evaluation semantics, verdict resolution, or any contract-level behavior (MI6).
- The policy applies to ALL in-flight flows, not a subset (MI7).
- The spec does not prescribe which policy to use — only that one MUST be declared.
- Frozen verdict semantics (§14) provide natural isolation at the verdict layer: in-flight flow snapshots are immutable, so rule/fact changes do NOT affect in-flight flow verdicts. However, operation execution against live entity state IS affected by entity state changes and operation definition changes.]

### 17.5 Migration Contract Representation

[Based on the CFFP outcome (Candidate B or C selected per user directive):
- Define how migration output is expressed as a Tenor contract
- If hybrid (C): `tenor diff` produces JSON DiffEntry; `tenor diff --migration` produces a Tenor contract
- Reference the canonical form from the CFFP run for the formal definition
- Note that the migration contract uses Tenor's existing constructs (no new constructs required for v1.0)
- Describe the conventions for mapping diff concepts to Tenor constructs (e.g., Facts represent before/after state, Rules classify changes, etc.)
- Acknowledge limitations from the CFFP run's scope_narrowings]
```

Important conventions:
- Use the same writing style as existing TENOR.md sections (formal, precise, numbered subsections)
- Cross-reference other sections using §N.M notation (e.g., §16.2, §13.2.1, §11.5, §14)
- Include a CFFP provenance note at the end of the section: "This section was derived through the Constraint-First Formalization Protocol (CFFP). See docs/cffp/migration-semantics.json for the full formalization record."
- Do NOT modify existing sections 1-16 content (only add the new section and renumber 17→18)
  </action>
  <verify>
1. Verify the new section exists: `grep -n "## 17. Versioning" docs/TENOR.md` returns a match
2. Verify old Section 17 was renumbered: `grep -n "## 18. Pending Work" docs/TENOR.md` returns a match
3. Verify taxonomy tables exist for all construct kinds: `grep -c "#### 17.2" docs/TENOR.md` returns at least 6
4. Verify migration obligations exist: `grep -c "^- M[0-9]" docs/TENOR.md` returns at least 6
5. Verify CFFP provenance reference: `grep "cffp/migration-semantics" docs/TENOR.md`
6. Verify in-flight policy section: `grep "Blue-Green\|Force-Migrate\|Abort" docs/TENOR.md`
  </verify>
  <done>
TENOR.md contains a new Section 17 (Versioning & Migration) with: (1) breaking change taxonomy tables for all six construct kinds, (2) numbered executor migration obligations M1-M6+, (3) mandatory in-flight flow migration policy declaration with three policy options, (4) migration contract representation section, (5) CFFP provenance reference. Former Section 17 (Pending Work) is now Section 18. All internal cross-references updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Table of Contents, Appendix A (Acknowledged Limitations), and cross-references</name>
  <files>docs/TENOR.md</files>
  <action>
Update all supporting sections in TENOR.md for consistency with the new Section 17:

1. **Table of Contents** (near the top of TENOR.md): Add "17. Versioning & Migration" with subsections (17.1-17.5). Update "17. Pending Work" to "18. Pending Work". Update any other ToC entries that reference section numbers > 16.

2. **Appendix A — Acknowledged Limitations**: Add new AL entries for any scope_narrowings from the CFFP run (migration-semantics.json phase6.canonical.acknowledged_limitations). Follow the existing AL numbering pattern (next available AL number after the current highest). Each entry should reference §17 and describe the limitation.

3. **Section 18 (formerly 17) — Pending Work**: Update any items that reference migration, breaking changes, or versioning. If migration-related pending work items exist, either mark them as resolved (if covered by §17) or update their section references.

4. **Cross-reference audit**: Search TENOR.md for any existing references to "Section 17" or "§17" that now need to point to "Section 18" or "§18". Also check for references to migration, versioning, or breaking changes in Sections 13 (ElaboratorSpec), 14 (Evaluation Model), 15 (Static Analysis), and 16 (Executor Obligations) that should cross-reference the new §17.

5. **Executor Obligations (Section 16)**: Add a brief cross-reference note in §16 pointing to §17 for migration-specific obligations. Do NOT modify E1-E9 — the migration obligations are M1-Mn in §17.3, not additions to E1-E9.

Do NOT change any spec semantics in existing sections. Only add cross-references and update section numbers.
  </action>
  <verify>
1. Verify ToC includes Section 17: `grep "17\. Versioning" docs/TENOR.md | head -2` shows both heading and ToC entry
2. Verify no stale "Section 17" references to Pending Work: `grep -n "Section 17" docs/TENOR.md` — all should reference Versioning & Migration or be updated to Section 18
3. Verify Appendix A has new AL entries: `grep -c "^- \*\*AL" docs/TENOR.md` — count should be higher than before
4. Verify Section 18 heading: `grep "## 18\. Pending Work" docs/TENOR.md`
5. Run the elaborator conformance suite to ensure no spec-dependent behavior changed: `cargo run -p tenor-cli -- test conformance` — should still be 55/55 passing
  </verify>
  <done>
TENOR.md is internally consistent: Table of Contents updated, all section references corrected (17→18 for Pending Work), Appendix A includes migration-related acknowledged limitations, cross-references between §16 (Executor Obligations) and §17 (Versioning & Migration) are bidirectional. Conformance suite still passes (no behavioral changes).
  </done>
</task>

</tasks>

<verification>
1. `grep -c "## 17\. Versioning" docs/TENOR.md` returns 1
2. `grep -c "## 18\. Pending Work" docs/TENOR.md` returns 1
3. All six construct kinds have taxonomy entries: `grep -c "#### 17.2" docs/TENOR.md` >= 6
4. Migration obligations numbered: `grep "M[0-9]" docs/TENOR.md | head -10` shows M1 through M6+
5. CFFP provenance: `grep "migration-semantics.json" docs/TENOR.md` returns match
6. Conformance suite unchanged: `cargo run -p tenor-cli -- test conformance` — 55/55 passing
7. ToC updated: `grep "Versioning" docs/TENOR.md | head -2` shows ToC entry and section heading
</verification>

<success_criteria>
- TENOR.md has a new Section 17 (Versioning & Migration) with complete subsections 17.1-17.5
- Breaking change taxonomy covers all six construct kinds with per-field classification tables
- Executor migration obligations M1-M6+ are numbered and precise
- In-flight flow migration policy section defines blue-green, force-migrate, and abort
- Migration contract representation section reflects CFFP outcome
- Former Section 17 (Pending Work) renumbered to Section 18
- Table of Contents and cross-references updated
- Appendix A includes migration-related acknowledged limitations
- Conformance suite still passes (no behavioral changes)
- CFFP provenance referenced in the new section
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-cffp-migration-semantics/03.1-02-SUMMARY.md`
</output>
