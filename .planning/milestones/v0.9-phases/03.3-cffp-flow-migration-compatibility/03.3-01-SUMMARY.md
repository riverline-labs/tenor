---
phase: 03.3-cffp-flow-migration-compatibility
plan: 01
subsystem: spec
tags: [cffp, migration, flow-compatibility, versioning, frozen-verdict, entity-state, directional-asymmetry]

# Dependency graph
requires:
  - phase: 03.1-cffp-migration-semantics
    provides: "Breaking change taxonomy (MI1-MI7), three migration policies (blue-green, force-migrate, abort), Section 17 in TENOR.md"
provides:
  - "CFFP artifact defining flow migration compatibility with 7 invariants (FMC1-FMC7)"
  - "Three-layer analysis model (verdict isolated, entity state checked, operation/flow structure checked)"
  - "5 static obligations (SO1-SO5) for Phase 4 implementation"
  - "Canonical form: position-sensitive compatibility function for force-migration safety"
  - "Coexistence layer pattern documented as executor strategy"
affects: [03.3-02-PLAN, phase-4-static-analysis, tenor-diff-breaking]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Three-layer compatibility analysis: Layer 1 (verdict isolation by frozen snapshot), Layer 2 (entity state equivalence), Layer 3 (operation/flow structure + dependencies)"
    - "Position-sensitive per-instance analysis (not per-flow-type)"
    - "Reachable path computation uses v2's step graph from current position"
    - "Flow-level compatibility refines construct-level breaking change taxonomy"

key-files:
  created:
    - docs/cffp/flow-migration-compatibility.json
  modified: []

key-decisions:
  - "Candidate C (layered analysis) selected via collapse -- subsumes graph-theoretic (A) and predicate-based (B) candidates by incorporating both plus frozen verdict isolation insight"
  - "Reachable path uses v2's step graph from current position, not v1's -- routing after migration follows v2 semantics"
  - "Flow-level compatibility refines construct-level breaking change classification -- a BREAKING construct change may be COMPATIBLE at specific flow positions"
  - "Conservative data dependency analysis (frozen snapshot + current entity states) is REQUIRED; aggressive analysis with intra-path production is OPTIONAL"
  - "Coexistence layer is executor strategy (MAY implement), not spec obligation (MUST implement)"

patterns-established:
  - "CFFP layered analysis: decompose compatibility by Tenor isolation properties (verdict frozen, entity live, operation live)"
  - "Position-sensitive function signature: compatible(v1_flow, v2_flow, position, entity_states, snapshot)"

requirements-completed: [MIGR-02]

# Metrics
duration: 7min
completed: 2026-02-22
---

# Phase 03.3 Plan 01: CFFP Flow Migration Compatibility Summary

**CFFP run formalizing flow migration compatibility as three-layer position-sensitive analysis: verdict isolation (frozen snapshot), entity state equivalence, and operation/flow structure with 7 invariants, 3 candidates collapsed, 12 counterexamples, and canonical form defining when force-migrate is safe per flow instance**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-22T04:03:53Z
- **Completed:** 2026-02-22T04:11:00Z
- **Tasks:** 2
- **Files modified:** 1

## Accomplishments
- 7 invariants declared (FMC1-FMC7) covering forward path existence, data dependency satisfaction, entity state equivalence, directional asymmetry, position sensitivity, recursive sub-flow compatibility, and semantic non-interference
- 3 candidate formalisms (graph-theoretic, predicate-based, layered analysis) with full claims against all 7 invariants
- 12 counterexamples pressure-testing escrow (safe/unsafe), position sensitivity, approval chain, subscription outcomes, sub-flow recursion, parallel branches, frozen verdict isolation, persona auth, and entity parent changes
- 3 scope narrowings discovered: v2 routing for reachable paths, flow-level refines construct-level taxonomy, intra-path dependency production
- Canonical form with three-layer analysis model and 6 acknowledged limitations
- 5 static obligations (SO1-SO5) defining what Phase 4's `tenor diff --breaking` must implement for flow-level analysis

## Task Commits

Each task was committed atomically:

1. **Task 1: CFFP Phases 1-3 (Invariants, Candidates, Pressure Testing)** - `770204d` (feat)
2. **Task 2: CFFP Phases 4-6 (Collapse, Static Obligations, Canonical Form)** - `c363fc9` (feat)

## Files Created/Modified
- `docs/cffp/flow-migration-compatibility.json` - Complete CFFP instance with all 6 phases defining flow migration compatibility

## Decisions Made
- **Candidate C selected via collapse:** The layered analysis candidate subsumes the graph-theoretic (A) and predicate-based (B) candidates. It incorporates A's graph traversal in Layer 3, B's predicate decomposition across three layers, and adds the frozen verdict isolation insight (Layer 1) unique to Tenor's evaluation model.
- **Reachable path uses v2's graph:** After the CE5 (approval chain) counterexample revealed that routing at the current step should use v2's definition, all candidates adopted the narrowing that ReachablePaths is computed from v2's step graph, not v1's.
- **Flow-level refines construct-level:** The CE6 (subscription outcome) counterexample showed that a construct-level BREAKING change (new operation outcome) can be flow-level COMPATIBLE if v2's flow handles the new outcome. This means flow compatibility is a refinement, not a replacement, of Section 17.2.
- **Conservative dependency analysis required:** The CE8 (parallel branch) counterexample showed that intra-path dependency production (verdicts produced by earlier v2 steps) would require path dominance analysis. Conservative analysis (snapshot + current entity states only) is the required baseline; aggressive analysis is optional.
- **Coexistence layer is executor strategy:** Documented as one valid approach, not prescribed by spec. Executors may choose any strategy for incompatible flow instances.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- CFFP artifact complete and ready for Plan 02 (spec prose in TENOR.md Section 17.6)
- Canonical form's formal_statement is designed for direct translation into spec prose
- 5 static obligations (SO1-SO5) ready for Phase 4 implementation reference
- 6 acknowledged limitations ready for Appendix A entries

## Self-Check: PASSED

- FOUND: docs/cffp/flow-migration-compatibility.json
- FOUND: 770204d (Task 1 commit)
- FOUND: c363fc9 (Task 2 commit)
- FOUND: 03.3-01-SUMMARY.md

---
*Phase: 03.3-cffp-flow-migration-compatibility*
*Completed: 2026-02-22*
