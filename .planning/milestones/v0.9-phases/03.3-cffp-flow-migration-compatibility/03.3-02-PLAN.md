---
phase: 03.3-cffp-flow-migration-compatibility
plan: 02
type: execute
wave: 2
depends_on:
  - 03.3-01
files_modified:
  - docs/TENOR.md
autonomous: true
requirements:
  - MIGR-02
  - MIGR-04
must_haves:
  truths:
    - "TENOR.md Section 17 has a flow compatibility subsection defining when force-migration is safe"
    - "The three compatibility conditions (forward path, data dependency, entity state) are formally stated in the spec"
    - "Directional asymmetry is documented as a named problem with the escrow example"
    - "Coexistence layer pattern is described as an executor strategy, not a spec obligation"
    - "S6 (flow path enumeration) is cross-referenced for reachable path computation"
  artifacts:
    - path: "docs/TENOR.md"
      provides: "Section 17.6 Flow Migration Compatibility with formal definitions"
      contains: "FMC1"
  key_links:
    - from: "docs/TENOR.md Section 17.6"
      to: "docs/TENOR.md Section 15 (S6)"
      via: "Cross-reference for reachable path computation"
      pattern: "S6|§15"
    - from: "docs/TENOR.md Section 17.6"
      to: "docs/cffp/flow-migration-compatibility.json"
      via: "CFFP provenance block"
      pattern: "cffp/flow-migration-compatibility.json"
---

<objective>
Translate the CFFP canonical form from `docs/cffp/flow-migration-compatibility.json` into authoritative spec prose in TENOR.md — adding a new subsection to Section 17 (Versioning & Migration) that formally defines flow-level migration compatibility, documents the directional asymmetry problem, describes the coexistence layer pattern, and cross-references S6 for implementation.

Purpose: Give executor implementers a precise, formal definition of when force-migration is safe for a specific in-flight flow instance, replacing the current vague "executor MUST handle the consequences" language with testable conditions.

Output: Updated `docs/TENOR.md` with new Section 17.6 (Flow Migration Compatibility), updated Appendix A (new ALs), and cross-references.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.3-cffp-flow-migration-compatibility/3.3-RESEARCH.md
@.planning/phases/03.3-cffp-flow-migration-compatibility/03.3-01-SUMMARY.md

# CFFP artifact produced by Plan 01
@docs/cffp/flow-migration-compatibility.json

# Current spec — Section 17 structure, Appendix A numbering, ToC
@docs/TENOR.md

# Prior plan for spec prose translation pattern
@.planning/phases/03.1-cffp-migration-semantics/03.1-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Flow Migration Compatibility spec section and update Appendix A</name>
  <files>docs/TENOR.md</files>
  <action>
Add a new subsection to Section 17 in `docs/TENOR.md`. Based on the current structure (17.1 through 17.5), the new subsection should be **Section 17.6 Flow Migration Compatibility**.

**Section 17.6 content (translate from CFFP canonical form):**

1. **Opening paragraph:** Introduce the flow migration compatibility problem — flows are long-lived stateful processes that outlive deployment cycles. When an executor uses the force-migrate policy (§17.4), it must determine per-flow-instance whether migration is safe. This section defines the formal conditions.

2. **Position and Reachable Paths:** Define formally:
   - Position(flow, step_id) = the current step where the flow instance is waiting
   - ReachablePaths(flow, position) = set of all execution paths from position to a Terminal state
   - Cross-reference S6 (§15) for the mechanism to compute reachable paths
   - Note that ParallelStep produces Cartesian product of branch paths, SubFlowStep produces recursive path through referenced flow

3. **Step Equivalence:** Define when a v1 step has a v2 equivalent:
   - Same operation reference (operation id)
   - Same or compatible persona
   - All outcome routing targets exist in v2 (possibly at different step ids but with equivalent semantics transitively)
   - For BranchStep: both if_true and if_false targets have v2 equivalents
   - For SubFlowStep: the referenced sub-flow is itself compatible (recursive check, FMC6)
   - For ParallelStep: all branches have v2 equivalents and the join policy is equivalent

4. **The Three Compatibility Conditions (FMC1, FMC2, FMC3):**

   A flow instance at position p in contract v1 is **force-migratable** to contract v2 if and only if ALL three conditions hold:

   **Condition 1 — Forward Path Existence (FMC1):** For every step in every reachable future path from position p in v1, there exists a step in v2 with equivalent semantics (per step equivalence definition above). This ensures the flow can reach a Terminal state under v2.

   **Condition 2 — Backward Data Dependency Satisfaction (FMC2):** All data dependencies of v2 steps in reachable future paths from the migration point are satisfiable. A v2 step's data dependencies are: (a) facts referenced in the step's operation precondition that must be present in the frozen snapshot, (b) verdicts referenced in the step's operation precondition that must be present in the frozen snapshot, (c) entity states required as preconditions for the step's operation effects (the entity must be in the expected source state), (d) persona authorization (the step's persona must be authorized under v2 definitions). Each dependency is satisfiable if the required value exists in the frozen snapshot (taken at flow initiation under v1) or in the current live entity state.

   **Condition 3 — Entity State Equivalence (FMC3):** Every entity whose state was established by the v1 flow execution must have that state available in v2's entity definition. No entity may be in a state that v2 does not declare.

5. **Directional Asymmetry (FMC4):** Document the directional asymmetry problem as a structural property. Forward path existence alone is insufficient — v2 steps may require state, verdicts, or fact values that v1 never established because v1 never executed the steps that would produce them. Use the escrow example from the research: v2 adds step_compliance_check between step_confirm and step_check_threshold; a flow at step_check_threshold has a compatible forward path but fails FMC2 because the compliance verdict was never produced. The directional asymmetry makes FMC2 the hardest condition to verify — it requires analyzing what WOULD have been produced by steps the flow has already passed.

6. **Position Sensitivity (FMC5):** State explicitly that flow compatibility is a function of (flow_definition_v1, flow_definition_v2, current_position, current_entity_states, frozen_snapshot). It is NOT a static property of two flow definitions. A flow may be compatible at one position and incompatible at another. Use the example from the research: entity state removal makes flows incompatible only at positions that transition to/from the removed state.

7. **Frozen Verdict Layer Isolation:** Note that the frozen verdict snapshot (§14) provides natural isolation at the verdict layer. Changes to Rules and Facts do NOT affect the frozen snapshot of an in-flight flow — verdicts were computed at initiation time and are immutable. This means Rule/Fact changes never cause FMC2 failures for verdict dependencies. However, entity state changes (live) and operation definition changes (evaluated at step execution time) ARE affected and must be checked. This insight means the compatibility analysis can skip the verdict layer entirely.

8. **Coexistence Layer Pattern:** Describe the coexistence layer (v1.5) as one valid executor implementation strategy for cases where force-migration is unsafe for some flow instances:
   - New flows start on v2
   - Compatible in-flight flows are force-migrated to v2
   - Incompatible in-flight flows continue on v1 runtime
   - On exit (flow reaches Terminal), results may be translated to v2 output format
   - This pattern generalizes blue-green (all on v1) and force-migrate (all on v2) by allowing mixed assignment based on per-instance compatibility analysis
   - Use "MAY implement" language — this is an executor strategy, NOT a spec obligation (per FMC7/Pitfall 4 from research)

9. **CFFP provenance block:** Add the standard CFFP provenance citation at the end: "This section was derived through the Constraint-First Formalization Protocol (CFFP). See `docs/cffp/flow-migration-compatibility.json` for the full formalization record..."

**Update Appendix A (Section 20):**
Add acknowledged limitations from CFFP pressure testing scope narrowings. Number them sequentially after the last existing AL (currently AL43). Expected new ALs:
- AL44: Flow compatibility analysis does not model time-based constraints (timeout changes between versions)
- AL45: Recursive sub-flow compatibility depth is unbounded in the formal definition; implementations may impose a practical depth limit
- AL46: ParallelStep compatibility requires all branches compatible — no partial migration of parallel branches
- (Additional ALs based on actual CFFP scope narrowings from Plan 01)

Each AL must cross-reference Section 17.6.

**Update Section 17.4 (In-Flight Flow Migration Policy):**
In the Force-Migrate description, add a forward reference to §17.6: "See §17.6 for the formal conditions under which force-migration is safe for a specific flow instance."

**Update Table of Contents:**
Add 17.6 to the ToC if there is a manual ToC section.

**Update Pending Work (Section 19) if needed:**
If the CFFP identifies any v2 deferrals, add them to Pending Work.
  </action>
  <verify>
- `grep -n "17.6" docs/TENOR.md` shows the new subsection exists
- `grep -n "FMC1" docs/TENOR.md` shows the formal conditions are referenced
- `grep -n "directional asymmetry" docs/TENOR.md` shows the problem is documented
- `grep -n "coexistence" docs/TENOR.md` shows the pattern is described
- `grep -n "S6" docs/TENOR.md` (in the Section 17.6 area) shows the cross-reference
- `grep -n "flow-migration-compatibility.json" docs/TENOR.md` shows the CFFP provenance block
- `grep -n "AL4[4-9]" docs/TENOR.md` shows new acknowledged limitations exist
- `grep -n "§17.6" docs/TENOR.md` (in Section 17.4 area) shows the forward reference
  </verify>
  <done>TENOR.md Section 17.6 defines flow migration compatibility with three formal conditions (forward path, data dependency, entity state), documents directional asymmetry with escrow example, describes coexistence layer as executor strategy, cross-references S6 for path computation, and carries CFFP provenance. Appendix A has new ALs. Section 17.4 has forward reference to 17.6.</done>
</task>

<task type="auto">
  <name>Task 2: Verify cross-references and internal consistency</name>
  <files>docs/TENOR.md</files>
  <action>
Verify that all cross-references in the new Section 17.6 are correct and that the section integrates cleanly with the existing spec:

1. **Cross-reference verification:**
   - §14 (Complete Evaluation Model) — verify the frozen verdict/snapshot description matches what 17.6 references
   - §15 (Static Analysis Obligations) — verify S6 (flow path enumeration) is correctly described and the cross-reference is accurate
   - §11 (Flow) — verify step type names (OperationStep, BranchStep, SubFlowStep, ParallelStep) match the spec terminology
   - §17.2 (Breaking Change Taxonomy) — verify Flow Changes table entries are consistent with the new compatibility analysis
   - §17.4 (In-Flight Flow Migration Policy) — verify the forward reference to §17.6 is placed correctly

2. **Terminology consistency:**
   - "force-migrate" vs "force-migration" vs "Force-Migrate" — match the convention used in §17.4
   - "frozen snapshot" vs "frozen verdict snapshot" — match the convention used in §14
   - Step type names: OperationStep, BranchStep, SubFlowStep, ParallelStep must match §11 exactly
   - Terminal state terminology must match §11 (Terminal(success), Terminal(failure))

3. **Appendix A numbering:**
   - Verify new AL numbers are sequential (no gaps, no duplicates)
   - Verify each new AL cross-references §17.6

4. **Section numbering:**
   - Verify §17.6 does not conflict with any existing subsection
   - Verify ToC is updated if manual

If any inconsistencies are found, fix them in TENOR.md. If all cross-references are correct, confirm with no changes needed.
  </action>
  <verify>
- Read Section 17.6 and verify all §-references point to correct content
- Verify step type names match Section 11 exactly
- Verify AL numbering is sequential after AL43
- `cargo build --workspace` passes (no code changes, but confirms no accidental breakage if TENOR.md is embedded)
  </verify>
  <done>All cross-references in Section 17.6 are verified correct, terminology is consistent with existing spec sections, AL numbering is sequential, and the new content integrates cleanly with the existing Versioning & Migration section</done>
</task>

</tasks>

<verification>
1. `grep -c "17.6" docs/TENOR.md` shows at least 3 occurrences (section heading, ToC entry, forward reference from 17.4)
2. Section 17.6 contains formal definitions for FMC1, FMC2, FMC3 as testable conditions
3. Directional asymmetry is documented with a concrete example
4. Coexistence layer uses "MAY" language (executor strategy, not obligation)
5. S6 cross-reference exists for reachable path computation
6. CFFP provenance block references `docs/cffp/flow-migration-compatibility.json`
7. Appendix A has new acknowledged limitations with §17.6 cross-references
8. Section 17.4 has forward reference to §17.6
9. All terminology matches existing spec conventions
</verification>

<success_criteria>
- TENOR.md Section 17.6 exists with complete flow migration compatibility definition
- The three conditions (forward path, data dependency, entity state) are formally stated
- Directional asymmetry is named, defined, and illustrated with a concrete example
- Coexistence layer is described as an executor strategy (not prescribed)
- S6 is cross-referenced for path computation mechanism
- Appendix A has new ALs from CFFP scope narrowings
- All cross-references are correct and terminology is consistent
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-cffp-flow-migration-compatibility/03.3-02-SUMMARY.md`
</output>
