---
phase: 05.1-fix-critical-dsl-gaps-before-v1-complete
plan: 01
status: complete
duration: 8min
tasks_completed: 2
---

# Plan 05.1-01: Effect-to-Outcome Mapping Syntax

## What was built

Implemented the `(Entity, from, to, outcome_label)` effect syntax for multi-outcome operations across the full elaboration pipeline, closing GAP-006/010/013 -- the highest-priority DSL gap identified during Phase 5 domain validation.

## Key changes

1. **AST** (`crates/core/src/ast.rs`): Extended Operation effects tuple from 4 to 5 elements with optional outcome label (`Option<String>`)
2. **Parser** (`crates/core/src/parser.rs`): Updated `parse_effects()` to detect and parse optional comma-separated outcome label after the `to` state
3. **Pass 5 validation** (`crates/core/src/pass5_validate.rs`): Added validation rules for multi-outcome operations -- effects must have outcome labels when 2+ outcomes declared, and labels must reference declared outcomes
4. **Pass 6 serialization** (`crates/core/src/pass6_serialize.rs`): Emits `"outcome"` field on effect objects in interchange JSON (keys sorted: entity_id, from, outcome, to)
5. **Conformance fixtures**: 1 positive (multi_outcome_operation) + 2 negative (effect_missing_outcome, effect_undeclared_outcome)
6. **Existing fixtures updated**: operation_outcomes.tenor and outcomes_error_contract_collision.tenor updated to include outcome labels

## Self-Check: PASSED

- `cargo build --workspace` -- compiles
- `cargo test --workspace` -- 380 tests pass
- `cargo run -p tenor-cli -- test conformance` -- 60/60 pass (57 existing + 3 new)
- Backward compatibility: single-outcome operations continue unchanged
- `cargo run -p tenor-cli -- elaborate conformance/positive/multi_outcome_operation.tenor` produces JSON with `"outcome"` fields

## Key files

### key-files.created
- `conformance/positive/multi_outcome_operation.tenor`
- `conformance/positive/multi_outcome_operation.expected.json`
- `conformance/negative/pass5/effect_missing_outcome.tenor`
- `conformance/negative/pass5/effect_missing_outcome.expected-error.json`
- `conformance/negative/pass5/effect_undeclared_outcome.tenor`
- `conformance/negative/pass5/effect_undeclared_outcome.expected-error.json`

### key-files.modified
- `crates/core/src/ast.rs`
- `crates/core/src/parser.rs`
- `crates/core/src/pass5_validate.rs`
- `crates/core/src/pass6_serialize.rs`
- `conformance/positive/operation_outcomes.tenor`
- `conformance/positive/operation_outcomes.expected.json`
- `conformance/negative/pass5/outcomes_error_contract_collision.tenor`

## Decisions

- Outcome label parsing uses positional lookahead: after `to`, if comma+word follows before RParen, consume as outcome label; trailing comma without word is treated as separator
- Multi-outcome threshold: 2+ outcomes triggers mandatory outcome labels (single-outcome operations remain unaffected)
