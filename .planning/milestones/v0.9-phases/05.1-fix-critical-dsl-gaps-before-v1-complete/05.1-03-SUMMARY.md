---
phase: 05.1-fix-critical-dsl-gaps-before-v1-complete
plan: 03
status: complete
duration: 8min
tasks_completed: 2
---

# Plan 05.1-03: S6 Escalate Path Fix + CLI Flow Evaluation

## What was built

1. Fixed S6 flow path analysis to follow Escalate handler `next` targets in DFS traversal (GAP-007), eliminating false unreachable step warnings for escalation-reachable steps.
2. Added `--flow` and `--persona` flags to `tenor eval` CLI for flow evaluation from the command line (GAP-008).

## Key changes

### S6 Escalate Path Fix
- **OperationStep handler** (`crates/analyze/src/s6_flow_paths.rs`): After processing normal outcome paths, checks `on_failure` handler -- if kind is `Escalate`, extracts `next` step ID and pushes onto DFS stack as an additional reachable path
- **SubFlowStep handler**: Updated to follow Escalate handler `next` targets instead of just recording terminal failure outcomes
- **Unit test**: `test_escalate_handler_reachable` verifies Escalate-reachable steps are not reported as unreachable

### CLI Flow Evaluation
- **Eval subcommand** (`crates/cli/src/main.rs`): Added optional `--flow` and `--persona` arguments
- **Flow mode**: When `--flow` specified, requires `--persona`, calls `tenor_eval::evaluate_flow()`, displays flow result including outcome, steps, entity state changes, and verdicts
- **Rule mode**: Unchanged when `--flow` not specified
- **Error handling**: Missing persona with flow exits 1, invalid flow ID exits 1

## Self-Check: PASSED

- `cargo build --workspace` -- compiles
- `cargo test --workspace` -- 382 tests pass (including new test_escalate_handler_reachable)
- `cargo run -p tenor-cli -- test conformance` -- 60/60 pass
- Manual test: `tenor eval <bundle> --facts <f> --flow subscription_lifecycle --persona account_manager` produces correct flow output
- Manual test: `tenor eval <bundle> --facts <f>` continues to work for rule-only evaluation
- Manual test: `--flow` without `--persona` exits 1 with error message

## Key files

### key-files.modified
- `crates/analyze/src/s6_flow_paths.rs`
- `crates/cli/src/main.rs`

## Decisions

- Escalate path treated as an alternative path fork from the failing step (outcome: "escalate") -- distinct from normal outcome paths
- Flow evaluation JSON output includes flow_id, outcome, initiating_persona, entity_state_changes, steps_executed, and verdicts
- Text output format mirrors rule evaluation style but adds flow-specific sections
