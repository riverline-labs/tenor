---
phase: 05.1-fix-critical-dsl-gaps-before-v1-complete
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/analyze/src/s6_flow_paths.rs
  - crates/cli/src/main.rs
autonomous: true
requirements:
  - ANLZ-06
  - CLI-05

must_haves:
  truths:
    - "S6 flow path analysis follows Escalate handler targets and does not report escalation-reachable steps as unreachable"
    - "tenor eval --flow <id> --persona <p> executes a flow and displays the result"
    - "tenor eval without --flow continues to work as before (rule-level evaluation only)"
  artifacts:
    - path: "crates/analyze/src/s6_flow_paths.rs"
      provides: "Escalate handler path tracing in DFS traversal"
      contains: "Escalate"
    - path: "crates/cli/src/main.rs"
      provides: "CLI --flow and --persona flags on eval subcommand"
      contains: "flow"
  key_links:
    - from: "crates/analyze/src/s6_flow_paths.rs"
      to: "Flow path enumeration"
      via: "DFS follows on_failure Escalate next targets"
      pattern: "Escalate.*next"
    - from: "crates/cli/src/main.rs"
      to: "crates/eval/src/lib.rs"
      via: "CLI calls evaluate_flow() when --flow flag is provided"
      pattern: "evaluate_flow"
---

<objective>
Fix S6 flow path analysis to follow Escalate handler targets (GAP-007) and add CLI flow evaluation support (GAP-008).

Purpose: S6 currently reports steps reachable through Escalate handlers as unreachable (false positive), which confuses contract authors. The CLI only supports rule-level evaluation -- flow evaluation is only available through the Rust API. Both are targeted fixes in isolated crates (analyze and cli) with no overlap with other plans.

Output: S6 correctly traces Escalate paths, and `tenor eval --flow <id> --persona <p>` executes flows from the CLI.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-fix-critical-dsl-gaps-before-v1-complete/05.1-RESEARCH.md

# Source files
@crates/analyze/src/s6_flow_paths.rs
@crates/cli/src/main.rs
@crates/eval/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix S6 flow path analysis to follow Escalate handler targets</name>
  <files>
    crates/analyze/src/s6_flow_paths.rs
  </files>
  <action>
    1. **Understand current DFS logic**: Read `s6_flow_paths.rs` and identify how the DFS traversal processes each step type. Locate the `OperationStep` match arm which processes outcome targets but currently ignores `on_failure` handlers.

    2. **Add Escalate handler tracing**: In the `OperationStep` match arm (and any other step type that has `on_failure`), after processing normal outcome/success targets, check for an `on_failure` handler:
       - Read the step's `on_failure` field from the interchange JSON (it's a JSON object with a `kind` field)
       - If `on_failure.kind == "Escalate"` and `on_failure.next` exists, extract the `next` step ID and push it onto the DFS stack as an additional reachable target
       - This creates a new path branch: the normal outcome paths AND an escalation failure path
       - Also check `SubFlowStep` and any other step type that might have `on_failure` with Escalate

    3. **Avoid duplicate path inflation**: When adding the Escalate target to the DFS, mark it as a distinct path fork (failure/escalation) from the failing step. Do not duplicate normal outcome paths. The Escalate path is an alternative path from the same step, just via the failure handler instead of a success outcome.

    4. **Test with healthcare contract**: The healthcare prior auth contract has an Escalate handler on step_deny that routes to step_director_review. After the fix, running `cargo run -p tenor-cli -- check domains/healthcare/prior_auth.tenor` should no longer report those steps as unreachable (or should report fewer unreachable steps).

    5. **Unit/integration test**: Verify existing S6 tests still pass. Add a dedicated test case (in the S6 module test suite or as a conformance fixture) with a flow that includes an Escalate handler whose `next` target is another step. Assert that the Escalate-reachable step is NOT reported as unreachable.
  </action>
  <verify>
    `cargo build --workspace` succeeds.
    `cargo test --workspace` passes.
    `cargo run -p tenor-cli -- check domains/healthcare/prior_auth.tenor` shows reduced or zero unreachable step warnings for escalation-reachable steps.
  </verify>
  <done>
    S6 flow path analysis follows Escalate handler targets in addition to normal outcome-based routing. Steps reachable through Escalate are no longer falsely reported as unreachable. Healthcare prior auth contract shows corrected reachability analysis.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --flow and --persona flags to tenor eval CLI</name>
  <files>
    crates/cli/src/main.rs
  </files>
  <action>
    1. **Add CLI arguments**: In the `Eval` subcommand struct, add two optional arguments:
       ```rust
       #[arg(long)]
       flow: Option<String>,
       #[arg(long)]
       persona: Option<String>,
       ```

    2. **Update command dispatch**: In the `Commands::Eval` match arm, destructure the new fields:
       ```rust
       Commands::Eval { bundle, facts, flow, persona } => { ... }
       ```

    3. **Flow evaluation path**: When `flow` is `Some(flow_id)`:
       - Read the bundle JSON and facts JSON (same as current rule eval path)
       - Extract entity initial states from the bundle's entity constructs: for each entity in the bundle, create an entry in an `EntityStateMap` (or equivalent) mapping entity ID to its `initial` state
       - Require `persona` to also be `Some(p)` -- if `--flow` is provided but `--persona` is not, print an error: "Error: --persona is required when --flow is specified" and exit with code 1
       - Call `tenor_eval::evaluate_flow()` with the flow ID, persona, facts, entity states, and any other required parameters
       - Format and display the flow result. Use a similar output format to rule verdicts: show the flow result status, entity state changes, and any verdicts produced during flow execution
       - If the specified flow ID is not found in the bundle, print an error and exit with code 1

    4. **Rule evaluation path (unchanged)**: When `flow` is `None`, continue with the existing `evaluate()` call for rule-level evaluation. The `persona` flag should be ignored in this case (or optionally print a warning if persona is provided without flow).

    5. **Integration test**: Add a CLI integration test (in `crates/cli/tests/` or wherever existing CLI tests live) that runs `tenor eval --flow <id> --persona <p>` against one of the domain contract bundles (e.g., the SaaS subscription). Verify:
       - Exit code 0 on success
       - Output contains flow result information
       - `--flow` without `--persona` produces exit code 1
       - Invalid flow ID produces exit code 1
  </action>
  <verify>
    `cargo build --workspace` succeeds.
    `cargo test --workspace` passes.
    Manual test: `cargo run -p tenor-cli -- eval <bundle.json> --facts <facts.json> --flow <flow_id> --persona <persona_id>` produces flow evaluation output.
    Manual test: `cargo run -p tenor-cli -- eval <bundle.json> --facts <facts.json>` continues to work for rule-level evaluation.
  </verify>
  <done>
    `tenor eval` supports `--flow <flow_id>` and `--persona <persona>` flags for CLI-based flow evaluation. Rule-level evaluation continues to work unchanged when --flow is not specified. Error handling covers missing persona, invalid flow ID, and evaluation failures.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` -- compiles without errors
2. `cargo test --workspace` -- all tests pass
3. S6 verification: `cargo run -p tenor-cli -- check domains/healthcare/prior_auth.tenor` shows corrected reachability for escalation paths
4. CLI flow eval: `cargo run -p tenor-cli -- eval <bundle> --facts <facts> --flow <flow_id> --persona <p>` produces output
5. Backward compatibility: `cargo run -p tenor-cli -- eval <bundle> --facts <facts>` still works for rule-only evaluation
6. Error cases: missing --persona with --flow returns exit 1, invalid flow ID returns exit 1
</verification>

<success_criteria>
- S6 follows Escalate handler targets in DFS traversal
- Healthcare prior auth contract no longer shows false unreachable step warnings for escalation paths
- `tenor eval --flow <id> --persona <p>` executes flow evaluation from the CLI
- `tenor eval` without --flow continues as rule-only evaluation (no regression)
- Proper error messages for missing persona, invalid flow ID
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-fix-critical-dsl-gaps-before-v1-complete/05.1-03-SUMMARY.md`
</output>
