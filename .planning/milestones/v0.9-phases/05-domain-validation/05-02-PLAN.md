---
phase: 05-domain-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - domains/healthcare/prior_auth.tenor
  - domains/healthcare/prior_auth_approve.facts.json
  - domains/healthcare/prior_auth_approve.verdicts.json
  - domains/healthcare/prior_auth_deny.facts.json
  - domains/healthcare/prior_auth_deny.verdicts.json
  - domains/healthcare/prior_auth_appeal.facts.json
  - domains/healthcare/prior_auth_appeal.verdicts.json
  - crates/eval/tests/conformance.rs
autonomous: true
requirements:
  - DOMN-02
  - DOMN-06
  - DOMN-07
  - DOMN-08

must_haves:
  truths:
    - "Healthcare prior auth contract elaborates without error"
    - "Healthcare contract passes tenor check with no warnings"
    - "Healthcare contract evaluates approve path with correct verdicts and provenance"
    - "Healthcare contract evaluates deny path with correct verdicts"
    - "Healthcare contract evaluates appeal path with correct verdicts"
    - "Healthcare contract is complex enough to produce a wow reaction (deep flows, escalation, sub-flows, multiple personas)"
  artifacts:
    - path: "domains/healthcare/prior_auth.tenor"
      provides: "Healthcare prior auth contract — the wow showcase contract for spec feature breadth"
      contains: "entity PriorAuth"
      min_lines: 300
    - path: "domains/healthcare/prior_auth_approve.verdicts.json"
      provides: "Expected verdicts for approval path"
    - path: "crates/eval/tests/conformance.rs"
      provides: "Domain eval test registration for healthcare"
      contains: "domain_healthcare"
  key_links:
    - from: "crates/eval/tests/conformance.rs"
      to: "domains/healthcare/"
      via: "domains_dir() path helper + run_eval_flow_fixture"
      pattern: "domains_dir.*healthcare"
---

<objective>
Author the healthcare prior authorization contract (LARGE) -- the most complex domain contract and the "wow" showcase for spec feature breadth. This contract models the full prior auth lifecycle: initial request, clinical review, peer review escalation, denial with appeal rights, and appeal adjudication.

Purpose: Proves Tenor handles deep, real-world business complexity. Exercises the widest set of spec features: deep flows with SubFlowStep, Escalate handlers, multi-stratum rules, 5+ personas, TaggedUnion types, bounded quantification, and handoff steps.

Output: Complete healthcare contract (~350+ lines) with 3 eval fixture sets (approve, deny, appeal), registered eval conformance tests, gap log entries if any.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-validation/05-CONTEXT.md
@.planning/phases/05-domain-validation/05-RESEARCH.md
@crates/eval/tests/conformance.rs
@conformance/eval/positive/escrow_release.tenor
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Author healthcare prior auth contract and eval fixtures</name>
  <files>
    domains/healthcare/prior_auth.tenor
    domains/healthcare/prior_auth_approve.facts.json
    domains/healthcare/prior_auth_approve.verdicts.json
    domains/healthcare/prior_auth_deny.facts.json
    domains/healthcare/prior_auth_deny.verdicts.json
    domains/healthcare/prior_auth_appeal.facts.json
    domains/healthcare/prior_auth_appeal.verdicts.json
    .planning/phases/05-domain-validation/gap-log.md
  </files>
  <action>
    Create `domains/healthcare/` directory. Author `prior_auth.tenor` as a LARGE contract (~350+ lines) modeling healthcare prior authorization.

    **This is the "wow" showcase contract for spec feature breadth.** It should demonstrate that Tenor can express genuinely complex business logic, not just toy examples.

    **Contract must include:**
    - TypeDecl (Record): `PolicyCriteria` (clinical criteria fields), `ReviewRecord` (reviewer notes, decision, timestamp)
    - TypeDecl (TaggedUnion): `DenialReason` with variants like `medical_necessity`, `experimental_treatment`, `out_of_network`, `documentation_insufficient`
    - 5-6 Personas: `requesting_physician`, `clinical_reviewer`, `peer_reviewer`, `medical_director`, `appeals_board`, `patient_advocate`
    - 8-10 Facts: `auth_status` (Enum), `medical_records` (List), `policy_rules` (Record), `diagnosis_code` (Text), `treatment_code` (Text), `urgency_level` (Enum: routine/urgent/emergent), `clinical_criteria_met` (Bool), `appeal_deadline` (Date), etc.
    - 2-3 Entities: `PriorAuth` with states [submitted, under_review, approved, denied, appealed, appeal_approved, appeal_denied], `AppealCase` with states [filed, review, decided]
    - 8-12 Rules across 3+ strata: stratum 0 for clinical criteria checks, stratum 1 for eligibility determination (verdict_present), stratum 2+ for final authorization decision. Include bounded quantification (forall over medical records).
    - 6-8 Operations: `submit_auth`, `assign_reviewer`, `approve_auth` (multi-outcome: approve/conditional_approve), `deny_auth`, `file_appeal`, `review_appeal`, `escalate_to_peer`, `overturn_denial`
    - 2-3 Flows: `auth_review_flow` (main flow with BranchStep for urgency routing, HandoffStep for reviewer assignment, Escalate handler for peer review), `appeal_flow` (SubFlowStep referenced from main flow)

    **Key spec features this contract MUST exercise (from feature coverage matrix):**
    - BranchStep (urgency routing: routine vs urgent vs emergent)
    - HandoffStep (reviewer handoff)
    - SubFlowStep (appeal sub-flow)
    - Escalate handler (escalate to peer review when initial reviewer denies)
    - Bounded quantification: `forall record in medical_records: ...`
    - Multi-outcome operation (approve/conditional_approve)
    - Multi-stratum rules (3+ strata)
    - 5+ personas with distinct authority

    **Eval fixtures (3 paths):**
    1. `prior_auth_approve` -- Happy path: clinical criteria met, reviewer approves. Flow executed by `requesting_physician` (submit) then `clinical_reviewer` (approve).
    2. `prior_auth_deny` -- Denial path: criteria not met, reviewer denies with reason.
    3. `prior_auth_appeal` -- Appeal path: denial followed by appeal filing, appeal review, and overturn.

    To create verdict fixtures: Elaborate, evaluate, capture output, verify by hand, save as `.verdicts.json`.

    **Append any gaps to `.planning/phases/05-domain-validation/gap-log.md`.** This is the contract most likely to surface spec gaps due to its complexity.

    **Critical:** If scenarios cannot be expressed (e.g., aggregate counts over medical records), skip and document. Pre-compute aggregates as Facts per Tenor's design.
  </action>
  <verify>
    ```bash
    cargo run -p tenor-cli -- elaborate domains/healthcare/prior_auth.tenor > /dev/null
    cargo run -p tenor-cli -- check domains/healthcare/prior_auth.tenor
    ```
    Both must exit 0. Verify the contract is at least 300 lines. Verify all 3 eval fixture pairs produce correct output.
  </verify>
  <done>Healthcare contract (~350+ lines) elaborates, passes check, and all 3 eval fixture paths produce verified verdicts. This contract visibly demonstrates Tenor's ability to handle complex real-world business logic.</done>
</task>

<task type="auto">
  <name>Task 2: Register healthcare eval conformance tests</name>
  <files>
    crates/eval/tests/conformance.rs
  </files>
  <action>
    Add healthcare domain eval tests to `crates/eval/tests/conformance.rs`.

    1. Add section comment:
    ```rust
    // ──────────────────────────────────────────────
    // Domain validation — Healthcare Prior Auth (Phase 5)
    // ──────────────────────────────────────────────
    ```

    2. Register 3 test functions (adjust flow_id and persona to match actual contract):
    ```rust
    #[test]
    fn domain_healthcare_approve() {
        run_eval_flow_fixture(
            &domains_dir().join("healthcare"),
            "prior_auth_approve",
            "auth_review_flow",
            "requesting_physician",
        );
    }

    #[test]
    fn domain_healthcare_deny() {
        run_eval_flow_fixture(
            &domains_dir().join("healthcare"),
            "prior_auth_deny",
            "auth_review_flow",
            "requesting_physician",
        );
    }

    #[test]
    fn domain_healthcare_appeal() {
        run_eval_flow_fixture(
            &domains_dir().join("healthcare"),
            "prior_auth_appeal",
            "auth_review_flow",
            "requesting_physician",
        );
    }
    ```

    3. Ensure `domains_dir()` helper exists (added in 05-01 if that runs first; add it here if not).

    4. Run tests to verify.
  </action>
  <verify>
    ```bash
    cargo test -p tenor-eval -- domain_healthcare
    ```
    All 3 healthcare tests pass. Full workspace:
    ```bash
    cargo test --workspace
    ```
  </verify>
  <done>Healthcare domain eval tests registered and passing. Full workspace test suite still passes.</done>
</task>

</tasks>

<verification>
1. `cargo run -p tenor-cli -- elaborate domains/healthcare/prior_auth.tenor` exits 0
2. `cargo run -p tenor-cli -- check domains/healthcare/prior_auth.tenor` exits 0 with no warnings
3. `prior_auth.tenor` is 300+ lines with 5+ personas, 2+ entities, 3+ rule strata, 2+ flows
4. `cargo test -p tenor-eval -- domain_healthcare` — all 3 tests pass
5. `cargo test --workspace` — full suite passes
6. Gap log updated with any findings
</verification>

<success_criteria>
- Healthcare prior auth contract is the "wow" showcase: deep flows, escalation, sub-flows, 5+ personas, bounded quantification, TaggedUnion, multi-outcome operations
- Contract elaborates, passes check, and evaluates correctly for 3 paths (approve, deny, appeal)
- All eval tests registered and passing
- Anyone in healthcare would recognize the prior auth workflow as realistic
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-validation/05-02-SUMMARY.md`
</output>
