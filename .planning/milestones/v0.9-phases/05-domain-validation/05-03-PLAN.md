---
phase: 05-domain-validation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - domains/supply_chain/types.tenor
  - domains/supply_chain/inspection.tenor
  - domains/supply_chain/inspection_pass.facts.json
  - domains/supply_chain/inspection_pass.verdicts.json
  - domains/supply_chain/inspection_hold.facts.json
  - domains/supply_chain/inspection_hold.verdicts.json
  - crates/eval/tests/conformance.rs
autonomous: true
requirements:
  - DOMN-03
  - DOMN-06
  - DOMN-07
  - DOMN-08

must_haves:
  truths:
    - "Supply chain contract elaborates without error (multi-file import)"
    - "Supply chain contract passes tenor check with no warnings"
    - "Supply chain contract evaluates pass path with correct verdicts"
    - "Supply chain contract evaluates hold path with correct verdicts"
    - "Multi-file import works correctly (types.tenor imported by inspection.tenor)"
  artifacts:
    - path: "domains/supply_chain/inspection.tenor"
      provides: "Supply chain inspection contract with parallel steps, compensation, entity hierarchies"
      contains: "entity Shipment"
    - path: "domains/supply_chain/types.tenor"
      provides: "Shared types for supply chain domain (multi-file import)"
      contains: "type InspectionReport"
    - path: "crates/eval/tests/conformance.rs"
      provides: "Domain eval test registration for supply chain"
      contains: "domain_supply_chain"
  key_links:
    - from: "domains/supply_chain/inspection.tenor"
      to: "domains/supply_chain/types.tenor"
      via: "import statement"
      pattern: "import.*types"
    - from: "crates/eval/tests/conformance.rs"
      to: "domains/supply_chain/"
      via: "domains_dir() helper"
      pattern: "domains_dir.*supply_chain"
---

<objective>
Author the supply chain inspection contract (MEDIUM) -- demonstrating parallel steps, compensation handlers, entity hierarchies, and multi-file imports. This contract models cargo inspection at a port: concurrent quality and compliance inspections, hold/release decisions, and compensation for failed inspections.

Purpose: Validates Tenor's ParallelStep, Compensate handlers, entity hierarchies (Shipment > InspectionLot), and multi-file import mechanism. Also proves the elaborator handles cross-file type sharing correctly.

Output: Complete supply chain contract (2 files, ~200 lines total) with 2 eval fixture sets (pass, hold), registered eval conformance tests.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-validation/05-CONTEXT.md
@.planning/phases/05-domain-validation/05-RESEARCH.md
@crates/eval/tests/conformance.rs
@conformance/cross_file/
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Author supply chain contract with multi-file imports and eval fixtures</name>
  <files>
    domains/supply_chain/types.tenor
    domains/supply_chain/inspection.tenor
    domains/supply_chain/inspection_pass.facts.json
    domains/supply_chain/inspection_pass.verdicts.json
    domains/supply_chain/inspection_hold.facts.json
    domains/supply_chain/inspection_hold.verdicts.json
    .planning/phases/05-domain-validation/gap-log.md
  </files>
  <action>
    Create `domains/supply_chain/` directory.

    **File 1: `types.tenor` (shared types, ~30-40 lines)**
    - TypeDecl (Record): `InspectionReport` with fields like `inspector_id: Text`, `pass: Bool`, `defect_count: Int`, `notes: Text`
    - TypeDecl (TaggedUnion): `DefectType` with variants like `structural`, `documentation`, `contamination`, `labeling`
    - Any other shared types needed by the main contract

    **File 2: `inspection.tenor` (main contract, ~160-180 lines)**
    - `import "types.tenor"` at the top to exercise multi-file imports
    - 3-4 Personas: `customs_officer`, `quality_inspector`, `port_authority`, `shipping_agent`
    - 6-8 Facts: `inspection_type` (Enum: standard/enhanced/expedited), `defect_count` (Int), `inspection_items` (List), `defect_threshold` (Int, default: 3), etc. Include bounded quantification trigger: `∃ item in inspection_items`
    - 2-3 Entities: `Shipment` with states [arrived, inspecting, cleared, held, released, rejected], `InspectionLot` with states [pending, in_progress, passed, failed] — entity hierarchy (Shipment contains InspectionLots)
    - 5-7 Rules across 2 strata: stratum 0 for inspection result checks (defect count below threshold, items pass), stratum 1 for release decision (all inspections pass verdict). Include bounded existential quantification: `∃ defect in inspection_items`.
    - 4-5 Operations: `begin_inspection`, `record_finding`, `release_shipment`, `hold_shipment`, `reject_shipment` — with multi-entity effects (Shipment + InspectionLot)
    - 1-2 Flows: `inspection_flow` with ParallelStep (concurrent quality + compliance inspections), BranchStep (defect check), Compensate handler (rollback inspection on hold), Terminate step

    **Key spec features this contract MUST exercise (from feature coverage matrix):**
    - ParallelStep (concurrent inspections — quality and compliance)
    - Compensate handler (rollback inspection)
    - Multi-entity effects (Shipment + InspectionLot state changes)
    - Entity hierarchy concept (Shipment > InspectionLot)
    - Bounded existential quantification: `exists item in inspection_items: ...`
    - Multi-file import
    - Int fact with default value

    **Eval fixtures (2 paths):**
    1. `inspection_pass` -- All inspections pass, shipment released. Quality and compliance both clear.
    2. `inspection_hold` -- Defect found, shipment held. Compensation triggers rollback.

    Elaborate, evaluate, capture output, verify by hand, save fixtures.
    Append any gaps to gap-log.md.
  </action>
  <verify>
    ```bash
    cargo run -p tenor-cli -- elaborate domains/supply_chain/inspection.tenor > /dev/null
    cargo run -p tenor-cli -- check domains/supply_chain/inspection.tenor
    ```
    Both must exit 0. Verify multi-file import resolves correctly (types from types.tenor used in inspection.tenor).
  </verify>
  <done>Supply chain contract with multi-file imports elaborates, passes check, and eval fixtures produce verified verdicts for 2 paths. ParallelStep and Compensate handlers functional.</done>
</task>

<task type="auto">
  <name>Task 2: Register supply chain eval conformance tests</name>
  <files>
    crates/eval/tests/conformance.rs
  </files>
  <action>
    Add supply chain domain eval tests to `crates/eval/tests/conformance.rs`.

    1. Add section comment:
    ```rust
    // ──────────────────────────────────────────────
    // Domain validation — Supply Chain Inspection (Phase 5)
    // ──────────────────────────────────────────────
    ```

    2. Register 2 test functions:
    ```rust
    #[test]
    fn domain_supply_chain_pass() {
        run_eval_flow_fixture(
            &domains_dir().join("supply_chain"),
            "inspection_pass",
            "inspection_flow",
            "customs_officer",
        );
    }

    #[test]
    fn domain_supply_chain_hold() {
        run_eval_flow_fixture(
            &domains_dir().join("supply_chain"),
            "inspection_hold",
            "inspection_flow",
            "customs_officer",
        );
    }
    ```

    3. Adjust flow_id and persona to match actual contract.
    4. Run tests to verify.
  </action>
  <verify>
    ```bash
    cargo test -p tenor-eval -- domain_supply_chain
    ```
    Both tests pass. Full workspace:
    ```bash
    cargo test --workspace
    ```
  </verify>
  <done>Supply chain domain eval tests registered and passing.</done>
</task>

</tasks>

<verification>
1. `cargo run -p tenor-cli -- elaborate domains/supply_chain/inspection.tenor` exits 0
2. `cargo run -p tenor-cli -- check domains/supply_chain/inspection.tenor` exits 0 with no warnings
3. Multi-file import: `types.tenor` types used in `inspection.tenor` without error
4. `cargo test -p tenor-eval -- domain_supply_chain` — both tests pass
5. `cargo test --workspace` — full suite passes
</verification>

<success_criteria>
- Supply chain contract exercises: ParallelStep, Compensate, multi-entity effects, entity hierarchy, bounded existential quantification, multi-file import, Int default
- Contract elaborates with cross-file resolution, passes check, evaluates for 2 paths
- All eval tests registered and passing
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-validation/05-03-SUMMARY.md`
</output>
