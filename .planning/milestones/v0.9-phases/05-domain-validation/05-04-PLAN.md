---
phase: 05-domain-validation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - domains/energy_procurement/types.tenor
  - domains/energy_procurement/rfp_workflow.tenor
  - domains/energy_procurement/rfp_approve.facts.json
  - domains/energy_procurement/rfp_approve.verdicts.json
  - domains/energy_procurement/rfp_reject.facts.json
  - domains/energy_procurement/rfp_reject.verdicts.json
  - domains/energy_procurement/rfp_escalate.facts.json
  - domains/energy_procurement/rfp_escalate.verdicts.json
  - crates/eval/tests/conformance.rs
autonomous: true
requirements:
  - DOMN-04
  - DOMN-06
  - DOMN-07
  - DOMN-08

must_haves:
  truths:
    - "Energy procurement contract elaborates without error"
    - "Energy procurement contract passes tenor check with no warnings"
    - "Energy procurement contract evaluates approve path with correct verdicts"
    - "Energy procurement contract evaluates reject path with correct verdicts"
    - "Energy procurement contract evaluates escalate path with correct verdicts"
    - "Contract is authentic enough that energy industry professionals would recognize the RFP workflow"
  artifacts:
    - path: "domains/energy_procurement/rfp_workflow.tenor"
      provides: "Energy procurement RFP workflow contract — the wow showcase for domain authenticity"
      contains: "entity RFP"
      min_lines: 250
    - path: "domains/energy_procurement/types.tenor"
      provides: "Shared types for energy procurement (multi-file import)"
      contains: "type SupplierScore"
    - path: "crates/eval/tests/conformance.rs"
      provides: "Domain eval test registration for energy procurement"
      contains: "domain_energy"
  key_links:
    - from: "domains/energy_procurement/rfp_workflow.tenor"
      to: "domains/energy_procurement/types.tenor"
      via: "import statement"
      pattern: "import.*types"
    - from: "crates/eval/tests/conformance.rs"
      to: "domains/energy_procurement/"
      via: "domains_dir() helper"
      pattern: "domains_dir.*energy"
---

<objective>
Author the energy procurement RFP workflow contract (MEDIUM-LARGE) -- the "wow" showcase for domain authenticity. This contract models a real energy procurement RFP workflow that the user personally built, with approval tiers by spend amount, delegation rules, supplier scoring, and award criteria.

Purpose: Proves Tenor handles real-world business complexity in a domain the user knows deeply. This contract will be shown to energy industry professionals. Exercises Money types, approval tiers, delegation, governed workflows, Date types, and Escalate handlers.

Output: Complete energy procurement contract (2 files, ~280 lines total) with 3 eval fixture sets (approve, reject, escalate), registered eval conformance tests.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-validation/05-CONTEXT.md
@.planning/phases/05-domain-validation/05-RESEARCH.md
@crates/eval/tests/conformance.rs
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Author energy procurement RFP workflow contract and eval fixtures</name>
  <files>
    domains/energy_procurement/types.tenor
    domains/energy_procurement/rfp_workflow.tenor
    domains/energy_procurement/rfp_approve.facts.json
    domains/energy_procurement/rfp_approve.verdicts.json
    domains/energy_procurement/rfp_reject.facts.json
    domains/energy_procurement/rfp_reject.verdicts.json
    domains/energy_procurement/rfp_escalate.facts.json
    domains/energy_procurement/rfp_escalate.verdicts.json
    .planning/phases/05-domain-validation/gap-log.md
  </files>
  <action>
    Create `domains/energy_procurement/` directory.

    **This is the user's personal showcase domain.** The contract must model a realistic energy procurement RFP workflow that energy industry professionals would recognize.

    **File 1: `types.tenor` (shared types, ~40-50 lines)**
    - TypeDecl (Record): `SupplierScore` with fields like `technical_score: Int(min: 0, max: 100)`, `price_score: Int(min: 0, max: 100)`, `reliability_score: Int(min: 0, max: 100)`, `total_score: Int(min: 0, max: 300)`
    - TypeDecl (Record): `CostBreakdown` with fields like `commodity_cost: Money(USD)`, `delivery_cost: Money(USD)`, `risk_premium: Money(USD)`

    **File 2: `rfp_workflow.tenor` (main contract, ~230-250 lines)**
    - 4-5 Personas: `procurement_manager`, `category_lead`, `vp_supply_chain`, `cfo`, `supplier`
    - 8-10 Facts:
      - `rfp_amount` (Money, USD) -- total RFP value
      - `bid_total` (Money, USD) -- winning bid amount
      - `rfp_deadline` (Date) -- submission deadline
      - `procurement_stage` (Enum: draft/published/evaluation/awarded/contracted)
      - `supplier_bids` (List) -- list of supplier bid records
      - `winning_bid` (Record: SupplierScore) -- selected supplier evaluation
      - `budget_approved` (Bool) -- budget availability
      - `compliance_checked` (Bool) -- regulatory compliance verified
      - Plus others as domain needs

    - 2-3 Entities: `RFP` with states [draft, published, evaluation, shortlisted, awarded, contracted, cancelled], `PurchaseOrder` with states [pending, approved, issued, fulfilled]

    - 7-10 Rules across 2-3 strata:
      - Stratum 0: Budget check (rfp_amount within budget), compliance check, deadline check (Date comparison), bid validity
      - Stratum 1: Approval tier determination based on spend amount:
        - Under $50,000: `procurement_manager` can approve
        - $50,000-$500,000: `category_lead` approval required
        - Over $500,000: `vp_supply_chain` approval required
        - Over $2,000,000: `cfo` approval required
      - Stratum 2: Award recommendation (all tier checks pass, supplier scores above threshold)
      - Include Money comparisons and bounded quantification: `forall bid in supplier_bids: ...`

    - 5-7 Operations:
      - `publish_rfp` (draft -> published)
      - `evaluate_bids` (published -> evaluation)
      - `shortlist_suppliers` (evaluation -> shortlisted)
      - `award_contract` (multi-outcome: award/reject) -- multi-entity effect (RFP + PurchaseOrder)
      - `approve_purchase` (PurchaseOrder pending -> approved)
      - `cancel_rfp` (any -> cancelled) -- terminate operation
    - 1-2 Flows: `rfp_approval_flow` with BranchStep for approval tier routing, Escalate handler (escalate to VP when category_lead denies high-value RFP), Terminate step for cancellation

    **Key spec features this contract MUST exercise:**
    - Money types (rfp_amount, bid_total, CostBreakdown) with Money comparisons
    - Date types (rfp_deadline)
    - Approval tiers via BranchStep (spend-amount routing)
    - Escalate handler (escalate to VP for high-value denials)
    - Multi-entity effects (RFP + PurchaseOrder)
    - Bounded universal quantification: `forall bid in supplier_bids`
    - Multi-outcome operation (award/reject)
    - Multi-file import

    **Eval fixtures (3 paths):**
    1. `rfp_approve` -- Happy path: budget available, compliance checked, supplier scores above threshold, spend below $50k so procurement_manager approves directly.
    2. `rfp_reject` -- Rejection path: supplier scores below threshold or budget not available.
    3. `rfp_escalate` -- High-value path: spend >$500k, requires VP approval escalation.

    Elaborate, evaluate, capture output, verify, save fixtures.
    Append any gaps to gap-log.md.
  </action>
  <verify>
    ```bash
    cargo run -p tenor-cli -- elaborate domains/energy_procurement/rfp_workflow.tenor > /dev/null
    cargo run -p tenor-cli -- check domains/energy_procurement/rfp_workflow.tenor
    ```
    Both exit 0. Verify Money comparisons work correctly in rules.
  </verify>
  <done>Energy procurement RFP contract elaborates, passes check, evaluates for 3 paths. Domain is authentic to energy industry professionals.</done>
</task>

<task type="auto">
  <name>Task 2: Register energy procurement eval conformance tests</name>
  <files>
    crates/eval/tests/conformance.rs
  </files>
  <action>
    Add energy procurement domain eval tests to `crates/eval/tests/conformance.rs`.

    1. Add section comment:
    ```rust
    // ──────────────────────────────────────────────
    // Domain validation — Energy Procurement RFP (Phase 5)
    // ──────────────────────────────────────────────
    ```

    2. Register 3 test functions:
    ```rust
    #[test]
    fn domain_energy_approve() {
        run_eval_flow_fixture(
            &domains_dir().join("energy_procurement"),
            "rfp_approve",
            "rfp_approval_flow",
            "procurement_manager",
        );
    }

    #[test]
    fn domain_energy_reject() {
        run_eval_flow_fixture(
            &domains_dir().join("energy_procurement"),
            "rfp_reject",
            "rfp_approval_flow",
            "procurement_manager",
        );
    }

    #[test]
    fn domain_energy_escalate() {
        run_eval_flow_fixture(
            &domains_dir().join("energy_procurement"),
            "rfp_escalate",
            "rfp_approval_flow",
            "procurement_manager",
        );
    }
    ```

    3. Adjust flow_id and persona to match actual contract.
    4. Run tests.
  </action>
  <verify>
    ```bash
    cargo test -p tenor-eval -- domain_energy
    ```
    All 3 tests pass. Full workspace:
    ```bash
    cargo test --workspace
    ```
  </verify>
  <done>Energy procurement domain eval tests registered and passing.</done>
</task>

</tasks>

<verification>
1. `cargo run -p tenor-cli -- elaborate domains/energy_procurement/rfp_workflow.tenor` exits 0
2. `cargo run -p tenor-cli -- check domains/energy_procurement/rfp_workflow.tenor` exits 0
3. Multi-file import: `types.tenor` types used without error
4. Money comparisons in approval tier rules work correctly
5. `cargo test -p tenor-eval -- domain_energy` — all 3 tests pass
6. `cargo test --workspace` — full suite passes
</verification>

<success_criteria>
- Energy procurement contract exercises: Money types, Date types, approval tiers, Escalate, multi-entity effects, bounded quantification, multi-outcome operation, multi-file import
- Contract is authentic to energy industry RFP workflows
- Elaborates, passes check, evaluates for 3 paths
- All eval tests registered and passing
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-validation/05-04-SUMMARY.md`
</output>
