---
phase: 05-domain-validation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - domains/trade_finance/letter_of_credit.tenor
  - domains/trade_finance/lc_present.facts.json
  - domains/trade_finance/lc_present.verdicts.json
  - domains/trade_finance/lc_discrepancy.facts.json
  - domains/trade_finance/lc_discrepancy.verdicts.json
  - crates/eval/tests/conformance.rs
autonomous: true
requirements:
  - DOMN-05
  - DOMN-06
  - DOMN-07
  - DOMN-08

must_haves:
  truths:
    - "Trade finance contract elaborates without error"
    - "Trade finance contract passes tenor check with no warnings"
    - "Trade finance contract evaluates present path with correct verdicts"
    - "Trade finance contract evaluates discrepancy path with correct verdicts"
    - "Contract is distinct from the existing escrow conformance tests (different domain model)"
  artifacts:
    - path: "domains/trade_finance/letter_of_credit.tenor"
      provides: "Trade finance letter of credit contract with multi-party personas, deadline rules, Money types"
      contains: "entity LetterOfCredit"
    - path: "crates/eval/tests/conformance.rs"
      provides: "Domain eval test registration for trade finance"
      contains: "domain_trade_finance"
  key_links:
    - from: "crates/eval/tests/conformance.rs"
      to: "domains/trade_finance/"
      via: "domains_dir() helper"
      pattern: "domains_dir.*trade_finance"
---

<objective>
Author the trade finance letter of credit contract (MEDIUM) -- the financial domain contract. This contract models an international trade letter of credit lifecycle: issuance, document presentation, compliance checking, discrepancy handling, and payment. Distinct from the existing escrow conformance tests.

Purpose: Validates Tenor's multi-party persona model (4-5 parties in trade finance: issuing bank, advising bank, beneficiary, applicant, confirming bank), deadline-based rules with Date types, Money types for LC amounts, and document entity state machines.

Output: Complete trade finance contract (~200 lines) with 2 eval fixture sets (present, discrepancy), registered eval conformance tests.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-validation/05-CONTEXT.md
@.planning/phases/05-domain-validation/05-RESEARCH.md
@crates/eval/tests/conformance.rs
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Author trade finance letter of credit contract and eval fixtures</name>
  <files>
    domains/trade_finance/letter_of_credit.tenor
    domains/trade_finance/lc_present.facts.json
    domains/trade_finance/lc_present.verdicts.json
    domains/trade_finance/lc_discrepancy.facts.json
    domains/trade_finance/lc_discrepancy.verdicts.json
    .planning/phases/05-domain-validation/gap-log.md
  </files>
  <action>
    Create `domains/trade_finance/` directory. Author `letter_of_credit.tenor` as a MEDIUM contract (~200 lines) modeling a trade finance letter of credit.

    **IMPORTANT:** This contract must be DISTINCT from the existing escrow conformance tests (`escrow_release.tenor`, `escrow_compliance.tenor`, `escrow_compensate.tenor`). The escrow tests model a simple three-party escrow. This contract models international trade documentary credit under UCP 600 rules — a fundamentally different domain.

    **Contract must include:**
    - TypeDecl (Record): `DocumentSet` with fields like `bill_of_lading: Bool`, `commercial_invoice: Bool`, `packing_list: Bool`, `certificate_of_origin: Bool`, `insurance_certificate: Bool`
    - TypeDecl (Record): `Presentation` with fields for document list and presentation date
    - TypeDecl (TaggedUnion): `DiscrepancyType` with variants like `late_presentation`, `incorrect_amount`, `missing_document`, `data_mismatch`
    - 4-5 Personas: `applicant` (buyer/importer), `beneficiary` (seller/exporter), `issuing_bank`, `advising_bank`, `confirming_bank`
    - 6-8 Facts:
      - `lc_amount` (Money, USD) -- face value of LC
      - `draft_amount` (Money, USD) -- presented draft amount
      - `lc_status` (Enum: issued/amended/presented/examined/accepted/paid/expired)
      - `expiry_date` (Date) -- LC expiry deadline
      - `docs_compliant` (Bool, default: false) -- document compliance check result
      - `required_documents` (List) -- documents required per LC terms
      - `presentation_date` (Date) -- date of document presentation
    - 2-3 Entities: `LetterOfCredit` with states [issued, amended, presented, examined, discrepant, accepted, paid, expired], `Document` with states [pending, submitted, examined, accepted, rejected]
    - 5-8 Rules across 2 strata:
      - Stratum 0: Document completeness check (all required docs present), amount check (draft_amount <= lc_amount, Money comparison), deadline check (presentation_date before expiry_date), individual document validity
      - Stratum 1: Overall compliance determination (all stratum-0 checks pass), discrepancy detection
      - Include bounded quantification: `forall doc in required_documents: ...`
    - 4-6 Operations:
      - `present_documents` (beneficiary presents to advising bank)
      - `examine_documents` (advising bank examines) — multi-outcome: accept/reject (discrepant)
      - `accept_presentation` (issuing bank accepts)
      - `pay_beneficiary` (issuing bank pays) — Money amount
      - `raise_discrepancy` (bank raises discrepancy notice)
    - 1-2 Flows: `lc_presentation_flow` with BranchStep for compliance check, HandoffStep (beneficiary -> advising_bank -> issuing_bank), Terminate for expiry

    **Key spec features this contract MUST exercise:**
    - Multi-party personas (4-5 distinct parties with different authority)
    - Money types and Money comparisons (draft_amount <= lc_amount)
    - Date types and deadline rules
    - Document entity state machine
    - Bounded universal quantification over required documents
    - HandoffStep (document passes between parties)
    - Multi-outcome operation (accept/reject)

    **Eval fixtures (2 paths):**
    1. `lc_present` -- Happy path: documents compliant, amount matches, within deadline, presentation accepted and paid.
    2. `lc_discrepancy` -- Discrepancy path: document missing or amount mismatch, discrepancy raised.

    Elaborate, evaluate, capture output, verify, save fixtures.
    Append any gaps to gap-log.md.
  </action>
  <verify>
    ```bash
    cargo run -p tenor-cli -- elaborate domains/trade_finance/letter_of_credit.tenor > /dev/null
    cargo run -p tenor-cli -- check domains/trade_finance/letter_of_credit.tenor
    ```
    Both exit 0. Verify Money comparisons and Date checks work correctly.
  </verify>
  <done>Trade finance contract elaborates, passes check, evaluates for 2 paths. Contract is distinct from existing escrow tests. Money and Date types exercised.</done>
</task>

<task type="auto">
  <name>Task 2: Register trade finance eval conformance tests</name>
  <files>
    crates/eval/tests/conformance.rs
  </files>
  <action>
    Add trade finance domain eval tests to `crates/eval/tests/conformance.rs`.

    1. Add section comment:
    ```rust
    // ──────────────────────────────────────────────
    // Domain validation — Trade Finance LC (Phase 5)
    // ──────────────────────────────────────────────
    ```

    2. Register 2 test functions:
    ```rust
    #[test]
    fn domain_trade_finance_present() {
        run_eval_flow_fixture(
            &domains_dir().join("trade_finance"),
            "lc_present",
            "lc_presentation_flow",
            "beneficiary",
        );
    }

    #[test]
    fn domain_trade_finance_discrepancy() {
        run_eval_flow_fixture(
            &domains_dir().join("trade_finance"),
            "lc_discrepancy",
            "lc_presentation_flow",
            "beneficiary",
        );
    }
    ```

    3. Adjust flow_id and persona to match actual contract.
    4. Run tests.
  </action>
  <verify>
    ```bash
    cargo test -p tenor-eval -- domain_trade_finance
    ```
    Both tests pass. Full workspace:
    ```bash
    cargo test --workspace
    ```
  </verify>
  <done>Trade finance domain eval tests registered and passing.</done>
</task>

</tasks>

<verification>
1. `cargo run -p tenor-cli -- elaborate domains/trade_finance/letter_of_credit.tenor` exits 0
2. `cargo run -p tenor-cli -- check domains/trade_finance/letter_of_credit.tenor` exits 0
3. Money comparisons (draft <= lc_amount) produce correct verdicts
4. Date deadline checks function correctly
5. Contract is visually and structurally distinct from escrow conformance tests
6. `cargo test -p tenor-eval -- domain_trade_finance` — both tests pass
7. `cargo test --workspace` — full suite passes
</verification>

<success_criteria>
- Trade finance contract exercises: multi-party personas, Money types/comparisons, Date types, document entity states, bounded quantification, HandoffStep, multi-outcome operation
- Contract is distinct from escrow (different domain, different parties, different lifecycle)
- Elaborates, passes check, evaluates for 2 paths
- All eval tests registered and passing
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-validation/05-05-SUMMARY.md`
</output>
