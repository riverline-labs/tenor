---
phase: 05-domain-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - domains/saas/saas_subscription.tenor
  - domains/saas/saas_activate.facts.json
  - domains/saas/saas_activate.verdicts.json
  - domains/saas/saas_suspend.facts.json
  - domains/saas/saas_suspend.verdicts.json
  - crates/eval/tests/conformance.rs
  - .planning/phases/05-domain-validation/gap-log.md
autonomous: true
requirements:
  - DOMN-01
  - DOMN-06
  - DOMN-07
  - DOMN-08

must_haves:
  truths:
    - "SaaS subscription contract elaborates without error"
    - "SaaS contract passes tenor check with no warnings"
    - "SaaS contract evaluates against activate facts with correct verdicts and provenance"
    - "SaaS contract evaluates against suspend facts with correct verdicts"
    - "Gap log file exists and captures any spec issues encountered during authoring"
  artifacts:
    - path: "domains/saas/saas_subscription.tenor"
      provides: "SaaS subscription contract with entity states, simple rules, feature-flag enums, basic operations"
      contains: "entity Subscription"
    - path: "domains/saas/saas_activate.facts.json"
      provides: "Happy path facts for subscription activation"
    - path: "domains/saas/saas_activate.verdicts.json"
      provides: "Expected verdicts for activation path"
    - path: "crates/eval/tests/conformance.rs"
      provides: "Domain eval test registration for SaaS"
      contains: "domain_saas"
  key_links:
    - from: "crates/eval/tests/conformance.rs"
      to: "domains/saas/"
      via: "domains_dir() path helper + run_eval_flow_fixture"
      pattern: "domains_dir.*saas"
---

<objective>
Author the SaaS subscription domain contract (SMALL) -- the simplest of the five domain contracts. This contract models seat limits, feature-flag enums, subscription lifecycle entity states, and basic operations.

Purpose: Establishes the domain contract authoring pattern (file structure, eval fixture triplets, test registration, gap logging) that all subsequent domain contracts follow. Validates that Tenor handles a straightforward business domain correctly.

Output: Complete SaaS contract with 2 eval fixture sets (activate, suspend), registered eval conformance tests, and initialized gap-log.md.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-validation/05-CONTEXT.md
@.planning/phases/05-domain-validation/05-RESEARCH.md
@crates/eval/tests/conformance.rs
@conformance/eval/positive/escrow_release.tenor
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Author SaaS subscription contract and eval fixtures</name>
  <files>
    domains/saas/saas_subscription.tenor
    domains/saas/saas_activate.facts.json
    domains/saas/saas_activate.verdicts.json
    domains/saas/saas_suspend.facts.json
    domains/saas/saas_suspend.verdicts.json
    .planning/phases/05-domain-validation/gap-log.md
  </files>
  <action>
    Create the `domains/saas/` directory. Author `saas_subscription.tenor` as a SMALL contract (~120 lines) modeling a SaaS subscription lifecycle.

    **Contract must include:**
    - TypeDecl (Record): `PlanFeatures` with `max_seats: Int`, `api_access: Bool`, `sso_enabled: Bool`, `custom_branding: Bool`
    - 3 Personas: `account_admin`, `billing_system`, `support_agent`
    - 5-6 Facts: `current_seat_count` (Int), `subscription_plan` (Enum: free/starter/professional/enterprise), `plan_features` (PlanFeatures Record), `payment_ok` (Bool, default: true), plus 1-2 others as domain needs
    - 1-2 Entities: `Subscription` with states [trial, active, suspended, cancelled] and natural transitions
    - 4-5 Rules across 2 strata: stratum 0 for direct fact checks (seats within limit, payment ok), stratum 1 for composite verdicts (verdict_present checks)
    - 3-4 Operations: `activate_subscription`, `suspend_subscription`, `cancel_subscription` -- single outcome operations with persona restrictions and preconditions
    - 1 Flow: `subscription_lifecycle` -- linear flow with branch step for payment check

    **DSL rules (from CLAUDE.md):** All keywords lowercase (`fact`, `entity`, `rule`, `operation`, `flow`, `type`, `persona`). Use `->` for transitions. Follow the escrow conformance tests as structural reference.

    **Eval fixtures:**
    1. `saas_activate` -- Happy path: trial->active with seats within limit and payment ok. Facts provide valid seat count, plan features, payment_ok=true. Flow executed by `billing_system`.
    2. `saas_suspend` -- Failure path: active->suspended when payment fails. Facts with payment_ok=false.

    To create verdict fixtures: First elaborate the contract (`cargo run -p tenor-cli -- elaborate domains/saas/saas_subscription.tenor`), then evaluate (`cargo run -p tenor-cli -- eval <bundle> --facts <facts>`). Capture the output, verify correctness by hand, save as `.verdicts.json`.

    **Initialize gap-log.md** with the structured header format from the research:
    ```
    # Phase 5: Domain Validation — Gap Log
    [Running log of spec issues encountered during domain contract authoring]
    ```
    Append any gaps encountered during SaaS authoring. If no gaps found, note "No gaps encountered for SaaS domain."

    **Critical:** If a domain scenario cannot be expressed in Tenor, skip it and document in gap-log.md with extreme clarity per user decision. Do NOT modify the elaborator/evaluator/analyzer.
  </action>
  <verify>
    Run all three pipeline steps:
    ```bash
    cargo run -p tenor-cli -- elaborate domains/saas/saas_subscription.tenor > /dev/null
    cargo run -p tenor-cli -- check domains/saas/saas_subscription.tenor
    ```
    Both must exit 0. Then verify eval fixtures produce correct output by running the elaborator and evaluator manually.
  </verify>
  <done>SaaS contract elaborates, passes check, and eval fixtures produce verified verdicts. Gap log initialized.</done>
</task>

<task type="auto">
  <name>Task 2: Register SaaS eval conformance tests</name>
  <files>
    crates/eval/tests/conformance.rs
  </files>
  <action>
    Add domain eval test registration to `crates/eval/tests/conformance.rs`.

    1. Add a `domains_dir()` helper function (if not already present):
    ```rust
    fn domains_dir() -> PathBuf {
        PathBuf::from(env!("CARGO_MANIFEST_DIR"))
            .parent().unwrap()
            .parent().unwrap()
            .join("domains")
    }
    ```

    2. Add a new section comment:
    ```rust
    // ──────────────────────────────────────────────
    // Domain validation — SaaS Subscription (Phase 5)
    // ──────────────────────────────────────────────
    ```

    3. Register two test functions:
    ```rust
    #[test]
    fn domain_saas_activate() {
        run_eval_flow_fixture(
            &domains_dir().join("saas"),
            "saas_activate",
            "subscription_lifecycle",  // flow_id from contract
            "billing_system",          // persona
        );
    }

    #[test]
    fn domain_saas_suspend() {
        run_eval_flow_fixture(
            &domains_dir().join("saas"),
            "saas_suspend",
            "subscription_lifecycle",
            "billing_system",
        );
    }
    ```

    Adjust flow_id and persona to match the actual contract authored in Task 1. The fixture names must match the `.facts.json` and `.verdicts.json` file stems.

    4. Run `cargo test -p tenor-eval -- domain_saas` to verify both tests pass.
  </action>
  <verify>
    ```bash
    cargo test -p tenor-eval -- domain_saas
    ```
    Both `domain_saas_activate` and `domain_saas_suspend` must pass. Also run full workspace tests to ensure no regressions:
    ```bash
    cargo test --workspace
    ```
  </verify>
  <done>SaaS domain eval tests registered and passing. Full workspace test suite still passes.</done>
</task>

</tasks>

<verification>
1. `cargo run -p tenor-cli -- elaborate domains/saas/saas_subscription.tenor` exits 0 and produces valid interchange JSON
2. `cargo run -p tenor-cli -- check domains/saas/saas_subscription.tenor` exits 0 with no warnings
3. `cargo test -p tenor-eval -- domain_saas` — both tests pass
4. `cargo test --workspace` — full suite passes (no regressions)
5. `domains/saas/` contains 5 files: .tenor + 2 fixture pairs
6. `.planning/phases/05-domain-validation/gap-log.md` exists
</verification>

<success_criteria>
- SaaS subscription contract exercises: TypeDecl Record, 3 personas, Enum fact, Bool fact with default, entity state machine, multi-stratum rules, operations with persona restrictions, linear flow with branch
- Contract elaborates, passes check, and evaluates correctly for 2 paths
- All eval tests registered and passing
- Gap log initialized
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-validation/05-01-SUMMARY.md`
</output>
