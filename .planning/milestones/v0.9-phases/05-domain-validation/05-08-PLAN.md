---
phase: 05-domain-validation
plan: 08
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - crates/cli/tests/cli_integration.rs
  - crates/eval/tests/conformance.rs
autonomous: true
requirements:
  - TEST-11

must_haves:
  truths:
    - "E10 test validates that tenor elaborate --manifest produces valid manifest JSON"
    - "E11 test validates that manifest bundle is self-contained (all references resolved)"
    - "E12 test validates etag determinism (same contract = same etag) and change detection (modified contract = different etag)"
    - "E13 test validates dry-run evaluation semantics (rules evaluate without state changes)"
    - "All executor conformance tests use domain contracts as test subjects"
  artifacts:
    - path: "crates/cli/tests/cli_integration.rs"
      provides: "E10, E12 executor conformance tests via CLI"
      contains: "e10_manifest"
    - path: "crates/eval/tests/conformance.rs"
      provides: "E11, E13 executor conformance tests via eval API"
      contains: "e11_cold_start"
  key_links:
    - from: "crates/cli/tests/cli_integration.rs"
      to: "domains/"
      via: "domain contract paths for manifest generation"
      pattern: "domains.*tenor"
    - from: "crates/eval/tests/conformance.rs"
      to: "tenor_eval::evaluate"
      via: "evaluate API for dry-run semantics test"
      pattern: "tenor_eval.*evaluate"
---

<objective>
Implement executor conformance tests (E10-E13) from spec Section 18, using domain contracts as test subjects. These tests validate that the Tenor toolchain produces artifacts meeting executor obligations: valid manifests, self-contained bundles, deterministic etags, and correct dry-run semantics.

Purpose: TEST-11 requirement. Proves that the toolchain's output meets the executor contract: manifests are schema-valid, bundles are complete, etags enable change detection, and evaluation is side-effect-free.

Output: 6-8 new tests across CLI integration and eval conformance test files covering E10-E13.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-validation/05-CONTEXT.md
@.planning/phases/05-domain-validation/05-RESEARCH.md
@.planning/phases/05-domain-validation/05-01-SUMMARY.md
@crates/cli/src/main.rs
@crates/cli/tests/cli_integration.rs
@crates/eval/tests/conformance.rs
@docs/manifest-schema.json
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement E10 and E12 manifest tests (CLI integration)</name>
  <files>
    crates/cli/tests/cli_integration.rs
  </files>
  <action>
    Add executor conformance tests to `crates/cli/tests/cli_integration.rs`.

    **E10: Manifest Serving — Valid Schema**
    ```rust
    #[test]
    fn e10_manifest_valid_schema() {
        // Run `tenor elaborate --manifest` on a domain contract
        // Parse output as JSON
        // Validate against manifest-schema.json
        // Verify: etag field present (hex string), bundle field present, tenor field present
    }
    ```
    Use a domain contract (e.g., `domains/saas/saas_subscription.tenor`). Run `tenor elaborate --manifest <path>`, capture stdout, parse as JSON, verify structure:
    - Top-level keys: `bundle`, `etag`, `tenor`
    - `etag` is a lowercase hex string (64 chars for SHA-256)
    - `tenor` is "1.1"
    - `bundle` has `kind: "Bundle"`

    For schema validation: Use jsonschema crate inline (already a dev-dependency). Load manifest schema via `include_str!` or read from docs/manifest-schema.json.

    **E12: Change Detection — Etag Determinism**
    ```rust
    #[test]
    fn e12_etag_determinism() {
        // Elaborate same contract twice with --manifest
        // Compare etag values — must be identical
    }
    ```

    ```rust
    #[test]
    fn e12_etag_change_detection() {
        // Elaborate two DIFFERENT contracts with --manifest
        // Etag values must be DIFFERENT
    }
    ```

    Use `assert_cmd` to run the CLI. For determinism, elaborate the same file twice and compare etag fields. For change detection, elaborate two different domain contracts and verify different etags.

    Add these under a new section comment:
    ```rust
    // ──────────────────────────────────────────────
    // Executor conformance — E10, E12 (Phase 5)
    // ──────────────────────────────────────────────
    ```
  </action>
  <verify>
    ```bash
    cargo test -p tenor-cli -- e10
    cargo test -p tenor-cli -- e12
    ```
    All E10 and E12 tests pass.
  </verify>
  <done>E10 (manifest schema validity) and E12 (etag determinism + change detection) CLI tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Implement E11 and E13 tests (eval conformance)</name>
  <files>
    crates/eval/tests/conformance.rs
  </files>
  <action>
    Add E11 and E13 executor conformance tests to `crates/eval/tests/conformance.rs`.

    **E11: Cold-Start Completeness**
    ```rust
    #[test]
    fn e11_cold_start_completeness() {
        // Elaborate a domain contract
        // Parse the interchange bundle
        // Verify all internal references resolve:
        //   - Every fact_ref in rules points to a declared fact
        //   - Every persona ref in operations points to a declared persona
        //   - Every entity ref in operations points to a declared entity
        //   - Every operation ref in flows points to a declared operation
        // This is already guaranteed by the elaborator, but E11 validates it
        // from the consumer perspective (parsing the JSON, not the DSL)
    }
    ```

    Implementation: Elaborate a domain contract, parse the JSON bundle, extract all construct IDs by kind, then walk through rules/operations/flows checking that all references point to declared constructs. This validates the bundle is self-contained.

    Use a complex domain contract (e.g., healthcare or energy) to maximize reference coverage.

    **E13: Dry-Run Evaluation Semantics**
    ```rust
    #[test]
    fn e13_dry_run_rule_evaluation() {
        // Elaborate a domain contract
        // Evaluate rules only (not flows)
        // Verify: verdicts are produced, no entity state changes
        // tenor_eval::evaluate() already does this for rule-only eval
    }
    ```

    The existing `tenor_eval::evaluate()` function evaluates rules without flows — this is inherently a dry-run of the rule engine. The test validates:
    - Rules produce verdicts
    - No entity state mutations occur (evaluate() doesn't touch entities)
    - Result is deterministic (same input = same output)

    If the domain contract has rules that don't require flow execution, use `tenor_eval::evaluate()` directly. If all rules require flow context, use a simpler contract or construct a minimal bundle inline.

    Add under a new section comment:
    ```rust
    // ──────────────────────────────────────────────
    // Executor conformance — E11, E13 (Phase 5)
    // ──────────────────────────────────────────────
    ```
  </action>
  <verify>
    ```bash
    cargo test -p tenor-eval -- e11
    cargo test -p tenor-eval -- e13
    ```
    All E11 and E13 tests pass. Full workspace:
    ```bash
    cargo test --workspace
    ```
  </verify>
  <done>E11 (cold-start completeness) and E13 (dry-run evaluation) tests pass. All executor conformance tests (E10-E13) complete.</done>
</task>

</tasks>

<verification>
1. `cargo test -p tenor-cli -- e10` — manifest schema validation passes
2. `cargo test -p tenor-cli -- e12` — etag determinism + change detection passes
3. `cargo test -p tenor-eval -- e11` — cold-start completeness passes
4. `cargo test -p tenor-eval -- e13` — dry-run evaluation passes
5. `cargo test --workspace` — full suite passes
6. All tests use domain contracts as test subjects (not synthetic/minimal bundles)
</verification>

<success_criteria>
- E10: Manifest from domain contract validates against manifest-schema.json
- E11: Domain contract bundle is self-contained (all references resolve from JSON perspective)
- E12: Same contract = same etag, different contract = different etag
- E13: Rule evaluation produces verdicts without side effects
- All executor conformance tests pass
- TEST-11 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-validation/05-08-SUMMARY.md`
</output>
