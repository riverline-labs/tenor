---
phase: 03.4-contract-discovery
plan: 01
subsystem: cli
tags: [sha2, manifest, etag, jsonschema, contract-discovery]

requires:
  - phase: 03-cli-evaluator
    provides: CLI elaborate/validate commands, interchange schema embedding
provides:
  - "--manifest flag on tenor elaborate producing TenorManifest envelope"
  - "SHA-256 etag computation for interchange bundles"
  - "Manifest auto-detection and validation in tenor validate"
  - "compute_etag and build_manifest functions in CLI"
affects: [03.4-02, phase-5]

tech-stack:
  added: [sha2 0.10]
  patterns: [manifest envelope wrapping, etag-based change detection, schema $ref resolution]

key-files:
  created: []
  modified:
    - Cargo.toml
    - crates/cli/Cargo.toml
    - crates/cli/src/main.rs

key-decisions:
  - "Resource::from_contents returns Resource directly (not Result) in jsonschema 0.42"
  - "Manifest schema $ref resolves relative to $id base URI -- interchange schema registered at https://tenor-lang.org/schemas/manifest/interchange-schema.json"
  - "Module-level statics for both INTERCHANGE_SCHEMA_STR and MANIFEST_SCHEMA_STR (moved from function-local)"

patterns-established:
  - "compute_etag: compact JSON -> SHA-256 -> lowercase hex for deterministic content addressing"
  - "build_manifest: BTreeMap-backed serde_json::Map ensures lexicographic key ordering"
  - "Auto-detection via field presence (etag) for schema selection in validate"

requirements-completed: [SPEC-08, CLI-10]

duration: 8min
completed: 2026-02-22
---

# Plan 03.4-01: Manifest Envelope and Etag Summary

**`tenor elaborate --manifest` produces TenorManifest envelope with SHA-256 etag, and `tenor validate` auto-detects manifests via etag field for schema validation with $ref resolution**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-22
- **Completed:** 2026-02-22
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- `--manifest` flag on elaborate wraps bundle in envelope with bundle/etag/tenor keys
- SHA-256 etag computed from compact canonical JSON bytes (64-char lowercase hex)
- `tenor validate` auto-detects manifests via etag field presence, validates against manifest-schema.json with $ref resolution to interchange-schema.json
- Existing bare elaborate and bundle validate behavior unchanged

## Task Commits

Each task was committed atomically:

1. **Task 1+2: Add sha2 dep, --manifest flag, etag, manifest envelope, manifest-aware validate** - `bcbfd02` (feat)

## Files Created/Modified
- `Cargo.toml` - Added sha2 workspace dependency
- `crates/cli/Cargo.toml` - Added sha2 dependency reference
- `crates/cli/src/main.rs` - compute_etag, build_manifest, --manifest flag, manifest-aware validate with $ref resolution

## Decisions Made
- Manifest schema $ref "interchange-schema.json" resolves relative to manifest schema's $id base URI, so interchange schema registered at full resolved URL
- Resource::from_contents in jsonschema 0.42 returns Resource directly (no unwrap/expect needed)
- Schema statics moved to module level for shared access between validate paths

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] $ref resolution URI mismatch**
- **Found during:** Task 2 (manifest validation)
- **Issue:** Registering interchange schema at bare "interchange-schema.json" failed because jsonschema resolves $ref relative to manifest schema's $id base URI
- **Fix:** Registered at "https://tenor-lang.org/schemas/manifest/interchange-schema.json"
- **Files modified:** crates/cli/src/main.rs
- **Verification:** `tenor validate /tmp/test-manifest.json` prints "valid manifest"
- **Committed in:** bcbfd02

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Essential for correct $ref resolution. No scope creep.

## Issues Encountered
None beyond the $ref URI resolution noted above.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Manifest generation working, ready for conformance test fixtures in Plan 02
- compute_etag and build_manifest available for runner to reuse or duplicate

---
*Phase: 03.4-contract-discovery*
*Completed: 2026-02-22*
