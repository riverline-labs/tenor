---
phase: 03.4-contract-discovery
plan: 02
type: execute
wave: 2
depends_on:
  - "03.4-01"
files_modified:
  - crates/cli/src/runner.rs
  - conformance/manifest/manifest_basic.tenor
  - conformance/manifest/manifest_basic.expected-manifest.json
autonomous: true
requirements:
  - SPEC-08
  - CLI-10

must_haves:
  truths:
    - "Conformance runner includes manifest test category that elaborates .tenor files with --manifest and compares against .expected-manifest.json"
    - "At least one manifest conformance test validates correct etag, correct structure, and deterministic output"
    - "`tenor test conformance` runs manifest tests as part of the full suite"
  artifacts:
    - path: "crates/cli/src/runner.rs"
      provides: "run_manifest_tests function integrated into run_suite"
      contains: "run_manifest_tests"
    - path: "conformance/manifest/manifest_basic.tenor"
      provides: "Simple .tenor source for manifest conformance test"
    - path: "conformance/manifest/manifest_basic.expected-manifest.json"
      provides: "Expected manifest output with correct etag, bundle, and tenor fields"
      contains: "etag"
  key_links:
    - from: "crates/cli/src/runner.rs"
      to: "conformance/manifest/"
      via: "run_manifest_tests reads manifest directory"
      pattern: "suite_dir.join.*manifest"
    - from: "crates/cli/src/runner.rs"
      to: "crates/cli/src/main.rs"
      via: "reuses build_manifest function (or reimplements in runner context via elaborate + envelope)"
      pattern: "build_manifest\\|compute_etag"
---

<objective>
Add manifest conformance tests to the test suite -- a new `conformance/manifest/` directory with test fixtures, and runner integration to elaborate .tenor files with manifest envelope wrapping and compare against expected output.

Purpose: Ensures manifest generation is correct and deterministic -- etag matches expected SHA-256, structure is valid, and output is reproducible across runs. This is the test coverage requirement for Phase 3.4.

Output: Manifest conformance tests passing as part of `tenor test conformance`.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-contract-discovery/3.4-RESEARCH.md
@.planning/phases/03.4-contract-discovery/03.4-01-SUMMARY.md

@crates/cli/src/runner.rs
@crates/cli/src/main.rs
@docs/manifest-schema.json
@conformance/positive/entity_basic.tenor
@conformance/positive/entity_basic.expected.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create manifest conformance fixtures</name>
  <files>
    conformance/manifest/manifest_basic.tenor
    conformance/manifest/manifest_basic.expected-manifest.json
  </files>
  <action>
1. Create `conformance/manifest/` directory.
2. Create `conformance/manifest/manifest_basic.tenor` -- a simple, minimal Tenor contract. Use an existing simple contract as a model (e.g., similar to entity_basic.tenor or a minimal contract with one entity and one fact). Keep it small so the expected JSON is manageable.
3. Generate the expected manifest output:
   a. Run `cargo run -p tenor-cli -- elaborate --manifest conformance/manifest/manifest_basic.tenor` to get the actual manifest output.
   b. Save this output as `conformance/manifest/manifest_basic.expected-manifest.json`.
   c. Verify the etag independently: run `cargo run -p tenor-cli -- elaborate conformance/manifest/manifest_basic.tenor` to get the bare bundle, compute SHA-256 of the compact JSON manually or via a script, confirm it matches the etag in the manifest.
4. The expected-manifest.json must have exactly three top-level keys: "bundle", "etag", "tenor". The "tenor" value must be "1.1". The "etag" must be a 64-character lowercase hex string. The "bundle" must match the bare elaboration output exactly.

Note: Follow the existing convention where expected JSON fixtures are regenerated from elaborator output for exact canonical match (per project decision). The test fixture IS the elaborator's actual output, saved as the expected file.
  </action>
  <verify>
    Verify `conformance/manifest/manifest_basic.tenor` exists and is valid Tenor DSL.
    Verify `conformance/manifest/manifest_basic.expected-manifest.json` exists and has "bundle", "etag", "tenor" keys.
    Verify the etag is 64 hex chars.
    Verify the bundle in the manifest matches the bare elaboration output.
  </verify>
  <done>
    Manifest test fixtures exist with correct structure and deterministic etag values.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add manifest test runner integration</name>
  <files>
    crates/cli/src/runner.rs
  </files>
  <action>
1. In `crates/cli/src/runner.rs`:
   a. Add `use sha2::{Sha256, Digest};` import (sha2 is already a dependency of the cli crate from Plan 01).
   b. Add a `run_manifest_tests(suite_dir: &Path, tap: &mut Tap)` function:
      - Joins suite_dir with "manifest".
      - If directory does not exist, return early (graceful skip).
      - Globs for .tenor files using existing `glob_tenor_files` helper.
      - Sorts entries.
      - For each .tenor file, looks for a matching `.expected-manifest.json` file.
      - For each pair, calls `run_manifest_test`.
   c. Add a `run_manifest_test(tenor_path, expected_path, name, tap)` function:
      - Reads expected JSON from the .expected-manifest.json file.
      - Elaborates the .tenor file using `elaborate::elaborate(tenor_path)`.
      - On success: wraps the bundle in a manifest envelope using inline logic (compute SHA-256 etag of compact bundle bytes, build manifest object with bundle/etag/tenor="1.1" -- same logic as main.rs's build_manifest but self-contained in the runner to avoid coupling).
      - Compares the generated manifest to expected JSON using existing `json_equal`.
      - Reports ok/not_ok via tap.
   d. Call `run_manifest_tests(suite_dir, &mut tap)` in `run_suite` after the shorthand tests (at the end of the test categories).
2. The runner does NOT import from main.rs (runner.rs and main.rs are sibling modules; the manifest logic is simple enough to duplicate: ~10 lines for etag + envelope). Alternatively, extract build_manifest/compute_etag to a shared module -- use your judgment. If extracting, create a `manifest.rs` module in the cli crate and have both main.rs and runner.rs use it.

Important: The etag computation in the runner MUST use `serde_json::to_string` (compact), NOT `to_string_pretty`. This must match the production code exactly.
  </action>
  <verify>
    Run `cargo build --workspace` -- must compile.
    Run `cargo run -p tenor-cli -- test conformance` -- must include manifest tests in TAP output and all pass.
    Run `cargo test --workspace` -- all existing tests must still pass.
    Verify TAP output includes lines like "ok N - manifest/manifest_basic".
  </verify>
  <done>
    `tenor test conformance` runs manifest conformance tests alongside all other test categories, and all manifest tests pass with correct etag and structure verification.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` succeeds
2. `cargo test --workspace` -- all tests pass
3. `cargo run -p tenor-cli -- test conformance` includes manifest test category
4. All manifest tests pass (etag correct, structure matches)
5. Existing conformance tests unaffected
</verification>

<success_criteria>
- `conformance/manifest/` directory exists with at least one test fixture
- Conformance runner includes manifest test category
- `tenor test conformance` runs manifest tests and they pass
- Etag in expected files matches SHA-256 of compact canonical bundle JSON
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-contract-discovery/03.4-02-SUMMARY.md`
</output>
