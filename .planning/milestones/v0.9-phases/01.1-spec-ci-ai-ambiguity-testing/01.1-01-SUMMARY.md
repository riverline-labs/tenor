---
phase: 01.1-spec-ci-ai-ambiguity-testing
plan: 01
subsystem: testing
tags: [anthropic-api, ureq, ambiguity-testing, tap, conformance, llm-evaluation]

# Dependency graph
requires:
  - phase: 01-spec-completion
    provides: "Frozen v1.0 spec (TENOR.md) and elaborator conformance suite (47 tests)"
provides:
  - "Anthropic Messages API client with retry/backoff (api.rs)"
  - "Verdict set comparator with symmetric difference (compare.rs)"
  - "TAP-format ambiguity reporter with YAML diagnostics (report.rs)"
  - "Prompt builder with spec section extraction (prompt.rs)"
  - "Fixture loader for ambiguity test cases (fixtures.rs)"
  - "16 synthetic test fixtures across 3 contracts (conformance/ambiguity/)"
affects: [01.1-02, phase-2-elaborator]

# Tech tracking
tech-stack:
  added: [ureq-3.2.0]
  patterns: [ambiguity-module-pattern, fixture-triplet-convention, spec-section-extraction]

key-files:
  created:
    - elaborator/src/ambiguity/mod.rs
    - elaborator/src/ambiguity/api.rs
    - elaborator/src/ambiguity/compare.rs
    - elaborator/src/ambiguity/report.rs
    - elaborator/src/ambiguity/prompt.rs
    - elaborator/src/ambiguity/fixtures.rs
    - conformance/ambiguity/rule_basic_all_satisfied.facts.json
    - conformance/ambiguity/rule_basic_all_satisfied.verdicts.json
    - conformance/ambiguity/rule_basic_partial.facts.json
    - conformance/ambiguity/rule_basic_partial.verdicts.json
    - conformance/ambiguity/rule_basic_none.facts.json
    - conformance/ambiguity/rule_basic_none.verdicts.json
    - conformance/ambiguity/escrow_release_approved.facts.json
    - conformance/ambiguity/escrow_release_approved.verdicts.json
    - conformance/ambiguity/escrow_refund_approved.facts.json
    - conformance/ambiguity/escrow_refund_approved.verdicts.json
    - conformance/ambiguity/escrow_compliance_required.facts.json
    - conformance/ambiguity/escrow_compliance_required.verdicts.json
    - conformance/ambiguity/mul_valid_satisfied.facts.json
    - conformance/ambiguity/mul_valid_satisfied.verdicts.json
    - conformance/ambiguity/mul_valid_not_satisfied.facts.json
    - conformance/ambiguity/mul_valid_not_satisfied.verdicts.json
  modified:
    - elaborator/Cargo.toml
    - elaborator/src/main.rs

key-decisions:
  - "ureq v3 chosen over reqwest/hyper -- synchronous HTTP, no tokio async runtime"
  - "Fixture naming convention: {contract}_{scenario}.facts.json with derive_contract_name mapping"
  - "Spec section extraction by top-level heading number (## N.) for prompt context injection"
  - "LLM response parsing handles markdown code fence wrapping gracefully"

patterns-established:
  - "Fixture triplet convention: .tenor source + .facts.json + .verdicts.json per test case"
  - "Ambiguity module structure: api/prompt/compare/report/fixtures as separate concerns"
  - "Spec section extraction by numbered heading for targeted LLM context"

requirements-completed: [SPEC-05]

# Metrics
duration: 5min
completed: 2026-02-21
---

# Phase 01.1 Plan 01: Ambiguity Harness Core Modules Summary

**Six Rust modules for AI ambiguity testing (ureq API client, prompt builder, verdict comparator, fixture loader, TAP reporter) plus 16 synthetic test fixtures across 3 contracts with manually-derived ground truth**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-21T17:41:50Z
- **Completed:** 2026-02-21T17:47:20Z
- **Tasks:** 2
- **Files modified:** 24 (6 Rust source + 16 fixture JSON + 2 modified)

## Accomplishments
- Built complete data pipeline modules: fixture loading, prompt construction, API calling, verdict comparison, TAP reporting
- Created 16 fixture files (8 fact sets + 8 verdict files) across 3 contracts covering all-satisfied, partial, and none-satisfied scenarios
- All 16 unit tests pass across compare, prompt, and fixtures modules
- Existing 47/47 conformance tests unaffected
- No async runtime (tokio) introduced -- ureq v3 is synchronous

## Task Commits

Each task was committed atomically:

1. **Task 1: Build API client, verdict comparator, and TAP reporter modules** - `8162196` (feat)
2. **Task 2: Build prompt constructor, fixture loader, and synthetic test cases** - `e7ed6eb` (feat)

## Files Created/Modified

### Rust Modules (elaborator/src/ambiguity/)
- `mod.rs` - Module declaration + shared types (AmbiguityTestCase, AmbiguityResult)
- `api.rs` - Anthropic Messages API client with ureq, exponential backoff retry on 429/500/503
- `compare.rs` - Verdict set comparison with BTreeSet symmetric difference + LLM response JSON parsing
- `report.rs` - TAP v14 reporter with YAML diagnostic blocks for verdict mismatches
- `prompt.rs` - System/user prompt builder with spec section extraction from TENOR.md
- `fixtures.rs` - Loader scanning conformance/ambiguity/ for .facts.json/.verdicts.json triplets

### Fixture Files (conformance/ambiguity/)
- `rule_basic_all_satisfied` - All 4 verdicts fire (account_active, within_credit_limit, all_items_approved, order_processable)
- `rule_basic_partial` - Only account_active fires (balance exceeds limit, one item not approved)
- `rule_basic_none` - No verdicts fire (is_active=false, all conditions fail)
- `escrow_release_approved` - Stratum 0: delivery_confirmed + line_items_validated + within_threshold; Stratum 1: release_approved
- `escrow_refund_approved` - Stratum 0: delivery_failed + refund_requested + line_items_validated + within_threshold; Stratum 1: refund_approved
- `escrow_compliance_required` - Stratum 0: delivery_confirmed + line_items_validated (amount exceeds threshold); Stratum 1: compliance_review_required
- `mul_valid_satisfied` - x=5 > 0 fires scaled_x verdict
- `mul_valid_not_satisfied` - x=0, condition fails, no verdicts

### Modified
- `elaborator/Cargo.toml` - Added ureq v3 with json feature
- `elaborator/src/main.rs` - Registered ambiguity module

## Decisions Made
- Used ureq v3 (synchronous) instead of async HTTP clients to avoid tokio runtime complexity -- aligns with elaborator's synchronous architecture
- Fixture naming uses `{contract}_{scenario}` convention with a `derive_contract_name` mapping to handle prefixes like `escrow_` -> `integration_escrow`
- Spec section extraction parses `## N.` headings from TENOR.md rather than hardcoding section text -- adapts automatically if spec is updated
- LLM response parser strips markdown code fences before JSON parsing for robustness

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required. (ANTHROPIC_API_KEY will be needed at runtime when Plan 02 orchestrator is wired, but not for compilation.)

## Next Phase Readiness
- All core modules compile and are tested
- Ready for Plan 02: orchestrator wiring + CLI subcommand integration
- Fixtures provide ground truth for 8 test scenarios across stratum 0/1 rules, bounded quantification, money comparison, and multiplication

## Self-Check: PASSED

All 22 created files verified present. Both task commits (8162196, e7ed6eb) verified in git log.

---
*Phase: 01.1-spec-ci-ai-ambiguity-testing*
*Completed: 2026-02-21*
