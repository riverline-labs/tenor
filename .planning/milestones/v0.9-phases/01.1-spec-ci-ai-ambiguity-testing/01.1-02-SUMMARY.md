---
phase: 01.1-spec-ci-ai-ambiguity-testing
plan: 02
subsystem: testing
tags: [anthropic-api, ambiguity-testing, cli, orchestrator, tap]

# Dependency graph
requires:
  - phase: 01.1-spec-ci-ai-ambiguity-testing
    plan: 01
    provides: "Ambiguity harness core modules (api, prompt, compare, report, fixtures) + 16 fixtures"
provides:
  - "End-to-end ambiguity orchestrator (run_ambiguity_suite) wiring all modules"
  - "CLI subcommand: tenor-elaborator ambiguity <suite-dir> [--spec path] [--model name]"
  - "AmbiguityRunResult struct distinguishing hard errors from informational mismatches"
affects: [phase-2-elaborator, ci-pipeline]

# Tech tracking
tech-stack:
  added: []
  patterns: [orchestrator-pattern, graceful-skip-on-missing-key, hard-error-vs-mismatch-distinction]

key-files:
  created: []
  modified:
    - elaborator/src/ambiguity/mod.rs
    - elaborator/src/main.rs
    - elaborator/Cargo.lock

key-decisions:
  - "Hard errors (API failure, missing files) cause exit 1; LLM mismatches are informational (exit 0)"
  - "Optional --model and --spec CLI flags for overriding defaults"
  - "Positional spec-path argument preserved for backward compatibility alongside --spec flag"

patterns-established:
  - "Orchestrator pattern: load fixtures -> build prompts -> call API -> compare -> report"
  - "Graceful degradation: skip when ANTHROPIC_API_KEY absent instead of failing"

requirements-completed: [SPEC-05]

# Metrics
duration: 2min
completed: 2026-02-21
---

# Phase 01.1 Plan 02: Ambiguity Orchestrator and CLI Wiring Summary

**End-to-end ambiguity orchestrator wiring all harness modules into a `tenor-elaborator ambiguity` CLI subcommand with graceful skip on missing API key and hard-error/mismatch distinction**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-21T17:50:30Z
- **Completed:** 2026-02-21T17:52:18Z
- **Tasks:** 1
- **Files modified:** 3 (2 Rust source + 1 Cargo.lock)

## Accomplishments
- Wired all ambiguity harness modules (api, prompt, compare, report, fixtures) into a single orchestrator function `run_ambiguity_suite`
- Added `ambiguity` subcommand to the CLI with optional `--spec` and `--model` flags
- Implemented graceful skip when `ANTHROPIC_API_KEY` is absent (prints skip message, exits 0)
- Distinguished hard errors (API failures, missing files) from informational mismatches in `AmbiguityRunResult`
- Existing 47/47 conformance tests unaffected
- All 16 unit tests pass

## Task Commits

Each task was committed atomically:

1. **Task 1: Build orchestrator and wire CLI subcommand** - `5cdf589` (feat)

## Files Created/Modified

### Modified
- `elaborator/src/ambiguity/mod.rs` - Added `AmbiguityRunResult` struct and `run_ambiguity_suite` orchestrator function
- `elaborator/src/main.rs` - Added `ambiguity` subcommand with `--spec`/`--model` flag parsing and usage message update
- `elaborator/Cargo.lock` - Lock file regenerated (Cargo.lock version 3 -> 4)

## Decisions Made
- Hard errors (all API retries exhausted, fixture file missing/unparseable, spec file not found) cause exit 1. LLM verdict mismatches are NOT hard errors -- they are informational spec ambiguity signals (exit 0).
- Added optional `--model` and `--spec` CLI flags alongside positional spec-path argument for backward compatibility.
- Each failed API call or parse error increments `hard_errors` and `continue`s to the next test case, rather than aborting the entire suite.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required. ANTHROPIC_API_KEY is needed at runtime to actually run ambiguity tests, but the harness gracefully skips without it.

## Next Phase Readiness
- The ambiguity harness is fully operational end-to-end
- Ready for real-world usage: `cd elaborator && cargo run -- ambiguity ../conformance`
- With ANTHROPIC_API_KEY set, it will load 8 test cases, call Claude, compare verdicts, and produce TAP output
- Phase 01.1 is complete -- all modules built and wired

## Self-Check: PASSED

All 3 modified files verified present. Task commit (5cdf589) verified in git log.

---
*Phase: 01.1-spec-ci-ai-ambiguity-testing*
*Completed: 2026-02-21*
