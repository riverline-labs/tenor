---
phase: 03-cli-evaluator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/cli/Cargo.toml
  - crates/cli/src/main.rs
autonomous: true
requirements: [CLI-01, CLI-02, CLI-03, CLI-07, CLI-09]

must_haves:
  truths:
    - "`tenor elaborate <file>` produces identical interchange JSON to current behavior"
    - "`tenor validate <bundle.json>` validates interchange against the formal JSON Schema and reports pass/fail"
    - "`tenor test` runs conformance suite with TAP v14 output (same as current `run` command)"
    - "`tenor --help` shows all subcommands with descriptions"
    - "`tenor <cmd> --quiet` suppresses non-essential output and `--output json` formats output as JSON"
    - "Exit codes are 0=success, 1=error, 2=not-implemented for stub subcommands"
  artifacts:
    - path: "crates/cli/src/main.rs"
      provides: "clap-based CLI with typed subcommand dispatch"
      contains: "#[derive(Parser)]"
    - path: "crates/cli/Cargo.toml"
      provides: "clap and jsonschema dependencies"
      contains: "clap"
  key_links:
    - from: "crates/cli/src/main.rs"
      to: "tenor_core::elaborate::elaborate"
      via: "elaborate subcommand handler"
      pattern: "elaborate::elaborate"
    - from: "crates/cli/src/main.rs"
      to: "jsonschema"
      via: "validate subcommand handler"
      pattern: "jsonschema"
---

<objective>
Migrate the `tenor` CLI from hand-rolled `std::env::args()` parsing to clap 4.5 derive-based subcommands, registering all Phase 3 subcommands (elaborate, validate, eval, test, diff) plus stubs for future phases (check, explain, generate). Add global `--output` and `--quiet` flags with meaningful exit codes.

Purpose: Establishes the unified CLI shell that all subsequent plans wire functionality into. The current hand-rolled parser has no help text, no validation, and fragile argument handling.
Output: A working `tenor` binary with clap subcommands where `elaborate`, `validate`, and `test` are fully functional, and `eval`/`diff` are stubbed for wiring in later plans.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cli-evaluator/03-RESEARCH.md

@crates/cli/src/main.rs
@crates/cli/Cargo.toml
@Cargo.toml
@docs/interchange-schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate CLI to clap derive with all subcommands and global flags</name>
  <files>
    crates/cli/src/main.rs
    crates/cli/Cargo.toml
    Cargo.toml
  </files>
  <action>
Replace the hand-rolled `std::env::args()` parsing in `main.rs` with clap 4.5 derive API.

**Cargo.toml changes:**
- Add `clap = { version = "4.5", features = ["derive"] }` to workspace dependencies in root `Cargo.toml`
- Add `clap = { workspace = true }` and `jsonschema = "0.42"` to `crates/cli/Cargo.toml` dependencies

**main.rs structure:**
Define a `#[derive(Parser)]` struct `Cli` with:
- `#[command(name = "tenor", version, about = "Tenor contract language toolchain")]`
- `#[command(subcommand)] command: Commands` field
- `#[arg(long, global = true, default_value = "text")] output: OutputFormat` -- enum with Text, Json variants (derive `clap::ValueEnum`)
- `#[arg(long, global = true)] quiet: bool`

Define `#[derive(Subcommand)] enum Commands` with:
- `Elaborate { file: PathBuf }` -- elaborate a .tenor file to interchange JSON
- `Validate { bundle: PathBuf }` -- validate interchange against JSON Schema
- `Eval { bundle: PathBuf, #[arg(long)] facts: PathBuf }` -- stub returning exit 2 with "not yet implemented"
- `Test { #[arg(default_value = "conformance")] suite_dir: PathBuf }` -- run conformance suite
- `Diff { t1: PathBuf, t2: PathBuf }` -- stub returning exit 2
- `Check { file: PathBuf }` -- stub returning exit 2 (Phase 4)
- `Explain { bundle: PathBuf }` -- stub returning exit 2 (Phase 5)
- `Generate { bundle: PathBuf, #[arg(long)] target: String }` -- stub returning exit 2 (Phase 6)
- `Ambiguity { suite_dir: PathBuf, #[arg(long)] spec: Option<PathBuf>, #[arg(long)] model: Option<String> }` -- preserve existing ambiguity functionality

**Dispatch logic in main():**
- `Elaborate`: Call `tenor_core::elaborate::elaborate(&file)`, output JSON to stdout. On error, print error JSON to stderr, exit 1. If `--quiet`, suppress the error detail. If `--output json`, wrap errors in JSON format.
- `Validate`: Read bundle JSON from file, load schema from `docs/interchange-schema.json` (use `include_str!` to embed at compile time or locate relative to executable -- prefer `include_str!` since the schema is small and should ship with the binary). Use `jsonschema::validator_for(&schema).unwrap()` then `validator.validate(&bundle)`. Report pass/fail. Exit 0 on valid, exit 1 on invalid.
- `Test`: Delegate to existing `runner::run_suite()` with TAP output. Exit 1 if any failures.
- `Ambiguity`: Preserve current behavior, calling `ambiguity::run_ambiguity_suite()`.
- Stubs (Eval, Diff, Check, Explain, Generate): Print "{subcommand} is not yet implemented" to stderr, exit with code 2.

**Exit code convention:**
- 0: success
- 1: error (elaboration failed, validation failed, test failures)
- 2: subcommand not yet implemented

**Preserve backward compatibility:**
- `tenor elaborate <file>` must produce identical output to current behavior
- `tenor test conformance` must produce identical TAP output to current `run conformance`
- `tenor ambiguity` must preserve all existing flags (--spec, --model, positional spec-path)
  </action>
  <verify>
Run `cargo build -p tenor-cli` to confirm compilation.
Run `cargo run -p tenor-cli -- --help` and verify all subcommands listed.
Run `cargo run -p tenor-cli -- elaborate conformance/positive/fact_basic.tenor` and verify JSON output matches current behavior.
Run `cargo run -p tenor-cli -- test conformance` and verify 55/55 passing.
Run `cargo run -p tenor-cli -- validate` with a known-good interchange JSON and verify exit 0.
Run `cargo run -p tenor-cli -- eval bundle.json --facts facts.json` and verify exit code 2 with "not yet implemented" message.
  </verify>
  <done>
All 8 subcommands registered in clap. `elaborate`, `validate`, `test`, and `ambiguity` are fully functional. Stub subcommands exit with code 2. `--help` shows usage for all commands. `--output` and `--quiet` global flags accepted. 55/55 conformance tests still pass via `tenor test`.
  </done>
</task>

</tasks>

<verification>
- `cargo build --workspace` succeeds with no warnings
- `cargo run -p tenor-cli -- --help` lists all subcommands
- `cargo run -p tenor-cli -- elaborate conformance/positive/fact_basic.tenor` produces valid JSON
- `cargo run -p tenor-cli -- test conformance` reports 55/55 passing
- `cargo run -p tenor-cli -- validate <any-positive-expected-json>` reports valid
- `cargo run -p tenor-cli -- eval x --facts y` exits with code 2
- `cargo run -p tenor-cli -- diff a b` exits with code 2
</verification>

<success_criteria>
- clap derive-based CLI replaces all hand-rolled argument parsing
- All 8 subcommands registered and dispatched
- elaborate, validate, test, and ambiguity fully functional
- Global --output and --quiet flags work
- Exit codes follow 0/1/2 convention
- 55/55 conformance tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-evaluator/03-01-SUMMARY.md`
</output>
