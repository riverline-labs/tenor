---
phase: 03-cli-evaluator
plan: 04
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - crates/cli/src/diff.rs
  - crates/cli/src/main.rs
autonomous: true
requirements: [MIGR-01]

must_haves:
  truths:
    - "`tenor diff <t1.json> <t2.json>` shows added constructs (in t2 but not t1)"
    - "`tenor diff` shows removed constructs (in t1 but not t2)"
    - "`tenor diff` shows changed constructs with field-level differences"
    - "Constructs are compared by (kind, id) key -- not by array position"
    - "Output is structured JSON by default, human-readable text with --output text"
  artifacts:
    - path: "crates/cli/src/diff.rs"
      provides: "Construct-level interchange bundle diff logic"
      contains: "diff_bundles"
    - path: "crates/cli/src/main.rs"
      provides: "Diff subcommand dispatch (replacing stub)"
      contains: "Commands::Diff"
  key_links:
    - from: "crates/cli/src/main.rs"
      to: "crates/cli/src/diff.rs"
      via: "Diff subcommand calls diff_bundles"
      pattern: "diff::diff_bundles"
---

<objective>
Implement the `tenor diff` subcommand that produces a structured diff of two interchange bundles, comparing constructs by `(kind, id)` and showing added, removed, and changed constructs with field-level differences.

Purpose: MIGR-01 requires structural diff as the foundation for contract versioning. Phase 3.1 (CFFP Migration Semantics) and Phase 4 (`tenor diff --breaking`) build on this structural diff capability.
Output: Working `tenor diff <t1.json> <t2.json>` that outputs construct-level differences.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cli-evaluator/03-RESEARCH.md
@.planning/phases/03-cli-evaluator/03-01-SUMMARY.md

@crates/cli/src/main.rs
@docs/interchange-schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement construct-level bundle diff</name>
  <files>crates/cli/src/diff.rs</files>
  <action>
Create `crates/cli/src/diff.rs` implementing construct-level structural diff. This is hand-built (not using a generic JSON diff library) because the diff must be domain-aware -- keyed by `(kind, id)`, not array position.

**Core types:**
```rust
pub struct BundleDiff {
    pub added: Vec<ConstructSummary>,
    pub removed: Vec<ConstructSummary>,
    pub changed: Vec<ConstructChange>,
}

pub struct ConstructSummary {
    pub kind: String,
    pub id: String,
}

pub struct ConstructChange {
    pub kind: String,
    pub id: String,
    pub fields: Vec<FieldDiff>,
}

pub struct FieldDiff {
    pub field: String,
    pub before: serde_json::Value,
    pub after: serde_json::Value,
}
```

**Algorithm in `diff_bundles(t1: &Value, t2: &Value) -> Result<BundleDiff, DiffError>`:**

1. Extract `constructs` array from both bundles. Each construct is a JSON object with `kind` and `id` fields.
2. Build index: `BTreeMap<(String, String), &Value>` for each bundle, keyed by `(kind, id)`.
3. **Added:** Keys in t2 index that are NOT in t1 index.
4. **Removed:** Keys in t1 index that are NOT in t2 index.
5. **Changed:** Keys in BOTH indexes where the construct values differ. For changed constructs, compute field-level diffs:
   - Compare each top-level field of the construct objects
   - Skip fields that are identical
   - Record before/after for fields that differ
   - Ignore the `line` field by default (line numbers change with any edit and are noise)
   - Ignore internal ordering differences in arrays where the elements are the same set (for `states`, `allowed_personas`, etc.)
6. Sort output: added, removed, changed -- each sorted by (kind, id) for deterministic output.

**JSON output format:**
```json
{
  "added": [{ "kind": "Fact", "id": "new_fact" }],
  "removed": [{ "kind": "Rule", "id": "old_rule" }],
  "changed": [{
    "kind": "Entity",
    "id": "Order",
    "fields": [{
      "field": "states",
      "before": ["draft", "submitted"],
      "after": ["draft", "submitted", "approved"]
    }]
  }]
}
```

**Text output format (for --output text):**
```
+ Fact new_fact
- Rule old_rule
~ Entity Order
    states: ["draft", "submitted"] -> ["draft", "submitted", "approved"]
```

Implement `BundleDiff::to_json(&self) -> Value` and `BundleDiff::to_text(&self) -> String`.

**DiffError:** enum with `InvalidBundle(&str)` (missing constructs array, missing kind/id).

Write unit tests covering:
- Identical bundles -> empty diff
- Added construct
- Removed construct
- Changed construct with field-level diff
- Line number changes ignored
- Multiple changes in single diff
  </action>
  <verify>
`cargo test -p tenor-cli` passes all diff unit tests.
Test identical bundles produce empty diff.
Test adding a construct shows it in added.
Test removing a construct shows it in removed.
Test changing a field shows it in changed with correct before/after.
  </verify>
  <done>
Construct-level diff produces correct added/removed/changed sets. Keyed by (kind, id). Field-level diffs for changed constructs. Line numbers excluded from comparison.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire diff subcommand into CLI</name>
  <files>
    crates/cli/src/main.rs
    crates/cli/src/diff.rs
  </files>
  <action>
Replace the `Commands::Diff` stub in main.rs with actual dispatch to `diff::diff_bundles`.

**Diff subcommand handler:**
1. Read both JSON files (t1 and t2) from disk.
2. Parse as `serde_json::Value`.
3. Call `diff::diff_bundles(&t1, &t2)`.
4. Format output based on `--output` flag:
   - `--output json` (default for diff): print `BundleDiff::to_json()` to stdout
   - `--output text`: print `BundleDiff::to_text()` to stdout
5. Exit code: 0 if no differences, 1 if differences found (like Unix `diff`).
6. `--quiet` mode: exit with appropriate code but no output.

Add `mod diff;` to main.rs.

Test manually with two conformance expected JSON files that differ (e.g., elaborate two different .tenor files and diff their outputs).
  </action>
  <verify>
`cargo build -p tenor-cli` compiles.
Run `tenor diff <same-file> <same-file>` -- exit code 0, empty diff.
Run `tenor diff <file1> <file2>` where files differ -- exit code 1, diff output shown.
Run `tenor diff <file1> <file2> --output text` -- human-readable output.
Run `tenor diff <file1> <file2> --quiet` -- no output, exit code 1.
  </verify>
  <done>
`tenor diff` subcommand fully functional. Reads two interchange bundles, computes construct-level diff, outputs in JSON or text format. Exit code 0 for identical, 1 for different. --quiet suppresses output.
  </done>
</task>

</tasks>

<verification>
- `cargo build --workspace` compiles
- `tenor diff` with identical files exits 0
- `tenor diff` with different files exits 1 and shows added/removed/changed
- Both JSON and text output formats work
- Unit tests pass for edge cases (identical, added, removed, changed, multiple changes)
</verification>

<success_criteria>
- `tenor diff <t1.json> <t2.json>` produces structured construct-level diff
- Diff keyed by (kind, id), not array position
- Field-level diffs for changed constructs
- JSON and text output formats
- Exit code 0 (same) / 1 (different) convention
- Line numbers excluded from comparison by default
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-evaluator/03-04-SUMMARY.md`
</output>
