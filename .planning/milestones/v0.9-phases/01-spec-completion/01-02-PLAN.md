---
phase: 01-spec-completion
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - docs/cffp/p7-outcome-typing.json
  - docs/TENOR.md
autonomous: true
requirements:
  - SPEC-02
  - SPEC-05

must_haves:
  truths:
    - "Operations declare named outcome types that are statically enumerable"
    - "Every Flow transition references a valid outcome of the referenced Operation"
    - "No implicit or catch-all outcomes are permitted"
    - "P7 CFFP artifact exists and conforms to docs/cffp.cue schema"
    - "P7 spec section in docs/TENOR.md defines syntax, semantics, elaboration rules, interchange representation"
  artifacts:
    - path: "docs/cffp/p7-outcome-typing.json"
      provides: "Complete CFFP instance for P7 Operation outcome typing"
      contains: "phase6"
    - path: "docs/TENOR.md"
      provides: "Updated Operation section with outcome type declarations and updated Flow section with typed outcome references"
      contains: "outcome"
  key_links:
    - from: "docs/cffp/p7-outcome-typing.json"
      to: "docs/TENOR.md"
      via: "CFFP canonical form translated to spec modifications"
      pattern: "canonical.*formal_statement"
    - from: "docs/TENOR.md (Operation section)"
      to: "docs/TENOR.md (Flow section)"
      via: "Flow transitions reference declared Operation outcomes"
      pattern: "outcome"
---

<objective>
Execute CFFP run for P7 Operation outcome typing and translate the canonical form into spec updates in docs/TENOR.md.

Purpose: Operations currently produce untyped outcomes that Flows classify ad-hoc (AL13: "typed outcome routing is Flow-side classification only"). P7 formalizes named outcome types declared on Operations, enabling static enumeration of all possible outcomes and type-safe flow routing. This is the second CFFP run; it depends on the Persona canonical form from plan 01-01.

Output: `docs/cffp/p7-outcome-typing.json` (complete CFFP instance), updated `docs/TENOR.md` with modified Operation and Flow sections.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-spec-completion/01-CONTEXT.md
@.planning/phases/01-spec-completion/01-RESEARCH.md
@.planning/phases/01-spec-completion/01-01-SUMMARY.md
@docs/cffp.cue
@docs/cffp/persona.json
@docs/TENOR.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execute full CFFP run for P7 Operation outcome typing</name>
  <files>docs/cffp/p7-outcome-typing.json</files>
  <action>
Produce `docs/cffp/p7-outcome-typing.json` — a complete CFFP instance conforming to `docs/cffp.cue#CFFPInstance`.

**Phase 1 — Invariant Declaration:**
Starting invariants from CONTEXT.md:
- I1: Every Flow transition must reference a valid outcome of the referenced Operation (class: soundness)
- I2: The set of outcomes for any Operation is statically determinable (class: analyzability)
- I3: No implicit/catch-all outcomes — every possible operation result is a named member of the outcome set (class: completeness)

Derive additional invariants from design constraints (C1-C7):
- I4: Outcome typing does not affect evaluation determinism — given the same inputs, the same outcome is produced (class: determinism)
- I5: The outcome set is finite (class: termination) — it is a closed enum, not an open set
- I6: Flow outcome routing is exhaustive — every declared outcome of a referenced Operation must be handled in the Flow (class: soundness) — or decide if partial routing is acceptable and why

Key design tension per research: P7 modifies TWO existing constructs (Operation and Flow), not adding a new one. The change radiates through the interchange format, elaboration passes, and conformance suite. The invariants must address backward compatibility.

**Phase 2 — Candidate Formalisms:**
Generate at least 2 candidates:

- Candidate A: Inline Outcome Enum — Operations declare an `outcomes` field listing named outcome labels (strings). Each label is a terminal outcome of the operation. Flows reference outcomes by label. The error channel (`error_contract`) remains separate. Structure: Operation gains `outcomes: [OutcomeLabel]`. Flow OperationStep `outcomes` map keys must be a subset of (or equal to) the referenced Operation's declared outcomes.

- Candidate B: Typed Outcome Variants — Operations declare outcome variants as a TaggedUnion-like structure, where each variant can carry typed payload data. Flows receive the outcome variant and can pattern-match on it. More expressive but more complex.

- Candidate C: Outcome as separate construct — Outcomes are declared as standalone constructs referenced by Operations and Flows. Enables reuse of outcome definitions across Operations.

Each candidate must include proof sketches for ALL invariants, complexity bounds, and failure modes. Pay special attention to:
- How does each candidate handle the existing `error_contract` field? Are errors separate from outcomes or unified?
- How does each candidate handle the transition from AL13 (Flow-side only) to Operation-declared outcomes?
- What is the migration path for existing contracts that use ad-hoc outcome labels like "success"/"failure"?

**Phase 3 — Pressure:**
Generate counterexamples targeting each candidate. Key pressure points:
- Test: Can an Operation have zero declared outcomes? What does that mean semantically?
- Test: Can outcomes overlap with error conditions? What happens if "failure" is both an outcome and an error_contract entry?
- Test: Composition with Persona (from plan 01-01) — does the persona gate affect which outcomes are possible?
- Test: Composition with Entity — if an outcome triggers a state transition, must the Entity validate the transition?
- Test: What happens when a Flow references an Operation outcome that doesn't exist? (Must be caught at elaboration time.)
- Test: What happens when a Flow doesn't handle all outcomes of a referenced Operation? Is partial handling valid?

Composition test against ALL depends_on constructs: Fact, Entity, Rule, Operation, Flow, TypeDecl, AND Persona (newly canonicalized).

Per pitfall #2: The canonical form MUST specify a migration path from AL13. The spec freeze says "no breaking changes to existing construct semantics" — P7 must be additive or provide explicit migration. Address this directly.

**Survivor Derivation:** Populate `derived` with eliminated and surviving candidates.

**Phase 4 — Collapse Test:** Only if multiple survivors.

**Phase 5 — Static Analysis Obligations:** Prove:
- S5 (Operation effect analysis) can enumerate all possible outcomes for any operation
- S6 (Flow path enumeration) can verify that all operation outcomes are handled in flow routing
- The outcome type set is enumerable at elaboration time (Pass 5)

**Phase 6 — Canonicalization:** Produce formal statement defining: outcome declaration syntax on Operations, outcome reference syntax in Flow OperationSteps, elaboration rules for outcome validation, interchange representation for declared outcomes.
  </action>
  <verify>
Validate the CFFP artifact:
- JSON parses without error
- Contains all required top-level fields per #CFFPInstance
- construct.depends_on includes ["Fact", "Entity", "Rule", "Operation", "Flow", "TypeDecl", "Persona"]
- phase1.invariants is non-empty (at least 3)
- phase2.candidates is non-empty (at least 2)
- phase3.counterexamples is non-empty (per pitfall #5 — zero counterexamples is a red flag)
- phase3.composition_failures tested against ALL depends_on including Persona
- derived.survivors is non-empty
- phase5.all_provable is true
- phase6.canonical exists with all required fields
- outcome is "canonical" or "collapse"
- The canonical form addresses backward compatibility with AL13
  </verify>
  <done>
Complete CFFP instance for P7 at docs/cffp/p7-outcome-typing.json with canonical outcome. At least 2 candidates pressure-tested, composition tested against all prior constructs including Persona. Canonical form defines outcome declaration on Operations, typed outcome routing in Flows, and migration path from AL13.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Operation and Flow spec sections in docs/TENOR.md for P7</name>
  <files>docs/TENOR.md</files>
  <action>
Translate the P7 CFFP canonical form into spec updates in `docs/TENOR.md`. P7 modifies existing constructs rather than adding a new section.

**Section 8 (Operation) updates:**
1. Add outcome declaration syntax — Operations now declare their outcome set. Define the syntax for declaring named outcomes on an Operation.
2. Update the Operation formal definition (Section 8.1) to include the outcome set as part of the Operation structure.
3. Update Operation semantics (Section 8.2) to specify how outcome production works — when an Operation executes, it produces exactly one of its declared outcomes.
4. Update Operation constraints (Section 8.3) to include: outcome names must be unique within an Operation, outcome set must be non-empty (or define what empty means).
5. Update Operation interchange representation (Section 8.5) to include the declared outcomes in serialized form.

**Section 10 (Flow) updates:**
1. Update OperationStep definition to reference declared outcomes instead of ad-hoc labels.
2. Update Flow routing semantics — when a Flow step invokes an Operation, the routing must handle declared outcomes of that Operation.
3. Define validation rule: Flow OperationStep outcome keys must be valid members of the referenced Operation's outcome set.
4. Update Flow interchange representation to reflect typed outcome references.

**Section 16 (Pending Work) updates:**
- Update P7 entry from "Deferred to v2" to "Resolved in v1.0" with a brief note.

**Appendix A (Acknowledged Limitations) updates:**
- Update or replace AL13 ("Flow typed outcomes are Flow-side only") since P7 supersedes it.
- Add any new acknowledged limitations from the CFFP canonical form.

**Migration / backward compatibility:**
- Document how existing contracts using ad-hoc outcome labels ("success"/"failure") map to the new system. This should be clear from the canonical form's migration path.
- The error_contract mechanism should remain as-is (errors are a separate channel from outcomes) unless the canonical form dictates otherwise.

Do NOT change Section 3 construct list — P7 modifies Operation and Flow, it does not add a new construct. Update the Section 3 description only if the construct relationships change.
  </action>
  <verify>
- Section 8 (Operation) includes outcome declaration syntax, updated definition, updated constraints, updated interchange representation
- Section 10 (Flow) references Operation-declared outcomes in OperationStep routing
- AL13 updated or replaced to reflect P7 resolution
- Section 16 P7 entry updated from "Deferred to v2" to "Resolved in v1.0"
- Acknowledged limitations from CFFP canonical form appear in Appendix A
- Existing Operation and Flow semantics preserved where not directly modified by P7
  </verify>
  <done>
docs/TENOR.md Operation section (8) includes outcome type declarations. Flow section (10) references Operation-declared outcomes for typed routing. AL13 superseded. P7 marked as resolved in Section 16. Migration path documented for existing contracts.
  </done>
</task>

</tasks>

<verification>
1. `docs/cffp/p7-outcome-typing.json` exists, parses as valid JSON, and structurally matches `docs/cffp.cue#CFFPInstance`
2. Operation section defines outcome declaration syntax and semantics
3. Flow section references Operation-declared outcomes in OperationStep
4. AL13 updated to reflect P7 resolution
5. CFFP artifact includes composition tests against Persona (from plan 01-01)
6. Backward compatibility / migration path documented
</verification>

<success_criteria>
- P7 CFFP run completed with canonical outcome
- Operation outcome types are statically enumerable from the spec definition
- Flow transitions reference valid Operation outcomes (not ad-hoc labels)
- No breaking changes to existing constructs — P7 is additive with explicit migration
- AL13 superseded by formal outcome typing semantics
</success_criteria>

<output>
After completion, create `.planning/phases/01-spec-completion/01-02-SUMMARY.md`
</output>
