---
phase: 12-system-construct
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/cffp/system.json
autonomous: true
requirements:
  - SYS-05

must_haves:
  truths:
    - "System construct invariants are declared and pressure-tested through CFFP"
    - "A canonical form for the System construct emerges from surviving candidates"
    - "Cross-contract composition semantics (member contracts, shared personas, flow triggers, entity relationships) are formally defined"
  artifacts:
    - path: "docs/cffp/system.json"
      provides: "CFFP artifact with invariants, candidates, pressure tests, canonical form"
      contains: "canonical_form"
  key_links:
    - from: "docs/cffp/system.json"
      to: "docs/TENOR.md"
      via: "canonical form translates to spec section in plan 02"
      pattern: "canonical_form"
---

<objective>
Run the CFFP (Constraint-First Formalization Protocol) for the System construct to formally design multi-contract composition semantics.

Purpose: The System construct is the first new construct since v0.9 freeze. It must be designed through CFFP to ensure invariants are sound before any implementation begins. This is the foundation for all other Phase 12 work.

Output: `docs/cffp/system.json` — the CFFP artifact containing invariants, candidate formalisms, pressure test results, and the canonical form for the System construct.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/TENOR.md
@docs/cffp/persona.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execute CFFP for the System construct</name>
  <files>docs/cffp/system.json</files>
  <action>
Run the Constraint-First Formalization Protocol for the System construct. Follow the established CFFP pattern from prior runs (persona.json, p7-outcome-typing.json, p5-shared-types.json).

**Phase 1 — Invariant Declaration:**
Declare invariants for the System construct covering these semantics:
- I1: System declares a finite set of member contracts by id; each id must resolve to a file path or inline contract
- I2: System member contract ids are unique within the System
- I3: Shared persona identity: a persona declared in the System maps to exactly one Persona in each member contract it references; the elaborator validates this binding
- I4: Cross-contract flow triggers: a trigger declaration in the System specifies (source_contract, source_flow, target_contract, target_flow); the elaborator validates all four references exist
- I5: Cross-contract entity relationships: a shared entity declaration in the System specifies (entity_id, contract_a, contract_b); the elaborator validates both contracts declare the entity with compatible state machines
- I6: System composition is statically determinable — no dynamic contract loading, no runtime composition
- I7: System does not alter single-contract semantics — a contract within a System produces identical elaboration output as the same contract outside a System (the System adds cross-contract metadata only)
- I8: System termination — System resolution is bounded by the finite set of member contracts; no recursive System embedding
- Additional invariants as the analysis reveals them

**Phase 2 — Candidate Formalisms:**
Propose 3-5 candidate representations for the System construct in DSL syntax and interchange JSON. Consider:
- Candidate A: System as a top-level construct with inline member declarations and cross-contract bindings
- Candidate B: System as a separate file that imports member contracts and declares bindings
- Candidate C: System as a contract-level annotation with binding declarations
- Evaluate each against all Phase 1 invariants

**Phase 3 — Pressure Testing:**
For each candidate, construct counterexamples targeting:
- Circular System dependencies (System A references System B which references A)
- Member contract with no shared personas (is this valid?)
- Cross-contract flow trigger where target flow requires a persona not shared in the System
- Entity state machine incompatibility across contracts
- System with a single member contract (degenerate case)
- Overlapping entity relationships (entity X shared between A-B and B-C)
Record which candidates survive each pressure test

**Phase 4 — Canonical Form Selection:**
Select the surviving candidate (or synthesize from survivors). Document:
- DSL syntax for the System construct (lowercase `system` keyword per CLAUDE.md)
- Interchange JSON representation (kind: "System")
- Member contract representation
- Shared persona binding representation
- Cross-contract flow trigger representation
- Cross-contract entity relationship representation
- Acknowledged limitations (AL-series) for scoped-down features

The CFFP artifact must follow the exact JSON structure of prior artifacts (see docs/cffp/persona.json for the canonical structure). Include all four phases with full documentation.

Important design constraints from ROADMAP.md:
- System is a new construct touching the full stack
- v0.9 spec is frozen — System is the only additive change
- Must support shared persona identity, cross-contract flow triggers, and cross-contract entity relationships
  </action>
  <verify>
Verify the CFFP artifact:
1. `cat docs/cffp/system.json | python3 -m json.tool` — valid JSON
2. Artifact contains all four CFFP phases (phase1, phase2, phase3, phase4)
3. Phase 1 has at least 7 invariants with id, description, testable, structural, class fields
4. Phase 2 has at least 3 candidates
5. Phase 3 has pressure test results for each candidate
6. Phase 4 has a canonical_form with dsl_syntax, interchange_representation, and acknowledged_limitations
  </verify>
  <done>
A complete CFFP artifact exists at docs/cffp/system.json containing:
- Invariants covering member contracts, shared personas, flow triggers, entity relationships, composition determinism, semantic isolation, and termination
- At least 3 candidate formalisms evaluated against invariants
- Pressure test results showing which candidates survive
- A canonical form with concrete DSL syntax, interchange JSON representation, and acknowledged limitations
  </done>
</task>

</tasks>

<verification>
- docs/cffp/system.json exists and is valid JSON
- All four CFFP phases are documented
- Canonical form provides concrete DSL syntax and interchange representation
- Design covers all four cross-contract features: member contracts, shared personas, flow triggers, entity relationships
</verification>

<success_criteria>
The CFFP artifact provides a complete, pressure-tested design for the System construct that can be directly translated into spec text and implementation in subsequent plans.
</success_criteria>

<output>
After completion, create `.planning/phases/12-system-construct/12-01-SUMMARY.md`
</output>
