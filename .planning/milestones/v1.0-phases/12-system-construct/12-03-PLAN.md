---
phase: 12-system-construct
plan: 03
type: execute
wave: 3
depends_on:
  - 12-02
files_modified:
  - crates/core/src/ast.rs
  - crates/core/src/lexer.rs
  - crates/core/src/parser.rs
  - crates/core/src/pass2_index.rs
  - crates/core/src/pass4_typecheck.rs
  - crates/core/src/pass6_serialize.rs
  - crates/core/src/lib.rs
autonomous: true
requirements:
  - SYS-01
  - SYS-02
  - SYS-03
  - SYS-04

must_haves:
  truths:
    - "The System keyword is recognized by the lexer and produces a System token"
    - "The parser produces a RawConstruct::System variant from valid System DSL syntax"
    - "Pass 2 indexes System constructs and detects duplicate System ids"
    - "System member contracts, shared personas, flow triggers, and entity relationships are represented in the AST"
  artifacts:
    - path: "crates/core/src/ast.rs"
      provides: "RawConstruct::System variant with member contracts, shared personas, flow triggers, entity relationships"
      contains: "System"
    - path: "crates/core/src/lexer.rs"
      provides: "System keyword token"
      contains: "System"
    - path: "crates/core/src/parser.rs"
      provides: "System construct parsing"
      contains: "parse_system"
    - path: "crates/core/src/pass2_index.rs"
      provides: "System construct indexing"
      contains: "System"
  key_links:
    - from: "crates/core/src/parser.rs"
      to: "crates/core/src/ast.rs"
      via: "parser produces RawConstruct::System"
      pattern: "RawConstruct::System"
    - from: "crates/core/src/pass2_index.rs"
      to: "crates/core/src/ast.rs"
      via: "indexer matches on RawConstruct::System"
      pattern: "RawConstruct::System"
---

<objective>
Implement the lexer, parser, AST types, and Pass 2 indexing for the System construct — the first half of the elaboration pipeline.

Purpose: Before any validation or serialization can happen, the elaborator must be able to lex, parse, and index System constructs from DSL source. This plan adds the System variant to the AST and ensures the parsing pipeline handles it correctly.

Output: Updated lexer, parser, AST, and Pass 2 that handle System constructs.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-system-construct/12-02-SUMMARY.md
@docs/TENOR.md
@crates/core/src/ast.rs
@crates/core/src/lexer.rs
@crates/core/src/parser.rs
@crates/core/src/pass2_index.rs
@crates/core/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add System AST variant and lexer token</name>
  <files>
crates/core/src/ast.rs
crates/core/src/lexer.rs
  </files>
  <action>
**AST (ast.rs):**
Add a `System` variant to the `RawConstruct` enum. The variant must represent all elements from the CFFP canonical form / spec section:

```rust
System {
    id: String,
    /// Member contract declarations: (contract_id, file_path)
    members: Vec<(String, String)>,
    /// Shared persona bindings: (persona_id, vec of contract_ids that share this persona)
    shared_personas: Vec<(String, Vec<String>)>,
    /// Cross-contract flow triggers: (source_contract, source_flow, target_contract, target_flow)
    flow_triggers: Vec<(String, String, String, String)>,
    /// Cross-contract entity relationships: (entity_id, contract_a, contract_b)
    shared_entities: Vec<(String, String, String)>,
    prov: Provenance,
},
```

Adjust the exact field types based on what the CFFP canonical form (plan 02 SUMMARY) specifies. The key requirement is that all four cross-contract features (SYS-01 members, SYS-02 shared personas, SYS-03 flow triggers, SYS-04 entity relationships) have dedicated fields.

If the CFFP design uses line-number tracking for sub-fields (like Entity tracks `initial_line`, `parent_line`), add those line fields too.

**Lexer (lexer.rs):**
Add a `System` token to the `Token` enum. Add `"system"` to the keyword matching in `lex()` — follow the exact pattern used for other keywords like `entity`, `operation`, `flow`, `persona`. The keyword is lowercase `system` per CLAUDE.md.

Ensure `cargo build --workspace` compiles (it will have warnings about non-exhaustive match patterns in later passes — that is expected and will be fixed in plans 04).
  </action>
  <verify>
1. `cargo build -p tenor-core 2>&1 | grep -c "error"` — zero errors (warnings are OK)
2. `grep "System" crates/core/src/ast.rs` — System variant exists
3. `grep "system" crates/core/src/lexer.rs` — system keyword recognized
  </verify>
  <done>
RawConstruct::System variant exists in ast.rs with fields for members, shared_personas, flow_triggers, and shared_entities. The lexer recognizes the lowercase `system` keyword.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement System parser and Pass 2 indexing</name>
  <files>
crates/core/src/parser.rs
crates/core/src/pass2_index.rs
crates/core/src/pass4_typecheck.rs
crates/core/src/pass6_serialize.rs
crates/core/src/lib.rs
  </files>
  <action>
**Parser (parser.rs):**
Add a `parse_system()` function following the pattern of `parse_entity()`, `parse_operation()`, `parse_flow()`. The function must:

1. Match on the `System` token from the lexer
2. Parse the System id (next identifier after `system` keyword)
3. Parse the body block with the sub-fields from the CFFP canonical form:
   - `members:` — list of (contract_id, file_path) pairs
   - `shared_personas:` — list of (persona_id, [contract_ids]) bindings
   - `flow_triggers:` — list of (source_contract, source_flow, target_contract, target_flow) tuples
   - `shared_entities:` — list of (entity_id, contract_a, contract_b) triples
4. Return `RawConstruct::System { ... }`

The exact syntax parsed must match what the spec section (plan 02 output) defines. Read the updated docs/TENOR.md System section for the authoritative DSL syntax before implementing.

Wire `parse_system` into the main construct dispatch in the parser (where `parse_fact`, `parse_entity`, etc. are dispatched based on the leading keyword token).

**Pass 2 Indexing (pass2_index.rs):**
Add a match arm for `RawConstruct::System` in `build_index()`. The System construct must be indexed like other constructs:
1. Add a `systems` field to the `Index` struct (or use the existing pattern of `HashMap<String, Provenance>`)
2. Check for duplicate System ids (same error pattern as duplicate Entity/Rule/etc. ids)
3. Add the System to the index

If the Index struct needs a new field, also update `crates/core/src/lib.rs` re-exports if Index is re-exported.

**lib.rs:**
If any new public types are added (e.g., new fields on Index), update the re-exports in lib.rs.

Ensure the workspace compiles after adding the new System variant. Check every `match` on `RawConstruct` in pass3 through pass6 for non-exhaustive patterns:
- **pass4_typecheck.rs**: `resolve_construct()` currently has `other => Ok(other)` catch-all, so it should already handle the new variant. Verify this is still true; if any explicit-arm match was added, add `RawConstruct::System { .. } => Ok(c)`.
- **pass5_validate.rs**: The main `validate()` dispatch has `_ => {}` catch-all. No change needed unless a new exhaustive match was introduced.
- **pass6_serialize.rs**: The `construct_id()` function has **explicit arms with no catch-all** (Fact, Entity, Rule, Operation, Flow, TypeDecl, Persona, Import). Add `RawConstruct::System { id, .. } => id` to this function. The main `serialize()` dispatch and `serialize_construct()` have `_ =>` catch-alls and need no change. Plan 12-04 will add the full serialization arm — this plan only adds the `construct_id` placeholder so the workspace compiles.
  </action>
  <verify>
1. `cargo build --workspace 2>&1 | grep -c "error"` — zero errors
2. Create a minimal test .tenor file with a system construct and verify `cargo run -p tenor-cli -- elaborate test.tenor` does not crash (it may produce incomplete output since pass5/pass6 are not yet updated — that is OK)
3. `grep "parse_system\|System" crates/core/src/parser.rs` — parser handles System
4. `grep "System" crates/core/src/pass2_index.rs` — indexer handles System
  </verify>
  <done>
The parser produces RawConstruct::System from DSL source. Pass 2 indexes System constructs and detects duplicate ids. The workspace compiles without errors.
  </done>
</task>

</tasks>

<verification>
- `cargo build --workspace` succeeds
- System keyword is lexed, parsed, and indexed
- AST variant contains all four cross-contract feature fields
- No existing tests broken (`cargo test --workspace` passes, noting that System-specific tests come in plan 05)
</verification>

<success_criteria>
A .tenor file containing a `system` declaration can be parsed into the AST and indexed in Pass 2. The elaboration pipeline does not crash on System input, even though validation and serialization are not yet complete.
</success_criteria>

<output>
After completion, create `.planning/phases/12-system-construct/12-03-SUMMARY.md`
</output>
