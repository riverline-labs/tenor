---
phase: 13-domain-re-validation
plan: 06
type: execute
wave: 2
depends_on: ["03", "05"]
files_modified:
  - domains/system_scenario/trade_inspection_system.tenor
autonomous: true
requirements: [DOMN-15]

must_haves:
  truths:
    - "A multi-contract System scenario exists composing at least two domain contracts"
    - "The System construct elaborates cleanly with shared personas and cross-contract flow triggers"
    - "tenor check produces cross-contract analysis findings (S4 cross-contract authority, S6 cross-contract flow triggers)"
    - "Any spec gaps discovered during System scenario authoring are documented"
    - "System-level evaluation limitation is explicitly documented as acknowledged (evaluator lacks System construct support)"
  artifacts:
    - path: "domains/system_scenario/trade_inspection_system.tenor"
      provides: "Multi-contract System scenario composing supply chain + trade finance domain contracts"
  key_links:
    - from: "domains/system_scenario/trade_inspection_system.tenor"
      to: "tenor elaborate"
      via: "System elaboration pipeline with member contract resolution"
      pattern: "cargo run -p tenor-cli -- elaborate"
    - from: "domains/system_scenario/trade_inspection_system.tenor"
      to: "tenor check"
      via: "System static analysis with cross-contract findings"
      pattern: "cargo run -p tenor-cli -- check"
---

<objective>
Create and validate a multi-contract System scenario composing real domain contracts end-to-end.

Purpose: Demonstrate that the System construct works in realistic domain contexts by composing at least two validated domain contracts into a System with shared personas and cross-contract flow triggers, then verifying end-to-end through elaboration and static analysis.

**Acknowledged limitation:** System-level evaluation (`tenor eval`) is not yet supported by the evaluator. The evaluator (tenor-eval) operates on individual contract bundles and has no System construct awareness -- it cannot coordinate cross-contract entity snapshots, resolve shared personas across member contracts, or execute cross-contract flow triggers. The ROADMAP Phase 13 success criterion 2 calls for "elaboration, static analysis, and evaluation"; this plan satisfies the first two pillars. System-level evaluation support is deferred to a future phase when the evaluator is extended with System semantics.

Output: A System .tenor file composing domain contracts, validated through elaborate and check, with any discovered spec gaps documented. The absence of System-level evaluation is documented as an acknowledged limitation.
</objective>

<execution_context>
@/Users/bwb/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bwb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-system-construct/12-05-SUMMARY.md
@conformance/positive/system_basic.tenor
@conformance/positive/system_shared_persona.tenor
@conformance/positive/system_flow_trigger.tenor
@conformance/positive/system_shared_entity.tenor
@conformance/analysis/system_authority.tenor
@conformance/analysis/system_flow_trigger.tenor
@domains/supply_chain/inspection.tenor
@domains/trade_finance/letter_of_credit.tenor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Design and create multi-contract System scenario</name>
  <files>
domains/system_scenario/trade_inspection_system.tenor
  </files>
  <action>
Create a directory `domains/system_scenario/` and a System .tenor file that composes the supply chain inspection and trade finance letter of credit contracts into a realistic multi-contract scenario.

**Scenario rationale:** In international trade, a cargo shipment must pass port inspection (supply chain contract) before the letter of credit documents can be presented for payment (trade finance contract). This is a natural cross-contract dependency.

**Design the System construct:**

```
system trade_inspection_system {
  members: [
    inspection: "../supply_chain/inspection.tenor",
    letter_of_credit: "../trade_finance/letter_of_credit.tenor"
  ]
  shared_personas: [
    { persona: customs_officer, contracts: [inspection] }
  ]
  triggers: [
    {
      source: inspection.inspection_flow,
      on: shipment_cleared,
      target: letter_of_credit.lc_presentation_flow,
      persona: beneficiary
    }
  ]
  shared_entities: []
}
```

**Key design decisions:**
1. **Member contracts:** Supply chain inspection + trade finance letter of credit -- both validated in plans 03 and 05
2. **Shared personas:** Evaluate which personas logically overlap between the two domains. The `customs_officer` persona exists in supply chain. If no natural overlap exists, use an empty shared_personas list (shared personas require the same persona id to exist in both contracts). Actually -- since the two contracts have different persona sets (supply chain: customs_officer, quality_inspector, port_authority, shipping_agent; trade finance: applicant, beneficiary, issuing_bank, advising_bank, confirming_bank), there is NO natural persona overlap. So shared_personas should be empty `[]`.
3. **Triggers:** When inspection_flow completes with outcome "shipment_cleared", trigger lc_presentation_flow in the trade finance contract. The trigger persona must be a persona that exists in the target contract -- use `beneficiary` (who initiates the LC presentation).
4. **Shared entities:** No natural entity overlap between these domains, so `[]`.

**Important:** The member contract paths must be relative to the System .tenor file location. Since the System file is in `domains/system_scenario/` and contracts are in `domains/supply_chain/` and `domains/trade_finance/`, use relative paths like `../supply_chain/inspection.tenor`.

Run `cargo run -p tenor-cli -- elaborate domains/system_scenario/trade_inspection_system.tenor` to verify the System elaborates cleanly. If path resolution fails, adjust relative paths.

If the elaborator rejects the trigger because `beneficiary` is not in the source contract's persona list or because of other System validation rules, adjust the trigger to satisfy all C-SYS constraints. The trigger persona must be a persona declared in the target contract per C-SYS-16/17 constraints.

Document any issues encountered -- these may be spec gaps to report.
  </action>
  <verify>
- `domains/system_scenario/trade_inspection_system.tenor` exists with valid System syntax
- `cargo run -p tenor-cli -- elaborate domains/system_scenario/trade_inspection_system.tenor` exits 0 with valid JSON containing the System construct and both member contracts' constructs
  </verify>
  <done>Multi-contract System scenario created and elaborates cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Validate System scenario through static analysis and document findings</name>
  <files>
domains/system_scenario/trade_inspection_system.tenor
  </files>
  <action>
1. Run `cargo run -p tenor-cli -- check domains/system_scenario/trade_inspection_system.tenor` and capture the full output.

2. Verify cross-contract analysis findings appear:
   - **S4 cross-contract authority**: If shared personas are declared, the analysis should report cross-contract authority topology for those personas. If no shared personas, this section should be absent or empty.
   - **S6 cross-contract flow triggers**: The analysis should report cross-contract flow trigger paths showing the inspection_flow -> lc_presentation_flow trigger chain.

3. Verify the output includes standard single-contract analysis for both member contracts:
   - Entity reachability for supply chain entities (Shipment, QualityLot, ComplianceLot)
   - Entity reachability for trade finance entities (LetterOfCredit, Document)
   - Authority topology for all personas across both contracts
   - Flow path analysis for both flows (inspection_flow, lc_presentation_flow)

4. Document the complete `tenor check` output as evidence of end-to-end System validation.

5. **Gap documentation:** Document the following acknowledged limitations and any additional issues discovered:
   - **Mandatory:** Document that System-level evaluation (`tenor eval`) is not supported for System constructs. The evaluator operates on individual contract bundles and has no System construct awareness (cannot coordinate cross-contract entity snapshots, resolve shared personas across members, or execute cross-contract flow triggers). Classify this as an acknowledged limitation, not a gap -- extending the evaluator for System semantics is future work.
   - For any other issues discovered during this System scenario that reveal spec gaps or elaborator limitations:
     - Document each gap with: what was attempted, what failed, which spec section is involved
     - Classify as: spec gap (spec text is ambiguous/incomplete), elaborator limitation (spec is clear but implementation doesn't handle it), or acknowledged limitation (already in Appendix A)
   - Create a gap/limitation report in the SUMMARY covering at minimum the evaluation limitation.

6. Run the full conformance suite to ensure no regressions:
   `cargo run -p tenor-cli -- test conformance`
   `cargo test --workspace`
  </action>
  <verify>
- `cargo run -p tenor-cli -- check domains/system_scenario/trade_inspection_system.tenor` exits 0 and produces cross-contract analysis output
- `cargo run -p tenor-cli -- test conformance` passes all tests
- `cargo test --workspace` passes all tests
  </verify>
  <done>System scenario passes static analysis with cross-contract findings documented, no conformance regressions, any spec gaps documented</done>
</task>

</tasks>

<verification>
- Multi-contract System scenario exists and elaborates cleanly
- Static analysis produces cross-contract findings
- No regressions in conformance suite or workspace tests
- Any spec gaps discovered are documented in the plan summary
- The scenario demonstrates realistic domain composition (not just test fixtures)
</verification>

<success_criteria>
DOMN-15 satisfied: At least one multi-contract System scenario is validated end-to-end across domain contracts through elaboration and static analysis, demonstrating that the System construct works in realistic domain contexts. System-level evaluation is not yet supported (the evaluator has no System construct awareness) and is documented as an acknowledged limitation rather than a gap -- the ROADMAP success criterion 2's "evaluation" pillar is deferred until the evaluator is extended with System semantics.
</success_criteria>

<output>
After completion, create `.planning/phases/13-domain-re-validation/13-06-SUMMARY.md`
</output>
