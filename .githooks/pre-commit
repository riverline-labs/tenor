#!/usr/bin/env bash
set -euo pipefail

echo "=== PRE-COMMIT: Running quality gates ==="

# Deny all warnings at the rustc level — zero tolerance
export RUSTFLAGS="-D warnings"

# 1. Formatting (exact match with CI: cargo fmt --all -- --check)
echo "[1/5] cargo fmt --all -- --check"
cargo fmt --all -- --check || {
    echo "FAILED: cargo fmt. Run 'cargo fmt --all' to fix."
    exit 1
}

# 2. Build
echo "[2/5] cargo build --workspace"
cargo build --workspace || {
    echo "FAILED: cargo build"
    exit 1
}

# 3. Tests
echo "[3/5] cargo test --workspace"
cargo test --workspace || {
    echo "FAILED: cargo test"
    exit 1
}

# 4. Conformance
echo "[4/5] cargo run -p tenor-cli -- test conformance"
cargo run -p tenor-cli -- test conformance || {
    echo "FAILED: conformance suite"
    exit 1
}

# 5. Clippy (warnings are errors, same as CI)
echo "[5/5] cargo clippy --workspace -- -D warnings"
cargo clippy --workspace -- -D warnings || {
    echo "FAILED: clippy"
    exit 1
}

# 6. WASM build if eval/interchange/wasm crates were touched
CHANGED_FILES=$(git diff --cached --name-only)
if echo "$CHANGED_FILES" | grep -qE 'crates/eval/|crates/interchange/|crates/tenor-eval-wasm/'; then
    echo "[WASM] Changes detected in eval/interchange/wasm — building WASM"
    (cd crates/tenor-eval-wasm && wasm-pack build --target nodejs && wasm-pack test --node) || {
        echo "FAILED: WASM build/test"
        exit 1
    }
fi

echo "=== PRE-COMMIT: All checks passed ==="
